#Область ОбработчикиСобытий

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	Если УправлениеПечатьюКлиент.ПроверитьДокументыПроведены(ПараметрКоманды, ПараметрыВыполненияКоманды.Источник) Тогда
		
		Если ТипЗнч(ПараметрКоманды) = Тип("Массив") Тогда
			
			Для Каждого Владелец Из ПараметрКоманды Цикл
				
				ПроверитьНаличиеЗаписиШтрихкода(Владелец);
				
			КонецЦикла;
			
		Иначе
			
			ПроверитьНаличиеЗаписиШтрихкода(ПараметрКоманды);

		КонецЕсли;

		УправлениеПечатьюКлиент.ВыполнитьКомандуПечати("Документ.ЗапросДоступностиТоваров",
					"ЛистОтбора",
					ПараметрКоманды,
					ПараметрыВыполненияКоманды.Источник,
					Неопределено);
	
	КонецЕсли;
КонецПроцедуры

#КонецОбласти	



&НаСервере
Процедура ПроверитьНаличиеЗаписиШтрихкода(Владелец)
	
	УстановитьПривилегированныйРежим(Истина);
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Штрихкоды.Штрихкод КАК Штрихкод
		|ИЗ
		|	РегистрСведений.Штрихкоды КАК Штрихкоды
		|ГДЕ
		|	Штрихкоды.Владелец = &Владелец";
	
	Запрос.УстановитьПараметр("Владелец", Владелец);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() тогда 
		НаборЗаписей = РегистрыСведений.Штрихкоды.СоздатьНаборЗаписей(); 
		ШтрихКод = Владелец.Номер+Формат(Год(ТекущаяДата()),"ЧГ=0");
		НаборЗаписей.Отбор.Штрихкод.Установить(ШтрихКод);
		НаборЗаписей.Отбор.Владелец.Установить(Владелец); 
		НаборЗаписей.Отбор.Характеристика.Установить(Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка()); 
		НаборЗаписей.Отбор.ТипШтрихкода.Установить(ПланыВидовХарактеристик.ТипыШтрихкодов.CODE39); 
		НаборЗаписей.Отбор.Упаковка.Установить(Справочники.УпаковкиНоменклатуры.ПустаяСсылка()); 
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Штрихкод = ШтрихКод;
		НоваяЗапись.Владелец = Владелец; 
		НоваяЗапись.Характеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
		НоваяЗапись.ТипШтрихкода = ПланыВидовХарактеристик.ТипыШтрихкодов.CODE39;
		НоваяЗапись.Упаковка = Справочники.УпаковкиНоменклатуры.ПустаяСсылка();
		НоваяЗапись.ПредставлениеШтрихкода = ШтрихКод;
		НоваяЗапись.ДатаИзменения = ТекущаяДата();
		НаборЗаписей.Записать();	
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры
