#Область ОписаниеПеременных

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ВозвратныйДокумент = Параметры.ВозвратныйДокумент;
	УИФормы = Строка(УникальныйИдентификатор);

КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)

	Если ИмяСобытия = "СозданнаяЭН"
			И Параметр.УИФормы = УИФормы
			И Не Параметр.Ссылка.Пустая() Тогда
		
		Закрыть(Параметр.Ссылка);
		
	КонецЕсли;

КонецПроцедуры
#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

// Код процедур и функций

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Создать(Команда)
	
	Если НомерЭН = 0 Тогда
		
	
		ОповещениеПослеОтметкиЭлементов = Новый ОписаниеОповещения(
	     "ЗавершениеСозданияЭН", ЭтотОбъект
		 );	
		
		ВозвратныйДокументСтруктура = Новый Структура("Ссылка", ВозвратныйДокумент);
		ПараметрыДляФормы = Новый Структура("ЗначенияЗаполнения, УИФормы", ВозвратныйДокументСтруктура, УИФормы);
		ОткрытьФорму("Документ.ЭлектроннаяНакладная.Форма.ФормаДокумента",
				ПараметрыДляФормы,
				ЭтотОбъект,
				,
				,
				,
				ОповещениеПослеОтметкиЭлементов,
				РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	ИначеЕсли Не СтрДлина(Строка(Формат(НомерЭН, "ЧГ=;"))) = 14 Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Номер електронної накладної має містити 14 цифр",
			"НомерЭН");
	Иначе
		
		Закрыть(СоздатьЭН(ВозвратныйДокумент, НомерЭН));
		
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервереБезКонтекста
Функция СоздатьЭН(ВозвратныйДокумент, НомерЭН)

	СтруктураЭН = ОбменНПСервер.СтруктураОтветаПоЭНИнициализация(ВозвратныйДокумент);
	СтруктураЭН.НомерТТН = Формат(НомерЭН, "ЧГ=;");

	ЭлектроннаяНакладная = ОбменНПСервер.СоздатьДокументЭН(СтруктураЭН);
	
	ОбменНПСервер.ПолучитьСтатусТТН(, Формат(НомерЭН, "ЧГ=;"), Истина);
	
	Возврат ЭлектроннаяНакладная

КонецФункции

&НаКлиенте 
Процедура ЗавершениеСозданияЭН(Результат, Параметры) Экспорт 
	
	Если ТипЗнч(Результат) = Тип("ДокументСсылка.ЭлектроннаяНакладная") Тогда
		
		Закрыть(Результат);
	
	КонецЕсли;

КонецПроцедуры


#КонецОбласти