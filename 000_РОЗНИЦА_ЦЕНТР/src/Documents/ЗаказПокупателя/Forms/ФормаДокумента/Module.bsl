&НаКлиенте
Перем КэшированныеЗначения;

&НаКлиенте
Перем ТекущиеДанныеИдентификатор; // Используется для передачи текущей строки в обработчик ожидания.

&НаКлиенте	//	LNK 04.07.2021 06:52:09
Перем ДанныеСтрокиПередИзменением;

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Пропускаем инициализацию, чтобы гарантировать получение формы при передаче параметра "АвтоТест".
	
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;
	КонецЕсли;
	
	Если Параметры.Свойство("Действие") Тогда
		СтрокаДействие = Параметры.Действие;
		Если СтрокаДействие = "ДействиеСогласование" Тогда
			Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Согласован;
		ИначеЕсли СтрокаДействие = "ДействиеРезерв" Тогда
			КоличествоСтрокРезервирования = РезервироватьПоДаннымОстатковСервер();
		ИначеЕсли СтрокаДействие = "ДействиеОтмена" Тогда
			КоличествоСтрокОтменено = ОтменитьСНепроданнымиТоварамиСервер(Параметры.ПричинаОтмены, Истина);
		ИначеЕсли СтрокаДействие = "ДействиеЗакрытие" Тогда
			Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Закрыт;
		КонецЕсли;
		Модифицированность = Истина;
	КонецЕсли;
	
	ДополнительныеКолонкиНоменклатуры = ЗначениеНастроекПовтИсп.ПолучитьЗначениеКонстанты("ДополнительнаяКолонкаПриОтображенииНоменклатуры");
	ОбщегоНазначенияРТ.ЗаполнитьШапкуДокумента(Объект, КартинкаСостоянияДокумента, СостояниеДокумента, РазрешеноПроведение);

	БезНДС = НСтр("ru = 'Без НДС'");
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		УстановитьДоступностьЦенаВключаетНДС();
		Объект.ДатаПродажиЖелаемая = НачалоДня(ТекущаяДатаСеанса());
	КонецЕсли;
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
	УстановитьТекущуюСтраницуСуммПодвала();
	ПараметрыСобытийПО = Новый Структура;
	ПараметрыСобытийПО.Вставить("РегистрацияНовойКарты", Истина);
	
	СкидкиНаценкиСерверПереопределяемый.ОбновитьОтображениеСкидки(Объект);
	БонусныеБаллыСервер.ОбновитьОтображениеОплатаБонуснымиБаллами(Объект);
	
	ЯвляетсяСуперВайзером = ЗаказыПокупателейСервер.ЯвляетсяСуперВайзеромКоллЦентра(ПараметрыСеанса.ТекущийПользователь);
	СотрудникКЦ = ЗаказыПокупателейСервер.ЯвляетсяСотрудникомКоллЦентра(ПараметрыСеанса.ТекущийПользователь).СотрудникКоллЦентра;
	ЯвляетсяСотрудникомКЦ = Не (СотрудникКЦ = Справочники.СотрудникиКоллЦентра.ПустаяСсылка());
	
	Если (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Новый) Тогда 
			
		Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.ВРаботе;
		Если ЯвляетсяСотрудникомКЦ Тогда
			Объект.Ответственный = СотрудникКЦ.Владелец;
		КонецЕсли;

	КонецЕсли;
	ДокументСотрудникаКЦ = (СотрудникКЦ.Владелец = Объект.Ответственный);
	УстановитьДоступностьЭлементовПоСтатусуСервер();
	
	//НастроитьФормуПоДополнительнымПравам();

	ИспользоватьПричиныОтменыЗаказовПокупателей = ПолучитьФункциональнуюОпцию("ИспользоватьПричиныОтменыЗаказовПокупателей"); 
	ИспользоватьАвтоматическиеСкидкиВПродажах	= ПолучитьФункциональнуюОпцию("ИспользоватьАвтоматическиеСкидкиВПродажах");

	Элементы.ТоварыГруппаОтмена.Видимость                        = ИспользоватьПричиныОтменыЗаказовПокупателей;
	Элементы.ТоварыОтмененоПричиныОтменыНеИспользуются.Видимость = НЕ ИспользоватьПричиныОтменыЗаказовПокупателей;

	Элементы.СтатусИМ.Доступность = ТехническаяПоддержкаВызовСервера.ОтладочныйРежимРаботы();	//	LNK 14.04.2022 07:39:09
	
	//Если НЕ РозничныеПродажиСерверПовтИсп.ЭтоУзелИнтернетМагазина() Тогда	//	LNK 20.11.2020 06:55:17
	Если ложь Тогда	//	LNK 20.11.2020 06:55:17

		//Криворучко
		Если (Объект.СтатусОплаты = Перечисления.СтатусОплаты.Оплачен) или (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Закрыт) Тогда
			Если НЕ ТехническаяПоддержкаВызовСервера.ИсключительныйРежим() = Истина Тогда
				
				Модифицированность = Ложь;

				ТолькоПросмотр = Истина;	
				
			КонецЕсли;
		КонецЕсли;

	Иначе
		
		Если ЯвляетсяСотрудникомКЦ Тогда  

			ТолькоПросмотр = Ложь;	
			Элементы.СуммаДоставкиОплачена.ТолькоПросмотр = Ложь;

		КонецЕсли;
	КонецЕсли;
	ЗаполнитьТелефонКлиента();   
	//Если Объект.Имя = "" или Объект.Фамилия = "" тогда
	//	ЗаполнитьФИОКлиента();	 
	//КонецЕсли;
	СписокКомментариев.Параметры.УстановитьЗначениеПараметра("ЗаказПокупателя", Объект.Ссылка);

	УправлениеДоступомРТ.ПриСозданииФормыНаСервере(ЭтотОбъект);	//	LNK 17.10.2019 14:30:01

	УстановитьОформлениеЭлементов(ЭтотОбъект);	//	LNK 03.02.2021 08:55:34
	ПрверитьВидимостьДоставкиИПолучателя();
	УстановитьЗначенияПоУмолчанию();
	ЗаполнитьСтатусДляВыбора(); 
	ЗаполнитьМагазиныДляВыбора(); 
	КонтрагентПриИзмененииНаСервере();
	
	Если ((Не (Объект.УчетнаяСистема = Перечисления.УчетныеСистемыКомпании.Розница 
			Или Объект.УчетнаяСистема = Перечисления.УчетныеСистемыКомпании.ПустаяСсылка()))
			И Не ТехническаяПоддержкаВызовСервера.ИсключительныйРежим())
			Или Не ОбменДаннымиПовтИсп.ЭтоГлавныйУзел() Тогда 
		
		ТолькоПросмотр = Истина; 
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ОтменитьПромоКод(Команда)

	Если Не Элементы.ПогашениеСкидочныхКупонов.ТекущиеДанные = Неопределено Тогда
		
		ОтменитьПромоКодНаСервере();
		Объект.ПогашениеСкидочныхКупонов.Удалить(Элементы.ПогашениеСкидочныхКупонов.ТекущиеДанные);
		ПересчитатьИлиОтменитьСкидки();
		Модифицированность = Истина;

	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура ОтменитьПромоКодНаСервере()

	ДокОбъект = РеквизитФормыВЗначение("Объект");
	ДокОбъект.ОтразитьДвиженияСерийныхНомеровКупонов(Объект.ПогашениеСкидочныхКупонов.Выгрузить(), Истина);

КонецПроцедуры

&НаСервере
Процедура УстановитьЗначенияПоУмолчанию()
	Если Не ЗначениеЗаполнено(Объект.Город) тогда
		Объект.Город = Справочники.ГородаДоставки.ПустаяСсылка();	
	КонецЕсли;	
	Если Не ЗначениеЗаполнено(Объект.Отделение) тогда
		Объект.Отделение = Справочники.Отделения.ПустаяСсылка();	
	КонецЕсли;	
	Если Не ЗначениеЗаполнено(Объект.Улица) тогда
		Объект.Улица = Справочники.Улицы.ПустаяСсылка();	
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ) 
	
	Элементы.ТоварыХарактеристика.Видимость = Ложь;
	Элементы.ТоварыВыгрузитьДанныеВТСД.Видимость = Ложь;
	Элементы.ТоварыЗагрузитьДанныеИзТСД.Видимость = Ложь;
	Элементы.ТоварыПоискПоМагнитномуКоду.Видимость = Ложь;
	Элементы.ГруппаРезерв.Видимость = Ложь;
	Элементы.НеПерезванивать.Видимость = Объект.НеПерезванивать;

	Элементы.Комментарий.Видимость = Не ПустаяСтрока(Объект.Комментарий);
	
	УстановитьТипПоУмолчанию();
	
	Если Объект.УчетнаяСистема = ПредопределенноеЗначение("Перечисление.УчетныеСистемыКомпании.Розница") Тогда
		
		Элементы.ТипДоставки.РежимВыбораИзСписка = Истина;
		
	КонецЕсли;
	
	УстановкаТипаДоставки();
	ОтобразитьРасчетныеКолонки(Истина);
	ПодключитьОбработчикОжидания("Подключаемая_ОтобразитьРасчетныеКолонки", 60); 
	ВидимостьЭлементов();

КонецПроцедуры

&НаКлиенте
Процедура ГородОчистка(Элемент, СтандартнаяОбработка)

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.ГородаДоставки")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Город.ОграничениеТипа = НашеОписание;  

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.Отделения")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Отделение.ОграничениеТипа = НашеОписание;  

КонецПроцедуры

&НаКлиенте
Процедура Город2Очистка(Элемент, СтандартнаяОбработка)

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.ГородаДоставки")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Город2.ОграничениеТипа = НашеОписание;  

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.Улицы")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Улица.ОграничениеТипа = НашеОписание;  

КонецПроцедуры

 

&НаКлиенте
Процедура УстановитьТипПоУмолчанию()
	
	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.ГородаДоставки")); 
	НашеОписание = Новый ОписаниеТипов(Массив);

	Если НЕ ЗначениеЗаполнено(Объект.Город) тогда
		Элементы.Город.ОграничениеТипа = НашеОписание;    
		Элементы.Город2.ОграничениеТипа = НашеОписание;
	КонецЕсли;

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.Улицы")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Если НЕ ЗначениеЗаполнено(Объект.Улица) тогда
		Элементы.Улица.ОграничениеТипа = НашеОписание; 
	КонецЕсли;
	
	ВыборТипаОтделения = Ложь;
	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.Отделения")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Если НЕ ЗначениеЗаполнено(Объект.Отделение) тогда
		Элементы.Отделение.ОграничениеТипа = НашеОписание;  
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура СброситьТипОтделения()

	ВыборТипаОтделения = Истина;
	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.Отделения")); 
	Массив.Добавить(Тип("СправочникСсылка.Почтоматы")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Отделение.ОграничениеТипа = НашеОписание;  
	
КонецПроцедуры

&НаКлиенте
Процедура ОтделениеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Если НЕ ЗначениеЗаполнено(Объект.Отделение) И ВыборТипаОтделения Тогда
		СтандартнаяОбработка = ЛОЖЬ;
		сзТипы = Новый СписокЗначений();
		сзТипы.Добавить(0,"Отделения");
		сзТипы.Добавить(1,"Почтоматы");
		ооВыборЗначенияТипа = Новый ОписаниеОповещения("ВыборЗначенияТипа",ЭтотОбъект);
		сзТипы.ПоказатьВыборЭлемента(
			ооВыборЗначенияТипа,	//Вызов процедуры оповещения
			"Выберите справочник",	//Заголовок диалогового окна выбора типа
			сзТипы[1]				//Первоначально позиционирование на значение выбора
			);
		ВыборТипаОтделения = ЛОЖЬ;
	КонецЕсли;		
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборЗначенияТипа(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда Возврат КонецЕсли;
	
	Если Результат.Значение = 0 Тогда	
		Элементы.Отделение.ОграничениеТипа = Новый ОписаниеТипов("СправочникСсылка.Отделения");
	ИначеЕсли Результат.Значение = 1 Тогда
		Элементы.Отделение.ОграничениеТипа = Новый ОписаниеТипов("СправочникСсылка.Почтоматы");
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура ОтделениеОчистка(Элемент, СтандартнаяОбработка)
	
	СброситьТипОтделения();
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	// +HVOYA. 2016-09-07 Юлия_Ж
	// ПодключаемоеОборудование
	//МенеджерОборудованияКлиент.НачатьОтключениеОборудованиеПриЗакрытииФормы(Неопределено, ЭтотОбъект);
	// Конец ПодключаемоеОборудование
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	
	Если ИсточникВыбора.ИмяФормы = "Обработка.ПодборТоваров.Форма.Форма" Тогда	
		
		СтрокиИзменены = ОбработкаВыбораПодборНаСервере(ВыбранноеЗначение, ИсточникВыбора.ИмяТабличнойЧасти);
		Если СтрокиИзменены Тогда
			ПересчитатьИлиОтменитьСкидки();
		КонецЕсли;
		
	КонецЕсли;
	
	Если Окно <> Неопределено Тогда
		
		Окно.Активизировать();
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ВнешнееСобытие(Источник, Событие, Данные)
// +HVOYA. 2016-09-07 Юлия_Ж	
	//Если ВводДоступен() И ВозможностьВводаПоШК() Тогда
	//	ПодключаемоеОборудованиеРТКлиент.ВнешнееСобытиеОборудования(ЭтотОбъект, Источник, Событие, Данные);
	//КонецЕсли;
// -HVOYA. 2016-09-07 Юлия_Ж	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	СтруктураДляПоиска = Новый Структура("Номенклатура", Справочники.Номенклатура.ПустаяСсылка());
	ТабличнаяЧастьДок = Объект.Товары;
	МассивПустыхСтрок = ТабличнаяЧастьДок.НайтиСтроки(СтруктураДляПоиска);
	Для Каждого Строка Из МассивПустыхСтрок Цикл
		ТабличнаяЧастьДок.Удалить(Строка);
	КонецЦикла; 

	ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьТипНоменклатурыВТЧСервер(Объект.Товары);
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
	
	ЗаполнитьИзРегистраОплаты();

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);

	УстановитьТекущуюСтраницуСуммПодвала();
	
	ОбщегоНазначенияРТКлиентСервер.ОбновитьСостояниеДокумента(Объект, СостояниеДокумента, КартинкаСостоянияДокумента, РазрешеноПроведение);
	ПродажиСервер.ОбновитьСостояниеЗаказа(Объект.Ссылка, СостояниеЗаказа);
	
	УстановитьДоступностьЦенаВключаетНДС();
	
	УстановитьДоступностьЭлементовПоСтатусуСервер();

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьИзРегистраОплаты()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ОплатаЗаказаКлиента.ЗаказКлиента,
		|	ОплатаЗаказаКлиента.НомерОплаты КАК НомерОплаты,
		|	ОплатаЗаказаКлиента.ТипОплаты,
		|	ОплатаЗаказаКлиента.Сумма,
		|	ОплатаЗаказаКлиента.СтатусОплаты,
		|	ОплатаЗаказаКлиента.Отменён,
		|	ОплатаЗаказаКлиента.ВидОплаты,
		|	ОплатаЗаказаКлиента.ДатаОплаты,
		|	ОплатаЗаказаКлиента.ДатаСоздания,
		|	ОплатаЗаказаКлиента.ИДОплаты
		|ИЗ
		|	РегистрСведений.ОплатаЗаказаКлиента КАК ОплатаЗаказаКлиента
		|ГДЕ
		|	ОплатаЗаказаКлиента.ЗаказКлиента = &ЗаказКлиента
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерОплаты";
	
	Запрос.УстановитьПараметр("ЗаказКлиента", Объект.Ссылка);
	
	Объект.ОплатаЗаказа.Загрузить(Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если Не Объект.СуммаБонусныхБалловСписано = Объект.Товары.Итог("СуммаБонусныхБалловСписано") Тогда
		
		Отказ = Истина;
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			"Нужно повторно распределить списанные бонусы",
				ЭтотОбъект,
				,
				,
				Отказ
				);
	КонецЕсли;
	
	Если ПараметрыЗаписи.Свойство("РежимЗаписи")
			И ПараметрыЗаписи.РежимЗаписи = ПредопределенноеЗначение("РежимЗаписиДокумента.Запись")
			И Объект.УчетнаяСистема = ПредопределенноеЗначение("Перечисление.УчетныеСистемыКомпании.Розница")
			И Не (Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовПокупателей.Новый")
				Или Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовПокупателей.ВРаботе")
				Или Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовПокупателей.Отменён")) Тогда
		
		Отказ = Истина;
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			"Записывать документ в таком статусе запрещено!!!",
				ЭтотОбъект,
				,
				,
				Отказ
				);
	КонецЕсли;
	
	ПередЗаписьюКлиент(Отказ, ПараметрыЗаписи);

КонецПроцедуры 

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакИспользованияХарактеристик(Объект.Товары);
	//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакИспользованияХарактеристик(Объект.Подарки);
	ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьТипНоменклатурыВТЧСервер(Объект.Товары);
	//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакЕстьПродажиПоСтроке(Объект.Ссылка, Объект.Товары);
	//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьДоговорПлатежногоАгентаВТЧСервер(Объект.Товары);
	// -HVOYA. 2016-09-07 Юлия_Ж
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	УстановитьТекущуюСтраницуСуммПодвала();
	
	СкидкиНаценкиСерверПереопределяемый.ОбновитьОтображениеСкидки(Объект);
	БонусныеБаллыСервер.ОбновитьОтображениеОплатаБонуснымиБаллами(Объект);

	ПродажиСервер.ОбновитьСостояниеЗаказа(Объект.Ссылка, СостояниеЗаказа);
	
	УстановитьДоступностьЭлементовПоСтатусуСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	Оповестить("ЗакрытиеИнтернетЗаказа"); 
	ОбщегоНазначенияРТКлиентСервер.ОбновитьСостояниеДокумента(Объект, СостояниеДокумента, КартинкаСостоянияДокумента, РазрешеноПроведение);
	
	ЗаполненостьСтрок = ПроверкаСтрок();
	
	Если Не ПустаяСтрока(ЗаполненостьСтрок.ТекстВопроса) Тогда
		
		ЗаполненостьСтрок.ПараметрыЗаписи = ПараметрыЗаписи; 

		ОписаниеОповещения = Новый ОписаниеОповещения("ИзменитьСтатусДокументаЗавершение", ЭтотОбъект, ЗаполненостьСтрок);

		ПоказатьВопрос(ОписаниеОповещения
			, ЗаполненостьСтрок.ТекстВопроса
			, РежимДиалогаВопрос.ОКОтмена
			, 60
			, КодВозвратаДиалога.ОК
			, "Изменение статуса документа"
			, КодВозвратаДиалога.Отмена
		);
	
	КонецЕсли; 
	
	ОтобразитьРасчетныеКолонки(Истина);
	УстановкаТипаДоставки();
	
КонецПроцедуры 


&НаСервере
Процедура ПередЗагрузкойДанныхИзНастроекНаСервере(Настройки)
	СкрыватьОтмененныеСтроки = Настройки.Получить("СкрыватьОтмененныеСтроки");
	
	Если СкрыватьОтмененныеСтроки Тогда
		Элементы.Товары.ОтборСтрок = Новый ФиксированнаяСтруктура("Отменено", Ложь);
	Иначе
		Элементы.Товары.ОтборСтрок = Неопределено;
	КонецЕсли;
	
	Элементы.ТоварыСкрыватьОтмененныеСтроки.Пометка = СкрыватьОтмененныеСтроки;
КонецПроцедуры

&НаКлиенте	
Процедура ИзменитьСтатусДокументаЗавершение(КодВозврата, ДополнительныеПараметры)	Экспорт

	Если КодВозврата = КодВозвратаДиалога.ОК Тогда
		
		Если ДополнительныеПараметры.ВсеОтменены Тогда 
			
			Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовПокупателей.Отменён");
			
		ИначеЕсли ДополнительныеПараметры.СтрокиЗаполнены Тогда 
			
			Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовПокупателей.ЗапросДоступности");
			
		КонецЕсли;
		
		Записать(ДополнительныеПараметры.ПараметрыЗаписи);
		
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	ДатаДокументаИзмененаВручную = Истина;
	
	Если НачалоДня(Объект.Дата) > НачалоДня(Объект.ДатаПродажиЖелаемая) Тогда
		Объект.ДатаПродажиЖелаемая = НачалоДня(Объект.Дата)
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СкладПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.Склад) Тогда
		ПриИзмененииСкладСервер();
		ПересчитатьИлиОтменитьСкидки();
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СтатусПриИзменении(Элемент)
	
	УстановкаТипаДоставки();
	ИспользоватьАссортимент = ПолучитьФункциональнуюОпциюКонтроляАссортимента();
	УстановитьДоступностьЭлементовПоСтатусуСервер();
	ЗаполнитьСтатусДляВыбора();
	
КонецПроцедуры

&НаКлиенте
Процедура МагазинПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.Магазин) Тогда
		ПриИзмененииМагазинСервер();
		ПересчитатьИлиОтменитьСкидки();
	КонецЕсли;
	
	УстановитьДоступностьЭлементов();
	
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	
	ПересчетНДСТабличнойЧастиСервер();
	ПересчитатьИлиОтменитьСкидки();
	
КонецПроцедуры

&НаКлиенте
Процедура ДисконтнаяКартаПриИзменении(Элемент)
	
	ПриИзмененииДисконтнаяКартаСервер();
	ПересчитатьИлиОтменитьСкидки();
	ЗаполнитьТелефонКлиента();
	ЗаполнитьФИОКлиента();	
КонецПроцедуры

&НаКлиенте
Процедура УчитыватьНДСПриИзменении(Элемент)
	
	ПриИзмененииУчитыватьНДССервер();
	ПересчитатьИлиОтменитьСкидки();
	
КонецПроцедуры

&НаКлиенте
Процедура ЦенаВключаетНДСПриИзменении(Элемент)
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВТЧ(Объект));
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, , СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыПодвала(Объект.Товары, Объект.ЦенаВключаетНДС, СуммаВсего);
	ПересчитатьИлиОтменитьСкидки();
		
КонецПроцедуры

&НаКлиенте
Процедура КомментарийПриИзменении(Элемент)
	ПодключитьОбработчикОжидания("Подключаемый_УстановитьКартинкуДляКомментария", 0.5, Истина);
КонецПроцедуры

&НаКлиенте	//	LNK 03.02.2021 08:49:41
Процедура СуммаДоставкиОплаченаПриИзменении(Элемент)

	УстановитьОформлениеЭлементов(ЭтотОбъект);

КонецПроцедуры

&НаКлиенте
Процедура ОтветственныйНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	ИзмененОтветственный = Истина;
	
	СтандартнаяОбработка = Ложь;
	
	//ПараметрыФормы = Новый Структура;
	//ПараметрыФормы.Вставить("РежимВыбора", Истина);
	//ПараметрыФормы.Вставить("ТекущаяСтрока", ?(
	//	Объект.Ответственный.Пустая(),
	//	Неопределено,
	//	Объект.Ответственный));
	
	//
	//ПараметрыФормы.Вставить("ЗакрыватьПриВыборе", Истина);
	//ПараметрыФормы.Вставить("МножественныйВыбор", Ложь);
	//ПараметрыФормы.Вставить("ОтборСотрудниковКЦ", Истина);
	//
	//
	//ОткрытьФорму("Справочник.Пользователи.ФормаВыбора", ПараметрыФормы, Элемент); 
	
	ДанныеВыбора = Новый СписокЗначений;
	ЗаказыПокупателейСервер.ВыборСотрудникаКЦ(ДанныеВыбора, Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтветственныйОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Объект.Ответственный = ВыбранноеЗначение;
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	
	КонтрагентПриИзмененииНаСервере();
	ПересчитатьИлиОтменитьСкидки();
	ЗаполнитьТелефонКлиента();
	ЗаполнитьФИОКлиента();
		
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	Оповещение = Новый ОписаниеОповещения("КонтрагентЗавершениеВыбора", ЭтотОбъект);
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("НомерТелефона", НомерТелефонаКлиента);
	ПараметрыФормы.Вставить("Контрагент", Объект.Контрагент);
	//ПараметрыФормы.Вставить("ЗакрыватьПриВыборе", Истина);
	//ПараметрыФормы.Вставить("МножественныйВыбор", Ложь);
	
	ОткрытьФорму("Справочник.Контрагенты.Форма.ФормаВыбораДляИМ", ПараметрыФормы, Элемент,,,, Оповещение);
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентОткрытие(Элемент, СтандартнаяОбработка) 
	Если Не ПустаяСтрока(НомерТелефонаКлиента) Тогда 
		СтандартнаяОбработка = Ложь;
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("ОткрытиеКонтрагенте", Истина); 
		
		Оповещение = Новый ОписаниеОповещения("КонтрагентЗавершениеВыбора", ЭтотОбъект, ДополнительныеПараметры);
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("НомерТелефона", НомерТелефонаКлиента);
		ПараметрыФормы.Вставить("ПросмотрКлиента", Истина);
		ПараметрыФормы.Вставить("Контрагент", Объект.Контрагент);
		//ПараметрыФормы.Вставить("МножественныйВыбор", Ложь);
		
		ОткрытьФорму("Справочник.Контрагенты.Форма.ФормаВыбораДляИМ", ПараметрыФормы, Элемент,,,, Оповещение); 
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентЗавершениеВыбора(Результат, ДополнительныеПараметры) Экспорт 
	
	Если Не ТипЗнч(ДополнительныеПараметры) = Тип("Структура") Тогда
		Если ТипЗнч(Результат) = Тип("Структура") Тогда
			Если Не Результат.ОтменаВыбора Тогда
				
				Объект.Контрагент = Результат.Контрагент;
				КонтрагентПриИзмененииНаСервере();
				ПересчитатьИлиОтменитьСкидки();
				ОбновитьОтображениеДанных();
				Элементы.Контрагент.ОбновитьТекстРедактирования();
				ВидимостьЭлементов();
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область ПрограммныйИнтерфейс

&НаСервере
Функция ПроверкаСтрок()
	Возврат Документы.ЗаказПокупателя.ЗаполненостьВсехСтрок(Объект);
КонецФункции

&НаКлиенте
Процедура НазначитьАвтоматическиеСкидкиЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		
		УправляемыеСкидки = Результат;
		
		СтруктураПараметры = Новый Структура;
		СтруктураПараметры.Вставить("ПрименятьКОбъекту",                Истина);
		СтруктураПараметры.Вставить("ТолькоПредварительныйРасчет",      Ложь);
		СтруктураПараметры.Вставить("ВосстанавливатьУправляемыеСкидки", Ложь);
		СтруктураПараметры.Вставить("УправляемыеСкидки",                УправляемыеСкидки);
		СтруктураПараметры.Вставить("ТолькоСообщенияПослеОформления",   Ложь);
		
		Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда // Проверка на определенность рабочего места ВО.
			РабочееМесто = МенеджерОборудованияКлиентПовтИсп.ПолучитьРабочееМестоКлиента();
		Иначе
			РабочееМесто = ""
		КонецЕсли;
		
		СтруктураПараметры.Вставить("РабочееМесто", РабочееМесто);
		
		Объект.Дата = ОбщегоНазначенияКлиент.ДатаСеанса();
		
		РассчитатьСкидкиНаценкиНаСервере(СтруктураПараметры);

		ОбновитьИтоговыеПоказатели(ЭтотОбъект);
		
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Скидки (наценки)'"),
			,
			НСтр("ru = 'Скидки (наценки) рассчитаны'"),
			БиблиотекаКартинок.Информация32
		);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НазначитьРучнуюСкидкуЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		
		НазначитьРучнуюСкидкуНаСервере(Результат);
		СкидкиНаценкиКлиент.ОповеститьОбОкончанииНазначенияРучныхСкидокНаценок(Результат, "RUB");
		ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

		ОбновитьИтоговыеПоказатели(ЭтотОбъект);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеВопросРассчитатьИОткрытьСкидки(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	//Если РезультатВопроса = КодВозвратаДиалога.Да Тогда
	//	ЭтотОбъект.Модифицированность = Истина;
	//	РассчитатьСкидкиНаценкиКлиент();
	//	ОткрытьИнформациюОСкидкахЗавершитьОбработкуВопроса();
	//КонецЕсли;
	//
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеВыдатьПодаркиНаВыбор(Результат = Неопределено, ДополнительныеПараметры = Неопределено) Экспорт
	
	Если Результат <> Неопределено Тогда
		ВыдатьПодаркиНаВыборНаСервере(Результат, ДополнительныеПараметры);
	КонецЕсли;

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Скидки (наценки)'"),
		?(Объект.Ссылка.Пустая(), "", ПолучитьНавигационнуюСсылку(Объект.Ссылка)),
		НСтр("ru = 'Скидки (наценки) рассчитаны'"),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеОткрытьФормуВыбораВидаЦены(РезультатОткрытияФормы, ДополнительныеПараметры) Экспорт
	Если ЗначениеЗаполнено(РезультатОткрытияФормы) Тогда
		
		ЦеныРассчитаны = ЗаполнитьЦеныВыделенныхСтрокПоВидуЦенСервер(РезультатОткрытияФормы);
		ЗапасыКлиент.ОповеститьОбОкончанииЗаполненияЦенПоВидуЦен(ЦеныРассчитаны, РезультатОткрытияФормы);
		ПересчитатьИлиОтменитьСкидки();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеОткрытьФормуОтменыВыделенныхСтрок(РезультатОткрытияФормы, ДополнительныеПараметры) Экспорт
	Если ЗначениеЗаполнено(РезультатОткрытияФормы) Тогда
		
		ПричинаОтмены = РезультатОткрытияФормы;
		ЗавершитьОтменуВыделенныхСтрок();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеОткрытьФормуОтменыВыделенныхНеЗарезервированныхСтрок(РезультатОткрытияФормы, ДополнительныеПараметры) Экспорт
	Если ЗначениеЗаполнено(РезультатОткрытияФормы) Тогда
		
		ПричинаОтмены = РезультатОткрытияФормы;
		ЗавершитьОтменуВыделенныхНеЗарезервированныхСтрок();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеОткрытьФормуОтменыНепроданныхТоваров(РезультатОткрытияФормы, ДополнительныеПараметры) Экспорт
	Если ЗначениеЗаполнено(РезультатОткрытияФормы) Тогда
		
		ПричинаОтмены = РезультатОткрытияФормы;
		ЗавершитьОтменуНепроданныхТоваров();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеРазбитьСтроку(Количество, ДополнительныеПараметры) Экспорт
	
	НоваяСтрока = ДополнительныеПараметры.НоваяСтрока;
	Если НоваяСтрока = Неопределено Тогда
		ОбработкаТабличнойЧастиТоварыКлиент.РазбитьСтрокуТЧПроверитьЧисло(Количество, ДополнительныеПараметры);
	КонецЕсли;
	
	НоваяСтрока = ДополнительныеПараметры.НоваяСтрока;
	Если НЕ НоваяСтрока = Неопределено Тогда
		ТекущаяСтрока              = ДополнительныеПараметры.ТекущаяСтрока;
		НоваяСтрока.КодСтроки = 0;
		
		СтруктураДействий = Новый Структура;
		ДобавитьВСтруктуруДействияПриИзмененииКоличестваУпаковок(СтруктураДействий,Объект);
		
		ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
		ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, НоваяСтрока, СтруктураДействий, КэшированныеЗначения);
		
		ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);
		ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(НоваяСтрока, Объект.ЦенаВключаетНДС);
		ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыПодвала(Объект.Товары, Объект.ЦенаВключаетНДС, СуммаВсего);
		
		ПересчитатьИлиОтменитьСкидки();
		
	КонецЕсли;
	
КонецПроцедуры

#Область ОбработчикиСобытийПодключаемогоОборудования

&НаКлиенте
Процедура ОповещениеПоискаПоШтрихкоду(Штрихкод, ДополнительныеПараметры) Экспорт
	
	//Если НЕ ПустаяСтрока(Штрихкод) Тогда
	//	СтруктураПараметровКлиента = ПолученШтрихкодИзСШК(Штрихкод);
	//	ОбработатьДанныеПоКодуКлиент(СтруктураПараметровКлиента);
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеПоискаПоМагнитномуКоду(ТекКод, ДополнительныеПараметры) Экспорт
	
	//Если Не ПустаяСтрока(ТекКод) Тогда
	//	СтруктураПараметровКлиента = ПолученМагнитныйКод(ТекКод);
	//	ОбработатьДанныеПоКодуКлиент(СтруктураПараметровКлиента);
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОповещениеОткрытьФормуВыбораДанныхПоиска(Результат, ДополнительныеПараметры) Экспорт
	
	//Если Результат <> Неопределено Тогда
	//	ОбработатьДанныеПоКодуСервер(Результат);
	//	ОбработатьДанныеПоКодуКлиент(Результат)
	//КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПолученМагнитныйКод(МагнитныйКод) Экспорт 
	
	//СтруктураРезультат = ПодключаемоеОборудованиеРТВызовСервера.ПолученМагнитныйКод(МагнитныйКод, ЭтотОбъект);
	//Возврат СтруктураРезультат;
	
КонецФункции

&НаСервере
Функция ПолученШтрихкодИзСШК(Штрихкод) 
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверкаВесовыхТоваров");
	СтруктураДействий.Вставить("ПроверкаТоваров");
	СтруктураДействий.Вставить("ПроверкаСерийныхНомеров");
	
	СтруктураПараметровДействия = Новый Структура;
	СтруктураПараметровДействия.Вставить("РегистрацияНовойКарты", Истина);
	СтруктураДействий.Вставить("ПроверкаКарт", СтруктураПараметровДействия);
	
	Возврат ПодключаемоеОборудованиеРТ.ПолученШтрихкодИзСШК(Штрихкод, ЭтотОбъект, СтруктураДействий);
	
КонецФункции

&НаКлиенте
Процедура ОбработатьДанныеПоКодуКлиент(СтруктураПараметровКлиента, ТекКод) Экспорт

	Если СтруктураПараметровКлиента.Свойство("НеизвестныеДанныеПО") 
		И СтруктураПараметровКлиента.НеизвестныеДанныеПО Тогда
		
		СтрокаСообщения = НСтр("ru = 'Данные по коду не найдены: %1%'");
		СтрокаСообщения = СтрЗаменить(СтрокаСообщения, "%1%", ТекКод);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрокаСообщения);
		
	ИначеЕсли СтруктураПараметровКлиента.Свойство("ТекстПредупреждения") Тогда
		
		ПоказатьПредупреждение(, СтруктураПараметровКлиента.ТекстПредупреждения);
		
	ИначеЕсли СтруктураПараметровКлиента.Свойство("РегистрацияНовойКарты") Тогда
		
		Если ИнформационныеКартыКлиент.ПолучитьРазрешениеПользователяНаСозданиеКарты(СтруктураПараметровКлиента.ТекстВопросаНовойКарты) Тогда
			
			ИнформационнаяКарта = ИнформационныеКарты.СоздатьДисконтнуюКарту(СтруктураПараметровКлиента.РегистрацияНовойКарты);
			ИнформационныеКартыКлиент.ОповеститьОСозданииНовойКарты(ИнформационнаяКарта); 
			
			Если ЗначениеЗаполнено(ИнформационнаяКарта) Тогда
				Объект.ДисконтнаяКарта = ИнформационнаяКарта;
				Модифицированность = Истина;
				ДисконтнаяКартаПриИзменении(Неопределено);
			КонецЕсли;
			
		КонецЕсли;
		
	ИначеЕсли СтруктураПараметровКлиента.Свойство("ПерейтиНаТоваронуюПозицию") Тогда
		
		ТоварДляПоиска = СтруктураПараметровКлиента.ПерейтиНаТоваронуюПозицию.Номенклатура;
		
		НайденнаяСтрока = Объект.Товары.НайтиСтроки(Новый Структура("Номенклатура", ТоварДляПоиска));
		
		Элементы.Товары.ТекущаяСтрока = НайденнаяСтрока[0].ПолучитьИдентификатор();
	//	
	//	Если ИнформационныеКартыКлиент.ПолучитьРазрешениеПользователяНаСозданиеКарты(СтруктураПараметровКлиента.ТекстВопросаНовойКарты) Тогда
	//		
	//		ВыбранноеЗначение = ОткрытьФормуМодально("РегистрСведений.ШаблоныРегистрацииНовыхКарт.Форма.ШаблоныНовыхКарт", Новый Структура("АдресШаблоновВХранилище", СтруктураПараметровКлиента.РегистрацияНовойКартыВыборШаблона), ЭтотОбъект);
	//		Если ВыбранноеЗначение <> Неопределено Тогда
	//		
	//			ИнформационнаяКарта = ДобавитьНайденныеИнформационныеКарты(ВыбранноеЗначение, СтруктураПараметровКлиента.РегистрацияНовойКартыВыборШаблона);
	//			ИнформационныеКартыКлиент.ОповеститьОСозданииНовойКарты(ИнформационнаяКарта); 
	//			
	//			Если ЗначениеЗаполнено(ИнформационнаяКарта) Тогда
	//				Объект.ДисконтнаяКарта = ИнформационнаяКарта;
	//				Модифицированность = Истина;
	//				ДисконтнаяКартаПриИзменении(Неопределено);
	//			КонецЕсли;
	//			
	//		КонецЕсли;

	//	КонецЕсли;
		
	ИначеЕсли СтруктураПараметровКлиента.Свойство("ВыборТоваров") Тогда
		
		ВыбранноеЗначение = ОткрытьФормуМодально("ОбщаяФорма.ВыборНоменклатуры", Новый Структура("АдресТоваровВХранилище", СтруктураПараметровКлиента.ВыборТоваров));
		Если ВыбранноеЗначение <> Неопределено Тогда
			
			ДобавитьНайденныеПозицииТоваров(ВыбранноеЗначение);
			
		КонецЕсли;
		
	ИначеЕсли СтруктураПараметровКлиента.Свойство("ВыборКарт") Тогда
		
		ВыбранноеЗначение = ОткрытьФормуМодально("ОбщаяФорма.ВыборИнформационнойКарты", Новый Структура("АдресКартВХранилище", СтруктураПараметровКлиента.ВыборКарт));
		Если ВыбранноеЗначение <> Неопределено Тогда
			
			Объект.ДисконтнаяКарта = ВыбранноеЗначение.ИнформационнаяКарта;
			Если ЗначениеЗаполнено(Объект.ДисконтнаяКарта) Тогда
				ДисконтнаяКартаПриИзменении(Неопределено);
			КонецЕсли;
			
		КонецЕсли;
		
	ИначеЕсли СтруктураПараметровКлиента.Свойство("НайденаДисконтнаяКарта") Тогда
		
		Если ЗначениеЗаполнено(Объект.ДисконтнаяКарта) Тогда
			
			ДисконтнаяКартаПриИзменении(Неопределено);
			
		КонецЕсли;
		
	КонецЕсли;
	
	
КонецПроцедуры

&НаСервере
Функция ОбработатьДанныеИзТСДСервер(СтруктураПараметров) Экспорт
	
	//Результат = ПодключаемоеОборудованиеРТВызовСервера.ОбработатьДанныеПоНоменклатуреИзТСДСервер(ЭтотОбъект, СтруктураПараметров);
	//Возврат Результат;
	
КонецФункции

&НаСервере
Функция ДобавитьНайденныеПозицииТоваров(СтруктураПараметров) Экспорт 
	//
	//ДобавленаСтрока = Ложь;
	////ТекущаяСтрока = ПодключаемоеОборудованиеРТВызовСервера.ИнициализацияСтрокиТоваров(ЭтотОбъект, СтруктураПараметров, ДобавленаСтрока);
	//
	//СтруктураДействий = Новый Структура;
	//СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	//СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	//СтруктураДействий.Вставить("ПересчитатьСумму");
	//СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	//СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	//
	//Если ДобавленаСтрока Тогда
	//	СтруктураДействий.Вставить("ПроставитьПродавца", Объект.Продавец);
	//	СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи", ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруЗаполненияЦеныПродажиВСтрокеТЧ(Объект, Истина));
	//	СтруктураДействий.Вставить("ЗаполнитьСтавкуНДССкладВШапке", ОбработкаТабличнойЧастиТоварыКлиентСервер.СтруктураПараметровСтавкиНДССкладВШапке(Объект));
	//	Если ИспользоватьАссортимент Тогда
	//		СтруктураДействий.Вставить("ПроверитьАссортиментСтроки", АссортиментКлиентСервер.ПараметрыПроверкиАссортимента(Объект, Истина));
	//	КонецЕсли;
	//	СтруктураДействий.Вставить("ПроверитьЗапретРозничнойПродажи", СкидкиНаценкиКлиентСервер.ПараметрыПроверкиЗапретаРозничнойПродажи(Объект));
	//	СтруктураДействий.Вставить("ЗаполнитьТипНоменклатуры");
	//	СтруктураДействий.Вставить("ЗаполнитьДоговорПлатежногоАгента");
	//КонецЕсли;
	//
	//ИдентификаторСтроки = ПодключаемоеОборудованиеРТВызовСервера.ЗавершениеОбработкиСтрокиТоваров(ЭтотОбъект, ТекущаяСтрока, СтруктураДействий);
	//
	//Возврат ИдентификаторСтроки;
	
КонецФункции

&НаКлиенте
Функция ДобавитьНайденныеСерийныеНомера(СтруктураПараметров) 

	Если СтруктураПараметров.Свойство("Количество") Тогда 

			КоличествоУпаковок = СтруктураПараметров.Количество;

	Иначе	КоличествоУпаковок = 1;

	КонецЕсли;

	ДанныеКупона = ПолучитьДанныеКупона(СтруктураПараметров.Номенклатура, СтруктураПараметров.СерийныйНомер);

	Если ДанныеКупона.ЯвляетсяКупоном Тогда

		ПараметрыИнформации = ОбщегоНазначенияРТКлиентСервер.ПолучитьСтруктуруВыводимойВРМКИнформации();
		ПараметрыИнформации.ЗаголовокИнформации = "Ошибки подарочных сертификатов и скидочных купонов";

		Если ДанныеКупона.ИспользоватьСерийныеНомера Тогда

			СписокСтрок = Объект.ПогашениеСкидочныхКупонов.НайтиСтроки(Новый Структура("СерийныйНомер", СтруктураПараметров.СерийныйНомер));

			Если СписокСтрок.Количество() > 0 Тогда

				ПараметрыИнформации.ТекстИнформации = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Номер купона «%1» вже міститься в цьому заказі", СтруктураПараметров.СерийныйНомер);
				ОбщегоНазначенияРТКлиент.ОткрытьФормуИнформацииДляРМК(ПараметрыИнформации);

				Возврат Ложь;

			КонецЕсли;

		КонецЕсли;

		Для каждого СтрокаТовары Из Объект.Товары Цикл

			Если НЕ СтрокаТовары.ПричинаРучнойСкидки.Пустая() Тогда

				ПараметрыИнформации.ТекстИнформации =
					"Відмовлено! У заказі є ручна знижка, використання будь-яких знижок (і купонів) неприпустимо.";
				ОбщегоНазначенияРТКлиент.ОткрытьФормуИнформацииДляРМК(ПараметрыИнформации);

				Возврат Ложь;

			КонецЕсли;

		КонецЦикла;

		Если ДанныеКупона.НоминалКупона = 0 Тогда

			СписокСтрок = Объект.Товары.НайтиСтроки(Новый Структура("Номенклатура", СтруктураПараметров.Номенклатура));

			Если СписокСтрок.Количество() > 0 Тогда

				ПараметрыИнформации.ТекстИнформации = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Знижковий купон номенклатури «%1» може бути застосований у заказі один раз", СтруктураПараметров.Номенклатура);
				ОбщегоНазначенияРТКлиент.ОткрытьФормуИнформацииДляРМК(ПараметрыИнформации);

				Возврат Ложь;

			КонецЕсли;

			Если НЕ Объект.ПогашениеСкидочныхКупонов.Итог("НоминалКупона") = 0 Тогда

				ПараметрыИнформации.ТекстИнформации = 
					"Відмовлено! Для заказу вже вказані купони з номіналом, несумісні з поточним купоном.";
				ОбщегоНазначенияРТКлиент.ОткрытьФормуИнформацииДляРМК(ПараметрыИнформации);

				Возврат Ложь;

			КонецЕсли;

		Иначе

			Если НЕ ЗначениеЗаполнено(СтруктураПараметров.СерийныйНомер) Тогда

			//	.. а купона-то, собственно, и нет! Явная ошибка.
				ПараметрыИнформации.ТекстИнформации = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					"Немає ідентифікації купона знижок номенклатури «%1»" + ?(НаборПравИНастроек.ПродажиАктивированы, "'", ", маючого номінал «%2»")
						, СтруктураПараметров.Номенклатура
						, Формат(ДанныеКупона.НоминалКупона, "ЧДЦ=2; ЧН=0,00; ЧГ="));
				ОбщегоНазначенияРТКлиент.ОткрытьФормуИнформацииДляРМК(ПараметрыИнформации);

				Возврат Ложь;

			Иначе
				
			//	контроль во избежание повторного ввода купона.

				СписокСтрок = Объект.ПогашениеСкидочныхКупонов.НайтиСтроки(Новый Структура("СерийныйНомер", СтруктураПараметров.СерийныйНомер));

				Если СписокСтрок.Количество() > 0 Тогда

					ПараметрыИнформации.ТекстИнформации = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						"Знижковий купон «%1» може бути застосований у чеку один раз", СтруктураПараметров.СерийныйНомер);
					ОбщегоНазначенияРТКлиент.ОткрытьФормуИнформацииДляРМК(ПараметрыИнформации);

					Возврат Ложь;

				КонецЕсли;

				Если НЕ НаборПравИНастроек.ПродажиАктивированы Тогда	//	LNK 26.09.2019 10:56:09

					Если НЕ Объект.ПогашениеСкидочныхКупонов.Количество() = 0 И Объект.ПогашениеСкидочныхКупонов.Итог("НоминалКупона") = 0 Тогда

						ПараметрыИнформации.ТекстИнформации = 
							"Відмовлено! Для чека вже вказані купони без номіналу, несумісні з поточним купоном.";
						ОбщегоНазначенияРТКлиент.ОткрытьФормуИнформацииДляРМК(ПараметрыИнформации);

						Возврат Ложь;

					КонецЕсли;

				КонецЕсли;

			КонецЕсли;

		КонецЕсли;

	КонецЕсли;	// - HVOYA 21.11.2016 13:31:11, Латышев А.А. 

	Если ДанныеКупона.ЯвляетсяКупоном Тогда	// + HVOYA 21.11.2016 11:15:10, Латышев А.А.

		ДобавитьПогашениеСкидочныхКупонов(СтруктураПараметров.Номенклатура, СтруктураПараметров.СерийныйНомер, ДанныеКупона.НоминалКупона);

	КонецЕсли; 

	Объект.СкидкиРассчитаны = Ложь;
	
	Модифицированность = Истина;

	Возврат Истина;

КонецФункции

#КонецОбласти

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыТовары

&НаКлиенте
Процедура ТоварыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	ДанныеСтрокиПередИзменением = ОбработкаТабличнойЧастиТоварыКлиент.СкопироватьВСтруктуруЭлементКоллекции(ТекущаяСтрока, Объект.Товары);

	Если НоваяСтрока Тогда

		ТекущаяСтрока.КодСтроки = 0;

	КонецЕсли;
	
	Если Копирование Тогда
		
		ТекущаяСтрока.СуммаАвтоматическойСкидки   = 0;
		ТекущаяСтрока.ПроцентАвтоматическойСкидки = 0;

		ТекущаяСтрока.КлючСвязиБонусныхБаллов		= 0;
		ТекущаяСтрока.СуммаБонусныхБалловНачислено	= 0;
		ТекущаяСтрока.СуммаБонусныхБалловСписано	= 0;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;

	БонусныеБаллыКлиент.ТоварыПриОкончанииРедактирования(ТекущиеДанные, ДанныеСтрокиПередИзменением, Объект, ОтменаРедактирования);	//	LNK 04.07.2021 07:48:28

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);

	Если ПропуститьАвтоматическийРасчетСкидок Тогда

		ПропуститьАвтоматическийРасчетСкидок = Ложь;

	КонецЕсли;

КонецПроцедуры

&НаКлиенте	//	LNK 18.06.2021 13:50:46
Процедура ТоварыПередУдалением(Элемент, Отказ)
	
	Если Не Объект.Ссылка.Пустая() Тогда
		
		Отказ = Истина;
		
	КонецЕсли;

	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;

	Если НЕ ТекущиеДанные = Неопределено Тогда
		
		Если ТекущиеДанные.Номенклатура.Пустая()
				Или ТекущиеДанные.Цена = 0 Тогда
			
			Отказ = Ложь;
			
		КонецЕсли;

		БонусныеБаллыКлиент.ТоварыПередУдалением(ТекущиеДанные, Объект, Отказ);

	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ТоварыПослеУдаления(Элемент)

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	Цена = 0;
	УчетнаяПолитика = ОбщегоНазначенияРТ.ПолучитьУчетнуюПолитику();
	Магазин = УчетнаяПолитика.ИнтернетМагазин;
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если ВнешниеИсточникиПовтИсп.ИспользоватьЦеныCompetera(Магазин,ТекущаяДата()) тогда 
		Если ЗначениеЗаполнено(ТекущаяСтрока.Номенклатура) тогда 
		 	IDN = ОбщегоНазначения.ПолучитьЗначениеРеквизита(ТекущаяСтрока.Номенклатура,"IDN");
			Если ЗначениеЗаполнено(IDN) тогда 
				Цена = ПолучитьЦенуCompetera(IDN);
			КонецЕсли;
		КонецЕсли;	
	КонецЕсли;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьТипНоменклатуры");
	СтруктураДействий.Вставить("ПроверитьФлагРезервирования");
	СтруктураДействий.Вставить("ПроверитьХарактеристикуПоВладельцу"   , ТекущаяСтрока.Характеристика);
	СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ТекущаяСтрока.Упаковка);
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");

	Если Цена = 0 Тогда 
		СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруЗаполненияЦеныПродажиВСтрокеТЧ(Объект, Истина));
	Иначе

		ТекущаяСтрока.Цена = Цена;
		ТекущаяСтрока.ЦеныCompeteraОтвет = "На товар IDN " +IDN + "на дату " + Строка(ТекущаяДата()) + " получена цена от Competera " + Строка(Цена);

	КонецЕсли;	
	СтруктураПараметровСтавкиНДС = Новый Структура;
	СтруктураПараметровСтавкиНДС.Вставить("Дата"       , Объект.Дата);
	СтруктураПараметровСтавкиНДС.Вставить("Организация", Объект.Организация);
	СтруктураПараметровСтавкиНДС.Вставить("Склад"      , Объект.Склад);
	
	СтруктураДействий.Вставить("ЗаполнитьСтавкуНДССкладВШапке", СтруктураПараметровСтавкиНДС);
	
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПроставитьПродавца", Объект.Продавец);
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Истина));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	
	Если ИспользоватьАссортимент Тогда
		СтруктураДействий.Вставить("ПроверитьАссортиментСтроки", АссортиментКлиентСервер.ПараметрыПроверкиАссортимента(Объект, Истина));
	КонецЕсли;
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
	Если ПропуститьАвтоматическийРасчетСкидок Тогда
		ПропуститьАвтоматическийРасчетСкидок = Ложь;
	КонецЕсли;
	
	ОтобразитьРасчетныеКолонки();
	
КонецПроцедуры


&НаСервере
Функция ПолучитьЦенуCompetera(IDN)
	Возврат ВнешниеИсточникиЦенообразование.ПолучитьЦенуТовараCompeteraОтGraphQL(IDN);	
КонецФункции	
	
&НаКлиенте
Процедура ТоварыХарактеристикаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	
	СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи",ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруЗаполненияЦеныПродажиВСтрокеТЧ(Объект, Истина));
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС" , ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Истина));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыХарактеристикаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
// +HVOYA. 2016-09-07 Юлия_Ж	
	//ОбработкаТабличнойЧастиТоварыКлиент.ВыбратьХарактеристикуНоменклатуры(ЭтотОбъект, Элемент, СтандартнаяОбработка, Элементы.Товары.ТекущиеДанные);
// -HVOYA. 2016-09-07 Юлия_Ж	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыУпаковкаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	Если ТекущаяСтрока.Количество > 0 Тогда
		СтруктураДействий.Вставить("ПересчитатьЦенуЗаУпаковку", ТекущаяСтрока.Количество);
	Иначе
		СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи" , ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруЗаполненияЦеныПродажиВСтрокеТЧ(Объект, Истина));
	КонецЕсли;
	
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыУпаковкаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ОбработкаТабличнойЧастиТоварыКлиент.ВыбратьУпаковкуНоменклатуры(ДанныеВыбора, СтандартнаяОбработка, Элементы.Товары.ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоУпаковокПриИзменении(Элемент)
	
	ПриИзмененииТоварыКоличестваУпаковок();
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
			
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПроцентРучнойСкидкиПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьСуммуРучнойСкидки");
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаРучнойСкидкиПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьПроцентРучнойСкидки");
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать, ПересчитыватьСуммуСкидки", Ложь, Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьЦенуСкидкуПоСуммеВПродажах", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаЦеныСкидкиВПродажахВТЧ(Объект));
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС",  ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСтавкаНДСПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыОтмененоПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	Если Объект.Товары.Количество() = 1 Тогда
				
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'Скасувати рядок не можна. Треба відміните увесь заказ!';
			|		uk = 'Скасувати рядок не можна. Треба відміните увесь заказ!'"));
			
		ТекущаяСтрока.Отменено = Ложь;

	ИначеЕсли ((Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Смешаный")
				И Не ТекущаяСтрока.Самовывоз)
			Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.СлужбаДоставки"))
			И ПроверкаОтправкиТовара(ТекущаяСтрока.КлючСвязиЗапросаДоступности) Тогда
				
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'Скасувати рядок не можна. Товар надіслано клієнту!';
			|		uk = 'Скасувати рядок не можна. Товар надіслано клієнту!'"));
			
		ТекущаяСтрока.Отменено = Ложь;

	КонецЕсли;
	
	Если Не ТекущаяСтрока.Отменено Тогда
		ТекущаяСтрока.ПричинаОтмены = ПредопределенноеЗначение("Справочник.ПричиныОтменыЗаказовПокупателей.ПустаяСсылка");
		ТекущаяСтрока.Резервировать = Истина;
	Иначе
		ТекущаяСтрока.Резервировать = Ложь;
	КонецЕсли;

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
	Элементы.Товары.ТекущийЭлемент = Элементы.ТоварыПричинаОтмены;
	
КонецПроцедуры

&НаСервере
Функция ПроверкаОтправкиТовара(КлючСвязиЗапросаДоступности)
	
	Результат = Ложь;

	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ЭНТаблица.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказПокупателя.Товары КАК ЗПТаблицаТовары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗапросДоступностиТоваров.Товары КАК ЗДТТаблицаТовары
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭлектроннаяНакладная КАК ЭНТаблица
		|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СтатусыЭН.СрезПоследних КАК СтатусыЭНСрезПоследних
		|				ПО ЭНТаблица.Ссылка = СтатусыЭНСрезПоследних.ДокументРегистратор
		|			ПО (ЗДТТаблицаТовары.Ссылка = ЭНТаблица.ДокументОснование)
		|		ПО ЗПТаблицаТовары.Ссылка = ЗДТТаблицаТовары.Ссылка.ДокументОснование
		|		И ЗПТаблицаТовары.КлючСвязиЗапросаДоступности = ЗДТТаблицаТовары.КлючСвязи
		|		И НЕ (ЗДТТаблицаТовары.СтатусЗапроса = ЗНАЧЕНИЕ(Перечисление.СтатусыЗапросовДоступностиТоваров.Отменён)
		|		ИЛИ ЗДТТаблицаТовары.СтатусЗапроса = ЗНАЧЕНИЕ(Перечисление.СтатусыЗапросовДоступностиТоваров.Удалён))
		|ГДЕ
		|	ЗПТаблицаТовары.Ссылка = &Ссылка
		|	И ЗПТаблицаТовары.КлючСвязиЗапросаДоступности = &КлючСвязиЗапросаДоступности
		|	И НЕ СтатусыЭНСрезПоследних.СтатусЭН.СтатусПосылки = ЗНАЧЕНИЕ(Перечисление.СтатусыПосылокСлужбыДоставки.Отменена)";
	
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("КлючСвязиЗапросаДоступности", КлючСвязиЗапросаДоступности);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Если РегистрыСведений.СтатусыЭН.ПосылкаВДороге(Выборка.Ссылка) Тогда
			
			Результат = Истина;
			
		КонецЕсли;

	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ТоварыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка) 
	
	Если (Элемент.ТекущийЭлемент = Элементы.ТоварыПроцентАвтоматическойСкидки
		Или Элемент.ТекущийЭлемент = Элементы.ТоварыСуммаАвтоматическойСкидки) 
		И НЕ ТолькоПросмотр Тогда
		
		ОткрытьИнформациюОСкидкахКлиент()
		
	КонецЕсли;
	
	Если Элемент.ТекущийЭлемент = Элементы.ТоварыНоменклатураКод Тогда 
		Если ПодключитьРасширениеРаботыСФайлами() Тогда 
			
			ЗапуститьПриложение("https://antoshka.ua/" + СокрЛП(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Элемент.ТекущиеДанные.Номенклатура, "Код")));  
			
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Если АвтоматическийРасчетСкидок Тогда
		ПропуститьАвтоматическийРасчетСкидок = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриИзменении(Элемент)
	
	ПересчитатьИлиОтменитьСкидки();
	
	Если Не Элемент.ТекущиеДанные = Неопределено 
			И Не Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Смешаный") Тогда 
		Элемент.ТекущиеДанные.Самовывоз = (Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз"));
	КонецЕсли;	

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыПодарки

&НаКлиенте
Процедура ПодаркиНоменклатураПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Подарки.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьТипНоменклатуры");
	СтруктураДействий.Вставить("ПроверитьХарактеристикуПоВладельцу"   , ТекущаяСтрока.Характеристика);
	СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ТекущаяСтрока.Упаковка);
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	
	СтруктураПараметровДействия = Новый Структура;
	СтруктураПараметровДействия.Вставить("Магазин", Объект.Магазин);
	СтруктураПараметровДействия.Вставить("РабочееМесто", РабочееМесто);
	СтруктураДействий.Вставить("ЗаполнитьСкладПродажи", СтруктураПараметровДействия);
	
	СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи" ,ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруЗаполненияЦеныПродажиВСтрокеТЧ(Объект, Истина));
	
	СтруктураДействий.Вставить("ПересчитатьСумму");
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Подарки, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиХарактеристикаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Подарки.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	
	СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи" ,ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруЗаполненияЦеныПродажиВСтрокеТЧ(Объект, Истина));
	СтруктураДействий.Вставить("ПересчитатьСумму");
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Подарки, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиХарактеристикаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ОбработкаТабличнойЧастиТоварыКлиент.ВыбратьХарактеристикуНоменклатуры(ЭтотОбъект, Элемент, СтандартнаяОбработка, Элементы.Подарки.ТекущиеДанные);
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиУпаковкаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Подарки.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	Если ТекущаяСтрока.Количество > 0 Тогда
		СтруктураДействий.Вставить("ПересчитатьЦенуЗаУпаковку", ТекущаяСтрока.Количество);
	Иначе
		СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи" ,ОбработкаТабличнойЧастиТоварыКлиент.ПолучитьСтруктуруЗаполненияЦеныПродажиВСтрокеТЧ(Объект, Истина));
	КонецЕсли;
	
	СтруктураДействий.Вставить("ПересчитатьСумму");
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Подарки, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиУпаковкаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ОбработкаТабличнойЧастиТоварыКлиент.ВыбратьУпаковкуНоменклатуры(ДанныеВыбора, СтандартнаяОбработка, Элементы.Подарки.ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиКоличествоУпаковокПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Подарки.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	СтруктураДействий.Вставить("ПересчитатьСумму");
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Подарки, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиЦенаПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.Подарки.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьСумму");
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Подарки, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиСуммаПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.Подарки.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	
	СтруктураДействий.Вставить("ПересчитатьЦенуСкидкуПоСуммеВПродажах");
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Подарки, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ = Истина;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаполнитьЦеныВыделенныхСтрокПоВидуЦен(Команда)
	
	Если Объект.Товары.Количество() = 0 Тогда
		
		ТекстПредупреждения = НСтр("ru='В документе не заполнена таблица %ПредставлениеТабличнойЧасти%. Цены не могут быть заполнены'");
		ТекстПредупреждения = СтрЗаменить(ТекстПредупреждения, "%ПредставлениеТабличнойЧасти%", "Товары");
		ПоказатьПредупреждение(,ТекстПредупреждения);
		
	Иначе
		
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("МножественныйВыбор", Ложь);
		СтруктураОтбора = Новый Структура("ИспользоватьПриПродаже", Истина);
		ПараметрыФормы.Вставить("Отбор", СтруктураОтбора);
		// +HVOYA. 2016-09-07 Юлия_Ж
		//ОбработчикОповещения= Новый ОписаниеОповещения("ОповещениеОткрытьФормуВыбораВидаЦены", ЭтотОбъект);
		Режим = РежимОткрытияОкнаФормы.БлокироватьОкноВладельца;
		//ОткрытьФорму("Справочник.ВидыЦен.Форма.ФормаВыбора", ПараметрыФормы,ЭтотОбъект,,,, ОбработчикОповещения, Режим);
		// -HVOYA. 2016-09-07 Юлия_Ж
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьЦеныВыделенныхСтрокПоРозничнымЦенам(Команда)
	
	Если Объект.Товары.Количество() = 0 Тогда
		
		ТекстПредупреждения = НСтр("ru='В документе не заполнена таблица %ПредставлениеТабличнойЧасти%. Цены не могут быть заполнены'");
		ТекстПредупреждения = СтрЗаменить(ТекстПредупреждения, "%ПредставлениеТабличнойЧасти%", "Товары");
		ПоказатьПредупреждение(,ТекстПредупреждения);
		
	Иначе	
		
		Если ЗначениеЗаполнено(Объект.Магазин) Тогда
			
			ЦеныРассчитаны = ЗаполнитьЦеныВыделенныхСтрокПоРозничнымЦенамСервер();
			ЗапасыКлиент.ОповеститьОбОкончанииЗаполненияЦенПоРозничнымЦенам(ЦеныРассчитаны, Объект.Магазин);
			ПересчитатьИлиОтменитьСкидки();
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НазначитьАвтоматическиеСкидки(Команда)
	
	ДополнительныеПараметры = Новый Структура;
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ОбработчикОповещения = Новый ОписаниеОповещения("НазначитьАвтоматическиеСкидкиЗавершение", ЭтотОбъект, ДополнительныеПараметры);
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("АдресВоВременномХранилище", ВыполнитьПредварительныйРасчетСкидокНаСервере());
	//ОткрытьФорму("ОбщаяФорма.НазначениеАвтоматическихУправляемыхСкидокНаценок", ПараметрыФормы, ЭтотОбъект, , , , ОбработчикОповещения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	 // -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура НазначитьРучнуюСкидку(Команда)
	
	Если НЕ СкидкиНаценкиКлиент.ПроверитьНеобходимостьНазначенияРучнойСкидкиНаценки(Объект, "Товары", "Товары") Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыДляРучнойСкидки = ПараметрыДляНазначенияРучнойСкидки();
	ДополнительныеПараметры = Новый Структура;
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ОбработчикОповещения = Новый ОписаниеОповещения("НазначитьРучнуюСкидкуЗавершение", ЭтотОбъект, ДополнительныеПараметры);
	//ОткрытьФорму("ОбщаяФорма.НазначениеРучнойСкидкиНаценки", ПараметрыДляРучнойСкидки, ЭтотОбъект, , , , ОбработчикОповещения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	 // -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьИнформациюОСкидках(Команда)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено ИЛИ ТекущиеДанные.ПродажаПодарка Тогда
		Возврат;
	КонецЕсли;
	
	ОткрытьИнформациюОСкидкахКлиент()
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьПодбор(Команда)
	
	Отказ = Ложь;
	Если Не ЗначениеЗаполнено(Объект.Магазин) Тогда
		ОчиститьСообщения();
		СообщитьОбОшибкахОткрытияПодбора(Отказ);
	КонецЕсли;
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрЗаголовок = НСтр("ru = 'Подбор товаров в %Документ%'");
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		ПараметрЗаголовок = СтрЗаменить(ПараметрЗаголовок, "%Документ%", Объект.Ссылка);
	Иначе
		ПараметрЗаголовок = СтрЗаменить(ПараметрЗаголовок, "%Документ%", НСтр("ru = 'реализацию товаров'"));
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Магазин", Объект.Магазин);
	ПараметрыФормы.Вставить("РежимПодбораСУчетомЗапрещенныхКПродаже", Истина);	//	LNK 31.07.2020 08:54:02
	ПараметрыФормы.Вставить("РежимПодбораСУчетомМинимальныхЦен", Истина);
	ПараметрыФормы.Вставить("Склад", Объект.Склад);
	ПараметрыФормы.Вставить("Заголовок", ПараметрЗаголовок);
	ПараметрыФормы.Вставить("Дата", Объект.Дата);
	
	Если НЕ ЕстьПравоИзменятьЦену() Тогда
		ПараметрыФормы.Вставить("РежимПодбораБезСуммовыхПараметров", Истина);
		ПараметрыФормы.Вставить("ЗаголовокКнопкиЗапрашиватьКоличествоИЦену",НСтр("ru = 'Запрашивать количество'"));
	КонецЕсли;
	
	Если ИспользоватьАссортимент Тогда
		ПараметрыФормы.Вставить("МагазинАссортимента", Объект.Магазин);
		ПараметрыФормы.Вставить("РежимПодбораСУчетомАссортимента", Истина);
		ПараметрыФормы.Вставить("УсловиеАссортимента", "РазрешеныПродажи");
	КонецЕсли;
	 // +HVOYA. 2016-09-07 Юлия_Ж
	//ОткрытьФорму("Обработка.ПодборТоваров.Форма", ПараметрыФормы, ЭтотОбъект, УникальныйИдентификатор);
	 // -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура ОтменитьРучныеСкидки(Команда)
	
	Если Не СкидкиНаценкиКлиент.ПроверитьНеобходимостьОтменыРучныхСкидокНаценок(Объект, "Товары", "Товары") Тогда
		Возврат;
	КонецЕсли;
	
	ОтменитьРучныеСкидкиНаСервере();
	СкидкиНаценкиКлиент.ОповеститьОбОкончанииНазначенияРучныхСкидокНаценок();
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьИнформациюОСкидкахКлиент()
	// +HVOYA. 2016-09-07 Юлия_Ж
	//Если Объект.СкидкиРассчитаны Тогда
	//	ОткрытьИнформациюОСкидкахЗавершитьОбработкуВопроса();
	//Иначе
	//	ДополнительныеПараметры = Новый Структура; 
	//	//ОбработчикОповещения = Новый ОписаниеОповещения("ОповещениеВопросРассчитатьИОткрытьСкидки", ЭтотОбъект, ДополнительныеПараметры);
	//	ТекстВопроса = НСтр("ru = 'Скидки (наценки) не рассчитаны, рассчитать?'");
	//	ПоказатьВопрос(ОбработчикОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	//КонецЕсли;
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСкидкиНаценки(Команда)
	
	РассчитатьСкидкиНаценкиКлиент();
	
КонецПроцедуры

&НаКлиенте
Процедура РазбитьСтроку(Команда)
	
	ТаблицаФормы  = Элементы.Товары;
	ДанныеТаблицы = Объект.Товары;
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;  
	
	КлючСвязиЗапросаДоступностиМакс = 0;
	Для Каждого СтрокаТЧ Из Объект.Товары Цикл
		
		КлючСвязиЗапросаДоступностиМакс = Макс(СтрокаТЧ.КлючСвязиЗапросаДоступности, КлючСвязиЗапросаДоступностиМакс);
		
	КонецЦикла;
	
	НоваяСтрока = ОбработкаТабличнойЧастиТоварыКлиент.РазбитьСтрокуТЧ(ДанныеТаблицы, ТаблицаФормы);
	
	Если НоваяСтрока <> Неопределено Тогда
		
		НоваяСтрока.КлючСвязи = 0;
		НоваяСтрока.КлючСвязиБонусныхБаллов = 0;
		НоваяСтрока.КлючСвязиЗапросаДоступности = КлючСвязиЗапросаДоступностиМакс + 1;
		НоваяСтрока.Склад = Неопределено;
		
		СтруктураДействий = Новый Структура;
		ДобавитьВСтруктуруДействияПриИзмененииКоличестваУпаковок(СтруктураДействий, Объект);
		
		ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
		ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, НоваяСтрока  , СтруктураДействий, КэшированныеЗначения);
		
	КонецЕсли;
	ПересчитатьИлиОтменитьСкидки();

КонецПроцедуры

&НаКлиенте
Процедура ПеренестиПодаркиВТовары(Команда)
	
	ПеренестиСкидкиПодаркиВТоварыСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура ПодаркиОткрытьПодбор(Команда)
	
	Отказ = Ложь;
	Если Не ЗначениеЗаполнено(Объект.Магазин) Тогда
		ОчиститьСообщения();
		СообщитьОбОшибкахОткрытияПодбора(Отказ);
	КонецЕсли;
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрЗаголовок = НСтр("ru = 'Подбор товаров в %Документ%'");
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		ПараметрЗаголовок = СтрЗаменить(ПараметрЗаголовок, "%Документ%", Объект.Ссылка);
	Иначе
		ПараметрЗаголовок = СтрЗаменить(ПараметрЗаголовок, "%Документ%", НСтр("ru = 'заказ покупателя'"));
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Магазин", Объект.Магазин);
	ПараметрыФормы.Вставить("РежимПодбораСУчетомЗапрещенныхКПродаже", Истина);	//	LNK 31.07.2020 08:54:02
	ПараметрыФормы.Вставить("ИмяТабличнойЧасти", "Подарки");
	ПараметрыФормы.Вставить("РежимПодбораБезСертификатов", Истина);
	ПараметрыФормы.Вставить("Заголовок", ПараметрЗаголовок);
	ПараметрыФормы.Вставить("Дата", Объект.Дата);
	
	Если НЕ ЕстьПравоИзменятьЦену() Тогда
		ПараметрыФормы.Вставить("РежимПодбораБезСуммовыхПараметров", Истина);
		ПараметрыФормы.Вставить("ЗаголовокКнопкиЗапрашиватьКоличествоИЦену",НСтр("ru = 'Запрашивать количество'"));
	КонецЕсли;
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ОткрытьФорму("Обработка.ПодборТоваров.Форма", ПараметрыФормы, ЭтотОбъект, УникальныйИдентификатор);
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура ОтменитьВыделенныеСтроки(Команда)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//Если Не РозничныеПродажиКлиент.НеобходимоЗаполнениеПричиныОтменыВыделенныхСтрок(Объект.Товары, НСтр("ru='Товары'"), Элементы.Товары.ВыделенныеСтроки) Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//ПричинаОтмены = ПредопределенноеЗначение("Справочник.ПричиныОтменыЗаказовПокупателей.ПустаяСсылка");
	//Если ИспользоватьПричиныОтменыЗаказовПокупателей Тогда
	//	
	//	//ОбработчикОповещения = Новый ОписаниеОповещения("ОповещениеОткрытьФормуОтменыВыделенныхСтрок", ЭтотОбъект);
	//	Режим = РежимОткрытияОкнаФормы.БлокироватьОкноВладельца;
	//	ОткрытьФорму("Справочник.ПричиныОтменыЗаказовПокупателей.ФормаВыбора",,,,,, ОбработчикОповещения, Режим); 
	//	
	//Иначе
	//	ЗавершитьОтменуВыделенныхСтрок();
	//КонецЕсли;
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура ОтменитьНеЗарезервированныеСтроки(Команда)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//Если Не РозничныеПродажиКлиент.НеобходимоЗаполнениеПричиныОтменыВыделенныхСтрок(Объект.Товары, НСтр("ru='Товары'"), Элементы.Товары.ВыделенныеСтроки) Тогда
	//	Возврат;
	//КонецЕсли;
	
	//ПричинаОтмены = ПредопределенноеЗначение("Справочник.ПричиныОтменыЗаказовПокупателей.ПустаяСсылка");
	//Если ИспользоватьПричиныОтменыЗаказовПокупателей Тогда
	//	
		//ОбработчикОповещения = Новый ОписаниеОповещения("ОповещениеОткрытьФормуОтменыВыделенныхНеЗарезервированныхСтрок", ЭтотОбъект);
	//	Режим = РежимОткрытияОкнаФормы.БлокироватьОкноВладельца;
	//	ОткрытьФорму("Справочник.ПричиныОтменыЗаказовПокупателей.ФормаВыбора",,,,,, ОбработчикОповещения, Режим); 
	//	
	//Иначе
	//	ЗавершитьОтменуВыделенныхНеЗарезервированныхСтрок()
	//КонецЕсли;
// -HVOYA. 2016-09-07 Юлия_Ж	
КонецПроцедуры

&НаКлиенте
Процедура ОтменитьНепроданныеТовары(Команда)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//Если Не РозничныеПродажиКлиент.НеобходимоЗаполнениеПричиныОтменыВыделенныхСтрок(Объект.Товары, НСтр("ru='Товары'"), Элементы.Товары.ВыделенныеСтроки) Тогда
	//	Возврат;
	//КонецЕсли;
	
	//ПричинаОтмены = ПредопределенноеЗначение("Справочник.ПричиныОтменыЗаказовПокупателей.ПустаяСсылка");
	//Если ИспользоватьПричиныОтменыЗаказовПокупателей Тогда
	//	
	//	//ОбработчикОповещения = Новый ОписаниеОповещения("ОповещениеОткрытьФормуОтменыНепроданныхТоваров", ЭтотОбъект);
	//	Режим = РежимОткрытияОкнаФормы.БлокироватьОкноВладельца;
	//	ОткрытьФорму("Справочник.ПричиныОтменыЗаказовПокупателей.ФормаВыбора",,,,,, ОбработчикОповещения, Режим); 
	//	
	//Иначе
	//	ЗавершитьОтменуНепроданныхТоваров();
	//КонецЕсли;
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура СкрыватьОтмененныеСтроки(Команда)
	
	СкрыватьОтмененныеСтроки = Не СкрыватьОтмененныеСтроки;
	
	Если СкрыватьОтмененныеСтроки Тогда
		Элементы.Товары.ОтборСтрок = Новый ФиксированнаяСтруктура("Отменено", Ложь);
	Иначе
		Элементы.Товары.ОтборСтрок = Неопределено;
	КонецЕсли;
	
	Элементы.ТоварыСкрыватьОтмененныеСтроки.Пометка = СкрыватьОтмененныеСтроки;
	
КонецПроцедуры

&НаКлиенте
Процедура РезервироватьПоДаннымОстатков(Команда)
	
	Если Объект.Товары.Количество() = 0 Тогда
		
		ТекстПредупреждения = НСтр("ru='В документе не заполнена таблица %ПредставлениеТабличнойЧасти%.'");
		ТекстПредупреждения = СтрЗаменить(ТекстПредупреждения, "%ПредставлениеТабличнойЧасти%", НСтр("ru = 'Товары'"));
		ПоказатьПредупреждение(,ТекстПредупреждения);
		Возврат;
		
	КонецЕсли;
	
	КоличествоСтрокРезервирования = РезервироватьПоДаннымОстатковСервер();
	
	ПодключитьОбработчикОжидания("ОповеститьОбРезервировании", 0.1, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура Изменить(Команда)
	УстановитьДоступностьЭлементовПоСтатусуСервер(Истина);
КонецПроцедуры

&НаКлиенте
Процедура РазвернутьСвернутьТЧ(Команда)
	РазвернутьСвернутьТЧНаСервере();
КонецПроцедуры

// +HVOYA. 2016-09-07 Юлия_Ж
&НаКлиенте
Процедура Подключаемый_ВыполнитьНазначаемуюКоманду(Команда)
	
	//Если НЕ ДополнительныеОтчетыИОбработкиКлиент.ВыполнитьНазначаемуюКомандуНаКлиенте(ЭтотОбъект, Команда.Имя) Тогда
		РезультатВыполнения = Неопределено;
		ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(Команда.Имя, РезультатВыполнения);
	//КонецЕсли;
	
КонецПроцедуры
// -HVOYA. 2016-09-07 Юлия_Ж

// СтандартныеПодсистемы.Печать
&НаКлиенте
Процедура Подключаемый_ВыполнитьКомандуПечати(Команда)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//УправлениеПечатьюКлиент.ВыполнитьПодключаемуюКомандуПечати(Команда, ЭтотОбъект, Объект);
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры
// Конец СтандартныеПодсистемы.Печать

#Область ОбработчикиКомандПодключаемогоОборудования

&НаКлиенте
Процедура ВыгрузитьДанныеВТСД(Команда)
	
	//ПодключаемоеОборудованиеРТКлиент.ВыгрузитьДокументВТСД(ЭтотОбъект, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьДанныеИзТСД(Команда)
	
	ДополнительныеПараметры = Новый Структура("ВыбиратьНенайденные", Ложь);
	ДополнительныеПараметры.Вставить("УчитыватьСерийныеНомераПриСвертке", Ложь);
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ПодключаемоеОборудованиеРТКлиент.ПолучитьДанныеИзТСД(ЭтотОбъект, ДополнительныеПараметры);
	// -HVOYA. 2016-09-07 Юлия_Ж
	ПересчитатьИлиОтменитьСкидки();
	
КонецПроцедуры

&НаКлиенте
Процедура ПоискПоМагнитномуКоду(Команда)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ОбработкаТабличнойЧастиТоварыКлиент.ВвестиМагнитныйКод(ЭтотОбъект);
// -HVOYA. 2016-09-07 Юлия_Ж	
КонецПроцедуры

&НаКлиенте
Процедура ПоискПоШтрихкоду(Команда)
	
	ТекШтрихкод = "";
	Если ОбработкаТабличнойЧастиТоварыКлиент.ВвестиШтрихкод(ТекШтрихкод) Тогда
		
		СтруктураПараметровКлиента = ПолученШтрихкодИзСШК(ТекШтрихкод);
		ОбработатьДанныеПоКодуКлиент(СтруктураПараметровКлиента, ТекШтрихкод);
				
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьТелефонКлиента()
	Запрос = Новый Запрос(
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ТаблицаКонтакты.НомерТелефона КАК НомерТелефона
		|ИЗ
		|	Справочник.Контрагенты.КонтактнаяИнформация КАК ТаблицаКонтакты
		|ГДЕ
		|	ТаблицаКонтакты.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Телефон)
		|	И ТаблицаКонтакты.Ссылка = &Ссылка"
		);
	Запрос.УстановитьПараметр("Ссылка", Объект.Контрагент);
	
	Результат = Запрос.Выполнить();
	Найден    = НЕ Результат.Пустой();

	Если Найден Тогда

		СписокТелефонов = Результат.Выгрузить().ВыгрузитьКолонку("НомерТелефона");

		НомерТелефонаКлиента = СписокТелефонов[0]; 
		
	Иначе 
		
		НомерТелефонаКлиента = "";
		
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Функция ВозможностьВводаПоШК()
	
	Результат = Истина;
	
	Если Элементы.Товары.ТолькоПросмотр Тогда
		Результат = Ложь;
	КонецЕсли;
	
	Если НЕ Результат Тогда
		ОчиститьСообщения();
		ТекстСообщения = НСтр("ru = 'Форма заблокирована. Ввод невозможен.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Процедура РазвернутьСвернутьТЧНаСервере()
	
	РазвернутаТЧ = НЕ РазвернутаТЧ;
	
	ВидимостьЭлементов = НЕ РазвернутаТЧ;
	 // +HVOYA. 2016-09-07 Юлия_Ж
	//ЭтотОбъект.ПоложениеКоманднойПанели               = ?(ВидимостьЭлементов, ПоложениеКоманднойПанелиФормы.Авто, ПоложениеКоманднойПанелиФормы.Нет);
	// -HVOYA. 2016-09-07 Юлия_Ж
	Элементы.Шапка.Видимость                          = ВидимостьЭлементов;
	
	Элементы.РазвернутьСвернутьТЧ.Картинка = ?(ВидимостьЭлементов, БиблиотекаКартинок.РазвернутьТабличнуюЧасть, БиблиотекаКартинок.СвернутьТабличнуюЧасть);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ДобавитьВСтруктуруДействияПриИзмененииКоличестваУпаковок(СтруктураДействий, Объект)
	
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	
КонецПроцедуры

// Функция заполняет цену выделенных строк по виду цен в ТЧ Товары.
//
//  Возвращаемое значение - Булево - Цены рассчитаны.
&НаСервере
Функция ЗаполнитьЦеныВыделенныхСтрокПоВидуЦенСервер(ВидЦены)
	
	СтруктураПараметров                                          = ЗапасыСервер.СтруктураПараметровЗаполненияПоВидуЦен();
	СтруктураПараметров.Объект                                   = Объект;
	СтруктураПараметров.ИмяТабличнойЧасти                        = "Товары";
	СтруктураПараметров.ВидЦен                                   = ВидЦены;
	СтруктураПараметров.ВыделенныеСтроки                         = Элементы.Товары.ВыделенныеСтроки;
	СтруктураПараметров.Дата                                     = ЗапасыСервер.ДатаДляЦенообразованияДляДокумента(Объект);
	СтруктураПараметров.НеобходимостьПересчетаСуммыСУчетомСкидок = Истина;
	
	ЦеныРассчитаны = ЗапасыСервер.ЗаполнитьЦеныВыделенныхСтрокПоВидуЦен(СтруктураПараметров);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыПодвала(Объект.Товары, Объект.ЦенаВключаетНДС, СуммаВсего);
	
	Возврат ЦеныРассчитаны;
	
КонецФункции

// Функция заполняет цену выделенных строк по розничным ценам в ТЧ Товары.
//
//  Возвращаемое значение - Булево - Цены рассчитаны.
&НаСервере
Функция ЗаполнитьЦеныВыделенныхСтрокПоРозничнымЦенамСервер()
	
	СтруктураПараметров                                          = ЗапасыСервер.СтруктураПараметровЗаполненияПоРозничнымЦенам();
	СтруктураПараметров.Объект                                   = Объект;
	СтруктураПараметров.ИмяТабличнойЧасти                        = "Товары";
	СтруктураПараметров.Магазин                                  = Объект.Магазин;
	СтруктураПараметров.ВыделенныеСтроки                         = Элементы.Товары.ВыделенныеСтроки;
	СтруктураПараметров.Дата                                     = ЗапасыСервер.ДатаДляЦенообразованияДляДокумента(Объект);
	СтруктураПараметров.ПриводитьКМинимальнойЦене                = Истина;
	СтруктураПараметров.НеобходимостьПересчетаСуммыСУчетомСкидок = Истина;
	
	ЦеныРассчитаны  = ЗапасыСервер.ЗаполнитьЦеныВыделенныхСтрокПоРозничнымЦенам(СтруктураПараметров);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыПодвала(Объект.Товары, Объект.ЦенаВключаетНДС, СуммаВсего);
	
	Возврат ЦеныРассчитаны;
	
КонецФункции

&НаСервере
Процедура НастроитьФормуПоДополнительнымПравам()

	АдминистративныйДоступ = РольДоступна(Метаданные.Роли.АдминистраторСистемы) И ТехническаяПоддержкаВызовСервера.ИсключительныйРежим();

	Если НЕ АдминистративныйДоступ Тогда

		ТолькоПросмотр = Истина;

	Иначе

		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.ТоварыСуммаРучнойСкидки.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьРучнуюСкидку);

		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.ТоварыПроцентРучнойСкидки.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьРучнуюСкидку);

		УправлениеПользователями.УстановитьДоступностьДляРеквизитовТабличнойЧасти(Элементы.ТоварыНазначитьРучнуюСкидку.Доступность, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьРучнуюСкидку);
		
		УправлениеПользователями.УстановитьДоступностьДляРеквизитовТабличнойЧасти(Элементы.ТоварыОтменитьРучныеСкидки.Доступность, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьРучнуюСкидку);
		
		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.ТоварыЦена.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьЦену);

		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.ТоварыСумма.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьЦену);

		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.ПодаркиЦена.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьЦену);

		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.ПодаркиСумма.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьЦену);
		
		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.Продавец.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьПродавца);

		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.ТоварыПродавец.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьПродавца);

		УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.Дата.ТолькоПросмотр, 
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьДату);
	//	LNK 04.01.2017 13:54:53
	//Криворучко
		Если НЕ ТехническаяПоддержкаВызовСервера.ИсключительныйРежим() = Истина Тогда

			УправлениеПользователями.УстановитьТолькоПросмотрДляРеквизитовТабличнойЧасти(Элементы.Номер.ТолькоПросмотр,
																					 ПланыВидовХарактеристик.ПраваПользователей.ИзменятьНомерДокумента);
		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

// Процедура заполняет товары из подбора.
// Параметры: 
//  ВыбранноеЗначение - Структура
&НаСервере
Функция ОбработкаВыбораПодборНаСервере(ВыбранноеЗначение, ИмяТабличнойЧасти  = "")
	
	СтрокиИзменены = Ложь;
	ТаблицаТоваров = ПолучитьИзВременногоХранилища(ВыбранноеЗначение.АдресТоваровВХранилище);
	ИмяТабличнойЧасти = ?(ПустаяСтрока(ИмяТабличнойЧасти), "Товары", ИмяТабличнойЧасти);
	ТаблицаСерийныхНомеров = ПолучитьИзВременногоХранилища(ВыбранноеЗначение.АдресСерийныхНомеровВХранилище);
	ЕстьСерийныеНомера = (ИмяТабличнойЧасти = "Товары") И (ТаблицаСерийныхНомеров.Количество() > 0);
	Для каждого СтрокаТовара Из ТаблицаТоваров Цикл
		
		ТекущаяСтрока = Объект[ИмяТабличнойЧасти].Добавить();
		ЗаполнитьЗначенияСвойств(ТекущаяСтрока, СтрокаТовара, "Номенклатура, Характеристика, Упаковка, Цена, КоличествоУпаковок");
		Если ЕстьСерийныеНомера Тогда
			МассивСерийныхНомеров = ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьМассивСерийныхНомеровДляСтрокиТоваров(СтрокаТовара.КлючСвязиСерийныхНомеров , ТаблицаСерийныхНомеров);
			ТекущаяСтрока.КлючСвязиСерийныхНомеров = ОбработкаТабличнойЧастиТоварыСервер.ДобавитьСерийныеНомераВТабличнуюЧасть(Объект.СерийныеНомера, МассивСерийныхНомеров, 0);
		КонецЕсли;
		СтруктураДействий = Новый Структура;

		Если ИмяТабличнойЧасти = "Товары" Тогда
			
			СтруктураДействий.Вставить("ЗаполнитьТипНоменклатуры");
			СтруктураПараметровСтавкиНДС = Новый Структура;
			СтруктураПараметровСтавкиНДС.Вставить("Дата"       , Объект.Дата);
			СтруктураПараметровСтавкиНДС.Вставить("Организация", Объект.Организация);
			СтруктураПараметровСтавкиНДС.Вставить("Склад"      , Объект.Склад);
			СтруктураДействий.Вставить("ЗаполнитьСтавкуНДССкладВШапке", СтруктураПараметровСтавкиНДС);
			СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект));
			
			СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
			СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
			
			СтруктураДействий.Вставить("ПроставитьПродавца", Объект.Продавец);
		ИначеЕсли ИмяТабличнойЧасти = "Подарки" Тогда
			ТекущаяСтрока.Склад = Объект.Склад;
		КонецЕсли;
		
		СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
		СтруктураДействий.Вставить("ПересчитатьСумму");
		
		КэшированныеЗначения = ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();
		ОбработкаТабличнойЧастиТоварыСервер.ОбработатьСтрокуТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
		
		СтрокиИзменены = Истина;
		
	КонецЦикла;
	 // +HVOYA. 2016-09-07 Юлия_Ж
	//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакИспользованияХарактеристик(Объект[ИмяТабличнойЧасти]);
	 // -HVOYA. 2016-09-07 Юлия_Ж
	Если ИмяТабличнойЧасти = "Товары" Тогда

		ОбновитьИтоговыеПоказатели(ЭтотОбъект);
		ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакЕстьПродажиПоСтроке(Объект.Ссылка, Объект.Товары);

	КонецЕсли;
	
	Возврат СтрокиИзменены;
	
КонецФункции

&НаСервере
Процедура ПересчетНДСТабличнойЧастиСервер()
	
	СтруктураДействий = Новый Структура;
	
	СтруктураПараметровСтавкиНДС = Новый Структура;
	СтруктураПараметровСтавкиНДС.Вставить("Дата"       , Объект.Дата);
	СтруктураПараметровСтавкиНДС.Вставить("Организация", Объект.Организация);
	СтруктураПараметровСтавкиНДС.Вставить("Склад"      , Объект.Склад);
	
	СтруктураДействий.Вставить("ЗаполнитьСтавкуНДССкладВШапке", СтруктураПараметровСтавкиНДС);
	
	СтруктураПараметровПересчетаНДС = ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(Объект);
	СтруктураПараметровПересчетаНДС.Вставить("НеобходимоОбработатьВсюТЧ", Истина);
	
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПараметровПересчетаНДС);
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Истина));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
	
	СтруктураТЧ = Новый Структура;
	СтруктураТЧ.Вставить("СтрокиТЧ" , Объект.Товары);
	ОбработкаТабличнойЧастиТоварыСервер.ПриИзмененииРеквизитовВТЧСервер(СтруктураТЧ, СтруктураДействий, Неопределено);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыПодвала(Объект.Товары, Объект.ЦенаВключаетНДС, СуммаВсего);
	
	Объект.СкидкиРассчитаны = Ложь;
	
КонецПроцедуры

// Процедура- обработчик изменения дисконтная карта на сервере.
//
// Параметры:
//  Нет
//
&НаСервере
Процедура ПриИзмененииДисконтнаяКартаСервер()
	
	Объект.Контрагент = Объект.ДисконтнаяКарта.ВладелецКарты;
	Объект.ВладелецДисконтнойКарты = Объект.Контрагент;
	
КонецПроцедуры

&НаСервере
Процедура КонтрагентПриИзмененииНаСервере()
	
	Объект.ДисконтнаяКарта = Справочники.ИнформационныеКарты.НайтиПоРеквизиту("ВладелецКарты", Объект.Контрагент);
	Объект.ВладелецДисконтнойКарты = Объект.Контрагент;
	ЮрЛицо = Не (ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Контрагент, "ЮрФизЛицо")
					= Перечисления.ЮрФизЛицо.ФизЛицо);
	КонтрагентЗаблокирован = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Контрагент, "Блокирован");
	ЗаполнитьФИОКлиента();
	ЗаполнитьТелефонКлиента();
	УстановитьДоступностьЭлементовПоСтатусуСервер();
	
КонецПроцедуры

// Процедура заполняет склад при изменении магазина.
//
&НаСервере
Процедура ПриИзмененииМагазинСервер()
	
	ИспользоватьАссортимент = ПолучитьФункциональнуюОпциюКонтроляАссортимента();
	
	Объект.Склад = ЗначениеНастроекПовтИсп.ПолучитьСкладПродажиПоУмолчанию(Объект.Магазин,,Объект.Склад, Пользователи.ТекущийПользователь());
	
	Если ЗначениеЗаполнено(Объект.Склад) Тогда
		ПриИзмененииСкладСервер();
	КонецЕсли;
	
КонецПроцедуры

// Процедура- обработчик изменения склада на сервере.
//
// Параметры:
//  Нет
//
&НаСервере
Процедура ПриИзмененииСкладСервер()
	
	Если НЕ ЗначениеЗаполнено(Объект.Организация) Тогда
		
		Объект.Организация = Справочники.Склады.РеквизитыСклада(Объект.Склад, Объект.Дата).Организация;	//	LNK 15.11.2023 18:13:43
		
	КонецЕсли;
	
	ПересчетНДСТабличнойЧастиСервер();
	
КонецПроцедуры

// Обрабатывает изменение количества упаковок.
//
// Параметры:
//  Нет;
//
&НаКлиенте
Процедура ПриИзмененииТоварыКоличестваУпаковок()
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	ДобавитьВСтруктуруДействияПриИзмененииКоличестваУпаковок(СтруктураДействий, Объект);
	
	ОбработкаТабличнойЧастиТоварыКлиент.ПриИзмененииРеквизитовВТЧКлиент(Объект.Товары, ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВСтрокеТаблицы(ТекущаяСтрока, Объект.ЦенаВключаетНДС);

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

// Заполняет реквизиты документа по умолчанию в зависимости от выбранного налогообложения НДС.
//
&НаСервере
Процедура ПриИзмененииУчитыватьНДССервер()
	
	УстановитьДоступностьЦенаВключаетНДС(Истина);
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьСтавкуНДС",  Объект.УчитыватьНДС);
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВТЧ(Объект));
	
	СтруктураТЧ = Новый Структура;
	СтруктураТЧ.Вставить("СтрокиТЧ" , Объект.Товары);
	ОбработкаТабличнойЧастиТоварыСервер.ПриИзмененииРеквизитовВТЧСервер(СтруктураТЧ, СтруктураДействий, Неопределено);
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыПодвала(Объект.Товары, Объект.ЦенаВключаетНДС, СуммаВсего);
	УстановитьТекущуюСтраницуСуммПодвала();
	
КонецПроцедуры

&НаСервере
Функция ПараметрыДляНазначенияРучнойСкидки()
	
	Возврат СкидкиНаценкиСервер.ПараметрыДляНазначенияРучнойСкидки(Объект);
	
КонецФункции

// Процедура сообщает о необходимости заполнения реквизитов документа при вызове подбора.
// Параметры:
//  Отказ - Булево
//
&НаКлиенте
Процедура СообщитьОбОшибкахОткрытияПодбора(Отказ)
	
	Если НЕ ЗначениеЗаполнено(Объект.Магазин) Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Поле ""Магазин"" не заполнено'"), Объект, "Объект.Магазин",,Отказ);
	КонецЕсли;
		
КонецПроцедуры

// Процедура управляет видимостью и доступностью элементов формы на сервере.
//
&НаСервере
Процедура УстановитьДоступностьЭлементовНаСервере(ТолькоПросмотрЭлементов)

	Если НЕ ТолькоПросмотрЭлементов Тогда
		

		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Склад", "ТолькоПросмотр", НЕ ЗначениеЗаполнено(Объект.Магазин));
		
		ДоступностьРезервирования = Объект.Проведен И Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Согласован И Объект.НаличиеНезарезервированныхСтрок;
		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, 
																	   "ТоварыРезервироватьПоДаннымОстатков", 
																	   "Доступность", 
																	   ДоступностьРезервирования);
   КонецЕсли;
   
   Если НЕ ТехническаяПоддержкаВызовСервера.ИсключительныйРежим() Тогда
   		
   		РедактированиеКонтрагента = Объект.Ссылка.Пустая()
   								 Или ((Объект.ТипОплаты = Перечисления.ТипОплатыЗаказПокупателя.БРПредоплата
   								 		Или Объект.ТипОплаты = Перечисления.ТипОплатыЗаказПокупателя.БРПостоплата)
   								 	 И (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Новый
   										Или Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.ВРаботе
   										Или Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.ЗапросДоступности));
   			
   	
	   ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Контрагент", "ТолькоПросмотр", НЕ РедактированиеКонтрагента);
	   ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "ДисконтнаяКарта", "ТолькоПросмотр", НЕ РедактированиеКонтрагента);
   КонецЕсли;


КонецПроцедуры

&НаСервере
Процедура УстановитьДоступностьЭлементовПоСтатусуСервер(РазрешитьРедактирование = Ложь)
	
	ТолькоПросмотрЭлементов = (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Закрыт)
							Или (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Отменён)
							Или (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Новый);

	//ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Статус", "ТолькоПросмотр", Не ДокументСотрудникаКЦ);
	ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Ответственный", "ТолькоПросмотр", Не ЯвляетсяСуперВайзером);
	
//	Если РазрешитьРедактирование ИЛИ ТехническаяПоддержкаВызовСервера.ОтладочныйРежимРаботы() Или ЯвляетсяСуперВайзером Тогда
//
//		ТолькоПросмотрЭлементов = Ложь;
//		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Статус", "ТолькоПросмотр", Ложь);
//		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Ответственный", "ТолькоПросмотр", Ложь);
//		
//	Иначе
		
		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Ответственный", "ТолькоПросмотр", ТолькоПросмотрЭлементов
				И Не ТехническаяПоддержкаВызовСервера.ИсключительныйРежим());
		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Статус", "ТолькоПросмотр", ТолькоПросмотрЭлементов
				И Не ТехническаяПоддержкаВызовСервера.ИсключительныйРежим());

//	КонецЕсли;
	ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Номер", "ТолькоПросмотр",
				Не ТехническаяПоддержкаВызовСервера.ИсключительныйРежим());
	ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Организация", "ТолькоПросмотр",
				Ложь);
	МассивЭлементов = Новый Массив;
	
	// Элементы управления шапки
		
	МассивЭлементов.Добавить("Дата");
	//МассивЭлементов.Добавить("Номер");
	МассивЭлементов.Добавить("ДисконтнаяКарта");
	МассивЭлементов.Добавить("Продавец");
	МассивЭлементов.Добавить("ДатаПродажиЖелаемая");
	МассивЭлементов.Добавить("Магазин");
	МассивЭлементов.Добавить("Склад");
	//МассивЭлементов.Добавить("Организация");
	МассивЭлементов.Добавить("ТипДоставки");
	МассивЭлементов.Добавить("Ответственный");
	//МассивЭлементов.Добавить("Комментарий");
	МассивЭлементов.Добавить("УчитыватьНДС");
	МассивЭлементов.Добавить("ЦенаВключаетНДС");
	//МассивЭлементов.Добавить("АдресДоставки");
	МассивЭлементов.Добавить("Товары");
	//МассивЭлементов.Добавить("Скидки");
	//МассивЭлементов.Добавить("НачислениеБонусныхБаллов");
	//МассивЭлементов.Добавить("ОплатаБонуснымиБаллами");
	МассивЭлементов.Добавить("СтраницаДополнительно");
	МассивЭлементов.Добавить("Подарки");

	ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементовФормы(Элементы, МассивЭлементов, "ТолькоПросмотр", ТолькоПросмотрЭлементов);
	
	МассивЭлементов = Новый Массив;
	
	МассивЭлементов.Добавить("ТоварыРазбитьСтроку");
	МассивЭлементов.Добавить("ТоварыПоискПоШтрихкоду");
	МассивЭлементов.Добавить("ТоварыВыгрузитьДанныеВТСД");
	МассивЭлементов.Добавить("ТоварыЗагрузитьДанныеИзТСД");
	МассивЭлементов.Добавить("ТоварыПоискПоМагнитномуКоду");
	МассивЭлементов.Добавить("ТоварыОткрытьПодбор");
	МассивЭлементов.Добавить("ТоварыЗаполнитьЦеныПоРозничнымЦенам");
	МассивЭлементов.Добавить("ТоварыЗаполнитьЦеныПоВидуЦен");
	МассивЭлементов.Добавить("ТоварыЗаполнитьЦеныВыделенныхСтрокПоРозничнымЦенам");
	МассивЭлементов.Добавить("ТоварыЗаполнитьЦеныВыделенныхСтрокПоВидуЦен");
	МассивЭлементов.Добавить("ТоварыРассчитатьСкидкиНаценки");
	МассивЭлементов.Добавить("ТоварыНазначитьАвтоматическиеСкидки");
	МассивЭлементов.Добавить("ТоварыНазначитьРучнуюСкидку");
	МассивЭлементов.Добавить("ТоварыОтменитьРучныеСкидки");
	МассивЭлементов.Добавить("ТоварыОткрытьИнформациюОСкидках");
	МассивЭлементов.Добавить("ТоварыРезервироватьПоДаннымОстатков");
	МассивЭлементов.Добавить("ТоварыОтменитьВыделенныеСтроки");
	МассивЭлементов.Добавить("ТоварыОтменитьНезарезервированныеСтроки");
	МассивЭлементов.Добавить("ТоварыОтменитьНеПроданныеТовары");
	МассивЭлементов.Добавить("ТоварыСкрыватьОтмененныеСтроки");
	МассивЭлементов.Добавить("ПодаркиОткрытьПодбор");
	МассивЭлементов.Добавить("ПодаркиПеренестиПодаркиВТовары");
	
	ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементовФормы(Элементы, МассивЭлементов, "Доступность", Не ТолькоПросмотрЭлементов);
	ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы,"Изменить", "Доступность", ТолькоПросмотрЭлементов);
	
	УстановитьДоступностьЭлементовНаСервере(ТолькоПросмотрЭлементов);
	
	Элементы.ОтменитьПромоКод.Видимость = (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.ВРаботе)
											Или (Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.ЗапросДоступности);
											
	ОбрабатываетсяМадженто = (Объект.УчетнаяСистема = Перечисления.УчетныеСистемыКомпании.Magento)
								Или (Объект.Дата < Дата(2023, 08, 01));
	
	Элементы.Магазин.Видимость = ОбрабатываетсяМадженто;
	//Элементы.Организация.Видимость = ОбрабатываетсяМадженто;
	Элементы.ТелефонШапка.Видимость = Не ОбрабатываетсяМадженто;
	
КонецПроцедуры

// Устанавливает доступность поля ЦенаВключаетНДС.
//
&НаСервере
Процедура УстановитьДоступностьЦенаВключаетНДС(ПриИзменении = Ложь)

	Если ПриИзменении И Не Объект.УчитыватьНДС И Объект.ЦенаВключаетНДС Тогда
		Объект.ЦенаВключаетНДС = Ложь;
	ИначеЕсли ПриИзменении И Объект.УчитыватьНДС Тогда
		Объект.ЦенаВключаетНДС = Истина;
	КонецЕсли;
	
	Элементы.ЦенаВключаетНДС.ТолькоПросмотр = Не Объект.УчитыватьНДС;

КонецПроцедуры

&НаКлиенте
Процедура УстановитьДоступностьЭлементов()
	
	ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Склад", "ТолькоПросмотр", НЕ ЗначениеЗаполнено(Объект.Магазин));
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста	//	LNK 03.02.2021 08:54:30
Процедура УстановитьОформлениеЭлементов(Форма)

	Форма.Элементы.ДекорацияСуммаДоставкиОплачена.Картинка = ?(Форма.Объект.СуммаДоставкиОплачена
		, БиблиотекаКартинок.КолокольчикЖелтый
		, БиблиотекаКартинок.КолокольчикНеактивный);

КонецПроцедуры

// Процедура учитывает изменение параметров налогообложения в документе.
//
&НаСервере
Процедура УстановитьТекущуюСтраницуСуммПодвала()
	
	Если Объект.УчитыватьНДС Тогда
		Элементы.ГруппаПодвалСтраницы.ТекущаяСтраница = Элементы.ГруппаСуммыНДС;
		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "СуммаВсего", "Видимость", Истина);
	Иначе
		Элементы.ГруппаПодвалСтраницы.ТекущаяСтраница = Элементы.ГруппаСуммы;
		ОбщегоНазначенияРТКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "СуммаВсего", "Видимость", Ложь);
	КонецЕсли;
	
КонецПроцедуры

Функция ЕстьПравоИзменятьЦену()
	
	Возврат УправлениеПользователями.ПолучитьБулевоЗначениеПраваПользователя(ПланыВидовХарактеристик.ПраваПользователей.ИзменятьЦену);
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// Скидки

&НаСервере
Функция ВыполнитьПредварительныйРасчетСкидокНаСервере()
	
	СтруктураПараметры = Новый Структура;
	СтруктураПараметры.Вставить("ПрименятьКОбъекту",                Ложь);
	СтруктураПараметры.Вставить("ТолькоПредварительныйРасчет",      Истина);
	СтруктураПараметры.Вставить("ВосстанавливатьУправляемыеСкидки", Истина);
	СтруктураПараметры.Вставить("УправляемыеСкидки", УправляемыеСкидки);
	СтруктураПараметры.Вставить("ТолькоСообщенияПослеОформления",   Ложь);
	СтруктураПараметры.Вставить("КонтролироватьОстаткиТоваров",		Ложь);
	СтруктураПараметры.Вставить("РабочееМесто", РабочееМесто);
	СтруктураПараметры.Вставить("ДатаРасчета" , Объект.Дата);	//	LNK 19.05.2021 07:36:49
	
	СведенияДокумента = Новый Структура;
	СегментИсключаемойНоменклатуры = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Магазин, "СегментИсключаемойНоменклатуры");
	СведенияДокумента.Вставить("СегментИсключаемойНоменклатуры", СегментИсключаемойНоменклатуры);
	СведенияДокумента.Вставить("Товары", Объект.Товары);
	СтруктураПараметры.Вставить("СведенияДокумента", СведенияДокумента);
	
	ДанныеРасчетаСкидок = СкидкиНаценкиСерверПереопределяемый.Рассчитать(Объект, СтруктураПараметры);
	
	Возврат ПоместитьВоВременноеХранилище(ДанныеРасчетаСкидок, УникальныйИдентификатор);
	
КонецФункции

&НаСервере
Функция ПоместитьСкидкиВХранилище()

	СтруктураТаблиц = Новый Структура;
	СтруктураТаблиц.Вставить("СкидкиНаценки", Объект.СкидкиНаценки.Выгрузить());
	СтруктураТаблиц.Вставить("Подарки", Объект.Подарки.Выгрузить());
	СтруктураТаблиц.Вставить("НачислениеБонусныхБаллов", Объект.НачислениеБонусныхБаллов.Выгрузить());
	
	Адрес = ПоместитьВоВременноеХранилище(СтруктураТаблиц, УникальныйИдентификатор);
	
	Возврат Адрес;

КонецФункции

&НаКлиенте
Процедура ОткрытьИнформациюОСкидкахЗавершитьОбработкуВопроса()
	
	АдресСкидок = ПоместитьСкидкиВХранилище();
	// +HVOYA. 2016-09-07 Юлия_Ж
	//СкидкиНаценкиКлиент.ОткрытьФормуПримененныеСкидки(Элементы.Товары.ТекущиеДанные, Объект, ЭтотОбъект, АдресСкидок);
// -HVOYA. 2016-09-07 Юлия_Ж	
КонецПроцедуры

&НаСервере
Процедура ОтменитьРучныеСкидкиНаСервере()
	
	СкидкиНаценкиСервер.ОтменитьРучныеСкидки(Объект, "Товары", Истина);
	
КонецПроцедуры

&НаСервере
Процедура НазначитьРучнуюСкидкуНаСервере(СуммаСкидкиНаценки)
	
	Если СуммаСкидкиНаценки <> 0 Тогда
		СкидкиНаценкиСервер.НазначитьРучнуюСкидку(Объект, "Товары", СуммаСкидкиНаценки, Истина);
	Иначе
		СкидкиНаценкиСервер.ОтменитьРучныеСкидки(Объект, "Товары", Истина);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПеренестиСкидкиПодаркиВТоварыСервер()
	
	ЕстьОшибки = Ложь;
	СкидкиНаценкиСерверПереопределяемый.СообщитьОбОстающихсяПодарках(Объект, ЕстьОшибки);
	Если НЕ ЕстьОшибки Тогда
		СкидкиНаценкиСерверПереопределяемый.ПеренестиСкидкиПодаркиВТовары(Объект, Объект.ЦенаВключаетНДС);
		ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
		// +HVOYA. 2016-09-07 Юлия_Ж
		//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакИспользованияХарактеристик(Объект.Товары);
		//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакИспользованияХарактеристик(Объект.Подарки);
		// -HVOYA. 2016-09-07 Юлия_Ж
		ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакЕстьПродажиПоСтроке(Объект.Ссылка, Объект.Товары);

		СкидкиНаценкиСерверПереопределяемый.ОбновитьОтображениеСкидки(Объект);
		БонусныеБаллыСервер.ОбновитьОтображениеОплатаБонуснымиБаллами(Объект);

		ОбновитьИтоговыеПоказатели(ЭтотОбъект);

	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСкидкиНаценкиКлиент()
	
	СтруктураПараметры = Новый Структура;
	СтруктураПараметры.Вставить("ПрименятьКОбъекту",                Истина);
	СтруктураПараметры.Вставить("ТолькоПредварительныйРасчет",      Ложь);
	СтруктураПараметры.Вставить("ВосстанавливатьУправляемыеСкидки", Истина);
	СтруктураПараметры.Вставить("УправляемыеСкидки",                УправляемыеСкидки);
	СтруктураПараметры.Вставить("ТолькоСообщенияПослеОформления",   Ложь);
	СтруктураПараметры.Вставить("ПеренестиСкидкиПодаркиВТовары");
	СтруктураПараметры.Вставить("КонтролироватьОстаткиТоваров",		Ложь);

	Если МенеджерОборудованияКлиент.ОбновитьРабочееМестоКлиента() Тогда // Проверка на определенность рабочего места ВО.
		РабочееМесто = МенеджерОборудованияКлиентПовтИсп.ПолучитьРабочееМестоКлиента();
	Иначе
		РабочееМесто = ""
	КонецЕсли;
	
	СтруктураПараметры.Вставить("РабочееМесто", РабочееМесто);
	
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) И НЕ ДатаДокументаИзмененаВручную Тогда
		Объект.Дата = ОбщегоНазначенияКлиент.ДатаСеанса();
	КонецЕсли;
	
	РассчитатьСкидкиНаценкиНаСервере(СтруктураПараметры);
	
	Если ПустаяСтрока(АдресПримененныхСкидокВоВременномХранилище) Тогда
		
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Скидки (наценки)'"),
			?(Объект.Ссылка.Пустая(), "", ПолучитьНавигационнуюСсылку(Объект.Ссылка)),
			НСтр("ru = 'Отказано! Скидки (наценки) НЕ рассчитаны'"),
			БиблиотекаКартинок.Ошибка32);

	Иначе
      	Если ВывестиСообщения Тогда
			СкидкиНаценкиКлиент.ОткрытьФормуВыводаСообщений(АдресПримененныхСкидокВоВременномХранилище);
		КонецЕсли;

		Если ВыдатьПодаркиНаВыбор
			И ЗначениеЗаполнено(АдресПодарковНаВыбор) Тогда
			ДополнительныеПараметры = Новый Структура;
			// +HVOYA. 2016-09-07 Юлия_Ж
			//ОбработчикОповещения = Новый ОписаниеОповещения("ОповещениеВыдатьПодаркиНаВыбор", ЭтотОбъект, ДополнительныеПараметры);
			ПараметрыФормы = Новый Структура;
			ПараметрыФормы.Вставить("АдресВоВременномХранилище", АдресПодарковНаВыбор);
			//ОткрытьФорму("ОбщаяФорма.ПодаркиНаВыбор",
			//	ПараметрыФормы,
			//	ЭтотОбъект,
			//	,
			//	,
			//	,
			//	ОбработчикОповещения,
			//	РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
			// -HVOYA. 2016-09-07 Юлия_Ж
		Иначе

			ОповещениеВыдатьПодаркиНаВыбор();

		КонецЕсли;

	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура РассчитатьСкидкиНаценкиНаСервере(СтруктураПараметры)
	
	Если ЮрЛицо Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПараметры.Вставить("ДатаРасчета", Объект.Дата);	//	LNK 19.05.2021 07:36:49
	ДанныеРасчетаСкидок = СкидкиНаценкиСерверПереопределяемый.Рассчитать(Объект, СтруктураПараметры);
	
	Если ТипЗнч(ДанныеРасчетаСкидок) = Тип("Массив") Тогда
      	ВывестиСообщения = Ложь;
		АдресПримененныхСкидокВоВременномХранилище = ПоместитьВоВременноеХранилище(ДанныеРасчетаСкидок, УникальныйИдентификатор);
		Если ДанныеРасчетаСкидок[0].Результаты.ТаблицаСообщений.Количество() > 0 Тогда
			ВывестиСообщения = Истина;
		КонецЕсли;

		//АдресПримененныхСкидокВоВременномХранилище = ПоместитьВоВременноеХранилище(ДанныеРасчетаСкидок, УникальныйИдентификатор);
		
		Если ДанныеРасчетаСкидок[0].Результаты.Свойство("ТаблицаПодарковНаВыбор") Тогда
			АдресПодарковНаВыбор = ПоместитьВоВременноеХранилище(ДанныеРасчетаСкидок[0].Результаты.ТаблицаПодарковНаВыбор, УникальныйИдентификатор);
			ВыдатьПодаркиНаВыбор = Истина;
		Иначе
			АдресПодарковНаВыбор = "";
			ВыдатьПодаркиНаВыбор = Ложь;
		КонецЕсли;
		
		Модифицированность = Истина;
		
		СкидкиНаценкиСерверПереопределяемый.ОбновитьОтображениеСкидки(Объект);
		БонусныеБаллыСервер.ОбновитьОтображениеОплатаБонуснымиБаллами(Объект);
		
		Если НЕ Объект.СкидкиРассчитаны Тогда
		
			Объект.СкидкиРассчитаны = Истина;
		
		КонецЕсли;

	Иначе

		АдресПримененныхСкидокВоВременномХранилище = "";

	КонецЕсли;
	
КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////
// Прочее

&НаКлиенте
Процедура ПередЗаписьюКлиент(Отказ, ПараметрыЗаписи)
	
	// Если документ проводится, рассчитаем скидки.
	
	Если ПараметрыЗаписи.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
	
		Если ИспользоватьАвтоматическиеСкидкиВПродажах
		И Не Объект.СкидкиРассчитаны 
			И Объект.Товары.Количество() > 0 Тогда
			
			РассчитатьСкидкиНаценкиКлиент();
			
		КонецЕсли;
		
	КонецЕсли;
	
	
КонецПроцедуры

&НаСервере
Функция ОтменитьСНепроданнымиТоварамиСервер(ПричинаОтмены, Знач ПроверятьОстатки = Ложь)
	
	КоличествоОтмененныхСтрок = РозничныеПродажиСервер.ОтменитьСНепроданнымиТоварами(Объект, "Товары", ПричинаОтмены, ПроверятьОстатки);
	
	Возврат КоличествоОтмененныхСтрок;
	
КонецФункции

&НаСервере
Функция РезервироватьПоДаннымОстатковСервер()
	
	КоличествоСтрок = РозничныеПродажиСервер.РезервироватьПоДаннымОстатков(Объект, "Товары");
	
	Возврат КоличествоСтрок;
	
КонецФункции

&НаКлиенте
Процедура ОповеститьОбРезервировании()
	
	Если КоличествоСтрокРезервирования = 0 Тогда
			
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Нет возможности для резерва'"),
			,
			НСтр("ru='Нет возможности для резерва. Товары по заказу или уже проданы, или нет остатка на складе'"),
			БиблиотекаКартинок.Информация32
		);
			
	Иначе
			
			ПоказатьОповещениеПользователя(
				НСтр("ru = 'Товары готовы к резерву'"),
				,
				НСтр("ru = 'Товары готовы к резерву. Выбраны все возможные товары к резерву.'"),
				БиблиотекаКартинок.Информация32
			);
			
		КоличествоСтрокРезервирования = 0;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьФункциональнуюОпциюКонтроляАссортимента()
	//
	//Если НЕ ЗначениеЗаполнено(Объект.Магазин) ИЛИ Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.НеСогласован Тогда
	//	Возврат Ложь;
	//КонецЕсли;
	//Возврат АссортиментСервер.ПолучитьФункциональнуюОпциюКонтроляАссортимента(Объект.Магазин, "КонтролироватьАссортиментВЗаказеПокупателя");
	
КонецФункции // ПолучитьФункциональнуюОпциюКонтроляАссортимента()

&НаКлиентеНаСервереБезКонтекста	//	LNK 09.11.2021 06:33:43
Процедура ОбновитьИтоговыеПоказатели(Форма)
	
	УчетнаяПолитика = ОбщегоНазначенияРТ.ПолучитьУчетнуюПолитику();
	СуммаДоставкиСлужбойДоставки = УчетнаяПолитика.СуммаДоставкиЗаказаПокупателя;
	СуммаБесплатнойДоставки = УчетнаяПолитика.СуммаБесплатнойДоставки;
	
	Для Каждого СтрокаТаблицыТовары Из Форма.Объект.Товары Цикл
		
		ОбработкаТабличнойЧастиТоварыКлиентСервер.РассчитатьРезультатСкидкиВСтрокеТЧ(СтрокаТаблицыТовары, Форма.Объект.ЦенаВключаетНДС, Истина);
		СтрокаТаблицыТовары.Сумма = СтрокаТаблицыТовары.Сумма + СтрокаТаблицыТовары.СуммаОкругления;

	КонецЦикла;
	
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Форма.Объект.Товары, Форма.Объект.ЦенаВключаетНДС);
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыПодвала(Форма.Объект.Товары, Форма.Объект.ЦенаВключаетНДС, Форма.СуммаВсего);

	ОбработкаТабличнойЧастиТоварыКлиентСервер.ОбновитьСуммыСкидкиНаценки(Форма.Объект.СкидкиНаценки, Форма.СуммаСкидкиНаценки, Истина);
	
	СуммаРучныхСкидок = 0;
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСуммуРучныхСкидокДокумента(Форма.Объект.Товары, СуммаРучныхСкидок);
	Форма.СуммаСкидкиНаценки = Форма.СуммаСкидкиНаценки + СуммаРучныхСкидок;
	
	Форма.СуммаБезСкидки = Форма.СуммаВсего + Форма.СуммаСкидкиНаценки;

	ВсегоБонусныхБаллов = Форма.Объект.НачислениеБонусныхБаллов.Количество() + Форма.Объект.ОплатаБонуснымиБаллами.Количество();
	
	Форма.Элементы.ГруппаБонусныеБаллы.Заголовок = "Бонусные баллы" + ?(ВсегоБонусныхБаллов = 0, "", " (" + Формат(ВсегоБонусныхБаллов, "ЧГ=") + ")");
	
	Если Форма.Объект.УчетнаяСистема = ПредопределенноеЗначение("Перечисление.УчетныеСистемыКомпании.Розница")
			И Не Форма.Объект.СуммаДоставкиВРучную
			И Не Форма.Объект.СуммаДоставкиОплачена Тогда
		Если Форма.Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз") Тогда
			Если Форма.Объект.СуммаДоставки = СуммаДоставкиСлужбойДоставки Тогда
				Форма.Объект.СуммаДоставки = 0;
				Форма.Модифицированность = Истина;
			КонецЕсли;
		Иначе
			Если Форма.СуммаВсего >= СуммаБесплатнойДоставки Тогда
				Если Не Форма.Объект.СуммаДоставки = 0 Тогда
					Форма.Объект.СуммаДоставки = 0;
					Форма.Модифицированность = Истина;
				КонецЕсли;
			Иначе
				Если Форма.Объект.СуммаДоставки = 0 Тогда
					Форма.Объект.СуммаДоставки = СуммаДоставкиСлужбойДоставки;
					Форма.Модифицированность = Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	СтруктураОплат = ЗаказыПокупателейКлиентСервер.СтруктураПодсчетаОплат();
	СтруктураОплат.СуммаВсего = Форма.СуммаВсего;
	ПодсчетОплаты = ЗаказыПокупателейКлиентСервер.ПодсчетОплаты(Форма.Объект, СтруктураОплат);

	Форма.СуммаОплачено = СтруктураОплат.СуммаОплачено; 
	Форма.СуммаОжидаетОплаты = СтруктураОплат.СуммаОжидаетОплаты; 
	Форма.СуммаСформированныхОплат = СтруктураОплат.СуммаСформированныхОплат;
	Форма.СуммаСформированныхВозвратов = СтруктураОплат.СуммаСформированныхВозвратов;

	Форма.СуммаВсегоДляОплаты = Форма.СуммаВсего + Форма.Объект.СуммаДоставки; 
	Форма.СуммаВсегоОплаты = Форма.СуммаОплачено - Форма.СуммаСформированныхВозвратов; 

	Форма.Элементы.СостояниеОплатыЗаказа.Заголовок = ПодсчетОплаты.ЗаголовокДляФормы;
	
КонецПроцедуры

// СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки
&НаСервере
Процедура ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(ИмяЭлемента, РезультатВыполнения)
// +HVOYA. 2016-09-07 Юлия_Ж	
	//ДополнительныеОтчетыИОбработки.ВыполнитьНазначаемуюКомандуНаСервере(ЭтотОбъект, ИмяЭлемента, РезультатВыполнения);
	 // -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры
// Конец СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки

&НаКлиенте
Процедура ЗавершитьОбработкуДанныхПоКодуКлиент(СтруктураПараметровКлиента)
	// +HVOYA. 2016-09-07 Юлия_Ж
	//ИдентификаторСтроки = ПодключаемоеОборудованиеРТКлиент.ЗавершитьОбработкуДанныхПоКодуКлиент(ЭтотОбъект, СтруктураПараметровКлиента);
	// -HVOYA. 2016-09-07 Юлия_Ж
	ПересчитатьИлиОтменитьСкидки();
	
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьОтменуВыделенныхСтрок()
	// +HVOYA. 2016-09-07 Юлия_Ж
	//РозничныеПродажиКлиент.ОтменитьВыделенныеСтроки(
	//	Объект.Товары,
	//	Элементы.Товары.ВыделенныеСтроки,
	//	ПричинаОтмены
	//);
	//
	//РозничныеПродажиКлиент.ОповеститьОбОтменеВыделенныхСтрок(ПричинаОтмены);
// -HVOYA. 2016-09-07 Юлия_Ж	
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьОтменуВыделенныхНеЗарезервированныхСтрок()
	 // +HVOYA. 2016-09-07 Юлия_Ж
	//РозничныеПродажиКлиент.ОтменитьВыделенныеНеЗарезервированныеСтроки(
	//	Объект.Товары,
	//	Элементы.Товары.ВыделенныеСтроки,
	//	ПричинаОтмены
	//);
	
	//РозничныеПродажиКлиент.ОповеститьОбОтменеВыделенныхНеЗарезервированныхСтрок(ПричинаОтмены);
	// -HVOYA. 2016-09-07 Юлия_Ж
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьОтменуНепроданныхТоваров()
	
	ПроверятьОстатки = Истина;
	
	КоличествоСтрокОтменено = ОтменитьСНепроданнымиТоварамиСервер(ПричинаОтмены, ПроверятьОстатки);
	// +HVOYA. 2016-09-07 Юлия_Ж
	//РозничныеПродажиКлиент.ОповеститьОбОтменеНепроданныхТоваров(ПричинаОтмены, КоличествоСтрокОтменено, ПроверятьОстатки);
// -HVOYA. 2016-09-07 Юлия_Ж	
КонецПроцедуры

&НаСервере
Процедура ОтменитьСкидки()
	
	Для Каждого СтрокаТовары Из Объект.Товары Цикл
		
		СтрокаТовары.СуммаОкругления = 0;
		
	КонецЦикла;
	
	Если Объект.СкидкиРассчитаны Тогда
		СкидкиНаценкиСервер.ОтменитьСкидки(Объект, "Товары");
		Объект.Подарки.Очистить();
		Объект.НачислениеБонусныхБаллов.Очистить();
		Объект.СкидкиРассчитаны = Ложь;
	КонецЕсли;

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_УстановитьКартинкуДляКомментария()
	ОбщегоНазначенияРТКлиентСервер.УстановитьКартинкуДляКомментария(Элементы.СтраницаКомментарий, Объект.Комментарий);
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьИлиОтменитьСкидки()
	
	Если АвтоматическийРасчетСкидок Тогда
		Если НЕ ПропуститьАвтоматическийРасчетСкидок Тогда
			РассчитатьСкидкиНаценкиКлиент();
		КонецЕсли;
	Иначе
		ОтменитьСкидки();
	КонецЕсли;

	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаСервере
Процедура ВыдатьПодаркиНаВыборНаСервере(Результат, ДополнительныеПараметры) Экспорт
	
	ПереноситьВПродажи = Ложь;
	ТаблицаПодарков = ПолучитьИзВременногоХранилища(Результат);
	Для Каждого СтрокаПодарка Из ТаблицаПодарков Цикл
	    НоваяСтрока = Объект.Подарки.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаПодарка);
		УчитыватьПодарокКакПродажу = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаПодарка.СкидкаНаценка, "УчитыватьПодарокКакПродажу");
		Если УчитыватьПодарокКакПродажу Тогда
			ПереноситьВПродажи = Истина;
		КонецЕсли;
	КонецЦикла;
	
	Если ПереноситьВПродажи Тогда
		КоличествоПеренесенных = 0;
		СкидкиНаценкиСерверПереопределяемый.ПеренестиСкидкиПодаркиВТовары(Объект, Объект.ЦенаВключаетНДС, , КоличествоПеренесенных);
		Если КоличествоПеренесенных > 0 Тогда
			ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);
			// +HVOYA. 2016-09-07 Юлия_Ж
			//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакИспользованияХарактеристик(Объект.Товары);
			//ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакИспользованияХарактеристик(Объект.Подарки);
			// -HVOYA. 2016-09-07 Юлия_Ж
			ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьПризнакЕстьПродажиПоСтроке(Объект.Ссылка, Объект.Товары);
			СкидкиНаценкиСерверПереопределяемый.ОбновитьОтображениеСкидки(Объект);
			БонусныеБаллыСервер.ОбновитьОтображениеОплатаБонуснымиБаллами(Объект);

		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокКомментариевПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ = Истина;
	КомментарийПараметры = Новый Структура("ЗаказКлиента", Объект.Ссылка);
	ОткрытьФорму("РегистрСведений.КомментарийИнтернетЗаказа.ФормаЗаписи", КомментарийПараметры, Элемент);
КонецПроцедуры

&НаКлиенте
Процедура СписокКомментариевПередНачаломИзменения(Элемент, Отказ)
	Отказ = Истина;
	КомментарийПараметры = Новый Структура("ПросмотрКомментария, ДанныеДляПросмотра, ЗаказКлиента", 
											Истина,
											Элемент.ТекущиеДанные,
											Объект.Ссылка);
	ОткрытьФорму("РегистрСведений.КомментарийИнтернетЗаказа.ФормаЗаписи", КомментарийПараметры, Элемент);
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСкладНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка) 
	
	Если  ЗначениеЗаполнено(Элементы.Товары.ТекущиеДанные.Номенклатура) Тогда 
		СтандартнаяОбработка = Ложь; 
		
		ДанныеВыбора = Новый СписокЗначений;
		СтруктураТовара = Новый Структура("Товар, Количество",
				Элементы.Товары.ТекущиеДанные.Номенклатура,
				Элементы.Товары.ТекущиеДанные.Количество);
		
		ТоварыСкладНачалоВыбораНаСервере(СтруктураТовара, ДанныеВыбора);
		
	КонецЕсли;

КонецПроцедуры

&НаСервереБезКонтекста
Процедура ТоварыСкладНачалоВыбораНаСервере(СтруктураТовара, ДанныеВыбора)
	
	ЗаказыПокупателейСервер.ТоварыСкладВыбор(СтруктураТовара, ДанныеВыбора);

КонецПроцедуры
				
&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	НаименованиеОбъекта = ТекущийОбъект.Ссылка.Метаданные().Имя;
	Менеджер = Документы[НаименованиеОбъекта]; 
	Ссылка = ТекущийОбъект.Ссылка;
	ЭтоНовый = ТекущийОбъект.Ссылка.Пустая();
	Если ЭтоНовый Тогда // Объект еще не был записан   
		Ссылка = Менеджер.ПолучитьСсылку(Новый УникальныйИдентификатор);
		ТекущийОбъект.УстановитьСсылкуНового(Ссылка);

	КонецЕсли;
	
	СписокКомментариев.Параметры.УстановитьЗначениеПараметра("ЗаказПокупателя", Ссылка); 
	
	ТекущийОбъект.ДополнительныеСвойства.Вставить("ИзмененОтветственный", ИзмененОтветственный);  
	
	МассивКомментарийСтрок = Новый Массив;
	МассивЦеныCompeteraОтвет = Новый Массив;
	
	Для Каждого СтрокаТЧ Из Объект.Товары Цикл

		СтруктураКомментария = РегистрыСведений.КомментарийПоСтрокам.СтруктураКомментария();
		
		СтруктураКомментария.КлючСвязи = СтрокаТЧ.КлючСвязиЗапросаДоступности;
		СтруктураКомментария.Комментарий = СтрокаТЧ.КомментарийПоСтроке; 
		СтруктураКомментария.УдалитьЗапись = Не СтрокаТЧ.ЕстьКомментарий; 
		
		МассивКомментарийСтрок.Добавить(СтруктураКомментария);

		Если Не ПустаяСтрока(СтрокаТЧ.ЦеныCompeteraОтвет) Тогда 

			МассивЦеныCompeteraОтвет.Добавить(СтрокаТЧ.ЦеныCompeteraОтвет);
			
		КонецЕсли;
		
	КонецЦикла; 
	
	ТекущийОбъект.ДополнительныеСвойства.Вставить("МассивКомментарийСтрок", МассивКомментарийСтрок);
	ТекущийОбъект.ДополнительныеСвойства.Вставить("МассивЦеныCompeteraОтвет", МассивЦеныCompeteraОтвет);
	
КонецПроцедуры  

&НаКлиенте
Процедура ТипДоставкиПриИзменении(Элемент)
	
	Элементы.ОператорДоставки.РежимВыбораИзСписка = Ложь;
	
	Для Каждого СтрокаТЧ Из Объект.Товары Цикл 
		
		Если Не Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Смешаный") Тогда 
			СтрокаТЧ.Самовывоз = (Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз"));
		КонецЕсли;
		
	КонецЦикла;
	
	Если Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз") Тогда 
		
		Объект.ОператорДоставки = ПредопределенноеЗначение("Перечисление.ОператорыДоставки.ВнутренняяЛогистика");
		
	ИначеЕсли Объект.ОператорДоставки = ПредопределенноеЗначение("Перечисление.ОператорыДоставки.ВнутренняяЛогистика") Тогда 
		
		Объект.ОператорДоставки = ПредопределенноеЗначение("Перечисление.ОператорыДоставки.ПустаяСсылка"); 

		Элементы.ОператорДоставки.РежимВыбораИзСписка = Истина;
		ЗаполнитьОператоровДоставки();

	КонецЕсли;
	
	ВидимостьЭлементов();
	
	ОбновитьИтоговыеПоказатели(ЭтотОбъект);

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьОператоровДоставки()
	
	Элементы.ОператорДоставки.СписокВыбора.Очистить();
	Элементы.ОператорДоставки.СписокВыбора.Добавить(Перечисления.ОператорыДоставки.НоваяПочта, "Нова пошта");		
	Элементы.ОператорДоставки.СписокВыбора.Добавить(Перечисления.ОператорыДоставки.MeestExpress, "MeestExpress");		

КонецПроцедуры

&НаКлиенте
Процедура ОператорДоставкиПриИзменении(Элемент)
	
	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.ГородаДоставки")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Город.ОграничениеТипа = НашеОписание;  

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.ГородаДоставки")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Город2.ОграничениеТипа = НашеОписание;  

	ВидимостьЭлементов();
	
КонецПроцедуры

&НаКлиенте
Процедура ВидимостьЭлементов()

	Элементы.ТоварыСамовывоз.Видимость = Не  
						(Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз")
						Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.СлужбаДоставки"));
						
	Элементы.ТоварыМагазинПолучатель.Видимость =   
						(Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз")
						Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Смешаный"));
						
	Элементы.МагазинПолучения.Видимость = 
						(Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз")
						Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Смешаный"));
						
	Элементы.ГруппаВидДоставки.Видимость = Не (Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз"));
	Элементы.ИнформацияОДоставке.Видимость = Не (Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз"));
	Элементы.ИнформацияОДоставке.Доступность = Не (Объект.ОператорДоставки = ПредопределенноеЗначение("Перечисление.ОператорыДоставки.ПустаяСсылка"));
	
	Элементы.СуммаДоставки.ТолькоПросмотр = Не Объект.СуммаДоставкиВРучную;
	
	Элементы.ОтделениеНеРаботает.Видимость = ОтделениеНеРаботает(Объект.Отделение);
	
	Элементы.ДекорацияЮрЛицо.Видимость = Не ЮрЛицо 
			И (Объект.ТипОплаты = ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.БРПредоплата")
				Или Объект.ТипОплаты = ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.БРПостоплата"));
			
	Элементы.ФормаИспользованиеБонусов.Видимость = Не ЮрЛицо;
	Элементы.ДекорацияКонтрагентЗаблокирован.Видимость = КонтрагентЗаблокирован;
	
КонецПроцедуры

&НаКлиенте
Процедура МагазинПолученияПриИзменении(Элемент)

	Для Каждого СтрокаТовары Из Объект.Товары Цикл
		
		СтрокаТовары.МагазинПолучатель = МагазинПолучения;
		
	КонецЦикла;
	
	Модифицированность = Истина;
	
КонецПроцедуры


&НаКлиенте
Процедура СуммаДоставкиВРучнуюПриИзменении(Элемент)
	Элементы.СуммаДоставки.ТолькоПросмотр = Не Объект.СуммаДоставкиВРучную;
КонецПроцедуры


&НаСервере
Процедура ДоставкаНаАдресПриИзмененииНаСервере()
	Если Объект.ДоставкаНаАдрес тогда
		Элементы.НаОтделение.Видимость	= ложь;	
		Элементы.НаАдрес.Видимость 		= Истина;			
	Иначе
		Элементы.НаОтделение.Видимость 	= Истина;	
		Элементы.НаАдрес.Видимость 		= ложь;			
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ДоставкаНаАдресПриИзменении(Элемент)
	ДоставкаНаАдресПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПолучательТЛПриИзмененииНаСервере()
	Если Объект.ПолучательТретееЛицо тогда
   		Объект.Телефон  = "";
	Иначе	
		ЗаполнитьФИОКлиента();	
	КонецЕсли;	
	//Если Объект.ПолучательТретееЛицо тогда
	//	Элементы.ГруппаКлиент.Видимость			= ложь;	
	//	Элементы.ГруппаКлиент2.Видимость		= ложь;	
	//	Элементы.ГруппаТретееЛицо.Видимость		= Истина;	
	//	Элементы.ГруппаТретееЛицо2.Видимость	= Истина;	
	//Иначе
	//	Элементы.ГруппаКлиент.Видимость			= Истина;	
	//	Элементы.ГруппаКлиент2.Видимость		= Истина;	
	//	Элементы.ГруппаТретееЛицо.Видимость		= ложь;	
	//	Элементы.ГруппаТретееЛицо2.Видимость	= ложь;	
	//КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПолучательТЛПриИзменении(Элемент)
	ПолучательТЛПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура 	ПрверитьВидимостьДоставкиИПолучателя();
	//Если Объект.ПолучательТретееЛицо тогда
	//	Элементы.ГруппаКлиент.Видимость			= ложь;	
	//	Элементы.ГруппаКлиент2.Видимость		= ложь;	
	//	Элементы.ГруппаТретееЛицо.Видимость		= Истина;	
	//	Элементы.ГруппаТретееЛицо2.Видимость	= Истина;	
	//Иначе
	//	Элементы.ГруппаКлиент.Видимость			= Истина;	
	//	Элементы.ГруппаКлиент2.Видимость		= Истина;	
	//	Элементы.ГруппаТретееЛицо.Видимость		= ложь;	
	//	Элементы.ГруппаТретееЛицо2.Видимость	= ложь;	
	//КонецЕсли;
	
	Если Объект.ДоставкаНаАдрес тогда
		Элементы.НаОтделение.Видимость	= ложь;	
		Элементы.НаАдрес.Видимость 		= Истина;			
	Иначе
		Элементы.НаОтделение.Видимость 	= Истина;	
		Элементы.НаАдрес.Видимость 		= ложь;			
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ОчиститьРайонИОбластьНаСервере()
	Объект.Область = Справочники.Области.ПустаяСсылка();  
	Объект.Район   = Справочники.Районы.ПустаяСсылка(); 
КонецПроцедуры 

&НаСервере
Процедура ЗаполнитьСтатусДляВыбора()
	
	//Элементы.Статус.СписокВыбора.Очистить();
	//СостояниеДокумента = ЗаказыПокупателейСервер.ПолучитьСостаяниеЗаказаПокупателя(Объект.Ссылка);
	//
	//Если Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Новый Тогда
	//	
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Новый, "Новый");		
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.ВРаботе, "В работу");		
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Отменён, "Отменён"); 
	//	
	//ИначеЕсли Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.ВРаботе Тогда 
	//	
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.ВРаботе, "В работу");		
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.ЗапросДоступности, "Запрос доступности");		
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Отменён, "Отменён"); 
	//	
	//ИначеЕсли Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.ЗапросДоступности Тогда 
	//	
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.ЗапросДоступности, "Запрос доступности");
	//	Если СостояниеДокумента = Перечисления.СостоянияЗаказовПокупателей.ГотовКПродаже Тогда 
	//		Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Продажа, "Продажа");
	//	ИначеЕсли СостояниеДокумента = Перечисления.СостоянияЗаказовПокупателей.ГотовКПеремещению Тогда 
	//		Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Перемещение, "Сборка заказа");
	//	КонецЕсли;
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Отменён, "Отменён"); 
	//	
	//ИначеЕсли Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Продажа Тогда 
	//	
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Продажа, "Продажа");
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Отменён, "Отменён"); 
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Закрыт, "Закрыт"); 
	//	
	//ИначеЕсли Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Перемещение Тогда 
	//	
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Перемещение, "Сборка заказа");
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Отменён, "Отменён"); 
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Закрыт, "Закрыт"); 
	//	
	//ИначеЕсли Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Отменён Тогда 
	//	
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.ВРаботе, "В работу");		
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Отменён, "Отменён"); 
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Закрыт, "Закрыт"); 
	//	
	//ИначеЕсли Объект.Статус = Перечисления.СтатусыЗаказовПокупателей.Закрыт Тогда 
	//	
	//	Элементы.Статус.СписокВыбора.Добавить(Перечисления.СтатусыЗаказовПокупателей.Закрыт, "Закрыт"); 
	//	
	//КонецЕсли;
	
 КонецПроцедуры

&НаСервере
Процедура ЗаполнитьМагазиныДляВыбора()
	
	Элементы.МагазинПолучения.СписокВыбора.Очистить();

	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Магазины.Ссылка КАК Ссылка,
		|	Склады.IDN КАК IDN
		|ИЗ
		|	Справочник.Магазины КАК Магазины
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Магазины.СкладПродажи = Склады.Ссылка
		|ГДЕ
		|	Магазины.ВведенВЭксплуатацию";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Элементы.МагазинПолучения.СписокВыбора.Добавить(Выборка.Ссылка, Выборка.IDN);
		
	КонецЦикла;

 КонецПроцедуры

&НаКлиенте
Процедура Подключаемая_ОтобразитьРасчетныеКолонки()
	
	ОтобразитьРасчетныеКолонки();

КонецПроцедуры

&НаКлиенте
Процедура ОтобразитьРасчетныеКолонки(НачальныйВызов = Ложь)

	МассивСогласованногоКоличество = СогласованноеКоличество(); 
	
	ОтобразитьРасчетнуюКолонку(МассивСогласованногоКоличество, "СогласованноеКоличество");
	ОбновитьПредставлениеНоменклатуры();
	
	Если НачальныйВызов Тогда 
		
		МассивЕстьКомментарий = ЕстьКомментарий(); 
		
		ОтобразитьРасчетнуюКолонку(МассивЕстьКомментарий, "ЕстьКомментарий");
		ОтобразитьРасчетнуюКолонку(МассивЕстьКомментарий, "КомментарийПоСтроке"); 
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ОтобразитьРасчетнуюКолонку(МассивКолонок, ИмяКолонки)
	
	Для Каждого СтрокаМассива Из МассивКолонок Цикл
		
		ОтборСтрок = Новый Структура("КлючСвязиЗапросаДоступности", СтрокаМассива.КлючСвязиЗапросаДоступности);
		
		НайденныеСтроки = Объект.Товары.НайтиСтроки(ОтборСтрок);
		
		Для Каждого СтрокаТЧ Из НайденныеСтроки Цикл
			
			СтрокаТЧ[ИмяКолонки] = СтрокаМассива[ИмяКолонки];
			
		КонецЦикла;  
		
	КонецЦикла; 
	
КонецПроцедуры 

&НаСервере
Функция СогласованноеКоличество()
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказПокупателяТовары.КлючСвязиЗапросаДоступности КАК КлючСвязиЗапросаДоступности,
		|	ЕСТЬNULL(ЗапросДоступностиТоваровТовары.Количество, 0) КАК СогласованноеКоличество
		|ИЗ
		|	Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗапросДоступностиТоваров.Товары КАК ЗапросДоступностиТоваровТовары
		|		ПО ЗаказПокупателяТовары.Ссылка = ЗапросДоступностиТоваровТовары.Ссылка.ДокументОснование
		|			И ЗаказПокупателяТовары.КлючСвязиЗапросаДоступности = ЗапросДоступностиТоваровТовары.КлючСвязи
		|ГДЕ
		|	ЗаказПокупателяТовары.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Результат.Добавить(Новый Структура("КлючСвязиЗапросаДоступности, СогласованноеКоличество"
					, Выборка.КлючСвязиЗапросаДоступности
					, Выборка.СогласованноеКоличество));
		
	КонецЦикла;
	
	Возврат Результат;

КонецФункции

&НаСервере
Функция ЕстьКомментарий()
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КомментарийПоСтрокам.КлючСвязи КАК КлючСвязи,
		|	КомментарийПоСтрокам.Комментарий КАК Комментарий
		|ИЗ
		|	РегистрСведений.КомментарийПоСтрокам КАК КомментарийПоСтрокам
		|ГДЕ
		|	КомментарийПоСтрокам.Документ = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Результат.Добавить(Новый Структура("КлючСвязиЗапросаДоступности, ЕстьКомментарий, КомментарийПоСтроке"
					, Выборка.КлючСвязи
					, Истина
					, Выборка.Комментарий));
		
	КонецЦикла;
	
	Возврат Результат;

КонецФункции

&НаСервере
Процедура ОбновитьПредставлениеНоменклатуры()

	Массив = Объект.Товары.Выгрузить(,"Номенклатура").ВыгрузитьКолонку("Номенклатура");
	Соответствие = ПолучитьСоответствиеПредставлений(Массив);
	
	Для Каждого Стр Из Объект.Товары Цикл
		Стр.ПолноеНаименованиеТовара = Соответствие[Стр.Номенклатура];
	КонецЦикла;	

КонецПроцедуры 

&НаСервереБезКонтекста
Функция ПолучитьСоответствиеПредставлений(Ссылка)

	Соответствие = Новый Соответствие;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА НоменклатурнаяИнформация.Наименование ЕСТЬ NULL
		|			ТОГДА Товар.Наименование
		|		ИНАЧЕ НоменклатурнаяИнформация.Наименование
		|	КОНЕЦ КАК ПолноеНаименованиеТовара,
		|	Товар.Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК Товар
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НоменклатурнаяИнформация КАК НоменклатурнаяИнформация
		|		ПО НоменклатурнаяИнформация.Номенклатура = Товар.Ссылка
		|ГДЕ
		|	Товар.Ссылка В (&Ссылка)";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Соответствие.Вставить(ВыборкаДетальныеЗаписи.Ссылка, ВыборкаДетальныеЗаписи.ПолноеНаименованиеТовара);
	КонецЦикла;
	
	Возврат Соответствие;

КонецФункции

#КонецОбласти  

&НаСервере
Процедура ЗаполнитьФИОКлиента()

	Если ЗначениеЗаполнено(Объект.Контрагент) и НЕ Объект.ПолучательТретееЛицо тогда

		Объект.Телефон  = ПолучитьНомерТелефона(Объект.Контрагент);

	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	// ПодключаемоеОборудование
	Если Источник = "ПодключаемоеОборудование"
	   И ВводДоступен() Тогда
		Если ИмяСобытия = "ScanData" Тогда
			
			Если Параметр[1] = Неопределено Тогда
				ТекКод = Параметр[0];
			Иначе
				ТекКод = Параметр[1][1];
			КонецЕсли;
			СтруктураПараметровКлиента = ПолученШтрихкодИзСШК(ТекКод);
			ОбработатьДанныеПоКодуКлиент(СтруктураПараметровКлиента, ТекКод);
			
		КонецЕсли;
	КонецЕсли;
	// Конец ПодключаемоеОборудование
	
КонецПроцедуры


&НаСервере
Функция ДобавитьСкидочныйКупон(МассивНомеров) 
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("СкидочныйКупон",МассивНомеров[0].Номенклатура); 
	МассивСтрок = Объект.ПогашениеСкидочныхКупонов.НайтиСтроки(СтруктураОтбора);
	СтруктураДействий = Новый Структура;
	
	Если МассивСтрок.Количество() > 0 Тогда
		Сообщить("Данный промокод уже был добавлен ранее!");
	Иначе
		ТекущаяСтрока = Объект.ПогашениеСкидочныхКупонов.Добавить();
		ТекущаяСтрока.СкидочныйКупон = МассивНомеров[0].Номенклатура;  
		ТекущаяСтрока.НоминалКупона = МассивНомеров[0].Номенклатура.Номинал;  
		Сообщить("Промокод успешно добавлен!");
	КонецЕсли;
	
	Объект.СкидкиРассчитаны = Ложь;
	
	Модифицированность = Истина;
	Возврат Истина;
	
КонецФункции


&НаСервере
Функция ОбработатьДанныеПОВФормеСервер(СтруктураПараметров, СтруктураПараметровКлиента) Экспорт
	
	Если НЕ СтруктураПараметров.НеизвестныеДанныеПО Тогда
		
		Если СтруктураПараметров.Действие = "ПроверкаВесовыхТоваров" Тогда
			
			ВходящиеПараметры = СтруктураПараметров.ЗначенияПоиска[0];
			ДобавитьНайденныеПозицииТоваров(ВходящиеПараметры);
			СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");
			
		ИначеЕсли СтруктураПараметров.Действие = "ПроверкаТоваров" Тогда
			Если СтруктураПараметров.ЗначенияПоиска.Количество() > 0 Тогда
				
				Если СтруктураПараметров.ЗначенияПоиска.Количество() = 1 Тогда
					
					СтруктураПараметровКлиента.Вставить("ПерейтиНаТоваронуюПозицию", СтруктураПараметров.ЗначенияПоиска[0]);
					СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");
					
//					Если СтруктураПараметров.ЗначенияПоиска[0].ТипНоменклатуры = Перечисления.ТипыНоменклатуры.СкидочныйКупон тогда
//						ОперацияВыполнена = ДобавитьСкидочныйКупон(СтруктураПараметров.ЗначенияПоиска);
//						
//						Если НЕ ОперацияВыполнена Тогда
//							СтруктураПараметровКлиента.Вставить("ТекстПредупреждения",НСтр("ru = 'По считанному штрихкоду определен номер подарочного сертификата.
//								|Он уже присутствует в документе.
//								|Повторный ввод данных не требуется.'"));
//
//						КонецЕсли;
//						СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");
//					Иначе
//						ВходящиеПараметры = СтруктураПараметров.ЗначенияПоиска[0];
//						Если СтруктураПараметров.Свойство("ИспользоватьКоличество") Тогда
//							ВходящиеПараметры.Вставить("Количество", СтруктураПараметров.ИспользоватьКоличество);
//						КонецЕсли;
//						ДобавитьНайденныеПозицииТоваров(ВходящиеПараметры);
//					КонецЕсли;	
				Иначе
					
					ТаблицаТоваров = Новый ТаблицаЗначений;
					ТаблицаТоваров.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
					ТаблицаТоваров.Колонки.Добавить("Характеристика", Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
					ТаблицаТоваров.Колонки.Добавить("Упаковка", Новый ОписаниеТипов("СправочникСсылка.УпаковкиНоменклатуры"));
					
					Для каждого ЗначениеПоиска Из СтруктураПараметров.ЗначенияПоиска Цикл
						ТекущаяСтрока = ТаблицаТоваров.Добавить();
						ЗаполнитьЗначенияСвойств(ТекущаяСтрока, ЗначениеПоиска);
					КонецЦикла;
					
					СтруктураПараметровКлиента.Вставить("ВыборТоваров", ПоместитьВоВременноеХранилище(ТаблицаТоваров));
					
				КонецЕсли;
				
				СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");
				
			КонецЕсли;
		ИначеЕсли СтруктураПараметров.Действие = "ПроверкаСерийныхНомеров" Тогда
			
			Если СтруктураПараметров.ЗначенияПоиска.Количество() > 0 Тогда
				
				ДанныеСерийногоНомера = ЗапасыПовтИсп.ДанныеСерийногоНомера(СтруктураПараметров.ЗначенияПоиска[0]);

				СтруктураСерийногоНомера = Новый Структура;
				СтруктураСерийногоНомера.Вставить("Номенклатура"       , ДанныеСерийногоНомера.Номенклатура);
				СтруктураСерийногоНомера.Вставить("ТипНоменклатуры"    , ДанныеСерийногоНомера.ТипНоменклатуры);
				СтруктураСерийногоНомера.Вставить("Характеристика"     , Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
				СтруктураСерийногоНомера.Вставить("Упаковка"           , Справочники.УпаковкиНоменклатуры.ПустаяСсылка());
				СтруктураСерийногоНомера.Вставить("Количество"         , 1);
				СтруктураСерийногоНомера.Вставить("ПерейтиНаКоличество", Истина);
				СтруктураСерийногоНомера.Вставить("СерийныйНомер"      , ДанныеСерийногоНомера.СерийныйНомер);
				СтруктураПараметровКлиента.Вставить("ДобавитьСерийныеНомера", СтруктураСерийногоНомера);
				СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");

			КонецЕсли;
		
		ИначеЕсли СтруктураПараметров.Действие = "ПроверкаКарт" Тогда
			
			КоличествоКарт = СтруктураПараметров.ЗначенияПоиска.Количество();
			Если КоличествоКарт = 1 Тогда
				ИнформационнаяКарта = СтруктураПараметров.ЗначенияПоиска[0].ИнформационнаяКарта;
				Если ЗначениеЗаполнено(ИнформационнаяКарта) Тогда
					Если ИнформационнаяКарта.ТипКарты = Перечисления.ТипыИнформационныхКарт.Дисконтная Тогда
						Объект.ДисконтнаяКарта = ИнформационнаяКарта;
						СтруктураПараметровКлиента.Вставить("НайденаДисконтнаяКарта");
						Модифицированность = Истина;
					Иначе
						
						СтруктураПараметровКлиента.Вставить("ТекстПредупреждения",НСтр("ru = 'По считанному штрихкоду определена регистрационная карта. 
						|Ввод данных о регистрационной карте в документе не предусмотрен.'"));
					КонецЕсли;
					СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");
				КонецЕсли;
			ИначеЕсли КоличествоКарт > 1 Тогда
				МассивТиповВладельцев = Новый Массив;
				МассивТиповВладельцев.Добавить(Тип("СправочникСсылка.Контрагенты"));
				МассивТиповВладельцев.Добавить(Тип("СправочникСсылка.Пользователи"));
				МассивТиповВладельцев.Добавить(Тип("СправочникСсылка.ФизическиеЛица"));
				ТаблицаКарт = Новый ТаблицаЗначений;
				ТаблицаКарт.Колонки.Добавить("ИнформационнаяКарта", Новый ОписаниеТипов("СправочникСсылка.ИнформационныеКарты"));
				ТаблицаКарт.Колонки.Добавить("ВладелецКарты", Новый ОписаниеТипов(МассивТиповВладельцев));
				
				Для каждого ЗначениеПоиска Из СтруктураПараметров.ЗначенияПоиска Цикл
					ТекущаяСтрока = ТаблицаКарт.Добавить();
					ЗаполнитьЗначенияСвойств(ТекущаяСтрока, ЗначениеПоиска);
				КонецЦикла;
				
				СтруктураПараметровКлиента.Вставить("ВыборКарт", ПоместитьВоВременноеХранилище(ТаблицаКарт));
				СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");
			КонецЕсли;
				
		ИначеЕсли СтруктураПараметров.Действие = "РегистрацияНовойКарты" Тогда
			
			Если СтруктураПараметров.ЗначенияПоиска.Количество() > 0 Тогда
				
				Если СтруктураПараметров.ЗначенияПоиска.Количество() > 1 Тогда
					
					ТаблицаШаблонов = Новый ТаблицаЗначений;
					ТаблицаШаблонов.Колонки.Добавить("ТипШтрихкода");
					ТаблицаШаблонов.Колонки.Добавить("КодКарты");
					
					Для каждого КлючИЗначение Из СтруктураПараметров.ЗначенияПоиска[0] Цикл
						ТаблицаШаблонов.Колонки.Добавить(КлючИЗначение.Ключ);
					КонецЦикла;
					
					Для каждого ЗначениеПоиска Из СтруктураПараметров.ЗначенияПоиска Цикл
						ТекущаяСтрока = ТаблицаШаблонов.Добавить();
						ЗаполнитьЗначенияСвойств(ТекущаяСтрока, ЗначениеПоиска);
					КонецЦикла;
					ТаблицаШаблонов.ЗаполнитьЗначения(СтруктураПараметров.ТипШтрихкода, "ТипШтрихкода");
					ТаблицаШаблонов.ЗаполнитьЗначения(СтруктураПараметров.КодКарты, "КодКарты");
					СтруктураПараметровКлиента.Вставить("РегистрацияНовойКартыВыборШаблона", ПоместитьВоВременноеХранилище(ТаблицаШаблонов, Новый УникальныйИдентификатор()));
					
					ТекстВопроса = НСтр("ru = 'Создать новую информационную карту? Карта %КодКарты%.'");
					ТекстВопроса = СтрЗаменить(ТекстВопроса, "%КодКарты%", СтруктураПараметров.КодКарты);
					
					СтруктураПараметровКлиента.Вставить("ТекстВопросаНовойКарты", ТекстВопроса);
				Иначе
					СтруктураПараметровКлиентаРегистрацииНовойКарты = СтруктураПараметров.ЗначенияПоиска[0];
					СтруктураПараметровКлиентаРегистрацииНовойКарты.Вставить("ТипШтрихкода", СтруктураПараметров.ТипШтрихкода);
					СтруктураПараметровКлиентаРегистрацииНовойКарты.Вставить("КодКарты"    , СтруктураПараметров.КодКарты);
					
					СтруктураПараметровКлиента.Вставить("РегистрацияНовойКарты", СтруктураПараметровКлиентаРегистрацииНовойКарты);
					
					ТекстВопроса = НСтр("ru = 'Создать новую информационную карту? Карта %КодКарты%%НаименованиеШаблона%'");
					ТекстВопроса = СтрЗаменить(ТекстВопроса, "%КодКарты%", СтруктураПараметров.КодКарты);
					Если СтруктураПараметровКлиентаРегистрацииНовойКарты.Свойство("НаименованиеШаблона") Тогда
						Если ПустаяСтрока(СтруктураПараметровКлиентаРегистрацииНовойКарты.НаименованиеШаблона) Тогда
							ТекстВопроса = СтрЗаменить(ТекстВопроса, "%НаименованиеШаблона%", ".");
						Иначе
							ТекстВопроса = СтрЗаменить(ТекстВопроса, "%НаименованиеШаблона%", " (" + СтруктураПараметровКлиентаРегистрацииНовойКарты.НаименованиеШаблона+").");
						КонецЕсли;
					КонецЕсли;
					
					СтруктураПараметровКлиента.Вставить("ТекстВопросаНовойКарты", ТекстВопроса);
				КонецЕсли;
				
				СтруктураПараметровКлиента.Вставить("ПрекратитьПоиск");
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	Возврат СтруктураПараметровКлиента;
	
КонецФункции


&НаСервере
Функция ПолучитьНомерТелефона(КонтрагентСсылка) Экспорт
	НомерТелефона = "";	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КонтрагентыКонтактнаяИнформация.НомерТелефона КАК НомерТелефона
		|ИЗ
		|	Справочник.Контрагенты.КонтактнаяИнформация КАК КонтрагентыКонтактнаяИнформация
		|ГДЕ
		|	КонтрагентыКонтактнаяИнформация.Вид = &Вид
		|	И КонтрагентыКонтактнаяИнформация.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Вид", Справочники.ВидыКонтактнойИнформации.ТелефонКонтрагента);
	Запрос.УстановитьПараметр("Ссылка", КонтрагентСсылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		НомерТелефона = ВыборкаДетальныеЗаписи.НомерТелефона;
	КонецЦикла;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

	Возврат НомерТелефона;
	
КонецФункции


&НаКлиенте
Процедура СкладСборкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Если  Не Объект.Товары.Количество() = 0 Тогда 
		СтандартнаяОбработка = Ложь; 
		
		МассивТоваров = Новый Массив;
		Для Каждого СтрокаТЧ Из Объект.Товары Цикл
			
			Если Не СтрокаТЧ.Отменено Тогда
				СтруктураТовара = Новый Структура("Товар, Количество", СтрокаТЧ.Номенклатура, СтрокаТЧ.Количество);
				МассивТоваров.Добавить(СтруктураТовара);
			КонецЕсли;
			
		КонецЦикла; 
		
		ДанныеВыбора = Новый СписокЗначений;
		ТоварыСкладНачалоВыбораНаСервере(МассивТоваров, ДанныеВыбора);
		
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура СкладСборкиОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Для Каждого СтрокаТЧ Из Объект.Товары Цикл 
		
		Если Не СтрокаТЧ.Отменено Тогда
			
			СтрокаТЧ.Склад = ВыбранноеЗначение;
		
		КонецЕсли;
	
	КонецЦикла;
	
	Модифицированность = Истина;

КонецПроцедуры

&НаКлиенте
Процедура Город2ПриИзменении(Элемент)

	Если ЗначениеЗаполнено(Объект.Город) тогда
		Объект.Область = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Город,"Область");  
		Объект.Район   = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Город,"Район");
	Иначе
		ОчиститьРайонИОбластьНаСервере();		
	КонецЕсли;

КонецПроцедуры


&НаКлиенте
Процедура ТоварыКомментарийПоСтрокеПриИзменении(Элемент)
	
	Если ПустаяСтрока(Элементы.Товары.ТекущиеДанные.КомментарийПоСтроке) Тогда 
		Элементы.Товары.ТекущиеДанные.ЕстьКомментарий = Ложь;
	Иначе 
		Элементы.Товары.ТекущиеДанные.ЕстьКомментарий = Истина;
	КонецЕсли;

КонецПроцедуры


&НаКлиенте
Процедура ОтправитьСообщениеКлиенту(Команда) 
	Если Не ПустаяСтрока(НомерТелефонаКлиента) И Не Объект.Контрагент.Пустая() Тогда 
		СтандартнаяОбработка = Ложь;
		
		//Оповещение = Новый ОписаниеОповещения("ОтправитьСообщениеКлиентуЗавершение", ЭтотОбъект);
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("НомерТелефона", НомерТелефонаКлиента);
		ПараметрыФормы.Вставить("Контрагент", Объект.Контрагент);
		ПараметрыФормы.Вставить("ЗаказКлиента", Объект.Ссылка);
		
		//ОткрытьФорму("Документ.ЗаказПокупателя.Форма.ФормаОтправкиСообщения", ПараметрыФормы,,,,, Оповещение); 
		ОткрытьФорму("Документ.ЗаказПокупателя.Форма.ФормаОтправкиСообщения", ПараметрыФормы); 
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьСообщениеКлиентуЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	//Если ТипЗнч(Результат) = Тип("Структура") Тогда
	//	РегистрыСведений.КомментарийИнтернетЗаказа.ЗаписьКомментария(Объект.Ссылка, Результат.Автор, Результат.ТекстСообщения)
	//КонецЕсли; 
КонецПроцедуры

&НаКлиенте
Процедура Оплатить(Команда)
	Если ЭтотОбъект.Модифицированность или Не ЗначениеЗаполнено(Объект.Ссылка) Тогда 
		Сообщить("Сначало запишите документ");
	Иначе
		Если Элементы.ОплатаЗаказа.ТекущиеДанные.Сумма = 0 Тогда 
			Сообщить("Не указанна сумма");
		Иначе
			Элементы.ОплатаЗаказа.ТекущиеДанные.ИДОплаты = ОбменСБанкамиLiqPayСервер.ОплатитьНаСервере(
				Объект.Номер, 
				Объект.Ссылка, 
				НомерТелефонаКлиента, 
				Элементы.ОплатаЗаказа.ТекущиеДанные.НомерОплаты,
				Элементы.ОплатаЗаказа.ТекущиеДанные.Сумма,
				Элементы.ОплатаЗаказа.ТекущиеДанные.ИДОплаты); 
				
			Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.ОтправленаСсылка");
			Записать();
			//Модифицированность = Истина;
		КонецЕсли;  
	КонецЕсли;
	ВидимостьКнопкиОплаты();
	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьОплату(Команда)
	Если Модифицированность или Не ЗначениеЗаполнено(Объект.Ссылка) Тогда 
		Сообщить("Сначало запишите документ");
	Иначе
		ОтветСервера = ПроверитьОплатуНаСервере(Элементы.ОплатаЗаказа.ТекущиеДанные.НомерОплаты);
		
		Если ОтветСервера.ОплатаПроизведена	Тогда 	
			Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.Оплачен"); 
			Элементы.ОплатаЗаказа.ТекущиеДанные.Сумма = ОтветСервера.Сумма; 
			Элементы.ОплатаЗаказа.ТекущиеДанные.Отменён = Ложь;
			Записать();
		Иначе 
			Сообщить(ОтветСервера.ТекстОшибки);
		КонецЕсли; 
	КонецЕсли; 
	ВидимостьКнопкиОплаты();
	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
КонецПроцедуры

&НаСервере
Функция ПроверитьОплатуНаСервере(НомерОплаты)
	
	СтруктураОтвета = Новый Структура("ОплатаПроизведена, ТекстОшибки, Сумма", Ложь, "", 0);
	
	public_key = ОбменСБанкамиПовтИсп.ДанныеLiqPay().public_key;

 	order_id = СокрЛП(Объект.Номер) + ?(НомерОплаты = 0, "", "-" + Строка(НомерОплаты));;
	
	СтруктураЗапроса = Новый Структура;
	СтруктураЗапроса.Вставить("public_key", public_key);
	СтруктураЗапроса.Вставить("version", "3");
	СтруктураЗапроса.Вставить("action", "status");
	СтруктураЗапроса.Вставить("order_id", order_id);
    ЗаписьJSON = Новый ЗаписьJSON; 
    ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));  
	ЗаписатьJSON(ЗаписьJSON,СтруктураЗапроса);
    СтрокаJSON = ЗаписьJSON.Закрыть();
	
	ДанныеДляОтправки = ОбменСБанкамиСервер.СформироватьДанныеLiqPay(СтрокаJSON);
	
	Заголовки = Новый Соответствие();
    Заголовки.Вставить("Content-Type", "application/x-www-form-urlencoded");
    Соединение = Новый HTTPСоединение("liqpay.ua", , , , , , Новый ЗащищенноеСоединениеOpenSSL());
    HTTPЗапрос = 
        Новый HTTPЗапрос(
                "/api/request"
            ,    Заголовки
        );
		
	HTTPЗапрос.УстановитьТелоИзСтроки("&data=" + ДанныеДляОтправки.Данные + "&signature=" + ДанныеДляОтправки.Сигнатура);
    HTTPОтвет = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
	СтрокаЗапроса = HTTPОтвет.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(СтрокаЗапроса);
	Результат = ПрочитатьJSON(ЧтениеJSON);
	
	РегистрыСведений.КомментарийИнтернетЗаказа.ЗаписьКомментария(Объект.Ссылка, ПараметрыСеанса.ТекущийПользователь, СтрокаЗапроса);
	
	Если Результат.Свойство("status")
			И Результат.Свойство("order_id")
			И Результат.status = "success" Тогда 
			
		СтруктураОтвета.ОплатаПроизведена = Истина;
		СтруктураОтвета.Сумма = Результат.amount;
		
		СтрокаКомментария = "Заказ на оплату №" + order_id + " оплачен";
		
		РегистрыСведений.КомментарийИнтернетЗаказа.ЗаписьКомментария(Объект.Ссылка, ПараметрыСеанса.ТекущийПользователь, СтрокаКомментария);
		
	Иначе
		
		Если Результат.Свойство("err_description") Тогда
			
			СтруктураОтвета.ТекстОшибки = "Нет оплаты. Статус: " + Результат.err_description;
			
		Иначе 
			 СтруктураОтвета.ТекстОшибки = "Ошибка запроса. Повторите позже";
			 
		КонецЕсли;
		
	КонецЕсли; 
	
	Возврат СтруктураОтвета;

КонецФункции

&НаКлиенте
Процедура ВидимостьКнопкиОплаты() 
	
	ОплатаПриват 		= Ложь;
	ОтправитьСсылку 	= Ложь;
	Отменён 			= Ложь; 
	СсылкаОтправлена 	= Ложь; 
	ОплатаНаличные 		= Ложь;	  
	
	Если Не Элементы.ОплатаЗаказа.ТекущиеДанные = Неопределено
			И Элементы.ОплатаЗаказа.ТекущиеДанные.ВидОплаты = ПредопределенноеЗначение("Перечисление.ВидыОплатыЗаказаПокупателя.Оплата") Тогда
		
		ОплатаПриват = (Элементы.ОплатаЗаказа.ТекущиеДанные.ТипОплаты = ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.ОплатаКартойПриват"));
		ОплатаНаличные = (Элементы.ОплатаЗаказа.ТекущиеДанные.ТипОплаты = ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.Наличные"));
		ОтправитьСсылку = (Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.НеОплачен"));
		СсылкаОтправлена = (Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.ОтправленаСсылка"));
		Отменён = Элементы.ОплатаЗаказа.ТекущиеДанные.Отменён;
		
	КонецЕсли;
	
	Элементы.Оплатить.Видимость = 								ОплатаПриват И ОтправитьСсылку И Не СсылкаОтправлена И Не Отменён;
	Элементы.ПроверитьОплату.Видимость =						ОплатаПриват;
	Элементы.ОплатаЗаказаРедактироватьСуммуОплаты.Видимость = 	ОплатаПриват И Не ОтправитьСсылку И СсылкаОтправлена И Не Отменён;
	
	Элементы.ОплатаЗаказаСтатусОплаты.ТолькоПросмотр = ОплатаПриват Или ОплатаНаличные; 

КонецПроцедуры

&НаКлиенте
Процедура ОплатаЗаказаПриАктивизацииСтроки(Элемент)
	
	ВидимостьКнопкиОплаты();

КонецПроцедуры

&НаКлиенте
Процедура ОплатаЗаказаПередУдалением(Элемент, Отказ)
	
	Если Элемент.ТекущиеДанные.Сумма = 0 Тогда
		Отказ = Ложь;
	Иначе
		Отказ = Истина;
	КонецЕсли;
	 
КонецПроцедуры

&НаКлиенте
Процедура ОплатаЗаказаПередНачаломИзменения(Элемент, Отказ)
	Отказ = Истина;
	Если Не Элементы.ОплатаЗаказа.ТекущиеДанные = Неопределено 
			И Не Элементы.ОплатаЗаказа.ТекущиеДанные.Отменён Тогда
		Если Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.НеОплачен") Тогда
			Отказ = Ложь; 
		ИначеЕсли Не Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.Оплачен") 
				И Элемент.ТекущийЭлемент.Имя = "ОплатаЗаказаОтменен" Тогда 
			Отказ = Ложь;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры 

&НаКлиенте
Процедура ОплатаЗаказаПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)

	Если Модифицированность Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'Спочатку треба записати заказ!';
			|		uk = 'Спочатку треба записати заказ!'"));
		Отказ = Истина;
		
	КонецЕсли;
	
	Если Копирование Тогда
		
		Отказ = Истина;
		
	Иначе
		
		СуммаОплаченныхСтрок = 0; 
		МаксимальныйНомерОплаты = 0;
		ПодсчетДанныхСтрокОплаты(СуммаОплаченныхСтрок, МаксимальныйНомерОплаты); 
		
		Если СуммаОплаченныхСтрок = СуммаВсегоДляОплаты Тогда
			
			Отказ = Истина;
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПодсчетДанныхСтрокОплаты(СуммаОплаченныхСтрок, МаксимальныйНомерОплаты)
	Для Каждого СтрокиОплаты Из Объект.ОплатаЗаказа Цикл
		Если Не СтрокиОплаты.Отменён Тогда 
			СуммаОплаченныхСтрок = СуммаОплаченныхСтрок 
				+ СтрокиОплаты.Сумма 
				* ?(СтрокиОплаты.ВидОплаты = ПредопределенноеЗначение("Перечисление.ВидыОплатыЗаказаПокупателя.Возврат"), -1, 1); 
		КонецЕсли;
		
		Если МаксимальныйНомерОплаты <= СтрокиОплаты.НомерОплаты Тогда
			МаксимальныйНомерОплаты = СтрокиОплаты.НомерОплаты + 1;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ОплатаЗаказаПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)

	ИнформацияОбОплате = ИнформацияОбОплате();

	Если НоваяСтрока Тогда
		СуммаОплаченныхСтрок = 0; 
		Элемент.ТекущиеДанные.Сумма = СуммаВсегоДляОплаты;
		МаксимальныйНомерОплаты = 0;
		ПодсчетДанныхСтрокОплаты(СуммаОплаченныхСтрок, МаксимальныйНомерОплаты); 
		Элемент.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.НеОплачен");
		Элемент.ТекущиеДанные.НомерОплаты = МаксимальныйНомерОплаты; 
		СуммаСтрокиДляОплаты = 0;
		
		Если СуммаОплаченныхСтрок > СуммаВсегоДляОплаты Тогда 
			СуммаСтрокиДляОплаты = СуммаВсегоДляОплаты - (СуммаОплаченныхСтрок - Элемент.ТекущиеДанные.Сумма); 
			Элемент.ТекущиеДанные.Сумма = СуммаСтрокиДляОплаты;
		КонецЕсли;
		
		Если СуммаСтрокиДляОплаты >= 0 Тогда
			Элемент.ТекущиеДанные.ВидОплаты = ПредопределенноеЗначение("Перечисление.ВидыОплатыЗаказаПокупателя.Оплата");
		Иначе
			Элемент.ТекущиеДанные.ВидОплаты = ПредопределенноеЗначение("Перечисление.ВидыОплатыЗаказаПокупателя.Возврат");
			Элемент.ТекущиеДанные.Сумма = - СуммаСтрокиДляОплаты;
		КонецЕсли;
		
		ИнформацияОбОплате.АктивныеСтроки = ИнформацияОбОплате.АктивныеСтроки + 1;

	КонецЕсли;
	
	Если ИнформацияОбОплате.АктивныеСтроки <= 1 Тогда
		
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Очистить();
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.Наличные"));
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.БРПредоплата"));
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.БРПостоплата"));
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.БезналичныйРасчетДляФизЛиц"));
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.ОплатаКартойПриват"));
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.amida_payparts"));
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ПредопределенноеЗначение("Перечисление.ТипОплатыЗаказПокупателя.monobank"));
		
	Иначе
		
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Очистить();
		Элементы.ОплатаЗаказаТипОплаты.СписокВыбора.Добавить(ИнформацияОбОплате.ТипОплаты);
		Элемент.ТекущиеДанные.ТипОплаты = ИнформацияОбОплате.ТипОплаты;
		
	КонецЕсли;	
	
	ВидимостьКнопкиОплаты();
		
КонецПроцедуры

&НаСервере
Функция ИнформацияОбОплате()
	Возврат Документы.ЗаказПокупателя.ИнформацияОбОплате(Объект.Ссылка);
КонецФункции

&НаКлиенте
Процедура ОплатаЗаказаПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	Если Не ОтменаРедактирования Тогда
		Если Элемент.ТекущиеДанные.Отменён И Не ПустаяСтрока(Элемент.ТекущиеДанные.ИДОплаты) Тогда
			
			ОтветСервера = ПроверитьОплатуНаСервере(Элементы.ОплатаЗаказа.ТекущиеДанные.НомерОплаты);
			
			Если ОтветСервера.ОплатаПроизведена	Тогда 	
				Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.Оплачен"); 
				Элементы.ОплатаЗаказа.ТекущиеДанные.Сумма = ОтветСервера.Сумма; 
				Элементы.ОплатаЗаказа.ТекущиеДанные.Отменён = Ложь;
			Иначе
				ОбменСБанкамиLiqPayСервер.ОплатитьНаСервере(Объект.Номер, Объект.Ссылка, НомерТелефонаКлиента, 0, 0, Элемент.ТекущиеДанные.ИДОплаты, Ложь);
				Элемент.ТекущиеДанные.ИДОплаты = "";
			КонецЕсли;
			
		КонецЕсли;
		
		ВидимостьКнопкиОплаты();
		Если Не Элемент.ТекущиеДанные.Отменён Тогда 
			СуммаОплаченныхСтрок = 0; 
			МаксимальныйНомерОплаты = 0;
			ПодсчетДанныхСтрокОплаты(СуммаОплаченныхСтрок, МаксимальныйНомерОплаты);
			Если СуммаОплаченныхСтрок > СуммаВсегоДляОплаты Тогда 
				Элемент.ТекущиеДанные.Сумма = СуммаВсегоДляОплаты - (СуммаОплаченныхСтрок - Элемент.ТекущиеДанные.Сумма); 
			КонецЕсли;   
		КонецЕсли;
		
		ЗаписатьОплату(Элемент.ТекущиеДанные.ПолучитьИдентификатор());
		
		Объект.ТипОплаты = Элемент.ТекущиеДанные.ТипОплаты;
		
		ВидимостьЭлементов();
	
	КонецЕсли; 
	ОбновитьИтоговыеПоказатели(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриАктивизацииСтроки(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если Не ТекущаяСтрока = Неопределено Тогда
		
		Элементы.ТоварыНоменклатура.ТолькоПросмотр = 
			Не (ТекущаяСтрока.Номенклатура = ПредопределенноеЗначение("Справочник.Номенклатура.ПустаяСсылка"));
		
	КонецЕсли;

КонецПроцедуры


&НаСервере
Процедура ЗаписатьОплату(НомерСтрокиОплаты)
	
	Если Не Объект.Ссылка.Пустая() Тогда

		СтрокаОплаты = Объект.ОплатаЗаказа.НайтиПоИдентификатору(НомерСтрокиОплаты);
		
		СтруктураЗаписи = РегистрыСведений.ОплатаЗаказаКлиента.ИнициализацияСтруктурыЗаписи();
			
		СтруктураЗаписи.ВидОплаты	 	= СтрокаОплаты.ВидОплаты;
		СтруктураЗаписи.ЗаказКлиента 	= Объект.Ссылка;
		СтруктураЗаписи.НомерОплаты 	= СтрокаОплаты.НомерОплаты;
		СтруктураЗаписи.ТипОплаты 		= СтрокаОплаты.ТипОплаты; 
		СтруктураЗаписи.Сумма 			= СтрокаОплаты.Сумма;
		СтруктураЗаписи.СтатусОплаты 	= СтрокаОплаты.СтатусОплаты;
		СтруктураЗаписи.Отменён 		= СтрокаОплаты.Отменён;
		СтруктураЗаписи.ДатаОплаты 		= ?(СтрокаОплаты.СтатусОплаты = Перечисления.СтатусОплаты.Оплачен, ТекущаяДатаСеанса(), Дата(1,1,1));
		СтруктураЗаписи.ИДОплаты 		= СтрокаОплаты.ИДОплаты;
		
		РегистрыСведений.ОплатаЗаказаКлиента.ЗаписьСтрокиВРегистр(СтруктураЗаписи);
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура РедактироватьСуммуОплаты(Команда)  
	
	Если Не Элементы.ОплатаЗаказа.ТекущиеДанные = Неопределено Тогда
		
		Оповещение = Новый ОписаниеОповещения("ПослеОтветаНаВопрос",
			ЭтотОбъект);
			
		ПоказатьВопрос(Оповещение,
			"Ссылка на оплату этой суммы отправленна. Для редактирования суммы ссылку нужно удалить. Желаете это сделать?",  // вместо привычного "Вопрос", теперь "ПоказатьВопрос"
			РежимДиалогаВопрос.ДаНет,
			0,  // задержка (секунды). необязательно
			КодВозвратаДиалога.Нет, // задает кнопку по умолчанию. необязательно
			"Редактирование суммы оплаты" // устанавливаем заголовок. необязательно
		);   
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПослеОтветаНаВопрос(Результат, Параметры) Экспорт // здесь, думаю, комментировать нечего
	
	Если Результат = КодВозвратаДиалога.Да Тогда 
		
		ОбменСБанкамиLiqPayСервер.ОплатитьНаСервере(
			Объект.Номер, 
			Объект.Ссылка, 
			НомерТелефонаКлиента, 
			0, 
			0, 
			Элементы.ОплатаЗаказа.ТекущиеДанные.ИДОплаты, 
			Ложь);
		Элементы.ОплатаЗаказа.ТекущиеДанные.ИДОплаты = "";
		Элементы.ОплатаЗаказа.ТекущиеДанные.СтатусОплаты = ПредопределенноеЗначение("Перечисление.СтатусОплаты.НеОплачен");
		ВидимостьКнопкиОплаты();
		ОбновитьИтоговыеПоказатели(ЭтотОбъект);
		
	КонецЕсли; 

КонецПроцедуры
 
#Область БонусныеБаллы

&НаКлиенте	//	LNK 28.02.2021 08:24:18
Функция ПроверитьВозможностьИспользованияБонусов(ПараметрыОткрытия)

	ТекстСообщения = "";
	
	Если ПустаяСтрока(ПараметрыОткрытия.НомерТелефона) Тогда

		ТекстСообщения = ТекстСообщения + ?(ПустаяСтрока(ТекстСообщения), "", Символы.ПС)
		+ "Не указан номер телефона для авторизации.";

	КонецЕсли;

	Если НЕ ПустаяСтрока(ТекстСообщения) Тогда

		ОбщегоНазначенияРТКлиент.ВывестиИнформациюДляРМК("Авторизация невозможна.", ТекстСообщения);

	КонецЕсли;

	Возврат ПустаяСтрока(ТекстСообщения);

КонецФункции

&НаКлиенте
Процедура ОткрытьФормуИспользованияБонусов()	
	
	МожноОплатаитьБонусами = ПровиритьОплатуЗаказа();
	Если МожноОплатаитьБонусами тогда
		ОткрытьФормуОплаты();	
	КонецЕсли;
КонецПроцедуры 


&НаСервере
Функция ПровиритьОплатуЗаказа() 
	Если Объект.ТипДоставки = Перечисления.ТипДоставкиЗаказПокупателя.Самовывоз или Объект.ТипДоставки = Перечисления.ТипДоставкиЗаказПокупателя.Смешаный тогда 
		Если Объект.ОплатаЗаказа.Количество() = 0 тогда  
			Сообщить("Не заполнена оплата заказа! Использование бонусов невозможно!");
		    Возврат Ложь;
		Иначе 
			НайденныеСтроки = Объект.ОплатаЗаказа.НайтиСтроки(
			Новый Структура("ТипОплаты,Отменён"	, Перечисления.ТипОплатыЗаказПокупателя.Наличные,Ложь));

			Если НайденныеСтроки.Количество() = 0 Тогда
		       Возврат Истина;
		  	Иначе
				Сообщить("Выбрана оплата на кассе магазина. Использование бонусов возможно только на кассе!");
			    Возврат Ложь;
			КонецЕсли;
		КонецЕсли;	
	Иначе
		Возврат Истина;
	КонецЕсли;

КонецФункции
&НаКлиенте
Процедура ОткрытьФормуОплаты()

	ОтменитьРучнуюОплатуБонуснымиБалламиНаСервере();
	Если ЗначениеЗаполнено(Объект.Телефон) тогда
		Телефон = Объект.Телефон;	
	Иначе	
		Телефон = ПолучитьНомерТелефона(Объект.Контрагент);	
	КонецЕсли;
	ПараметрыОткрытия = Новый Структура;
	ПараметрыОткрытия.Вставить("Контрагент"			, Объект.ВладелецДисконтнойКарты);
	ПараметрыОткрытия.Вставить("Магазин"			, Объект.Магазин);
	ПараметрыОткрытия.Вставить("ТоварыДляОплаты"	, БонусныеБаллыКлиент.ТоварыДляОплатыБонусами(Объект.Товары,Истина));
	ПараметрыОткрытия.Вставить("НомерТелефона"		, Телефон);
	Если Не Объект.СуммаБонусныхБалловСписано = 0 Тогда
		
		ПараметрыОткрытия.Вставить("РежимКонтрольногоОткрытия"		, Истина);
		ПараметрыОткрытия.Вставить("СуммаБонусовДляСписания"		, Объект.СуммаБонусныхБалловСписано);
		
	КонецЕсли;

	Если ПроверитьВозможностьИспользованияБонусов(ПараметрыОткрытия) Тогда

		ОписаниеОповещения = Новый ОписаниеОповещения("КомандаИспользованиеБонусовЗавершение", ЭтаФорма);
		ОткрытьФорму(РМККлиент.КонтекстИмениФормы("Обработка.РМК.Форма.ФормаИспользованиеБонусов", "Интернет заказ")
			, ПараметрыОткрытия
			, ЭтаФорма
			, УникальныйИдентификатор
			,,, ОписаниеОповещения
			, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
		);

	КонецЕсли;  

КонецПроцедуры

&НаСервере	//	LNK 23.06.2021 09:48:36
Функция ОтменитьРучнуюОплатуБонуснымиБалламиНаСервере()	

	ТаблицаОплатаИзменена = БонусныеБаллыВызовСервера.ОчиститьОплатуБонуснымиБаллами(Объект, "Товары", "ОплатаБонуснымиБаллами", БонусныеБаллыПовтИсп.УправляемыеТипыБонусов(), Объект.ОплатаБонуснымиБаллами.Количество() = 0);

	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

    //Выберем всех регистраторов регистра
    Запрос = Новый Запрос;
    Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
    |	БонусныеБаллыПоЗаказамПокупателей.Регистратор
    |ИЗ
    |	РегистрНакопления.БонусныеБаллыПоЗаказамПокупателей КАК БонусныеБаллыПоЗаказамПокупателей
    |ГДЕ
    |	БонусныеБаллыПоЗаказамПокупателей.Регистратор = &Регистратор";
    Запрос.УстановитьПараметр("Регистратор", Объект.Ссылка);
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    //Обойдем регистраторов
    Пока Выборка.Следующий() Цикл

        //Для каждого регистратора выполним изменение набора записей
        НаборЗаписей = РегистрыНакопления.БонусныеБаллыПоЗаказамПокупателей.СоздатьНаборЗаписей(); 
        НаборЗаписей.Отбор.Регистратор.Значение = Выборка.Регистратор;
        НаборЗаписей.Прочитать();
        Для каждого Запись Из НаборЗаписей Цикл
            Запись.СуммаБонусныхБаллов = 0;
        КонецЦикла;
        НаборЗаписей.Записать();
    КонецЦикла; 

	Возврат ТаблицаОплатаИзменена;

КонецФункции

&НаКлиенте	//	LNK 26.02.2021 13:10:01
Функция КомандаИспользованиеБонусовЗавершение(ДанныеПрименения, ДополнительныеПараметры) Экспорт	

	Если ТипЗнч(ДанныеПрименения) = Тип("Структура") Тогда

		ПрименитьКОбъектуОплатуБонуснымиБаллами(ДанныеПрименения);
		ЗаписатьЧекККМПоВсемДанным(Объект.Организация, ПредопределенноеЗначение("Перечисление.СтатусыЧековККМ.ПустаяСсылка"), Истина);
	
		Модифицированность = Истина;

	КонецЕсли;

	//ОтобразитьСкидки();
	//ОбновитьИнформациюОбщейСуммы();

	//ТабличноеПолеЧеков[0].Сумма = Объект.Товары.Итог("СуммаВсего");	//	LNK 23.06.2021 10:35:23
	//ЭтаФорма.Прочитать();
	Возврат ПолучитьПараметрыОплатыСуммы();

КонецФункции

&НаСервере
Функция ЗаписатьЧекККМПоВсемДанным(Организация, СтатусЧекаККМ = Неопределено, ЗагрузкаДанных = Ложь)
  	//ОбъектЧекККМ = РеквизитФормыВЗначение("Объект");

	//Если НЕ ОбъектЧекККМ = Неопределено Тогда

	//	ОбъектЧекККМ.Дата = ОбщегоНазначенияВызовСервера.ТекущаяДатаСервера();

	//Иначе

	//	ОбъектЧекККМ = Документы.ЧекККМ.СоздатьДокумент();
	//	ОбъектЧекККМ.УстановитьСсылкуНового(?(ЧекККМВОбработке.Пустая(), Документы.ЧекККМ.ПолучитьСсылку(), ЧекККМВОбработке));
	//	ОбъектЧекККМ.Дата = ОбщегоНазначенияВызовСервера.ТекущаяДатаСервера();

	//	ЧекККМВОбработке = ОбъектЧекККМ.ПолучитьСсылкуНового();

	//КонецЕсли;
	ЗаполнитьЧекПоВсемДанным(Объект);
	
	//ОбъектЧекККМ.РежимРМК      = Истина;
	//ОбъектЧекККМ.Ответственный = ПараметрыСеанса.ТекущийПользователь;

	//Если НЕ СтатусЧекаККМ = Неопределено Тогда

	//	ОбъектЧекККМ.СтатусЧекаККМ = СтатусЧекаККМ;

	//КонецЕсли;

	Объект.СуммаДокумента = ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСуммуДокумента(Объект.Товары, Объект.ЦенаВключаетНДС);
//
//	Если ЗагрузкаДанных = Истина Тогда
//
//		Объект.ОбменДанными.Загрузка = Истина;
//
//	КонецЕсли;
//
//	Объект.Записать(РежимЗаписиДокумента.Запись);
//
	ЧекККМВОбработке = Объект.Ссылка;

	Возврат ЧекККМВОбработке;

КонецФункции

&НаСервере
Процедура ЗаполнитьЧекПоВсемДанным(ОбъектЧекККМ)

//	LNK 30.08.2017 15:10:25
	Для каждого СтрокаТовары Из ОбъектЧекККМ.Товары Цикл

		Если СтрокаТовары.ПричинаРучнойСкидки.Пустая() Тогда

			СтрокаТовары.Содержание = "";

		КонецЕсли;
		СтрокаТовары.Сумма =  	СтрокаТовары.Цена*СтрокаТовары.Количество- СтрокаТовары.СуммаАвтоматическойСкидки - СтрокаТовары.СуммаРучнойСкидки -СтрокаТовары.СуммаБонусныхБалловСписано ;
	КонецЦикла;
	
	Объект.СуммаБонусныхБалловСписано = Объект.Товары.Итог("СуммаБонусныхБалловСписано");
	БонусныеБаллыСервер.ЗаполнитьКлючСвязиБонусныхБаллов(Объект.Товары);

	//ЗаполнитьЗначенияСвойств(ОбъектЧекККМ, Объект,, "Ссылка, Дата");
	//
	//ОбработатьТоварыПодарочныеСертификаты("Сохранение");	//	LNK 18.02.2020 11:17:19

	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.Товары                         , ОбъектЧекККМ.Товары, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.УправляемыеСкидки              , ОбъектЧекККМ.УправляемыеСкидки, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.Подарки                        , ОбъектЧекККМ.Подарки, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.СкидкиНаценки                  , ОбъектЧекККМ.СкидкиНаценки, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.СерийныеНомера                 , ОбъектЧекККМ.СерийныеНомера, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.Серии                          , ОбъектЧекККМ.Серии, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.Оплата                         , ОбъектЧекККМ.Оплата, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.ПогашениеПодарочныхСертификатов, ОбъектЧекККМ.ПогашениеПодарочныхСертификатов, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.ПогашениеСкидочныхКупонов	 	 , ОбъектЧекККМ.ПогашениеСкидочныхКупонов, Истина);
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.ВыдачаСкидочныхКупонов	 	 , ОбъектЧекККМ.ВыдачаСкидочныхКупонов, Истина);	//	LNK 19.11.2019 10:59:09
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.НачислениеБонусныхБаллов	 	 , ОбъектЧекККМ.НачислениеБонусныхБаллов, Истина);				//	LNK 01.02.2021 11:28:08
	//ОбщегоНазначенияРТСервер.ЗагрузитьВТаблицуЗначений(Объект.ОплатаБонуснымиБаллами	 	 , ОбъектЧекККМ.ОплатаБонуснымиБаллами, Истина);				//	LNK 01.02.2021 11:28:08

	//ОбработатьТоварыПодарочныеСертификаты("Восстановление");	//	LNK 18.02.2020 15:01:40

	//ДанныеХранилища = Документы.ЧекККМ.ПолучитьДанныеХранилища(ОбъектЧекККМ.Хранилище, Истина);	//	LNK 29.10.2020 05:18:55

	//Для каждого СтрокаОплата Из Объект.Оплата Цикл	//	LNK 29.10.2020 05:47:11

	//	Если НЕ ПустаяСтрока(СтрокаОплата.ОтветЭквайрера) Тогда

	//		ДанныеХранилища.ОтветЭквайрера.Вставить(СтрокаОплата.ВидОплаты, ЗначениеИзСтрокиВнутр(СтрокаОплата.ОтветЭквайрера));

	//	КонецЕсли;

	//КонецЦикла;

	//ОбъектЧекККМ.Хранилище = Новый ХранилищеЗначения(ДанныеХранилища, Новый СжатиеДанных(9));

КонецПроцедуры

&НаСервере	//	LNK 19.06.2021 08:06:42
Процедура ПрименитьКОбъектуОплатуБонуснымиБаллами(ДанныеПрименения)

	ДанныеРаспределения = ПолучитьИзВременногоХранилища(ДанныеПрименения.АдресДанныеРаспределенияВоВременномХранилище);

	БонусныеБаллыВызовСервера.ПрименитьРезультатыРаспределенияОплатыБонуснымиБалламиКОбъекту(Объект, "Товары", "ОплатаБонуснымиБаллами", ДанныеРаспределения);

	Если НЕ Объект.ОплатаБонуснымиБаллами.Количество() = 0 тогда // ИЛИ ЗаказПокупателяЗаполнен(Объект.ЗаказПокупателя, "ЗаказПокупателя")) Тогда  

		БонусныеБаллыВызовСервера.ОчиститьСкидкиНачислениеБонусныхБаллов(Объект, "Товары", "СкидкиНаценки");

		БонусныеБаллыВызовСервера.ПересчитатьНачислениеБонусныхБаллов(Объект);

	КонецЕсли;

	//СкидкиНаценкиСервер.ОкруглитьЧекВПользуПокупателя(Объект, "Товары", "СкидкиНаценки");
	ОбработкаТабличнойЧастиТоварыКлиентСервер.ЗаполнитьСуммуВсегоВТаблице(Объект.Товары, Объект.ЦенаВключаетНДС);

КонецПроцедуры


&НаКлиенте	//	LNK 23.06.2021 08:49:47
Функция ПолучитьПараметрыОплатыСуммы()

	//Если ПараметрыОткрытия = Неопределено Тогда

		ПараметрыОткрытия = Новый Структура;

	//КонецЕсли;

//	В разных формах оплаты используются разные имена сумм.. оххх! тяжка наша чоловича доля!
	ПараметрыОткрытия.Вставить("ИтогПоОрганизации"	, Объект.Товары.Итог("Сумма"));
	ПараметрыОткрытия.Вставить("ИтогПоЧеку"			, Объект.Товары.Итог("Сумма") - ПолучитьСуммуКупонов());
	ПараметрыОткрытия.Вставить("СуммаИтоговая"		, Объект.Товары.Итог("Сумма"));
	ПараметрыОткрытия.Вставить("СуммаСкидки"		, Объект.Товары.Итог("СуммаАвтоматическойСкидки")+Объект.Товары.Итог("СуммаРучнойСкидки"));

	Возврат ПараметрыОткрытия;

КонецФункции

 
&НаКлиенте	//	LNK 21.09.2017 11:40:09
Функция ПолучитьСуммуКупонов()

	СуммаКупонов = 0;
	
	//Если ЭтоПогашениеКупона Тогда    

	//	СтрокиКупонов = Объект.Товары.НайтиСтроки(Новый Структура("ТипНоменклатуры", ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.СкидочныйКупон")));

	//	Для каждого СтрокаКупона Из СтрокиКупонов Цикл

	//		СуммаКупонов = СуммаКупонов + СтрокаКупона.СуммаВсего;

	//	КонецЦикла; 

	//КонецЕсли; 

	Возврат СуммаКупонов;

КонецФункции

&НаКлиенте
Процедура ПоискШКПриИзменении(Элемент)

	КодЗначение = СтрЗаменить(ПоискШК, " ", "");
   	СтруктураПараметровКлиента = ПолученШтрихкодИзСШККупон(КодЗначение,, 1);
	ОбработатьДанныеПоКодуКлиентКупон(СтруктураПараметровКлиента, КодЗначение, 1);
	ПересчитатьИлиОтменитьСкидки();
	ПоискШК = "";

КонецПроцедуры
 	
&НаСервере
Функция ПолученШтрихкодИзСШККупон(Штрихкод, ДополнительныйПараметрПоискаКарты = Неопределено, КолВСтроке = 1)
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверкаТоваров");
	СтруктураДействий.Вставить("ИспользоватьДополнительныеКолонки");
	СтруктураДействий.Вставить("РаботаетФронт");  
	СтруктураДействий.Вставить("ПроверкаСерийныхНомеров");

	Возврат ПодключаемоеОборудованиеРТ.ПолученШтрихкодИзСШК(Штрихкод, ЭтотОбъект, СтруктураДействий);
КонецФункции

&НаКлиенте
Процедура ОбработатьДанныеПоКодуКлиентКупон(СтруктураПараметровКлиента, ТекКод, КолВСтроке = 1,НеВыдавать = Ложь)
	
	Если СтруктураПараметровКлиента.Свойство("НеизвестныеДанныеПО") 
			И СтруктураПараметровКлиента.НеизвестныеДанныеПО И НЕ НеВыдавать Тогда
	
		СтрокаСообщения = НСтр("ru = 'Данные по коду не найдены: %1%'");
		СтрокаСообщения = СтрЗаменить(СтрокаСообщения, "%1%", ТекКод);
		ОбщегоНазначенияРТКлиент.ВывестиИнформациюДляРМК(СтрокаСообщения);

	ИначеЕсли СтруктураПараметровКлиента.Свойство("ДобавитьСерийныеНомера") Тогда
		
		ТекстСообщения = "";
		Результат = hiПроверимСННаРеализацию(СтруктураПараметровКлиента.ДобавитьСерийныеНомера, ТекстСообщения);
		
		Если Результат Тогда
			ВыбранноеЗначение = СтруктураПараметровКлиента.ДобавитьСерийныеНомера;
			ОперацияВыполнена = ДобавитьНайденныеСерийныеНомера(ВыбранноеЗначение);
			
			Если НЕ ОперацияВыполнена Тогда
				СтруктураПараметровКлиента.Вставить("ТекстПредупреждения",
					НСтр("ru = 'По считанному штрихкоду определен номер подарочного сертификата.
					|Он уже присутствует в документе.
					|Повторный ввод данных не требуется.'"));

			КонецЕсли;
			
		Иначе
			ОбщегоНазначенияРТКлиент.ВывестиИнформациюДляРМК(ТекстСообщения);
		КонецЕсли;
	
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ТоварыПричинаОтменыПриИзменении(Элемент)
	ТекДанные = Элементы.Товары.ТекущиеДанные;
КонецПроцедуры

&НаКлиенте
Процедура УстановкаТипаДоставки()
	Если Объект.УчетнаяСистема = ПредопределенноеЗначение("Перечисление.УчетныеСистемыКомпании.Розница")
			И Не (Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.СлужбаДоставки")
				Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз")
				Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Смешаный")) Тогда

		Элементы.ТипДоставки.РежимВыбораИзСписка = Истина;
		
		Если Не (Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз")
				Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Смешаный")
				Или Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.ПустаяСсылка")) Тогда
				
			Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.СлужбаДоставки");
			Модифицированность = Истина;
			
		ИначеЕсли Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.ПустаяСсылка") Тогда 
			
			Объект.ТипДоставки = ПредопределенноеЗначение("Перечисление.ТипДоставкиЗаказПокупателя.Самовывоз");
			Модифицированность = Истина;
			
		КонецЕсли;
	
	КонецЕсли;
КонецПроцедуры

&НаСервереБезКонтекста
Функция hiПроверимСННаРеализацию(ДобавитьСерийныеНомера, ТекстСообщения)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ДвиженияСерийныхНомеровКупонов.АналитикаХозяйственнойОперации,
		|	ДвиженияСерийныхНомеровКупонов.Дата КАК Дата,
		|	ДвиженияСерийныхНомеровКупонов.ЧекККМ.Магазин как Магазин
		|ИЗ
		|	РегистрСведений.ДвиженияСерийныхНомеровКупонов КАК ДвиженияСерийныхНомеровКупонов
		|ГДЕ
		|	ДвиженияСерийныхНомеровКупонов.Купон = &Купон
		|	И ДвиженияСерийныхНомеровКупонов.СерийныйНомер = &СерийныйНомер
		|
		|УПОРЯДОЧИТЬ ПО
		|	Дата УБЫВ";
	
	Запрос.УстановитьПараметр("Купон", ДобавитьСерийныеНомера.Номенклатура);
	Запрос.УстановитьПараметр("СерийныйНомер", ДобавитьСерийныеНомера.СерийныйНомер);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Истина;
	КонецЕсли; 
	
	Выборка = Результат.Выбрать();
	
	Выборка.Следующий();
	Если Выборка.АналитикаХозяйственнойОперации = Справочники.АналитикаХозяйственныхОпераций.РеализацияТоваров Тогда
		ТекстСообщения = "Купон " + ДобавитьСерийныеНомера.Номенклатура + " с номером "+ ДобавитьСерийныеНомера.СерийныйНомер + " уже был реализован "+ 
		Выборка.Дата + " в магазине " + Выборка.Магазин;
		Возврат Ложь;
	ИначеЕсли Выборка.АналитикаХозяйственнойОперации = Справочники.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов Тогда
		ТекстСообщения = "Купон " + ДобавитьСерийныеНомера.Номенклатура + " с номером "+ ДобавитьСерийныеНомера.СерийныйНомер + " уже был погашен "+ 
		Выборка.Дата + " в магазине " + Выборка.Магазин;
		Возврат Ложь;
	КонецЕсли; 
	
КонецФункции  

&НаСервереБезКонтекста	//	LNK 18.09.2018 13:58:31
Функция ПолучитьДанныеКупона(Номенклатура, СерийныйНомер)

	ДанныеКупона = Новый Структура(
		"ЯвляетсяКупоном, ТипНоменклатуры, ИспользоватьСерийныеНомера, НоминалКупона"
		, Ложь
		, Перечисления.ТипыНоменклатуры.ПустаяСсылка()
		, Ложь
		, 0);

	Запрос = Новый Запрос(
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ВЫБОР
	|		КОГДА ТаблицаСправочник.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.СкидочныйКупон)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЯвляетсяКупоном,
	|	ТаблицаСправочник.ТипНоменклатуры КАК ТипНоменклатуры,
	|	ТаблицаСправочник.ИспользоватьСерийныеНомера КАК ИспользоватьСерийныеНомера,
	|	ЕСТЬNULL(ТаблицаРегистра.Сумма, 0) КАК НоминалКупона
	|ИЗ
	|	Справочник.Номенклатура КАК ТаблицаСправочник
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СерийныеНомераДляАкций КАК ТаблицаРегистра
	|		ПО (ТаблицаРегистра.СерийныйНомер = &СерийныйНомер)
	|			И (НЕ ТаблицаРегистра.Использован)
	|			И (НЕ ТаблицаРегистра.Сумма = 0)
	|ГДЕ
	|	ТаблицаСправочник.Ссылка = &Номенклатура
	|	И ТаблицаСправочник.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.СкидочныйКупон)"
	);
	Запрос.УстановитьПараметр("Номенклатура" , Номенклатура);
	Запрос.УстановитьПараметр("СерийныйНомер", СерийныйНомер);
	
	Результат = Запрос.Выполнить();

	Если НЕ Результат.Пустой() Тогда

		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();

		ЗаполнитьЗначенияСвойств(ДанныеКупона, Выборка);

	КонецЕсли;

	Возврат ДанныеКупона;

КонецФункции

&НаКлиенте
Процедура ДобавитьПогашениеСкидочныхКупонов(Номенклатура, СерийныйНомер = Неопределено, НоминалКупона = 0)

	Если НЕ ЗначениеЗаполнено(СерийныйНомер) Тогда

		СтрокиКупонов = Объект.ПогашениеСкидочныхКупонов.НайтиСтроки(Новый Структура("СкидочныйКупон", Номенклатура));

		Если НЕ СтрокиКупонов.Количество() = 0 Тогда

		//	Уже есть такой безномерной купон..
			Возврат;

		КонецЕсли;

	КонецЕсли;

	СтрокаПогашенияКупона = Объект.ПогашениеСкидочныхКупонов.Добавить();
	СтрокаПогашенияКупона.СкидочныйКупон = Номенклатура;
	СтрокаПогашенияКупона.СерийныйНомер  = СерийныйНомер;
	СтрокаПогашенияКупона.НоминалКупона  = НоминалКупона;

	Если ЗначениеЗаполнено(СерийныйНомер) Тогда

		ПоказатьОповещениеПользователя("Купон принят"
		,, "Купон «" + СерийныйНомер + "» принят и будет использован в текущем чеке"
		, БиблиотекаКартинок.Информация2_32);

	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ГородАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
    СтандартнаяОбработка = Ложь;
    ДанныеВыбора = ГородАвтоПодборНаСервере(Текст);
КонецПроцедуры

&НаКлиенте
Процедура Город2АвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
    СтандартнаяОбработка = Ложь;
    ДанныеВыбора = ГородАвтоПодборНаСервере(Текст);
КонецПроцедуры

&НаСервереБезКонтекста
Функция ГородАвтоПодборНаСервере(Текст)
	
	Возврат ОбменНПСервер.ГородАвтоПодбор(Текст);

КонецФункции


&НаСервереБезКонтекста
Функция ОтделениеАвтоПодборНаСервере(Текст, Город)
	
	Возврат ОбменНПСервер.ОтделениеАвтоПодбор(Текст, Город);

КонецФункции

&НаКлиенте
Процедура ОтделениеОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)

	Массив = Новый Массив(); 
	Массив.Добавить(ТипЗнч(ВыбранноеЗначение)); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Отделение.ОграничениеТипа = НашеОписание;  

КонецПроцедуры


&НаКлиенте
Процедура ОтделениеАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)

    СтандартнаяОбработка = Ложь;
    ДанныеВыбора = ОтделениеАвтоПодборНаСервере(Текст,Объект.Город);
	
КонецПроцедуры

&НаКлиенте
Процедура ГородПриИзменении(Элемент)

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.Отделения")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Отделение.ОграничениеТипа = НашеОписание;  

КонецПроцедуры


&НаКлиенте
Процедура ТелефонПриИзменении(Элемент)
	Если Объект.Телефон <> "" тогда
		Поз = Найти(Объект.Телефон, " ");
		Если Поз <> 0 тогда    
			Сообщить("Не правильно введен телефон!");
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура УлицаОчистка(Элемент, СтандартнаяОбработка)

	Массив = Новый Массив(); 
	Массив.Добавить(Тип("СправочникСсылка.Улицы")); 
	НашеОписание = Новый ОписаниеТипов(Массив);
	Элементы.Улица.ОграничениеТипа = НашеОписание;  

КонецПроцедуры

&НаКлиенте
Процедура УлицаАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
    СтандартнаяОбработка = Ложь;
    ДанныеВыбора = УлицаАвтоПодборНаСервере(Текст, Объект.Город);
КонецПроцедуры

&НаСервереБезКонтекста
Функция УлицаАвтоПодборНаСервере(Текст, Город)
	
	Возврат ОбменНПСервер.УлицаАвтоПодбор(Текст, Город);

КонецФункции

&НаКлиенте
Процедура СписокКомментариевПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ОтделениеПриИзменении(Элемент)
	
	ВидимостьЭлементов();

КонецПроцедуры

// Возвращает признак рабочего отделения.
// 
// Параметры:
//  СсылкаНаОтделение - СправочникСсылка.Почтоматы, Строка, СправочникСсылка.Отделения - Ссылка на отделение
// 
// Возвращаемое значение:
//  Булево - Отделение не работает
&НаСервереБезКонтекста
Функция ОтделениеНеРаботает(СсылкаНаОтделение)
	
	Если ТипЗнч(СсылкаНаОтделение) = Тип("Строка") Тогда
		
		Результат = ПустаяСтрока(СсылкаНаОтделение);
		
	Иначе
		
		Результат = Не (СсылкаНаОтделение.Пустая()
			Или ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаОтделение, "Работает", Ложь, Ложь));

	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ОтправитьСообщениеМагазинам(Команда)

	Если Модифицированность Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'Спочатку треба записати заказ!';
			|		uk = 'Спочатку треба записати заказ!'"));
	Иначе

		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("ДокументПечати", Объект.Ссылка);
		ПараметрыФормы.Вставить("НомерДокумента", Объект.Номер);
		ПараметрыФормы.Вставить("Ответственный", Объект.Ответственный);

		ОткрытьФорму("Документ.ЗаказПокупателя.Форма.ФормаОтправкиСообщенияМагазинам", ПараметрыФормы); 

	КонецЕсли;
КонецПроцедуры

#КонецОбласти

