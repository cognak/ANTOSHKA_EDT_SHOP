
// ПРОЦЕДУРА "ПриИзменении" НА СЕРВЕРЕ.
// ВЫЗОВ ЭТОЙ ПРОЦЕДУРЫ ДОЛЖЕН ОСУЩЕСТВЛЯТЬСЯ ИЗ КЛИЕНТСКОГО МОДУЛЯ
// ПРИ НЕОБХОДИМОСТИ ВЫПОЛНЕНИЯ НА СЕРВЕРЕ.
//
// СтруктураДействий - Структура. Возможно передавать следующие поля:
//  "ПроверитьХарактеристикуПоВладельцу", Характеристика.
//  "ПроверитьЗаполнитьУпаковкуПоВладельцу"      , Упаковка.
//  "ЗаполнитьОбъемВесУпаковки"	        , Упаковка.
//  "ПересчитатьКоличествоЕдиниц".
//  "ПересчитатьКоличествоЕдиницПлан".
//  "ПересчитатьКоличествоЕдиницФакт". ИмяФакта
//  "ОчиститьКоличествоУчет"
//  "ЗаполнитьЦенуПродажи"              , СтруктураПараметровДействия.
//  "ЗаполнитьЦенуПродажиНазначенную"   , СтруктураПараметровДействия.
//  "ЗаполнитьЦенуПоВидуЦен"            , СтруктураПараметровДействия.
//  "ПересчитатьСумму".
//  "ПересчитатьСуммуСУчетомРучнойСкидки"     , СтруктураПараметровДействия.
//  "ПересчитатьСуммуСУчетомАвтоматическойСкидки"     , СтруктураПараметровДействия.
//  "ПересчитатьЦенуЗаУпаковку".
//  "ПересчитатьСуммуНДС".
//  "ЗаполнитьСтавкуНДС".
//  "ПересчитатьКоличествоУпаковок"., Имя
//  "ПересчитатьКоличествоУпаковок"., ИмяФакта
//  "ЗаполнитьНоменклатуруПоНоменклатуреПоставщика".
//  "ПересчитатьСуммуФакт",ИмяКоличества.
//  "ЗаполнитьЦенуЗакупки"            , СтруктураПараметровДействия
//  "ЗаполнитьЦенуПрошлойЗакупки"            , СтруктураПараметровДействия

// Процедура при измерении реквизитов в ТЧ на сервере
//
Процедура ПриИзмененииРеквизитовВТЧСервер(СтруктураТЧ, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Перем ЗначениеИзСтруктуры;
	
	СоответствиеДействий = Новый Соответствие;
	
//	Для случая когда процедура вызывается напрямую с сервера
	Если КэшированныеЗначения = Неопределено Тогда

		КэшированныеЗначения = ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();

	КонецЕсли;

	ПересчитатьСуммыНДССервер(СтруктураТЧ, СтруктураДействий, КэшированныеЗначения, СоответствиеДействий);

	Если СтруктураТЧ.Свойство("СтрокиТЧ", ЗначениеИзСтруктуры) Тогда

		Для Каждого ТекущаяСтрока Из ЗначениеИзСтруктуры Цикл

			ТекСтруктураДействий = СоответствиеДействий[ТекущаяСтрока];

			Если ТекСтруктураДействий <> Неопределено Тогда

				ОбработатьСтрокуТЧСервер(ТекущаяСтрока, ТекСтруктураДействий, КэшированныеЗначения);

			КонецЕсли;

		КонецЦикла;

	КонецЕсли;

	Если СтруктураТЧ.Свойство("ТекущаяСтрока", ЗначениеИзСтруктуры) Тогда

		ОбработатьСтрокуТЧСервер(ЗначениеИзСтруктуры, СтруктураДействий, КэшированныеЗначения);

	КонецЕсли;

КонецПроцедуры

// Процедура обработки строки ТЧ на сервере
//
Процедура ОбработатьСтрокуТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	ПроверитьАссортиментСтроки(ТекущаяСтрока								 , СтруктураДействий);
	ПроверитьЗапретРозничнойПродажи(ТекущаяСтрока							 , СтруктураДействий);
	ПроверитьСерийныеНомераПоВладельцуСервер(ТекущаяСтрока                   , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьДанныеПоДокументуПродажиВСтрокеТЧСервер(ТекущаяСтрока           , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьТипНоменклатурыВСтрокеТЧСервер(ТекущаяСтрока                    , СтруктураДействий, КэшированныеЗначения);
	ПроверитьКорректностьЗаполнитьХарактеристикиИУпаковкиСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	ПересчитатьКоличествоУпаковокВСтрокеТЧСервер(ТекущаяСтрока               , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьКоличествоУпаковокФактВСтрокеТЧСервер(ТекущаяСтрока           , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьКоличествоЕдиницПланВСтрокеТЧСервер(ТекущаяСтрока             , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьКоличествоЕдиницФактВСтрокеТЧСервер(ТекущаяСтрока             , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьОчиститьКоличествоУчетВСтрокеТЧСервер(ТекущаяСтрока           , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьКоличествоЕдиницВСтрокеТЧСервер(ТекущаяСтрока                 , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьЗаполнитьОбъемВесПоУпаковкеВСтрокеТЧСервер(ТекущаяСтрока        , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьЦенуЗаУпаковкуВСтрокеТЧСервер(ТекущаяСтрока                   , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьСкладПродажиВСтрокеТЧСервер(ТекущаяСтрока                       , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьОрганизациюПродажиВСтрокеТЧСервер(ТекущаяСтрока                 , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьЦенуПродажиВСтрокеТЧСервер(ТекущаяСтрока                        , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьЦенуПродажиНазначеннуюВСтрокеТЧСервер(ТекущаяСтрока             , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьЦенуПоВидуЦенВСтрокеТЧСервер(ТекущаяСтрока                      , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьЦенуЗакупкиВСтрокеТЧСервер(ТекущаяСтрока                        , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьЦенуПрошлойЗакупкиВСтрокеТЧСервер(ТекущаяСтрока                 , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьСтавкуНДСВСтрокеТЧСервер(ТекущаяСтрока                          , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьСтавкуНДСВСтрокеСкладВСтрокеТЧСервер(ТекущаяСтрока              , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьСтавкуНДСВСтрокеСкладВШапкеТЧСервер(ТекущаяСтрока               , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуРучнойСкидкиВСтрокеТЧСервер(ТекущаяСтрока                , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьПроцентРучнойСкидкиВСтрокеТЧСервер(ТекущаяСтрока              , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуВСтрокеТЧСервер(ТекущаяСтрока                            , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуФактВСтрокеТЧСервер(ТекущаяСтрока                        , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьЦенуСкидкуПоСуммеВПродажахВСтрокеТЧСервер(ТекущаяСтрока       , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьЦенуСкидкуПоСуммеВЗакупкахВСтрокеТЧСервер(ТекущаяСтрока       , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуСУчетомАвтоматическойСкидкиВСтрокеТЧСервер(ТекущаяСтрока , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуСУчетомБонусыНачислениеВСтрокеТЧСервер(ТекущаяСтрока     , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуСУчетомБонусыСписаниеВСтрокеТЧСервер(ТекущаяСтрока       , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуСУчетомРучнойСкидкиВСтрокеТЧСервер(ТекущаяСтрока         , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуНДСВСтрокеТЧСервер(ТекущаяСтрока                         , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьПодакцизныйТоварВСтрокеТЧСервер(ТекущаяСтрока                    , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуНДСиАкцизногоНалогаВСтрокеТЧСервер(ТекущаяСтрока         , СтруктураДействий, КэшированныеЗначения);
 	ПересчитатьСуммуСНДСВСтрокеТЧСервер(ТекущаяСтрока                        , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуНДСПоСуммеСНДСВСтрокеТЧСервер(ТекущаяСтрока              , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьЗаполнитьРеквизитыПоНоменклатуреВСтрокеТЧСервер(ТекущаяСтрока   , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуВозвратСУчетомОснованияВСтрокеТЧСервер(ТекущаяСтрока     , СтруктураДействий, КэшированныеЗначения);
	ПроставитьПродавцаВСтрокеТЧСервер(ТекущаяСтрока                          , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьСуммуПоСуммеСНДСВСтрокеТЧСервер(ТекущаяСтрока                 , СтруктураДействий, КэшированныеЗначения);
	ПересчитатьЦенуПоСуммеВЗакупкахВСтрокеТЧСервер(ТекущаяСтрока             , СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьДубликатыЗависимыхРеквизитовСервер(ТекущаяСтрока				 , СтруктураДействий, КэшированныеЗначения);
//	LNK 15.11.2016 14:20:57
	ПолучитьКоличествоНаСкладе(ТекущаяСтрока								 , СтруктураДействий, КэшированныеЗначения);
//	LNK 05.04.2017 16:11:34
	ПолучитьКоличествоПлановое(ТекущаяСтрока								 , СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

// ПРОЦЕДУРЫ ПЕРЕСЧЕТА И ЗАПОЛНЕНИЯ СЕРВЕР.

// Процедура пересчета "ПроверитьСерийныеНомераПоВладельцу"
//
Процедура ПроверитьСерийныеНомераПоВладельцуСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ПроверитьСерийныеНомераПоВладельцу", СтруктураПараметровДействия) Тогда
		Если ТекущаяСтрока.КлючСвязиСерийныхНомеров <> 0 И Справочники.СерийныеНомера.СерийныеНомераНеПринадлежатВладельцу(ТекущаяСтрока.Номенклатура, СтруктураПараметровДействия.МассивСерийныхНомеров) Тогда
			ТекущаяСтрока.КлючСвязиСерийныхНомеров = 0;
		КонецЕсли;
		ТекущаяСтрока.ИспользоватьСерийныеНомера = ЗапасыПовтИсп.ДанныеНоменклатуры(ТекущаяСтрока.Номенклатура).ИспользоватьСерийныеНомера;
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПроверитьХарактеристикуПоВладельцу" и "ПроверитьЗаполнитьУпаковкуПоВладельцу"
//
Процедура ПроверитьКорректностьЗаполнитьХарактеристикиИУпаковкиСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)

	Перем Характеристика;
	Перем Упаковка;

	СтруктураПараметровДействия = Неопределено;

	ПроверитьХарактеристикуПоВладельцу = СтруктураДействий.Свойство("ПроверитьХарактеристикуПоВладельцу", Характеристика);
	ПроверитьЗаполнитьУпаковкуПоВладельцу       = СтруктураДействий.Свойство("ПроверитьЗаполнитьУпаковкуПоВладельцу", Упаковка);

	Если ПроверитьХарактеристикуПоВладельцу Или ПроверитьЗаполнитьУпаковкуПоВладельцу Тогда

		РезультатПроверки = Справочники.Номенклатура.ПроверитьПринадлежностьХарактеристикиИУпаковкиВладельцу(ТекущаяСтрока.Номенклатура, Характеристика, Упаковка);

		ЗаполнитьЗначенияСвойств(ТекущаяСтрока, РезультатПроверки);
		
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчета "ПересчитатьКоличествоЕдиниц"
//
Процедура ПересчитатьКоличествоЕдиницВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Если СтруктураДействий.Свойство("ПересчитатьКоличествоЕдиниц") Тогда
		ТекущаяСтрока.Количество = ТекущаяСтрока.КоличествоУпаковок
		   * ПолучитьКоэффициентУпаковкиСервер(ТекущаяСтрока.Упаковка, КэшированныеЗначения);
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьОбъемВесУпаковки"
//
Процедура ЗаполнитьЗаполнитьОбъемВесПоУпаковкеВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	Если СтруктураДействий.Свойство("ЗаполнитьОбъемВесУпаковки") Тогда
		ТекущаяСтрока.ОбъемУпаковки = ПолучитьОбъемУпаковкиСервер(ТекущаяСтрока.Упаковка, КэшированныеЗначения);
		ТекущаяСтрока.ВесУпаковки = ПолучитьВесУпаковкиСервер(ТекущаяСтрока.Упаковка, КэшированныеЗначения);
	КонецЕсли;
КонецПроцедуры

// Процедура пересчета "ПересчитатьКоличествоЕдиницПлан"
//
Процедура ПересчитатьКоличествоЕдиницПланВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Если СтруктураДействий.Свойство("ПересчитатьКоличествоЕдиницПлан") Тогда
		ТекущаяСтрока.КоличествоПлан = ТекущаяСтрока.КоличествоУпаковокПлан
		   * ПолучитьКоэффициентУпаковкиСервер(ТекущаяСтрока.Упаковка, КэшированныеЗначения);
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьКоличествоЕдиницФакт"
//
Процедура ПересчитатьКоличествоЕдиницФактВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	ИмяФакта = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьКоличествоЕдиницФакт",ИмяФакта) Тогда
		ТекущаяСтрока["Количество" + ИмяФакта]  = ТекущаяСтрока["КоличествоУпаковок" + ИмяФакта]
		   * ПолучитьКоэффициентУпаковкиСервер(ТекущаяСтрока.Упаковка, КэшированныеЗначения);
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьЦенуЗаУпаковку"
//
Процедура ПересчитатьЦенуЗаУпаковкуВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем КоличествоЕдиницДоПересчета;

	Если СтруктураДействий.Свойство("ПересчитатьЦенуЗаУпаковку", КоличествоЕдиницДоПересчета)
	   И КоличествоЕдиницДоПересчета <> 0 Тогда
		ТекущаяСтрока.Цена = ТекущаяСтрока.Цена
		   / КоличествоЕдиницДоПересчета
		   * ТекущаяСтрока.Количество;
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьЦенуПродажиНазначенную"
//
Процедура ЗаполнитьЦенуПродажиНазначеннуюВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ЗаполнитьЦенуПродажиНазначенную", СтруктураПараметровДействия) Тогда
		
		Если ТекущаяСтрока.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.ПодарочныйСертификат Тогда
			
			ТекущаяСтрока.Цена = ТекущаяСтрока.Номенклатура.Номинал;
			
		Иначе
			
			ЗаполнитьЦенуПродажиПоЦенамНоменклатурыВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьЦенуПродажи"
//
Процедура ЗаполнитьЦенуПродажиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;

	АкционнаяЦена = Ложь;	//	LNK 05.08.2021 13:24:39

	Если СтруктураДействий.Свойство("ЗаполнитьЦенуПродажи", СтруктураПараметровДействия) Тогда
		
		ТекущаяДатаСеанса = ТекущаяДатаСеанса();
		Если СтруктураПараметровДействия.Дата = НачалоДня(ТекущаяДатаСеанса) Тогда
			СтруктураПараметровДействия.Дата = ТекущаяДатаСеанса;
		КонецЕсли;

		Цена = ЗапасыСервер.ПолучитьЦенуПродажи(
			СтруктураПараметровДействия.ОбъектЦенообразования,
			СтруктураПараметровДействия.Дата, 
			ТекущаяСтрока.Номенклатура, 
			ТекущаяСтрока.Характеристика, ТекущаяСтрока.Упаковка,
			СтруктураПараметровДействия.ПриводитьКМинимальнойЦене,
			АкционнаяЦена);

		ОпорнаяЦена = ЗапасыСервер.ПолучитьОпорнуюЦену(
			СтруктураПараметровДействия.ОбъектЦенообразования,
			СтруктураПараметровДействия.Дата, 
			ТекущаяСтрока.Номенклатура, 
			ТекущаяСтрока.Характеристика, ТекущаяСтрока.Упаковка,
			СтруктураПараметровДействия.ПриводитьКМинимальнойЦене);

		Если Цена > 0 Тогда

			ТекущаяСтрока.Цена = Цена;

		Иначе

			ТекущаяСтрока.Цена = 0;

		//	LNK 04.05.2017 14:49:55
			Если НЕ ОбменДаннымиПовтИсп.ЭтоГлавныйУзел() Тогда

				ОсновнойМагазин = ОбменДаннымиПовтИсп.ПолучитьДанныеУзла().Магазин;

				Если ЗначениеЗаполнено(ОсновнойМагазин)
				И НЕ ОсновнойМагазин = СтруктураПараметровДействия.ОбъектЦенообразования
				И ОбщегоНазначенияРТповтИсп.ЭтоТоварУниверсальный(ТекущаяСтрока.Номенклатура)	Тогда

					Цена = ЗапасыСервер.ПолучитьЦенуПродажи(
						ОсновнойМагазин,
						СтруктураПараметровДействия.Дата, 
						ТекущаяСтрока.Номенклатура, 
						ТекущаяСтрока.Характеристика, ТекущаяСтрока.Упаковка,
						СтруктураПараметровДействия.ПриводитьКМинимальнойЦене,
						АкционнаяЦена);

					Если Цена > 0 Тогда

						ТекущаяСтрока.Цена = Цена;

					КонецЕсли;

				КонецЕсли;

			КонецЕсли;

		КонецЕсли;
		// При вызове когда сканируется 
		Попытка
			Если ОпорнаяЦена = 0 Тогда
				ТекущаяСтрока.ОпорнаяЦена = ТекущаяСтрока.Цена;
			Иначе
				ТекущаяСтрока.ОпорнаяЦена = ОпорнаяЦена;
			КонецЕсли;
			
			ТекущаяСтрока.ЦенаСтандартная = ТекущаяСтрока.Цена;
		Исключение
		КонецПопытки;

		Если СтруктураПараметровДействия.Свойство("ПроверитьАкционнуюЦену") И СтруктураПараметровДействия.ПроверитьАкционнуюЦену = Истина Тогда

			ТекущаяСтрока.АкционнаяЦена = АкционнаяЦена;

		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьЦенуПоВидуЦен"
//
Процедура ЗаполнитьЦенуПоВидуЦенВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ЗаполнитьЦенуПоВидуЦен", СтруктураПараметровДействия) Тогда
		
		Цена = ЗапасыСервер.ПолучитьЦенуПоВидуЦен(
			СтруктураПараметровДействия.ВидЦены, 
			СтруктураПараметровДействия.Дата, 
			ТекущаяСтрока.Номенклатура, 
			ТекущаяСтрока.Характеристика, 
			ТекущаяСтрока.Упаковка);
			
		Если Цена > 0 Тогда
			ТекущаяСтрока.Цена = Цена;	
		КонецЕсли;	
		
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьЦенуПродажиНазначенную" и "ЗаполнитьЦенуПродажи"
//
Процедура ЗаполнитьЦенуПродажиПоЦенамНоменклатурыВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) 
	
	Перем СтруктураПараметровДействия;

	АкционнаяЦена = Ложь;	//	LNK 05.08.2021 13:24:39
	
	Если СтруктураДействий.Свойство("ЗаполнитьЦенуПродажиНазначенную", СтруктураПараметровДействия) 
		ИЛИ СтруктураДействий.Свойство("ЗаполнитьЦенуПродажи", СтруктураПараметровДействия) Тогда
		
		ТекущаяДатаСеанса = ТекущаяДатаСеанса();
		Если СтруктураПараметровДействия.Дата = НачалоДня(ТекущаяДатаСеанса) Тогда
			СтруктураПараметровДействия.Дата = ТекущаяДатаСеанса;
		КонецЕсли;
		
		Цена = ЗапасыСервер.ПолучитьЦенуПродажиПоЦенамНоменклатуры(
			СтруктураПараметровДействия.ОбъектЦенообразования, 
			СтруктураПараметровДействия.Дата, 
			ТекущаяСтрока.Номенклатура, 
			ТекущаяСтрока.Характеристика, 
			ТекущаяСтрока.Упаковка, 
			СтруктураПараметровДействия.ПриводитьКМинимальнойЦене,
			АкционнаяЦена);
			
		Если Цена > 0 Тогда
			ТекущаяСтрока.Цена = Цена;
		Иначе
			ТекущаяСтрока.Цена = 0;
		КонецЕсли;

		Если СтруктураПараметровДействия.Свойство("ПроверитьАкционнуюЦену") И СтруктураПараметровДействия.ПроверитьАкционнуюЦену = Истина Тогда

			ТекущаяСтрока.АкционнаяЦена = АкционнаяЦена;

		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьЦенуЗакупки"
//
Процедура ЗаполнитьЦенуЗакупкиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ЗаполнитьЦенуЗакупки", СтруктураПараметровДействия) Тогда
				
		Цена = ЗапасыСервер.ПолучитьЦенуПоследнейЗакупки(
			СтруктураПараметровДействия.Дата,
			СтруктураПараметровДействия.Магазин,
			СтруктураПараметровДействия.Контрагент, 
			СтруктураПараметровДействия.Ссылка, 
			ТекущаяСтрока.Номенклатура, 
			ТекущаяСтрока.Характеристика, 
			ТекущаяСтрока.Упаковка);
			
		Если Цена > 0 Тогда
			ТекущаяСтрока.Цена = Цена;	
		КонецЕсли;	
			
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьЦенуПрошлойЗакупки"
//
Процедура ЗаполнитьЦенуПрошлойЗакупкиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ЗаполнитьЦенуПрошлойЗакупки", СтруктураПараметровДействия) Тогда
				
		Цена = ЗапасыСервер.ПолучитьЦенуПоследнейЗакупки(
			СтруктураПараметровДействия.Дата,
			Справочники.Магазины.ПустаяСсылка(),
			Справочники.Контрагенты.ПустаяСсылка(), 
			СтруктураПараметровДействия.Ссылка, 
			ТекущаяСтрока.Номенклатура, 
			ТекущаяСтрока.Характеристика, 
			ТекущаяСтрока.Упаковка);
					
		ТекущаяСтрока.ЦенаПрошлойЗакупки = Цена;
					
	КонецЕсли;

КонецПроцедуры

Процедура ЗаполнитьСтавкуНДСВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем НалогообложениеНДС;

	Если СтруктураДействий.Свойство("ЗаполнитьСтавкуНДС", НалогообложениеНДС) Тогда
		
		ТекущаяСтрока.СтавкаНДС = НДСОбщегоНазначенияСервер.ОпределитьСтавкуНДСИзНалогообложенияНДС(НалогообложениеНДС, ТекущаяСтрока.Номенклатура);
		    		
	КонецЕсли;	
	
КонецПроцедуры

Процедура ЗаполнитьСтавкуНДСВСтрокеСкладВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ЗаполнитьСтавкуНДССкладВСтроке", СтруктураПараметровДействия) Тогда
		
		
		ТекущаяСтрока.СтавкаНДС = НДСОбщегоНазначенияСервер.ОпределитьСтавкуНДС(ТекущаяСтрока, СтруктураПараметровДействия);
		
	КонецЕсли;

КонецПроцедуры

Процедура ЗаполнитьСтавкуНДСВСтрокеСкладВШапкеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ЗаполнитьСтавкуНДССкладВШапке", СтруктураПараметровДействия) Тогда
		
		
		ТекущаяСтрока.СтавкаНДС = НДСОбщегоНазначенияСервер.ОпределитьСтавкуНДС(ТекущаяСтрока, СтруктураПараметровДействия);
		
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьСумму"
//
Процедура ПересчитатьСуммуВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Если СтруктураДействий.Свойство("ПересчитатьСумму") Тогда
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Цена * ТекущаяСтрока.КоличествоУпаковок;
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуФакт"
//
Процедура ПересчитатьСуммуФактВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	ИмяКоличества = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуФакт",ИмяКоличества) Тогда
		Если Не ЗначениеЗаполнено(ИмяКоличества) Тогда
			ИмяКоличества = "КоличествоУпаковокФакт";
		КонецЕсли;
		ТекущаяСтрока.СуммаФакт = ТекущаяСтрока.Цена * ТекущаяСтрока[ИмяКоличества];
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьПроцентРучнойСкидки"
//
Процедура ПересчитатьПроцентРучнойСкидкиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьПроцентРучнойСкидки", СтруктураПараметровДействия) Тогда
		
		Если ТекущаяСтрока.КоличествоУпаковок * ТекущаяСтрока.Цена <> 0 Тогда
			ТекущаяСтрока.ПроцентРучнойСкидки = Окр(100*ТекущаяСтрока.СуммаРучнойСкидки / (ТекущаяСтрока.КоличествоУпаковок *ТекущаяСтрока.Цена), 2);
		Иначе
			ТекущаяСтрока.ПроцентРучнойСкидки = 0;
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуРучнойСкидки"
//
Процедура ПересчитатьСуммуРучнойСкидкиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуРучнойСкидки", СтруктураПараметровДействия) Тогда
		
		ТекущаяСтрока.СуммаРучнойСкидки = Окр(ТекущаяСтрока.КоличествоУпаковок *ТекущаяСтрока.Цена * ТекущаяСтрока.ПроцентРучнойСкидки / 100, 2);
		
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьЦенуСкидкуПоСуммеВПродажах"
//
Процедура ПересчитатьЦенуСкидкуПоСуммеВПродажахВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьЦенуСкидкуПоСуммеВПродажах", СтруктураПараметровДействия) Тогда
		
		ИспользоватьРучныеСкидки = Ложь;
		Если СтруктураПараметровДействия <> Неопределено Тогда
			Если СтруктураПараметровДействия.Свойство("ИспользоватьРучныеСкидки") Тогда
				ИспользоватьРучныеСкидки = Истина;
			КонецЕсли;
		КонецЕсли;
		
		ИспользоватьАвтоматическиеСкидки = Ложь;
		Если СтруктураПараметровДействия <> Неопределено Тогда
			Если СтруктураПараметровДействия.Свойство("ИспользоватьАвтоматическиеСкидки") Тогда
				ИспользоватьАвтоматическиеСкидки = Истина;
			КонецЕсли;
		КонецЕсли;
		
		Если ИспользоватьРучныеСкидки И КэшированныеЗначения.ИспользоватьРучныеСкидкиВПродажах = Неопределено Тогда
			КэшированныеЗначения.ИспользоватьРучныеСкидкиВПродажах = ПолучитьФункциональнуюОпцию("ИспользоватьРучныеСкидкиВПродажах");
		КонецЕсли;
		
		Если ИспользоватьАвтоматическиеСкидки И КэшированныеЗначения.ИспользоватьАвтоматическиеСкидкиВПродажах = Неопределено Тогда
			КэшированныеЗначения.ИспользоватьАвтоматическиеСкидкиВПродажах = ПолучитьФункциональнуюОпцию("ИспользоватьАвтоматическиеСкидкиВПродажах");
		КонецЕсли;
		
		// Если используются ручные скидки - перерасчитаем процент и сумму ручной скидки, иначе перерасчитываем цену
		Если ИспользоватьРучныеСкидки И КэшированныеЗначения.ИспользоватьРучныеСкидкиВПродажах Тогда
				
				Если ТекущаяСтрока.КоличествоУпаковок = 0 Тогда
					Сумма = ТекущаяСтрока.Цена;
				Иначе
					Сумма = ТекущаяСтрока.Цена * ТекущаяСтрока.КоличествоУпаковок;
				КонецЕсли;
				
				Если Сумма = 0 Или ТекущаяСтрока.Сумма = 0 Тогда
					
					ТекущаяСтрока.Цена                = ТекущаяСтрока.Сумма;
					ТекущаяСтрока.СуммаРучнойСкидки   = 0;
					ТекущаяСтрока.ПроцентРучнойСкидки = 0;
					
				Иначе
					
					ТекущаяСтрока.СуммаРучнойСкидки   = Сумма - ТекущаяСтрока.Сумма;
					ТекущаяСтрока.ПроцентРучнойСкидки = Окр(100*ТекущаяСтрока.СуммаРучнойСкидки / Сумма, 2);
					
				КонецЕсли;
			
		Иначе
			
			Если ТекущаяСтрока.КоличествоУпаковок = 0 Тогда
				ТекущаяСтрока.Цена = ТекущаяСтрока.Сумма;
			Иначе
				ТекущаяСтрока.Цена = Окр(ТекущаяСтрока.Сумма / ТекущаяСтрока.КоличествоУпаковок, 2);
			КонецЕсли;
			
		КонецЕсли;
		
		Если ИспользоватьАвтоматическиеСкидки Тогда
			Если КэшированныеЗначения.ИспользоватьАвтоматическиеСкидкиВПродажах Тогда
				ТекущаяСтрока.СуммаАвтоматическойСкидки   = 0;
				ТекущаяСтрока.ПроцентАвтоматическойСкидки = 0;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчета "ПересчитатьЦенуСкидкуПоСуммеВЗакупках"
//
Процедура ПересчитатьЦенуСкидкуПоСуммеВЗакупкахВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьЦенуСкидкуПоСуммеВЗакупках", СтруктураПараметровДействия) Тогда
		
		// Если используются ручные скидки - перерасчитаем процент и сумму ручной скидки, иначе перерасчитываем цену
		ИспользоватьРучныеСкидки = Ложь;
		Если СтруктураПараметровДействия <> Неопределено Тогда
			Если СтруктураПараметровДействия.Свойство("ИспользоватьРучныеСкидки") Тогда
				ИспользоватьРучныеСкидки = Истина;
			КонецЕсли;
		КонецЕсли;
		
		Если ИспользоватьРучныеСкидки И КэшированныеЗначения.ИспользоватьРучныеСкидкиВЗакупках = Неопределено Тогда
			
			//КэшированныеЗначения.ИспользоватьРучныеСкидкиВЗакупках = ПолучитьФункциональнуюОпцию("ИспользоватьРучныеСкидкиВЗакупках");
			КэшированныеЗначения.ИспользоватьРучныеСкидкиВЗакупках = Ложь;
			
		КонецЕсли;
		
		// Если используются ручные скидки - перерасчитаем процент и сумму ручной скидки, иначе перерасчитываем цену
		Если ИспользоватьРучныеСкидки И КэшированныеЗначения.ИспользоватьРучныеСкидкиВЗакупках Тогда
			
				Если ТекущаяСтрока.КоличествоУпаковок = 0 Тогда
					Сумма = ТекущаяСтрока.Цена;
				Иначе
					Сумма = ТекущаяСтрока.Цена * ТекущаяСтрока.КоличествоУпаковок;
				КонецЕсли;
				
				Если Сумма = 0 Или ТекущаяСтрока.Сумма = 0 Тогда
					
					ТекущаяСтрока.Цена                = ТекущаяСтрока.Сумма;
					ТекущаяСтрока.СуммаРучнойСкидки   = 0;
					ТекущаяСтрока.ПроцентРучнойСкидки = 0;
					
				Иначе
					
					ТекущаяСтрока.СуммаРучнойСкидки   = Сумма - ТекущаяСтрока.Сумма;
					ТекущаяСтрока.ПроцентРучнойСкидки = Окр(100*ТекущаяСтрока.СуммаРучнойСкидки / Сумма, 2);
					
				КонецЕсли;
			
		Иначе
			
			Если ТекущаяСтрока.КоличествоУпаковок = 0 Тогда
				ТекущаяСтрока.Цена = ТекущаяСтрока.Сумма;
			Иначе
				ТекущаяСтрока.Цена = Окр(ТекущаяСтрока.Сумма / ТекущаяСтрока.КоличествоУпаковок, 2);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчета "ПересчитатьЦенуПоСуммеВЗакупках"
//
Процедура ПересчитатьЦенуПоСуммеВЗакупкахВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьЦенуПоСуммеВЗакупках", СтруктураПараметровДействия) Тогда
		
		Если ТекущаяСтрока.КоличествоУпаковок = 0 Тогда
			ТекущаяСтрока.Цена = ТекущаяСтрока.Сумма;
		Иначе
			ТекущаяСтрока.Цена = Окр(ТекущаяСтрока.Сумма / ТекущаяСтрока.КоличествоУпаковок, 2);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчета "ПересчитатьЦенуПоСуммеФакт"
//
Процедура ПересчитатьЦенуПоСуммеФактВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьЦенуПоСуммеФакт", СтруктураПараметровДействия) Тогда
						
		Если ТекущаяСтрока.КоличествоУпаковокФакт = 0 Тогда
			
			ТекущаяСтрока.Цена = ТекущаяСтрока.СуммаФакт;
			
		Иначе
			
			ТекущаяСтрока.Цена = Окр(ТекущаяСтрока.СуммаФакт / ТекущаяСтрока.КоличествоУпаковокФакт, 2);
			
		КонецЕсли;
				
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуСУчетомРучнойСкидки"
//
Процедура ПересчитатьСуммуСУчетомРучнойСкидкиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуСУчетомРучнойСкидки", СтруктураПараметровДействия) Тогда
		
		Очищать = Неопределено;
		ПересчитыватьСуммуРучнойСкидки = Неопределено;
		Если СтруктураПараметровДействия <> Неопределено Тогда
			
			СтруктураПараметровДействия.Свойство("Очищать", Очищать);
			СтруктураПараметровДействия.Свойство("ПересчитыватьСуммуРучнойСкидки", ПересчитыватьСуммуРучнойСкидки);
			
			Если Очищать = Истина Тогда
				
				ТекущаяСтрока.СуммаРучнойСкидки   = 0;
				ТекущаяСтрока.ПроцентРучнойСкидки = 0;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если ПересчитыватьСуммуРучнойСкидки = Ложь Тогда
			
		Иначе
			ТекущаяСтрока.СуммаРучнойСкидки = Окр(ТекущаяСтрока.КоличествоУпаковок *ТекущаяСтрока.Цена * ТекущаяСтрока.ПроцентРучнойСкидки / 100, 2);
		КонецЕсли;
		
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Сумма - ТекущаяСтрока.СуммаРучнойСкидки;
		
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуСУчетомАвтоматическойСкидки"
//
Процедура ПересчитатьСуммуСУчетомАвтоматическойСкидкиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуСУчетомАвтоматическойСкидки", СтруктураПараметровДействия) Тогда
		
		Очищать = Неопределено;
		СтруктураПараметровДействия.Свойство("Очищать", Очищать);
		
		Если Очищать = Истина Тогда
			
			ТекущаяСтрока.СуммаАвтоматическойСкидки = 0;
			ТекущаяСтрока.ПроцентАвтоматическойСкидки = 0;
			
		КонецЕсли;
		
		Скидка = ТекущаяСтрока.СуммаАвтоматическойСкидки;
		
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Сумма - Скидка;
		
	КонецЕсли;

КонецПроцедуры

//	LNK 19.03.2021 10:19:15
Процедура ПересчитатьСуммуСУчетомБонусыНачислениеВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуСУчетомБонусныхБалловНачислено", СтруктураПараметровДействия) Тогда
		
		Очищать = Неопределено;
		СтруктураПараметровДействия.Свойство("Очищать", Очищать);
		
		Если Очищать = Истина Тогда
			
			ТекущаяСтрока.СуммаБонусныхБалловНачислено = 0;
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

//	LNK 19.03.2021 10:19:15
Процедура ПересчитатьСуммуСУчетомБонусыСписаниеВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	СтруктураПараметровДействия = Неопределено;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуСУчетомБонусныхБалловСписано", СтруктураПараметровДействия) Тогда
		
		Очищать = Неопределено;
		СтруктураПараметровДействия.Свойство("Очищать", Очищать);
		
		Если Очищать = Истина Тогда
			
			ТекущаяСтрока.СуммаБонусныхБалловСписано = 0;
			
		КонецЕсли;
		
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Сумма - ТекущаяСтрока.СуммаБонусныхБалловСписано;

	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуНДС"
//
Процедура ПересчитатьСуммуНДСВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуНДС", СтруктураПараметровДействия) Тогда
		
		Если КэшированныеЗначения.Свойство("ПроцентыСтавокНДС") Тогда
			ТекПроцентНДС = КэшированныеЗначения.ПроцентыСтавокНДС[ТекущаяСтрока.СтавкаНДС];
		Иначе
			КэшированныеЗначения.Вставить("ПроцентыСтавокНДС", Новый Соответствие);
			ТекПроцентНДС = Неопределено;
		КонецЕсли;
		
		Если ТекПроцентНДС = Неопределено Тогда
			
			ТекПроцентНДС = ОбработкаТабличнойЧастиТоварыПовтИсп.ПолучитьСтавкуНДСЧислом(ТекущаяСтрока.СтавкаНДС);
			КэшированныеЗначения.ПроцентыСтавокНДС.Вставить(ТекущаяСтрока.СтавкаНДС, ТекПроцентНДС);
			
		КонецЕсли;
		
		ТекущаяСтрока.СуммаНДС = РассчитатьСуммуНДС(ТекущаяСтрока.Сумма, ТекущаяСтрока.СтавкаНДС, СтруктураПараметровДействия.ЦенаВключаетНДС);
		
	КонецЕсли;

КонецПроцедуры


// Процедура пересчета "ПересчитатьСуммуНДСиАкцизногоНалога"
//
Процедура ПересчитатьСуммуНДСиАкцизногоНалогаВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуНДСиАкцизногоНалога", СтруктураПараметровДействия) Тогда
		
		Если КэшированныеЗначения.Свойство("ПроцентыСтавокНДС") Тогда
			ТекПроцентНДС = КэшированныеЗначения.ПроцентыСтавокНДС[ТекущаяСтрока.СтавкаНДС];
		Иначе
			КэшированныеЗначения.Вставить("ПроцентыСтавокНДС", Новый Соответствие);
			ТекПроцентНДС = Неопределено;
		КонецЕсли;
		
		Если ТекПроцентНДС = Неопределено Тогда
			
			ТекПроцентНДС = ОбработкаТабличнойЧастиТоварыПовтИсп.ПолучитьСтавкуНДСЧислом(ТекущаяСтрока.СтавкаНДС);
			КэшированныеЗначения.ПроцентыСтавокНДС.Вставить(ТекущаяСтрока.СтавкаНДС, ТекПроцентНДС);
			
		КонецЕсли;
		
		
		Если УчетАкцизногоНалогаКлиентСервер.ДействуетАкцизныйНалог(СтруктураПараметровДействия.Дата) Тогда
			ТекущаяСтрока.СуммаАкцизногоНалога = УчетАкцизногоНалогаКлиентСервер.РассчитатьСуммуАкцизногоНалога(
											 		ТекущаяСтрока.Сумма, 
													СтруктураПараметровДействия.ЦенаВключаетНДС, 
													ТекущаяСтрока.ПодакцизныйТовар, 
													ТекущаяСтрока.ПодакцизныеТоварыДляКоммерческогоИспользования
													);
		Иначе
			ТекущаяСтрока.СуммаАкцизногоНалога = 0;
		КонецЕсли; 
		
		ТекущаяСтрока.СуммаНДС = РассчитатьСуммуНДС(ТекущаяСтрока.Сумма - ТекущаяСтрока.СуммаАкцизногоНалога, ТекущаяСтрока.СтавкаНДС, СтруктураПараметровДействия.ЦенаВключаетНДС);
		
	КонецЕсли;

КонецПроцедуры
 

// Процедура пересчета "ПересчитатьСуммуНДСПоСуммеСНДС"
//
Процедура ПересчитатьСуммуНДСПоСуммеСНДСВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуНДСПоСуммеСНДС", СтруктураПараметровДействия) Тогда
		
		Если КэшированныеЗначения.Свойство("ПроцентыСтавокНДС") Тогда
			ТекПроцентНДС = КэшированныеЗначения.ПроцентыСтавокНДС[ТекущаяСтрока.СтавкаНДС];
		Иначе
			КэшированныеЗначения.Вставить("ПроцентыСтавокНДС", Новый Соответствие);
			ТекПроцентНДС = Неопределено;
		КонецЕсли;
		
		Если ТекПроцентНДС = Неопределено Тогда
			
			ТекПроцентНДС = ОбработкаТабличнойЧастиТоварыПовтИсп.ПолучитьСтавкуНДСЧислом(ТекущаяСтрока.СтавкаНДС);
			КэшированныеЗначения.ПроцентыСтавокНДС.Вставить(ТекущаяСтрока.СтавкаНДС, ТекПроцентНДС);
			
		КонецЕсли;
		
		ТекущаяСтрока.СуммаНДС = РассчитатьСуммуНДСПоСуммеСНДС(ТекущаяСтрока.СуммаВсего, ТекПроцентНДС, СтруктураПараметровДействия.ЦенаВключаетНДС);
	
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуПоСуммеСНДС"
//
Процедура ПересчитатьСуммуПоСуммеСНДСВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуПоСуммеСНДС", СтруктураПараметровДействия) Тогда
		
		Если СтруктураПараметровДействия.ЦенаВключаетНДС Тогда
			ТекущаяСтрока.Сумма = ТекущаяСтрока.СуммаВсего;
		Иначе
			ТекущаяСтрока.Сумма = ТекущаяСтрока.СуммаВсего - ТекущаяСтрока.СуммаНДС;
		КонецЕсли;
	
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуСНДС"
//
Процедура ПересчитатьСуммуСНДСВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Перем СтруктураПараметровДействия;
	
	Если СтруктураДействий.Свойство("ПересчитатьСуммуСНДС", СтруктураПараметровДействия) Тогда
		
		ТекущаяСтрока.СуммаСНДС = ТекущаяСтрока.Сумма + ?(СтруктураПараметровДействия.ЦенаВключаетНДС, 0, ТекущаяСтрока.СуммаНДС);
	
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьКоличествоУпаковок"
//
Процедура ПересчитатьКоличествоУпаковокВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Имя = "";
	
	Если СтруктураДействий.Свойство("ПересчитатьКоличествоУпаковок",Имя) Тогда
		ТекущаяСтрока["КоличествоУпаковок" + Имя] = ТекущаяСтрока["Количество" + Имя]
		   / ПолучитьКоэффициентУпаковкиСервер(ТекущаяСтрока.Упаковка, КэшированныеЗначения);
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьКоличествоУпаковокФакт"
//
Процедура ПересчитатьКоличествоУпаковокФактВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	ИмяФакта = "";
	
	Если СтруктураДействий.Свойство("ПересчитатьКоличествоУпаковокФакт",ИмяФакта) Тогда
		ТекущаяСтрока["КоличествоУпаковок" + ИмяФакта] = ТекущаяСтрока["Количество" + ИмяФакта]
		   / ПолучитьКоэффициентУпаковкиСервер(ТекущаяСтрока.Упаковка, КэшированныеЗначения);
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ПересчитатьСуммуНДС"
//
Процедура ПересчитатьСуммыНДССервер(СтруктураТЧ, СтруктураДействий, КэшированныеЗначения, СоответствиеДействий)

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ПересчитатьСуммуНДС", СтруктураПараметровДействия) Тогда
		Если СтруктураПараметровДействия.Свойство("НеобходимоОбработатьВсюТЧ") Тогда
			Для Каждого ТекСтрока Из СтруктураТЧ.СтрокиТЧ Цикл
				НоваяСтруктураДействий = Новый Структура;
				ОбщегоНазначенияРТКлиентСервер.ДобавитьВСтруктуру(НоваяСтруктураДействий, СтруктураДействий);
				СоответствиеДействий.Вставить(ТекСтрока, НоваяСтруктураДействий);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ЗаполнитьТипНоменклатуры"
//
Процедура ЗаполнитьТипНоменклатурыВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Если СтруктураДействий.Свойство("ЗаполнитьТипНоменклатуры") Тогда
		
		Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	Номенклатура.ТипНоменклатуры   КАК ТипНоменклатуры
			|ИЗ
			|	Справочник.Номенклатура КАК Номенклатура
			|ГДЕ
			|	Номенклатура.Ссылка = &Номенклатура
			|");

		Запрос.УстановитьПараметр("Номенклатура", ТекущаяСтрока.Номенклатура);

		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			ТекущаяСтрока.ТипНоменклатуры = Выборка.ТипНоменклатуры;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ЗаполнитьТипНоменклатурыВСтрокеТЧСервер()

// Процедура заполнения типа номенклатуры в ТЧ 
//
Процедура ЗаполнитьТипНоменклатурыВТЧСервер(ТаблицаФормы) Экспорт

	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваров.Номенклатура КАК Номенклатура
	|ПОМЕСТИТЬ Источник
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Источник.НомерСтроки КАК НомерСтроки,
	|	Источник.Номенклатура КАК Номенклатура,
	|	ТаблицаСправочник.ТипНоменклатуры КАК ТипНоменклатуры
	|ИЗ
	|	Источник КАК Источник
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ТаблицаСправочник
	|		ПО Источник.Номенклатура = ТаблицаСправочник.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Источник.НомерСтроки,
	|	Источник.Номенклатура,
	|	ТаблицаВладельцы.ТипНоменклатуры
	|ИЗ
	|	Источник КАК Источник
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СерийныеНомера КАК ТаблицаСправочник
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ТаблицаВладельцы
	|			ПО (ТаблицаСправочник.Владелец = ТаблицаВладельцы.Ссылка)
	|		ПО Источник.Номенклатура = ТаблицаСправочник.Ссылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Источник"
	);
	Запрос.УстановитьПараметр("ТаблицаТоваров",  ТаблицаФормы.Выгрузить(,"НомерСтроки, Номенклатура"));
	
	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрТабл из ТаблицаФормы Цикл
		
		СтрокаРезультата = ТаблицаРезультата[СтрТабл.НомерСтроки-1];
		
		СтрТабл.ТипНоменклатуры = СтрокаРезультата.ТипНоменклатуры;
		
	КонецЦикла;

КонецПроцедуры

//	LNK 14.02.2020 10:20:55
Процедура ЗаполнитьКодНоменклатурыВТЧСервер(ТаблицаФормы, ИмяРеквизита = "КодНоменклатуры")	Экспорт

	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваров.Номенклатура КАК Номенклатура
	|ПОМЕСТИТЬ Источник
	|ИЗ
	|	&ТаблицаФормы КАК ТаблицаТоваров
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Источник.НомерСтроки КАК НомерСтроки,
	|	Источник.Номенклатура КАК Номенклатура,
	|	ТаблицаСправочник.Код КАК КодНоменклатуры
	|ИЗ
	|	Источник КАК Источник
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ТаблицаСправочник
	|		ПО Источник.Номенклатура = ТаблицаСправочник.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Источник.НомерСтроки,
	|	Источник.Номенклатура,
	|	ТаблицаСправочник.Владелец.Код
	|ИЗ
	|	Источник КАК Источник
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СерийныеНомера КАК ТаблицаСправочник
	|		ПО Источник.Номенклатура = ТаблицаСправочник.Ссылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Источник"
	);
	Запрос.УстановитьПараметр("ТаблицаФормы",  ТаблицаФормы.Выгрузить(, "НомерСтроки, Номенклатура"));

	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();

	Для Каждого СтрокаТаблицы из ТаблицаФормы Цикл

		СтрокаРезультата = ТаблицаРезультата[СтрокаТаблицы.НомерСтроки - 1];

		СтрокаТаблицы[ИмяРеквизита] = СтрокаРезультата.КодНоменклатуры;
		
	КонецЦикла;

КонецПроцедуры


// Процедура пересчета "ЗаполнитьПодакцизныйТовар"
//
Процедура ЗаполнитьПодакцизныйТоварВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Если СтруктураДействий.Свойство("ЗаполнитьПодакцизныйТовар") Тогда
		
		Запрос = Новый Запрос("
			|ВЫБРАТЬ
			|	Номенклатура.ПодакцизныйТовар   КАК ПодакцизныйТовар
			|ИЗ
			|	Справочник.Номенклатура КАК Номенклатура
			|ГДЕ
			|	Номенклатура.Ссылка = &Номенклатура
			|");

		Запрос.УстановитьПараметр("Номенклатура", ТекущаяСтрока.Номенклатура);

		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			ТекущаяСтрока.ПодакцизныйТовар = Выборка.ПодакцизныйТовар;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ЗаполнитьТипНоменклатурыВСтрокеТЧСервер()

// Процедура заполнения подакцизного товара в ТЧ 
//
Процедура ЗаполнитьПодакцизныйТоварВТЧСервер(ТаблицаФормы) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки,
	|	ТаблицаТоваров.Номенклатура
	|ПОМЕСТИТЬ ТаблицаЗапроса
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаЗапроса.НомерСтроки,
	|	ТаблицаЗапроса.Номенклатура,
	|	ТаблицаЗапроса.Номенклатура.ПодакцизныйТовар КАК ПодакцизныйТовар
	|ИЗ
	|	ТаблицаЗапроса КАК ТаблицаЗапроса";
	
	Запрос.УстановитьПараметр("ТаблицаТоваров",  ТаблицаФормы.Выгрузить(,"НомерСтроки,Номенклатура"));
	
	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрТабл из ТаблицаФормы Цикл
		
		СтрокаРезультата = ТаблицаРезультата[СтрТабл.НомерСтроки-1];
		
		СтрТабл.ПодакцизныйТовар = СтрокаРезультата.ПодакцизныйТовар;
		
	КонецЦикла;

КонецПроцедуры
 

// Процедура заполнения типа оплат в ТЧ 
//
Процедура ЗаполнитьТипыОплатВТЧСервер(Объект) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Оплата.ВидОплаты
	|ПОМЕСТИТЬ ТаблицаВидов
	|ИЗ
	|	&Оплата КАК Оплата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаВидов.ВидОплаты.ТипОплаты КАК ТипОплаты
	|ИЗ
	|	ТаблицаВидов КАК ТаблицаВидов";
	
	Запрос.УстановитьПараметр("Оплата", Объект.Оплата.Выгрузить());
	
	Результат = Запрос.Выполнить();
	ТаблицаТиповОплат = Результат.Выгрузить();
	МассивТиповОплат = ТаблицаТиповОплат.ВыгрузитьКолонку("ТипОплаты");
	
	ТаблицаОплата = Объект.Оплата.Выгрузить();
	ТаблицаОплата.ЗагрузитьКолонку(МассивТиповОплат, "ТипОплаты");
	
	Объект.Оплата.Загрузить(ТаблицаОплата);
	
КонецПроцедуры

// Процедура заполнения использования серийных номеров в ТЧ
//
Процедура ЗаполнитьИспользоватьСерийныеНомераВТЧСервер(ТаблицаФормы) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки,
	|	ТаблицаТоваров.Номенклатура
	|ПОМЕСТИТЬ ТаблицаЗапроса
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаЗапроса.НомерСтроки,
	|	ТаблицаЗапроса.Номенклатура,
	|	ТаблицаЗапроса.Номенклатура.ИспользоватьСерийныеНомера КАК ИспользоватьСерийныеНомера
	|ИЗ
	|	ТаблицаЗапроса КАК ТаблицаЗапроса";
	
	Запрос.УстановитьПараметр("ТаблицаТоваров",  ТаблицаФормы.Выгрузить(,"НомерСтроки,Номенклатура"));
	
	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрТабл из ТаблицаФормы Цикл
		
		СтрокаРезультата = ТаблицаРезультата[СтрТабл.НомерСтроки-1];
		
		СтрТабл.ИспользоватьСерийныеНомера = СтрокаРезультата.ИспользоватьСерийныеНомера;
		
	КонецЦикла;
	

КонецПроцедуры

// Процедура пересчета "ЗаполнитьРеквизитыПоНоменклатуре"
//
Процедура ЗаполнитьЗаполнитьРеквизитыПоНоменклатуреВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ЗаполнитьРеквизитыПоНоменклатуре", СтруктураПараметровДействия) Тогда

		Если ТипЗнч(СтруктураПараметровДействия) = Тип("Структура") Тогда	//	LNK 14.02.2020 10:19:33

			СоставРеквизитов = Справочники.Номенклатура.ПолучитьРеквизитыНоменклатуры(ТекущаяСтрока.Номенклатура);

			Для каждого КлючЗначение Из СтруктураПараметровДействия Цикл

				Если СоставРеквизитов.Свойство(КлючЗначение.Ключ) Тогда

					ТекущаяСтрока[КлючЗначение.Значение] = СоставРеквизитов[КлючЗначение.Ключ];

				КонецЕсли;

			КонецЦикла;
			//ТекущаяСтрока.ЭтоУслуга               = Реквизиты.ЭтоУслуга;
			//ТекущаяСтрока.ЭтоПодарочныйСертификат = Реквизиты.ЭтоПодарочныйСертификат;

		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

Процедура ЗаполнитьДубликатыЗависимыхРеквизитовСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)
	
	Перем ПараметрСтруктурыДействий;
	Если Не СтруктураДействий.Свойство("ЗаполнитьДубликатыЗависимыхРеквизитов", ПараметрСтруктурыДействий) Тогда
		Возврат;
	КонецЕсли;
	
	// ПараметрСтруктурыДействий - Структура
	// 		Ключ: Имя реквизита флага активности
	// 		Значение: Строка с перечислением через запятую имен зависимых реквизитов
	
	Для Каждого ПолеСтруктуры Из ПараметрСтруктурыДействий Цикл
		
		ИмяФлагаАктивности = ПолеСтруктуры.Ключ;
		ЗначениеФлагаАктивности = ТекущаяСтрока[ИмяФлагаАктивности];
		
		ЗависимыеРеквизиты = Новый Структура(ПолеСтруктуры.Значение);
		Для Каждого Реквизит Из ЗависимыеРеквизиты Цикл
			ТекущаяСтрока[Реквизит.Ключ+ИмяФлагаАктивности] = ?(
				ЗначениеФлагаАктивности,
				ТекущаяСтрока[Реквизит.Ключ],
				0
			);
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры


Процедура ПересчитатьСуммуВозвратСУчетомОснованияВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)
	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ПересчитатьСуммуВозвратСУчетомОснования", СтруктураПараметровДействия) Тогда
		
		ЦенаВСтроке = НайтиЦенуВозврата(ТекущаяСтрока, СтруктураПараметровДействия.Основание);
		
		Если ЗначениеЗаполнено(ЦенаВСтроке) Тогда
			ТекущаяСтрока.Сумма = ЦенаВСтроке * ТекущаяСтрока.КоличествоУпаковок;
		Иначе
			ТекущаяСтрока.Сумма = ТекущаяСтрока.Цена * ТекущаяСтрока.КоличествоУпаковок;
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

Процедура ПроставитьПродавцаВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)
	Перем Продавец;

	Если СтруктураДействий.Свойство("ПроставитьПродавца", Продавец) Тогда
		
		ТекущаяСтрока.Продавец = Продавец;
		
	КонецЕсли;

КонецПроцедуры

Процедура ЗаполнитьДанныеПоДокументуПродажиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)
	Перем ИмяДокумента;

	Если СтруктураДействий.Свойство("ЗаполнитьДанныеПоДокументуПродажи", ИмяДокумента) Тогда
		
		СвойстваСтроки = ПолучитьСтруктуруСтрокиТоваровВДокументеПродажи(ТекущаяСтрока.ЧекККМ, 
																		 ИмяДокумента, 
																		 ТекущаяСтрока.Номенклатура, 
																		 ТекущаяСтрока.Характеристика);
		
		Если Не СвойстваСтроки = Неопределено Тогда
			
			ЗаполнитьЗначенияСвойств(ТекущаяСтрока, СвойстваСтроки, , "Сумма");
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

Процедура ПолучитьКоличествоНаСкладе(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)

	Перем Склад, СоставГраницы;

	Если СтруктураДействий.Свойство("ПолучитьОстатокСклада") Тогда

		УстановитьПривилегированныйРежим(Истина);

		СтруктураДействий.ПолучитьОстатокСклада.Свойство("Склад"  , Склад);
		СтруктураДействий.ПолучитьОстатокСклада.Свойство("Граница", СоставГраницы);

		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	ТоварыНаСкладах.КоличествоОстаток КАК КоличествоНаСкладе
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(
		|			&Граница,
		|			Номенклатура = &Номенклатура
		|				И Характеристика = &Характеристика
		|				И ВЫБОР
		|					КОГДА &Склад = НЕОПРЕДЕЛЕНО
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ Склад = &Склад
		|				КОНЕЦ) КАК ТоварыНаСкладах"
		);
		Запрос.УстановитьПараметр("Склад"  , Склад);
		Запрос.УстановитьПараметр("Граница", ?(СоставГраницы = Неопределено, ТекущаяДатаСеанса()
										   , ?(ТипЗнч(СоставГраницы) = Тип("Структура")
										   		, Новый Граница(Новый МоментВремени(СоставГраницы.Дата, СоставГраницы.Ссылка), ВидГраницы.Исключая), СоставГраницы)));
		Запрос.УстановитьПараметр("Номенклатура"  , ТекущаяСтрока.Номенклатура);
		Запрос.УстановитьПараметр("Характеристика", ТекущаяСтрока.Характеристика);

		Выборка = Запрос.Выполнить().Выбрать();

		Если Выборка.Следующий() Тогда

			ТекущаяСтрока.КоличествоНаСкладе = Выборка.КоличествоНаСкладе;

		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

//	LNK 05.04.2017 16:12:09
Процедура ПолучитьКоличествоПлановое(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения)

	Перем ДокументОснование;

	Если СтруктураДействий.Свойство("ПолучитьКоличествоПлановое", ДокументОснование) Тогда

		УстановитьПривилегированныйРежим(Истина);

		Запрос = Новый Запрос(
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СУММА(ТабличнаяЧасть.КоличествоУпаковок) КАК Количество
		|ИЗ
		|	Документ.ПеремещениеТоваров.Товары КАК ТабличнаяЧасть
		|ГДЕ
		|	ТабличнаяЧасть.Ссылка = &ДокументОснование
		|	И ТабличнаяЧасть.Номенклатура = &Номенклатура
		|	И ТабличнаяЧасть.Характеристика = &Характеристика
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	СУММА(ТабличнаяЧасть.КоличествоУпаковок)
		|ИЗ
		|	Документ.ВозвратТоваровОтПокупателя.Товары КАК ТабличнаяЧасть
		|ГДЕ
		|	ТабличнаяЧасть.Ссылка = &ДокументОснование
		|	И ТабличнаяЧасть.Номенклатура = &Номенклатура
		|	И ТабличнаяЧасть.Характеристика = &Характеристика
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	СУММА(ТабличнаяЧасть.КоличествоУпаковок)
		|ИЗ
		|	Документ.ПоступлениеТоваров.Товары КАК ТабличнаяЧасть
		|ГДЕ
		|	ТабличнаяЧасть.Ссылка = &ДокументОснование
		|	И ТабличнаяЧасть.Номенклатура = &Номенклатура
		|	И ТабличнаяЧасть.Характеристика = &Характеристика
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	СУММА(ТабличнаяЧасть.КоличествоУпаковок)
		|ИЗ
		|	Документ.ЗаказПоставщику.Товары КАК ТабличнаяЧасть
		|ГДЕ
		|	ТабличнаяЧасть.Ссылка = &ДокументОснование
		|	И ТабличнаяЧасть.Номенклатура = &Номенклатура
		|	И ТабличнаяЧасть.Характеристика = &Характеристика"
		);
		Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
		Запрос.УстановитьПараметр("Номенклатура"     , ТекущаяСтрока.Номенклатура);
		Запрос.УстановитьПараметр("Характеристика"   , ТекущаяСтрока.Характеристика);

		Выборка = Запрос.Выполнить().Выбрать();

		Если Выборка.Следующий() Тогда

			ТекущаяСтрока.КоличествоПлановое = Выборка.Количество;

		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

// ПРОЧИЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Процедура получения списка упаковок для выбора
//
Функция ПолучитьСписокДляВыбораУпаковок(Номенклатура, ДанныеВыбора, ДобавлятьПустуюУпаковку, СтрокаПоиска = Неопределено) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЕСТЬNULL(СпрУпаковки.Ссылка, НЕОПРЕДЕЛЕНО) КАК Упаковка,
	|	ПРЕДСТАВЛЕНИЕ(СпрУпаковки.Ссылка) КАК УпаковкаПредставление,
	|	ПРЕДСТАВЛЕНИЕ(СпрНоменклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление
	|ИЗ
	|	Справочник.Номенклатура КАК СпрНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УпаковкиНоменклатуры КАК СпрУпаковки
	|		ПО (СпрУпаковки.Владелец = ВЫБОР
	|				КОГДА СпрНоменклатура.НаборУпаковок = ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ИндивидуальныйДляНоменклатуры)
	|					ТОГДА СпрНоменклатура.Ссылка
	|				КОГДА СпрНоменклатура.НаборУпаковок <> ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.ПустаяСсылка)
	|					ТОГДА СпрНоменклатура.НаборУпаковок
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|ГДЕ
	|	СпрНоменклатура.Ссылка = &Номенклатура
	|	" + ?(СтрокаПоиска = Неопределено, "", "И СпрУпаковки.Наименование ПОДОБНО &СтрокаПоиска") + "
	|   И НЕ СпрУпаковки.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	СпрУпаковки.Коэффициент,
	|	СпрУпаковки.Ссылка
	|АВТОУПОРЯДОЧИВАНИЕ";

	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);

	Если СтрокаПоиска <> Неопределено Тогда
		Запрос.УстановитьПараметр("СтрокаПоиска", СтрокаПоиска + "%");
	КонецЕсли;
	
	Если ДобавлятьПустуюУпаковку Тогда
		ДанныеВыбора.Добавить(Справочники.УпаковкиНоменклатуры.ПустаяСсылка(),Номенклатура.ЕдиницаИзмерения);
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
			Если Выборка.Упаковка <> Неопределено Тогда
				ДанныеВыбора.Добавить(Выборка.Упаковка, Выборка.УпаковкаПредставление);
			КонецЕсли;
	КонецЦикла;

	Возврат Истина;

КонецФункции

// Проверка на использование характеристик и получение списка для выбора
//
Функция ПроверитьИспользованиеХарактеристикИПолучитьСписокДляВыбора(Номенклатура, ДанныеВыбора, СтрокаПоиска = Неопределено) Экспорт

	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	ЕСТЬNULL(СпрХарактеристики.Ссылка, НЕОПРЕДЕЛЕНО) КАК Характеристика,
	|	ПРЕДСТАВЛЕНИЕ(СпрХарактеристики.Ссылка) КАК ХарактеристикаПредставление,
	|	ВЫБОР КОГДА СпрНоменклатура.ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.НеИспользовать) ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ
	|		ИСТИНА
	|	КОНЕЦ КАК ИспользоватьХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК СпрНоменклатура
	|ЛЕВОЕ СОЕДИНЕНИЕ
	|	Справочник.ХарактеристикиНоменклатуры КАК СпрХарактеристики
	|ПО
	|	СпрХарактеристики.Владелец = ВЫБОР КОГДА СпрНоменклатура.ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры) ТОГДА
	|			СпрНоменклатура.ВидНоменклатуры
	|		КОГДА СпрНоменклатура.ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры) ТОГДА
	|			СпрНоменклатура.Ссылка
	|		ИНАЧЕ
	|			ЛОЖЬ
	|		КОНЕЦ
	|ГДЕ
	|	СпрНоменклатура.Ссылка = &Номенклатура
	|	" + ?(СтрокаПоиска = Неопределено, "", "И СпрХарактеристики.Наименование ПОДОБНО &СтрокаПоиска") + "
	|УПОРЯДОЧИТЬ ПО
	|	СпрХарактеристики.Ссылка
	|АВТОУПОРЯДОЧИВАНИЕ
	|");

	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);

	Если СтрокаПоиска <> Неопределено Тогда
		Запрос.УстановитьПараметр("СтрокаПоиска", СтрокаПоиска + "%");
	КонецЕсли;

	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Выборка.ИспользоватьХарактеристики Тогда
			Если Выборка.Характеристика <> Неопределено Тогда
				ДанныеВыбора.Добавить(Выборка.Характеристика, Выборка.ХарактеристикаПредставление);
			КонецЕсли;
		Иначе
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;

	Возврат Истина;

КонецФункции

// Проверка на использование характеристик и получение владельца для выбора
//
Функция ПроверитьИспользованиеХарактеристикИПолучитьВладельцаДляВыбора(Номенклатура, ВладелецХарактеристики) Экспорт

	СтруктураРеквизитов = Новый Структура;
	СтруктураРеквизитов.Вставить("ВидНоменклатуры"           , "ВидНоменклатуры");
	СтруктураРеквизитов.Вставить("ИспользованиеХарактеристик", "ВидНоменклатуры.ИспользованиеХарактеристик");
	ЗначенияРеквизитовВИБ = ОбщегоНазначенияРТ.ПолучитьЗначенияРеквизитовОбъекта(Номенклатура, СтруктураРеквизитов);

	Если ЗначенияРеквизитовВИБ.ИспользованиеХарактеристик = Перечисления.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.НеИспользовать Тогда
		ИспользованиеХарактеристик = Ложь;
	Иначе
		ИспользованиеХарактеристик = Истина;

		Если ЗначенияРеквизитовВИБ.ИспользованиеХарактеристик = Перечисления.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры Тогда
			ВладелецХарактеристики = ЗначенияРеквизитовВИБ.ВидНоменклатуры;
		Иначе
			ВладелецХарактеристики = Номенклатура;
		КонецЕсли;
	КонецЕсли;

	Возврат ИспользованиеХарактеристик;

КонецФункции

// Процедура заполнения колонок "ХарактеристикиИспользуются" в формах.
// Параметры:
//	ТаблицаФормы - ДанныеФормыКоллекция
//	ПараметрыЗаполнения - структура
//		возможное поле (необязательное):
//  СуффиксДопРеквизита - суффикс реквизитов "Номенклатура" и "Характеристика", если в ТЧ есть такие реквизиты
Процедура ЗаполнитьПризнакИспользованияХарактеристик(ТаблицаФормы, ПараметрыЗаполнения = Неопределено, НомерСтроки = 0) Экспорт
	
	Перем СуффиксДопРеквизита;
	
	Если ТаблицаФормы.Количество() = 0
		Или Не ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристикиНоменклатуры") Тогда
		Возврат;
	КонецЕсли;
	
	Если ПараметрыЗаполнения <> Неопределено Тогда
		
		ПараметрыЗаполнения.Свойство("СуффиксДопРеквизита",СуффиксДопРеквизита);	
		
	КонецЕсли;
	
	Если НомерСтроки = 0 Тогда
		Запрос = Новый Запрос;
		ТекстЗапроса =
		"ВЫБРАТЬ
		|	ТаблицаТоваров.НомерСтроки,";
		Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
			ТекстЗапроса = ТекстЗапроса + "	
		|	ТаблицаТоваров.Номенклатура" + СуффиксДопРеквизита +"  КАК Номенклатура" + СуффиксДопРеквизита +","; 
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + "	
		|	ТаблицаТоваров.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ ТаблицаТоваров
		|ИЗ
		|	&ТаблицаТоваров КАК ТаблицаТоваров
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаТоваров.НомерСтроки,";
		Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
			ТекстЗапроса = ТекстЗапроса + "	
			|	ВЫБОР
			|		КОГДА ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
			|				ИЛИ ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры)	
			|			ТОГДА ИСТИНА
			|		ИНАЧЕ ЛОЖЬ
			|	КОНЕЦ КАК ХарактеристикиИспользуются" + СуффиксДопРеквизита +",";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + "	
		|	ВЫБОР
		|		КОГДА ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
		|			ИЛИ ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ХарактеристикиИспользуются
		|ИЗ
		|	ТаблицаТоваров КАК ТаблицаТоваров
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";
		
		Запрос.Текст = ТекстЗапроса;
		
		СтрокаДопРеквизитов = ?(Не ЗначениеЗаполнено(СуффиксДопРеквизита), "", ",Номенклатура"+СуффиксДопРеквизита);
		Запрос.УстановитьПараметр("ТаблицаТоваров",  ТаблицаФормы.Выгрузить(,"НомерСтроки,Номенклатура"+СтрокаДопРеквизитов));
		
		ТаблицаПризнаков = Запрос.Выполнить().Выгрузить();
		
		Для Каждого СтрТабл из ТаблицаФормы Цикл
			
			СтрокаХарактеристик = ТаблицаПризнаков[СтрТабл.НомерСтроки-1];
			
			СтрТабл.ХарактеристикиИспользуются = СтрокаХарактеристик.ХарактеристикиИспользуются;
			Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
				СтрТабл["ХарактеристикиИспользуются"+СуффиксДопРеквизита] = СтрокаХарактеристик["ХарактеристикиИспользуются"+СуффиксДопРеквизита];
			КонецЕсли;
			
		КонецЦикла;
	Иначе
		ОбрабатываемаяСтрока = ТаблицаФормы[НомерСтроки-1];
		Запрос = Новый Запрос;
		ТекстЗапроса =
		"ВЫБРАТЬ
		|	1 КАК НомерСтроки,";
		Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
			ТекстЗапроса = ТекстЗапроса + "	
		|	ТаблицаТоваров" + СуффиксДопРеквизита +"  КАК Номенклатура" + СуффиксДопРеквизита +","; 
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + "	
		|	ТаблицаТоваров.Ссылка КАК Номенклатура
		|ПОМЕСТИТЬ ТаблицаТоваров
		|ИЗ
		|	Справочник.Номенклатура КАК ТаблицаТоваров
		|ГДЕ
		|	ТаблицаТоваров.Ссылка = &Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаТоваров.НомерСтроки,";
		Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
			ТекстЗапроса = ТекстЗапроса + "	
			|	ВЫБОР
			|		КОГДА ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
			|				ИЛИ ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры)	
			|			ТОГДА ИСТИНА
			|		ИНАЧЕ ЛОЖЬ
			|	КОНЕЦ КАК ХарактеристикиИспользуются" + СуффиксДопРеквизита +",";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + "	
		|	ВЫБОР
		|		КОГДА ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
		|			ИЛИ ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ХарактеристикиИспользуются
		|ИЗ
		|	ТаблицаТоваров КАК ТаблицаТоваров
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";
		Запрос.Текст = ТекстЗапроса;
		Запрос.УстановитьПараметр("Номенклатура", ОбрабатываемаяСтрока.Номенклатура);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			ОбрабатываемаяСтрока.ХарактеристикиИспользуются = Выборка.ХарактеристикиИспользуются;
			Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
				ОбрабатываемаяСтрока["ХарактеристикиИспользуются" + СуффиксДопРеквизита] = Выборка["ХарактеристикиИспользуются" + СуффиксДопРеквизита];
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

//	LNK 15.11.2016 15:03:07
Процедура ЗаполнитьКоличествоНаСкладе(Склад, МоментВремени, ТаблицаФормы)	Экспорт

	УстановитьПривилегированныйРежим(Истина);

	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(Товары.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	Товары.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ Товары
	|ИЗ
	|	&ТаблицаТоваров КАК Товары
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Номенклатура КАК Номенклатура,
	|	Товары.Характеристика КАК Характеристика,
	|	ЕСТЬNULL(ТоварыНаСкладах.КоличествоОстаток, 0) КАК КоличествоНаСкладе
	|ИЗ
	|	Товары КАК Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				&Граница,
	|				Склад = &Склад
	|					И (Номенклатура, Характеристика) В
	|						(ВЫБРАТЬ
	|							Товары.Номенклатура,
	|							Товары.Характеристика
	|						ИЗ
	|							Товары)) КАК ТоварыНаСкладах
	|		ПО Товары.Номенклатура = ТоварыНаСкладах.Номенклатура
	|			И Товары.Характеристика = ТоварыНаСкладах.Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Товары"
	);
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("Граница", Новый Граница(МоментВремени, ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("ТаблицаТоваров",  ТаблицаФормы.Выгрузить(, "Номенклатура, Характеристика"));
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаРезультат = РезультатЗапроса.Выгрузить();
	
	Для каждого СтрокаТаблицыФормы Из ТаблицаФормы Цикл

		СтрокиТаблицы = ТаблицаРезультат.НайтиСтроки(
						Новый Структура(
							"Номенклатура, Характеристика"
							, СтрокаТаблицыФормы.Номенклатура
							, СтрокаТаблицыФормы.Характеристика
						)
		);

		Если СтрокиТаблицы.Количество() = 0 Тогда

				СтрокаТаблицыФормы.КоличествоНаСкладе = 0;

		Иначе	СтрокаТаблицыФормы.КоличествоНаСкладе = СтрокиТаблицы[0].КоличествоНаСкладе;

		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

//	LNK 13.07.2017 11:13:24
Процедура ЗаполнитьКоличествоАМпоСкладу(Склад, ТаблицаФормы)	Экспорт

	УстановитьПривилегированныйРежим(Истина);

	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ТаблицаАссортимент.Номенклатура КАК Номенклатура,
	|	МАКСИМУМ(ТаблицаАссортимент.Количество) КАК КоличествоАМ
	|ИЗ
	|	РегистрСведений.АссортиментнаяМатрица КАК ТаблицаАссортимент
	|ГДЕ
	|	ТаблицаАссортимент.Номенклатура В(&СписокСсылок)
	|	И ТаблицаАссортимент.Склад = &Склад
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаАссортимент.Номенклатура"
	);
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("СписокСсылок", ТаблицаФормы.Выгрузить(, "Номенклатура").ВыгрузитьКолонку("Номенклатура"));
	
	ТаблицаРезультат = Запрос.Выполнить().Выгрузить();
	ТаблицаРезультат.Индексы.Добавить("Номенклатура");
	
	Для каждого СтрокаТаблицыФормы Из ТаблицаФормы Цикл

		СтрокаТаблицы = ТаблицаРезультат.Найти(СтрокаТаблицыФормы.Номенклатура, "Номенклатура");

		Если СтрокаТаблицы = Неопределено Тогда

				СтрокаТаблицыФормы.КоличествоАМ = 0;

		Иначе	СтрокаТаблицыФормы.КоличествоАМ = СтрокаТаблицы.КоличествоАМ;

		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

//	LNK 05.04.2017 16:29:36
Процедура ЗаполнитьКоличествоПлановое(ДокументОснование, ТаблицаФормы)	Экспорт

	УстановитьПривилегированныйРежим(Истина);

	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	&ДокументОснование КАК ДокументОснование,
	|	ВЫРАЗИТЬ(Товары.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	Товары.Характеристика КАК Характеристика,
	|	Товары.НомерСтроки
	|ПОМЕСТИТЬ Товары
	|ИЗ
	|	&ТаблицаТоваров КАК Товары
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОснование,
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Ведущая.Номенклатура,
	|	Ведущая.Характеристика,
	|	Ведущая.НомерСтроки КАК НомерСтроки,
	|	СУММА(ТабличнаяЧасть.КоличествоУпаковок) КАК Количество
	|ИЗ
	|	Товары КАК Ведущая
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров.Товары КАК ТабличнаяЧасть
	|		ПО Ведущая.ДокументОснование = ТабличнаяЧасть.Ссылка
	|			И Ведущая.Номенклатура = ТабличнаяЧасть.Номенклатура
	|			И Ведущая.Характеристика = ТабличнаяЧасть.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	Ведущая.Номенклатура,
	|	Ведущая.Характеристика,
	|	Ведущая.НомерСтроки
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки"
	);
	Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
	Запрос.УстановитьПараметр("ТаблицаТоваров",  ТаблицаФормы.Выгрузить(, "НомерСтроки, Номенклатура, Характеристика"));
	
	ТаблицаРезультат = Запрос.Выполнить().Выгрузить();
	
	Для каждого СтрокаТаблицыФормы Из ТаблицаФормы Цикл

		СтрокаРезультат = ТаблицаРезультат[СтрокаТаблицыФормы.НомерСтроки - 1];
		СтрокаТаблицыФормы.КоличествоПлановое = СтрокаРезультат.Количество;
		СтрокаТаблицыФормы.КоличествоРазница  = СтрокаТаблицыФормы.КоличествоПлановое - СтрокаТаблицыФормы.КоличествоУпаковок;

	КонецЦикла;

КонецПроцедуры

// Процедура проверки заполнения колонок "Характеристика" в формах.
// Параметры:
//	Объект - ДокументОбъект (СправочникОбъект и т.п.)
//  МассивНепроверяемыхРеквизитов - массив реквизитов, которые не нужно проверять платформенной проверкой
//	Отказ - отказ продолжения операции
//	ПараметрыЗаполнения - структура
//		возможные поля (все необязательные):
//  СуффиксДопРеквизита - суффикс реквизитов "Номенклатура" и "Характеристика", если в ТЧ есть такие реквизиты,
//						например, "Оприходование", если в ТЧ помимо "Номенклатура" и "Характеристика" есть еще
//						"НоменклатураОприходование" и "ХарактеристикаОприходование"
//	ИмяТЧ - имя проверяемой табличной части, если оно отличается от "Товары"
Процедура ПроверитьЗаполнениеХарактеристик(Объект,МассивНепроверяемыхРеквизитов,Отказ,ПараметрыПроверки = Неопределено) Экспорт
	
	Перем СуффиксДопРеквизита;
	Перем ИмяТЧ;
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристикиНоменклатуры") Тогда
		Возврат;
	КонецЕсли;
	
	Если ПараметрыПроверки <> Неопределено Тогда
		
		ПараметрыПроверки.Свойство("ИмяТЧ",ИмяТЧ);
		ПараметрыПроверки.Свойство("СуффиксДопРеквизита",СуффиксДопРеквизита);
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ИмяТЧ) Тогда
		ИмяТЧ = "Товары";
	КонецЕсли;
	
	МассивНепроверяемыхРеквизитов.Добавить(ИмяТЧ+".Характеристика");
	
	Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
		МассивНепроверяемыхРеквизитов.Добавить(ИмяТЧ+".Характеристика"+СуффиксДопРеквизита);
	КонецЕсли;
	
	МетаданныеОбъекта = Объект.Метаданные();
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки,";
	Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
		ТекстЗапроса = ТекстЗапроса + "
	|	ТаблицаТоваров.Номенклатура"+СуффиксДопРеквизита+" КАК Номенклатура"+СуффиксДопРеквизита+",
	|	ТаблицаТоваров.Характеристика"+СуффиксДопРеквизита+" КАК Характеристика"+СуффиксДопРеквизита+",";
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса + "
	|	ТаблицаТоваров.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваров.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ СтрокиСОшибками
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|ГДЕ
	|	ТаблицаТоваров.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)";
	Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
		ТекстЗапроса = ТекстЗапроса + "
	|	ИЛИ ТаблицаТоваров.Характеристика"+СуффиксДопРеквизита+" = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)";
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса + "
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СтрокиСОшибками.НомерСтроки,";
	Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
		ТекстЗапроса = ТекстЗапроса + "	
		|	ВЫБОР
		|		КОГДА (ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
		|				ИЛИ ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры))
		|			И СтрокиСОшибками.Характеристика"+СуффиксДопРеквизита+" = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК НеЗаполненаХарактеристика" + СуффиксДопРеквизита +",";
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса + "	
	|	ВЫБОР
	|		КОГДА (ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
	|			ИЛИ ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры))
	|			И СтрокиСОшибками.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК НеЗаполненаХарактеристика
	|ИЗ
	|	СтрокиСОшибками КАК СтрокиСОшибками
	|ГДЕ
	|	(ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
	|			ИЛИ ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры))
	| 	И СтрокиСОшибками.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)";
	Если ЗначениеЗаполнено(СуффиксДопРеквизита) Тогда
		ТекстЗапроса = ТекстЗапроса + "
	|	ИЛИ (ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ОбщиеДляВидаНоменклатуры)
	|			ИЛИ ВЫРАЗИТЬ(СтрокиСОшибками.Номенклатура" + СуффиксДопРеквизита +" КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыВеденияДополнительныхДанныхПоНоменклатуре.ИндивидуальныеДляНоменклатуры))
	|	И СтрокиСОшибками.Характеристика"+СуффиксДопРеквизита+" = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)";
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапроса;
	
	СтрокаДопРеквизитов = ?(Не ЗначениеЗаполнено(СуффиксДопРеквизита), "", ",Номенклатура"+СуффиксДопРеквизита+",Характеристика"+СуффиксДопРеквизита);
	Запрос.УстановитьПараметр("ТаблицаТоваров",  Объект[ИмяТЧ].Выгрузить(,"НомерСтроки,Номенклатура,Характеристика"+СтрокаДопРеквизитов));
	
	ШаблонСообщения = "Не заповнено значення «%Характеристика%» в рядку %НомерСтроки% списку «%ТаблицаТовары%».";
	
	Выборка = Запрос.Выполнить().Выбрать();
	ПредставлениеТЧ                      = МетаданныеОбъекта.ТабличныеЧасти[ИмяТЧ].Синоним;
	ПредставлениеРеквизитаХарактеристика = МетаданныеОбъекта.ТабличныеЧасти[ИмяТЧ].Реквизиты.Характеристика.Синоним;
	ПредставлениеРеквизитаХарактеристикаДоп = МетаданныеОбъекта.ТабличныеЧасти[ИмяТЧ].Реквизиты["Характеристика"+СуффиксДопРеквизита].Синоним;
	
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.НеЗаполненаХарактеристика Тогда
			
			ТекстСообщения = СтрЗаменить(ШаблонСообщения, "%Характеристика%", ПредставлениеРеквизитаХарактеристика);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ТаблицаТовары%", ПредставлениеТЧ);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%НомерСтроки%", Выборка.НомерСтроки);
			
			Поле
			= ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТЧ, Выборка.НомерСтроки, "Характеристика");
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,Поле,"Объект",Отказ);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СуффиксДопРеквизита)
			И Выборка["НеЗаполненаХарактеристика" + СуффиксДопРеквизита] Тогда
			
			ТекстСообщения = СтрЗаменить(ШаблонСообщения, "%Характеристика%", ПредставлениеРеквизитаХарактеристикаДоп);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ТаблицаТовары%", ПредставлениеТЧ);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%НомерСтроки%", Выборка.НомерСтроки);
			
			Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТЧ, Выборка.НомерСтроки, "Характеристика"+СуффиксДопРеквизита);
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,Поле,"Объект",Отказ);
		КонецЕсли;
		
	КонецЦикла;
		
КонецПроцедуры

// Процедура проверки заполнения колонки "Номенклатура" в документах.
// Параметры:
//	Объект - ДокументОбъект
//	Отказ - отказ продолжения операции
//	ПараметрыПроверки - структура
//		возможные поля (все необязательные):
//  ИмяРеквизита - имя проверяемого реквизита с типом СправочникСсылка.Номенклатура, по умолчанию "Номенклатура"
//	ИмяТЧ - имя проверяемой табличной части, по умолчанию "Товары"
Процедура ПроверитьЗаполнениеТЧПриНаличииОбменаСУправлениемТорговлей(Объект, Отказ, ПараметрыПроверки = Неопределено) Экспорт
	
	Перем ИмяРеквизита;
	Перем ИмяТЧ;
		
	ИспользуетсяОбменСУправлениемТорговлей = Константы.ИспользуетсяОбменСУправлениемТорговлей.Получить();
	Если НЕ ИспользуетсяОбменСУправлениемТорговлей Тогда
		Возврат;
	КонецЕсли;	
	
	ИмяТЧ = "Товары";
	ИмяРеквизита = "Номенклатура";
	
	Если ПараметрыПроверки <> Неопределено Тогда
		Если ПараметрыПроверки.Свойство("ИмяТЧ") Тогда
			ИмяТЧ = ПараметрыПроверки.ИмяТЧ;
		КонецЕсли;	
		Если ПараметрыПроверки.Свойство("ИмяРеквизита") Тогда
			ИмяРеквизита = ПараметрыПроверки.ИмяРеквизита;
		КонецЕсли;			
	КонецЕсли;
			
	МетаданныеОбъекта = Объект.Метаданные();
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	Товары.НомерСтроки КАК НомерСтроки,
	|	Товары.Номенклатура КАК Номенклатура
	|ПОМЕСТИТЬ Товары
	|ИЗ
	|	&ТаблицаТоваров КАК Товары
	|ГДЕ
	|	Товары.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.НомерСтроки,
	|	Товары.Номенклатура,
	|	СправочникНоменклатура.ТипНоменклатуры КАК ТипНоменклатуры,
	|	ВЫБОР
	|		КОГДА СправочникНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар)
	|			ТОГДА 1
	|		КОГДА СправочникНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЕстьТовары,
	|	ВЫБОР
	|		КОГДА СправочникНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат)
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЕстьСертификаты
	|ПОМЕСТИТЬ Т
	|ИЗ
	|	Товары КАК Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СправочникНоменклатура
	|		ПО Товары.Номенклатура = СправочникНоменклатура.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.НомерСтроки КАК НомерСтроки,
	|	Товары.Номенклатура КАК Номенклатура
	|ИЗ
	|	Т КАК ТоварыСводно
	|		ЛЕВОЕ СОЕДИНЕНИЕ Т КАК Товары
	|		ПО (ИСТИНА)
	|
	|СГРУППИРОВАТЬ ПО
	|	Товары.Номенклатура,
	|	Товары.НомерСтроки,
	|	Товары.ТипНоменклатуры
	|
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(ТоварыСводно.ЕстьТовары) = 1 И
	|	МАКСИМУМ(ТоварыСводно.ЕстьСертификаты) = 1 И
	|	Товары.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат)");
	
	
	ТаблицаТоваров = Объект[ИмяТЧ].Выгрузить(,"НомерСтроки," + ИмяРеквизита);
	КолонкаТаблицыТоваров = ТаблицаТоваров.Колонки[ИмяРеквизита];
	КолонкаТаблицыТоваров.Имя = "Номенклатура";                	
	Запрос.УстановитьПараметр("ТаблицаТоваров",  ТаблицаТоваров);
	
	ПредставлениеТЧ                      = МетаданныеОбъекта.ТабличныеЧасти[ИмяТЧ].Синоним;
	ПредставлениеРеквизитаНоменклатура   = МетаданныеОбъекта.ТабличныеЧасти[ИмяТЧ].Реквизиты[ИмяРеквизита].Синоним;
	ШаблонСообщения =	"У рядку %НомерСтроки% в колонці «%Номенклатура%» списку «%ТаблицаТоваров%»
						|вказано подарунковий сертифікат.
						|При сумісному використанні з конфігурацією «Управління торговлею для України» 
						|операції з подарунковими сертифікатами оформлюються окремими документами.";
	ШаблонСообщения = СтрЗаменить(ШаблонСообщения, "%Номенклатура%", ПредставлениеРеквизитаНоменклатура);
	ШаблонСообщения = СтрЗаменить(ШаблонСообщения, "%ТаблицаТоваров%", ПредставлениеТЧ);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтрЗаменить(ШаблонСообщения, "%НомерСтроки%", Выборка.НомерСтроки);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения,
			,
			ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТЧ, Выборка.НомерСтроки, ИмяРеквизита),
			"Объект",
			Отказ);
			
	КонецЦикла;

КонецПроцедуры

Функция ПолучитьКоэффициентУпаковкиСервер(ТекУпаковка, КэшированныеЗначения)

	Если ЗначениеЗаполнено(ТекУпаковка) Тогда
		ТекКоэффициент = КэшированныеЗначения.КоэффициентыУпаковок[ТекУпаковка];
		Если ТекКоэффициент = Неопределено Тогда
			ТекКоэффициент = ТекУпаковка.Коэффициент;
			КэшированныеЗначения.КоэффициентыУпаковок.Вставить(ТекУпаковка, ТекКоэффициент);
			КэшированныеЗначения.ОбъемУпаковок.Вставить(ТекУпаковка, ТекУпаковка.Объем);
			КэшированныеЗначения.ВесУпаковок.Вставить(ТекУпаковка, ТекУпаковка.Вес);
		КонецЕсли;
	Иначе
		ТекКоэффициент = 1;
	КонецЕсли;

	Возврат ТекКоэффициент;

КонецФункции

Функция ПолучитьВесУпаковкиСервер(ТекУпаковка, КэшированныеЗначения)

	Если ЗначениеЗаполнено(ТекУпаковка) Тогда
		ТекВес = КэшированныеЗначения.ВесУпаковок[ТекУпаковка];
		Если ТекВес = Неопределено Тогда
			ТекВес = ТекУпаковка.Вес;
			КэшированныеЗначения.КоэффициентыУпаковок.Вставить(ТекУпаковка, ТекУпаковка.Коэффициент);
			КэшированныеЗначения.ОбъемУпаковок.Вставить(ТекУпаковка, ТекУпаковка.Объем);
			КэшированныеЗначения.ВесУпаковок.Вставить(ТекУпаковка, ТекВес);
		КонецЕсли;
	Иначе
		ТекВес = 0;
	КонецЕсли;

	Возврат ТекВес;

КонецФункции

Функция ПолучитьОбъемУпаковкиСервер(ТекУпаковка, КэшированныеЗначения)

	Если ЗначениеЗаполнено(ТекУпаковка) Тогда
		ТекОбъем = КэшированныеЗначения.ОбъемУпаковок[ТекУпаковка];
		Если ТекОбъем = Неопределено Тогда
			ТекОбъем = ТекУпаковка.Объем;
			КэшированныеЗначения.КоэффициентыУпаковок.Вставить(ТекУпаковка, ТекУпаковка.Коэффициент);
			КэшированныеЗначения.ОбъемУпаковок.Вставить(ТекУпаковка, ТекОбъем);
			КэшированныеЗначения.ВесУпаковок.Вставить(ТекУпаковка, ТекУпаковка.Вес);
		КонецЕсли;
	Иначе
		ТекОбъем = 0;
	КонецЕсли;

	Возврат ТекОбъем;

КонецФункции

// Процедура устанавливает параметры выбора для номенклатуры.
//
// Параметры:
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа
//	ЭлементНоменклатура - ПолеФормы - Поле для ввода номенклатуры.
//
Процедура УстановитьПараметрыВыбораНоменклатуры(ХозяйственнаяОперация, ЭлементНоменклатура) Экспорт
	
	МассивПараметров = Новый Массив;
	
	Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию
	 ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПриемНаКомиссию
	 ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОтКомиссионера
	Тогда
		МассивПараметров.Добавить(Новый ПараметрВыбора("Отбор.ТипНоменклатуры", Перечисления.ТипыНоменклатуры.Товар));
	КонецЕсли;
	
	ЭлементНоменклатура.ПараметрыВыбора = Новый ФиксированныйМассив(МассивПараметров);
	
КонецПроцедуры // УстановитьПараметрыВыбораНоменклатуры()

// Рассчитывает сумму НДС от суммы в зависимости от включения НДС в цену
//
// Сумма           - Число - Сумма, от которой необходимо рассчитать сумму НДС
// СтавкаНДС       - ПеречислениеСсылка.СтавкиНДС - Ставка НДС
// ЦенаВключаетНДС - Булево - Признак включения НДС в цену
//
Функция   РассчитатьСуммуНДС(Сумма, СтавкаНДС, ЦенаВключаетНДС = Истина) Экспорт
	
	ПроцентНДС = ОбработкаТабличнойЧастиТоварыПовтИсп.ПолучитьСтавкуНДСЧислом(СтавкаНДС);
	
	Если ЦенаВключаетНДС Тогда
		СуммаНДС = Сумма * ПроцентНДС / (ПроцентНДС + 1);
	Иначе
		СуммаНДС = Сумма * ПроцентНДС;
	КонецЕсли;
	
	Возврат СуммаНДС;
	
КонецФункции 

Функция РассчитатьСуммуНДСПоСуммеСНДС(Сумма, ПроцентНДС, ЦенаВключаетНДС = Истина) Экспорт
	
	Если ЦенаВключаетНДС Тогда
		СуммаНДС = Сумма * ПроцентНДС / (ПроцентНДС + 1);
	Иначе
		СуммаНДС = Сумма * (1 - 1 / (ПроцентНДС + 1));
	КонецЕсли;
	
	Возврат СуммаНДС;
	
КонецФункции

// Процедуры проверки заполнения реквизита Количество и КоличествоУпаковок в документах.
//
Процедура ПроверитьЗаполнениеКоличества(Объект, ПроверяемыеРеквизиты, Отказ, ИмяТабЧасти = "Товары") Экспорт
	
	ИмяРеквизита = "КоличествоУпаковок";
	
	ПроверяемыеРеквизиты.Удалить(ПроверяемыеРеквизиты.Найти(ИмяТабЧасти + ".Количество"));
	ПроверяемыеРеквизиты.Удалить(ПроверяемыеРеквизиты.Найти(ИмяТабЧасти + ".КоличествоУпаковок"));
	
	ШаблонОшибкаКоличества	= "Не заповнено значення «Количество» в рядку №%1 списку «%2»";
	ШаблонОшибкаПересчета	= "Виявлено нульову кількість при перерахунку в одиницю зберігання у рядку %1 списку «%2»";
	
	Для Каждого СтрокаТаб Из Объект[ИмяТабЧасти] Цикл
		Если СтрокаТаб.Количество = 0 И СтрокаТаб.КоличествоУпаковок <> 0 Тогда
			
			Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонОшибкаПересчета,
				Строка(СтрокаТаб.НомерСтроки),
				ИмяТабЧасти
			);
			
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст,
				Объект,
				ОбщегоНазначенияРТ.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ(ИмяТабЧасти, СтрокаТаб.НомерСтроки, ИмяРеквизита),
				,
				Отказ
			);
			
		ИначеЕсли СтрокаТаб.Количество = 0 Или СтрокаТаб.КоличествоУпаковок = 0 Тогда
			
			Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонОшибкаКоличества,
				Строка(СтрокаТаб.НомерСтроки),
				ИмяТабЧасти
			);
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст,
				Объект,
				ОбщегоНазначенияРТ.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ(ИмяТабЧасти, СтрокаТаб.НомерСтроки, ИмяРеквизита),
				,
				Отказ
			);
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Процедура заполнения склада продажи в строках
//
Процедура ЗаполнитьСкладПродажиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ЗаполнитьСкладПродажи", СтруктураПараметровДействия) Тогда

		Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ТекущаяСтрока.Номенклатура, "ТипНоменклатуры, НоменклатурнаяГруппа", Ложь);

	//	Если НЕ ТекущаяСтрока.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
		Если НЕ Реквизиты.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга
			ИЛИ СтруктураПараметровДействия.Свойство("ЗаполнитьДляУслуги") = Истина Тогда

			Запрос = Новый Запрос(
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ 
			|	РаспределениеПродаж.Склад,
			|	ВЫБОР
			|		КОГДА РаспределениеПродаж.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
			|			ТОГДА ВЫБОР
			|					КОГДА РаспределениеПродаж.РабочееМесто = &РабочееМесто
			|						ТОГДА 1
			|					ИНАЧЕ 2
			|				КОНЕЦ
			|		ИНАЧЕ ВЫБОР
			|				КОГДА РаспределениеПродаж.РабочееМесто = &РабочееМесто
			|					ТОГДА 3
			|				ИНАЧЕ 4
			|			КОНЕЦ
			|	КОНЕЦ КАК ПолеУпорядочивания
			|ИЗ
			|	РегистрСведений.РаспределениеПродаж КАК РаспределениеПродаж
			|ГДЕ
			|	РаспределениеПродаж.Магазин = &Магазин
			|	И (РаспределениеПродаж.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
			|			ИЛИ РаспределениеПродаж.НоменклатурнаяГруппа = ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка))
			|	И (РаспределениеПродаж.РабочееМесто = &РабочееМесто
			|			ИЛИ РаспределениеПродаж.РабочееМесто = ЗНАЧЕНИЕ(Справочник.РабочиеМеста.ПустаяСсылка))
			|
			|УПОРЯДОЧИТЬ ПО
			|	ПолеУпорядочивания");
			
			Запрос.УстановитьПараметр("Магазин", СтруктураПараметровДействия.Магазин);
			Запрос.УстановитьПараметр("РабочееМесто", СтруктураПараметровДействия.РабочееМесто);
		//	Запрос.УстановитьПараметр("НоменклатурнаяГруппа", ТекущаяСтрока.Номенклатура.НоменклатурнаяГруппа);
			Запрос.УстановитьПараметр("НоменклатурнаяГруппа", Реквизиты.НоменклатурнаяГруппа);
			
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			
			Если Выборка.Следующий() Тогда

				ТекущаяСтрока.Склад = Выборка.Склад;

			Иначе

			//	ТекущаяСтрока.Склад = СтруктураПараметровДействия.Магазин.СкладПродажи;
				ТекущаяСтрока.Склад = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураПараметровДействия.Магазин, "СкладПродажи", Ложь);

			КонецЕсли;

		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

// Процедура заполнения организации продажи в строках
//
Процедура ЗаполнитьОрганизациюПродажиВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт

	Перем СтруктураПараметровДействия;

	Если СтруктураДействий.Свойство("ЗаполнитьОрганизациюПродажи", СтруктураПараметровДействия) Тогда
		
		ДанныеНоменклатуры = ЗапасыПовтИсп.ДанныеНоменклатуры(ТекущаяСтрока.Номенклатура);

		Если ДанныеНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
			
			Запрос = Новый Запрос(
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ 
			|	РаспределениеПродажУслугПоОрганизациям.Организация,
			|	ВЫБОР
			|		КОГДА РаспределениеПродажУслугПоОрганизациям.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
			|			ТОГДА 1
			|		ИНАЧЕ 2
			|	КОНЕЦ КАК ПолеУпорядочивания
			|ИЗ
			|	РегистрСведений.РаспределениеПродажУслугПоОрганизациям КАК РаспределениеПродажУслугПоОрганизациям
			|ГДЕ
			|	РаспределениеПродажУслугПоОрганизациям.Магазин = &Магазин
			|	И (РаспределениеПродажУслугПоОрганизациям.НоменклатурнаяГруппа = &НоменклатурнаяГруппа
			|			ИЛИ РаспределениеПродажУслугПоОрганизациям.НоменклатурнаяГруппа = ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка))
			|
			|УПОРЯДОЧИТЬ ПО
			|	ПолеУпорядочивания");
			
			Запрос.УстановитьПараметр("Магазин", СтруктураПараметровДействия.Магазин);
			Запрос.УстановитьПараметр("НоменклатурнаяГруппа", ДанныеНоменклатуры.НоменклатурнаяГруппа);
			
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			
			Если Выборка.Следующий() Тогда
				ТекущаяСтрока.Организация = Выборка.Организация;
			КонецЕсли;

		Иначе

			ТекущаяСтрока.Организация = ЗапасыПовтИсп.ДанныеСклада(ТекущаяСтрока.Склад).Организация;

		КонецЕсли;

		Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.Организация) Тогда

			ТекущаяСтрока.Организация = ЗапасыПовтИсп.ДанныеМагазинаЦенообразование(СтруктураПараметровДействия.Магазин).Организация;

		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

// Процедура заполнения организации продажи в ТЧ
//
Процедура ЗаполнитьОрганизациюПродажиВТЧСервер(ТаблицаФормы, СтруктураПараметров) Экспорт

	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РаспределениеПродажУслугПоОрганизациям.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	|	РаспределениеПродажУслугПоОрганизациям.Организация КАК Организация
	|ПОМЕСТИТЬ ТаблицаРаспределенияУслуг
	|ИЗ
	|	РегистрСведений.РаспределениеПродажУслугПоОрганизациям КАК РаспределениеПродажУслугПоОрганизациям
	|ГДЕ
	|	РаспределениеПродажУслугПоОрганизациям.Магазин = &Магазин
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки КАК НомерСтроки,
	|	ВЫРАЗИТЬ(ТаблицаТоваров.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ВЫРАЗИТЬ(ТаблицаТоваров.Склад КАК Справочник.Склады) КАК Склад
	|ПОМЕСТИТЬ ТаблицаЗапроса
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаЗапроса.НомерСтроки КАК НомерСтроки,
	|	ТаблицаЗапроса.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапроса.Номенклатура.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа
	|ПОМЕСТИТЬ ТаблицаУслуга
	|ИЗ
	|	ТаблицаЗапроса КАК ТаблицаЗапроса
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаЗапроса.Номенклатура.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВложенныйЗапрос.НомерСтроки КАК НомерСтроки,
	|	ВложенныйЗапрос.Номенклатура КАК Номенклатура,
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.Приоритет КАК Приоритет
	|ПОМЕСТИТЬ ТаблицаУслугиОрганизации
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаУслуга.НомерСтроки КАК НомерСтроки,
	|		ТаблицаУслуга.Номенклатура КАК Номенклатура,
	|		ТаблицаРаспределенияУслуг.Организация КАК Организация,
	|		1 КАК Приоритет
	|	ИЗ
	|		ТаблицаУслуга КАК ТаблицаУслуга
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРаспределенияУслуг КАК ТаблицаРаспределенияУслуг
	|			ПО ТаблицаУслуга.НоменклатурнаяГруппа = ТаблицаРаспределенияУслуг.НоменклатурнаяГруппа
	|	ГДЕ
	|		НЕ ТаблицаУслуга.НоменклатурнаяГруппа = ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ТаблицаУслуга.НомерСтроки,
	|		ТаблицаУслуга.Номенклатура,
	|		ТаблицаРаспределенияУслуг.Организация,
	|		2
	|	ИЗ
	|		ТаблицаУслуга КАК ТаблицаУслуга
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРаспределенияУслуг КАК ТаблицаРаспределенияУслуг
	|			ПО (ТаблицаУслуга.НоменклатурнаяГруппа = ТаблицаРаспределенияУслуг.НоменклатурнаяГруппа
	|					ИЛИ ТаблицаРаспределенияУслуг.НоменклатурнаяГруппа = ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка))
	|	ГДЕ
	|		ТаблицаУслуга.НоменклатурнаяГруппа = ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ТаблицаУслуга.НомерСтроки,
	|		ТаблицаУслуга.Номенклатура,
	|		&ОрганизацияПоУмолчанию,
	|		3
	|	ИЗ
	|		ТаблицаУслуга КАК ТаблицаУслуга) КАК ВложенныйЗапрос
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаЗапроса.НомерСтроки КАК НомерСтроки,
	|	ТаблицаЗапроса.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапроса.Склад.Организация КАК Организация
	|ИЗ
	|	ТаблицаЗапроса КАК ТаблицаЗапроса
	|ГДЕ
	|	НЕ ЕСТЬNULL(ТаблицаЗапроса.Номенклатура.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.НомерСтроки,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.Организация
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаУслугиОрганизации.НомерСтроки КАК НомерСтроки,
	|		ТаблицаУслугиОрганизации.Номенклатура КАК Номенклатура,
	|		ТаблицаУслугиОрганизации.Организация КАК Организация
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ТаблицаУслугиОрганизации.НомерСтроки КАК НомерСтроки,
	|			ТаблицаУслугиОрганизации.Номенклатура КАК Номенклатура,
	|			МИНИМУМ(ТаблицаУслугиОрганизации.Приоритет) КАК Приоритет
	|		ИЗ
	|			ТаблицаУслугиОрганизации КАК ТаблицаУслугиОрганизации
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ТаблицаУслугиОрганизации.Номенклатура,
	|			ТаблицаУслугиОрганизации.НомерСтроки) КАК ВложенныйЗапрос
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаУслугиОрганизации КАК ТаблицаУслугиОрганизации
	|			ПО ВложенныйЗапрос.НомерСтроки = ТаблицаУслугиОрганизации.НомерСтроки
	|				И ВложенныйЗапрос.Номенклатура = ТаблицаУслугиОрганизации.Номенклатура
	|				И ВложенныйЗапрос.Приоритет = ТаблицаУслугиОрганизации.Приоритет) КАК ВложенныйЗапрос"
	);
	Запрос.УстановитьПараметр("ТаблицаТоваров"        ,  ТаблицаФормы.Выгрузить(,"НомерСтроки,Номенклатура, Склад"));
	Запрос.УстановитьПараметр("Магазин"               ,  СтруктураПараметров.Магазин);
	Запрос.УстановитьПараметр("ОрганизацияПоУмолчанию",  СтруктураПараметров.Магазин.СкладПродажи.Организация);

	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();

	Для Каждого СтрТабл из ТаблицаФормы Цикл
		
		СтрокаРезультата = ТаблицаРезультата[СтрТабл.НомерСтроки - 1];
		
		СтрТабл.Организация = СтрокаРезультата.Организация;
		
	КонецЦикла;

КонецПроцедуры

// Процедура заполнения организации в сериях
//
Процедура ЗаполнитьОрганизациюВСериях(ТаблицаИсточник, ТаблицаПриема) Экспорт
	
	Для каждого СтрокаПриема Из ТаблицаПриема Цикл
		
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("Номенклатура"  , СтрокаПриема.Номенклатура);
		СтруктураПоиска.Вставить("Характеристика", СтрокаПриема.Характеристика);
		
		СтрокиИсточника = ТаблицаИсточник.НайтиСтроки(СтруктураПоиска);
		
		Если СтрокиИсточника.Количество() > 0  Тогда
			
			СтрокаПриема.Организация = СтрокиИсточника[0].Организация;
			
		КонецЕсли;
		
	КонецЦикла;
	
	КолвоЭлементовКоллекции = ТаблицаПриема.Количество();
	Для ОбратныйИндекс = 1 По КолвоЭлементовКоллекции Цикл
		ЭлементКоллекции = ТаблицаПриема[КолвоЭлементовКоллекции - ОбратныйИндекс];

		Если НЕ ЗначениеЗаполнено(ЭлементКоллекции.Организация) Тогда
			ТаблицаПриема.Удалить(ЭлементКоллекции);
		КонецЕсли;
	КонецЦикла;
	
	
КонецПроцедуры

// Функция поиска цены возврата
//
// Параметры:
//  СтрокаТабличнойЧасти - ссылка на строку табличной части
//  Основание - документ основание
//
// Возвращаемое значение:
//   Число - цена возврата
//
Функция НайтиЦенуВозврата(СтрокаТабличнойЧасти, Основание) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ВЫБОР
	|		КОГДА ВложенныйЗапрос.Количество = 0
	|			ТОГДА ВложенныйЗапрос.Сумма
	|		ИНАЧЕ ВложенныйЗапрос.Сумма / ВложенныйЗапрос.Количество
	|	КОНЕЦ КАК Цена
	|ИЗ
	|	(ВЫБРАТЬ
	|		СУММА(ЧекККМТовары.Сумма) КАК Сумма,
	|		СУММА(ВЫБОР
	|				КОГДА &Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиНоменклатуры.ПустаяСсылка)
	|					ТОГДА ЧекККМТовары.Количество
	|				ИНАЧЕ ЧекККМТовары.КоличествоУпаковок
	|			КОНЕЦ) КАК Количество
	|	ИЗ
	|		Документ.ЧекККМ.Товары КАК ЧекККМТовары
	|	ГДЕ
	|		ЧекККМТовары.Ссылка = &Ссылка
	|		И ЧекККМТовары.Номенклатура = &Номенклатура
	|		И ЧекККМТовары.Характеристика = &Характеристика
	|		И (ЧекККМТовары.Упаковка = &Упаковка
	|				ИЛИ &Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиНоменклатуры.ПустаяСсылка))) КАК ВложенныйЗапрос";
	
	Запрос.УстановитьПараметр("Ссылка"        , Основание);
	Запрос.УстановитьПараметр("Упаковка"      , СтрокаТабличнойЧасти.Упаковка);
	Запрос.УстановитьПараметр("Номенклатура"  , СтрокаТабличнойЧасти.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", СтрокаТабличнойЧасти.Характеристика);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Цена;
	Иначе
		Возврат 0;
	КонецЕсли;
	

КонецФункции // НайтиЦенуВозврата()

// Получает по документу, номенклатуре и характеристике номенклатуры, таблицу строк номенклатуры.
//
// Параметры
//  Документ - ссылка на документ
//  МетаданныеНаименование - имя метаданных документа
//  Номенклатура
//  Характеристика
//  ПолучитьДокументПродажи - Булево
//
// Возвращаемое значение:
//   Таблица Значений
//
Функция ПолучитьТаблицуСтрокДокументаПродажи(Документ, МетаданныеНаименование, Номенклатура, Характеристика)

	ПолучитьДокументПродажиЧекаККМ = МетаданныеНаименование = "ЧекККМ";
	
	Если ПолучитьДокументПродажиЧекаККМ Тогда
		СтрокаДокументаПродажи = " ПЕРВЫЕ 1	ДокументПродажиТовары.Ссылка.ОтчетОРозничныхПродажах КАК ДокументПродажи, "
	Иначе
		СтрокаДокументаПродажи = " РАЗЛИЧНЫЕ ДокументПродажиТовары.Ссылка КАК ДокументПродажи,";
	КонецЕсли;
	
	Если МетаданныеНаименование = "РеализацияТоваров" Тогда
		СтрокаПродавец = "ДокументПродажиТовары.Ссылка.Продавец"
	Иначе
		СтрокаПродавец = "ДокументПродажиТовары.Продавец"
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ " + СтрокаДокументаПродажи + "
	|	ДокументПродажиТовары.Количество КАК КоличествоВДокументеПродажи,
	|	ДокументПродажиТовары.Сумма,
	|	ДокументПродажиТовары.СтавкаНДС,
	|	" + СтрокаПродавец + " КАК Продавец,
	|	ВЫБОР
	|		КОГДА ДокументПродажиТовары.Количество = 0
	|			ТОГДА ДокументПродажиТовары.Цена
	|		ИНАЧЕ ДокументПродажиТовары.Сумма / ДокументПродажиТовары.Количество
	|	КОНЕЦ КАК Цена
	|ИЗ
	|	Документ." + МетаданныеНаименование +  ".Товары КАК ДокументПродажиТовары
	|ГДЕ
	|	ДокументПродажиТовары.Ссылка = &Ссылка
	|	И ДокументПродажиТовары.Номенклатура = &Номенклатура
	|	И ДокументПродажиТовары.Характеристика = &Характеристика
	|
	|УПОРЯДОЧИТЬ ПО
	|	Цена";

	
	Запрос.УстановитьПараметр("Ссылка", Документ);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", Характеристика);

	
	ТаблицаСтрок = Запрос.Выполнить().Выгрузить();
	
	Возврат ТаблицаСтрок;

КонецФункции // ПолучитьТаблицуСтрокДокументаПродажи()

// Получает по документу, номенклатуре и характеристике номенклатуры, строку таблицы
//
// Параметры
//  Документ - ссылка на документ
//  МетаданныеНаименование - имя метаданных документа
//  Номенклатура
//  Характеристика
//  ПолучитьДокументПродажи - Булево
//
// Возвращаемое значение:
//   Строка таблицы Значений
//
Функция ПолучитьСтруктуруСтрокиТоваровВДокументеПродажи(Документ, МетаданныеНаименование, Номенклатура, Характеристика) Экспорт
	
	Перем Результат;
	
	Результат = Неопределено;
	
	ТаблицаСтрок = ПолучитьТаблицуСтрокДокументаПродажи(Документ, МетаданныеНаименование, Номенклатура, Характеристика);
	
	Если НЕ ТаблицаСтрок.Количество() = 0 Тогда
		Результат = ТаблицаСтрок[0];
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

// Получает по документу, номенклатуре и характеристике номенклатуры, строку таблицы
//
// Параметры
//  Документ - ссылка на документ
//  МетаданныеНаименование - имя метаданных документа
//  Номенклатура
//  Характеристика
//  ПолучитьДокументПродажи - Булево
//  УникальныйИдентификатор
//
//
Функция ПолучитьСтрокиДокументаПродажиНаКлиента(Документ, МетаданныеНаименование, Номенклатура, Характеристика, УникальныйИдентификатор) Экспорт

	Перем Результат;
	
	Результат = Неопределено;
	
	ТаблицаСтрок = ПолучитьТаблицуСтрокДокументаПродажи(Документ, МетаданныеНаименование, Номенклатура, Характеристика);
	
	Если НЕ ТаблицаСтрок.Количество() = 0 Тогда
		
		Результат = ПоместитьВоВременноеХранилище(ТаблицаСтрок, УникальныйИдентификатор);
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции // ПолучитьСтрокиДокументаПродажиНаКлиента()

// Функция добавления серийных номеров в ТЧ
//
Функция ДобавитьСерийныеНомераВТабличнуюЧасть(ТЧСерийныеНомера, МассивСерийныхНомеров, ТекущийКлючСвязи)  Экспорт

	НовыйКлючСвязи = 0;

	Если ТекущийКлючСвязи <> 0 Тогда

		Для Каждого СтрокаТЧ Из ТЧСерийныеНомера.НайтиСтроки(Новый Структура("КлючСвязиСерийныхНомеров", ТекущийКлючСвязи)) Цикл
			ТЧСерийныеНомера.Удалить(ТЧСерийныеНомера.Индекс(СтрокаТЧ));
		КонецЦикла;

	КонецЕсли;

	Если МассивСерийныхНомеров.Количество() = 0 Тогда

		НовыйКлючСвязи = 0;

	Иначе

		Если ТекущийКлючСвязи = 0 Тогда

			ВремКлючСвязи = 0;
			Для Каждого СтрокаТЧ Из ТЧСерийныеНомера Цикл
				Если ВремКлючСвязи < СтрокаТЧ.КлючСвязиСерийныхНомеров Тогда
					ВремКлючСвязи = СтрокаТЧ.КлючСвязиСерийныхНомеров;
				КонецЕсли;
			КонецЦикла;

			НовыйКлючСвязи = ВремКлючСвязи + 1;

		Иначе
			НовыйКлючСвязи = ТекущийКлючСвязи;
		КонецЕсли;

		Для Каждого СерийныйНомер Из МассивСерийныхНомеров Цикл

			НоваяСтрокаСН = ТЧСерийныеНомера.Добавить();
			НоваяСтрокаСН.СерийныйНомер            = СерийныйНомер;
			НоваяСтрокаСН.КлючСвязиСерийныхНомеров = НовыйКлючСвязи;

		КонецЦикла;
	КонецЕсли;

	Возврат НовыйКлючСвязи;

КонецФункции

// Процедура заполняет значения реквизитов табличной части по структуре
//
// Параметры:
// 		КоллекцияДанных - ДанныеФормыКоллекция - Табличная часть
// 		СтруктураРеквизитов - Структура - Структура. Ключ - имя реквизита флага активности. Значение - строка перечисления зависимых реквизитов
//
Процедура ЗаполнитьДубликатыЗависимыхРеквизитовВКоллекции(КоллекцияДанных, СтруктураРеквизитов) Экспорт
	
	// Получение шаблона поля выборки для значения дубликата реквизита
	// 		Если флаг активности ИСТИНА - скопировать значение из реквизита
	// 		Иначе - заполнить пустым значением
	ШаблонПоляВыборки = ",
	|	ВЫБОР КОГДА Коллекция.%ИмяФлага% = ИСТИНА
	|		ТОГДА Коллекция.%ИмяРеквизита%
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК %ИмяРеквизита%%ИмяФлага%";
	
	ПоляВыборки = ""; // Поля выборки для запроса получения данных
	ПоляВыгрузки = "НомерСтроки"; // Перечисление через запятую полей, выгружаемых из коллекции
	Для Каждого РеквизитФлага Из СтруктураРеквизитов Цикл
		ПоляВыгрузки = ПоляВыгрузки + ", " + РеквизитФлага.Ключ;
		ЗависимыеРеквизиты = Новый Структура(РеквизитФлага.Значение);
		Для Каждого ЗависимыйРеквизит Из ЗависимыеРеквизиты Цикл
			ПоляВыборки = ПоляВыборки + СтрЗаменить(СтрЗаменить(ШаблонПоляВыборки, "%ИмяФлага%", РеквизитФлага.Ключ), "%ИмяРеквизита%", ЗависимыйРеквизит.Ключ);
			ПоляВыгрузки = ПоляВыгрузки + ", " + ЗависимыйРеквизит.Ключ + ", " + ЗависимыйРеквизит.Ключ + РеквизитФлага.Ключ;
		КонецЦикла;
	КонецЦикла;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	Коллекция.НомерСтроки" + ПоляВыборки + "
	|ПОМЕСТИТЬ втКоллекция
	|ИЗ &КоллекцияДанных КАК Коллекция;
	|
	|ВЫБРАТЬ *
	|ИЗ втКоллекция КАК втКоллекция
	|УПОРЯДОЧИТЬ ПО НомерСтроки");
	Запрос.УстановитьПараметр("КоллекцияДанных", КоллекцияДанных.Выгрузить( , ПоляВыгрузки));
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ЗаполнитьЗначенияСвойств(КоллекцияДанных[Выборка.НомерСтроки-1], Выборка, , "НомерСтроки");
	КонецЦикла;
	
КонецПроцедуры // ЗаполнитьДубликатыЗависимыхРеквизитовВКоллекции()

/////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ РАБОТЫ С СЕРИЯМИ

//Процедура заполняет статусы указания серий в строках ТЧ товары (комментарий содержит описание подсистемы серий)
//
//Возможные статусы указания серий:
//
//  0 - серии указывать не требуется
//  нечетные статусы - количество по сериям не совпадает с количеством товаров
//  четные статусы   - количество по сериям не совпадает с количеством товаров
//		 1,2  - серии указываются справочно
//       3,4  - по сериям учитываются остатки, серии указываются по факту отбора
//       5,6  - по сериям учитываются остатки, серии указываются при планировании отбора,
//					заполняются по FEFO (используются только в документах отгрузки товаров)
//       7,8  - по сериям учитываются остатки, серии указываются при планировании отбора
//       9,10 - по сериям учитываются остатки, серии указываются при планировании отгрузки,
//				по сериям формируются движения по регистру СвободныеОстатки (как при приходе, так и при расходе)
//  11 - серии не указаны, указание не обязательно (используется только в заказах)
//
//Параметры процедуры:
//
//		Объект - объект, в котором нужно заполнить статусы. Тип: ДанныеФормыСтруктура или ДокументОбъект
//
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа (обработки)
//			Содержит свойства:
//				ОБЯЗАТЕЛЬНЫЕ:
//					ИспользоватьСерииНоменклатуры - признак, нужно ли в документе заполнять статусы указания серий 
//					ПоляСвязиСерий - массив с именами реквизитов ТЧ Товары и ТЧ Серии, по которым устанавливается
//									 связь между табличными частями (поля связи "Номенклатура" и "Характеристика" 
//									 присутствуют всегда, их отдельно указывать не нужно)
//					СкладскиеОперации - массив значений ПеречислениеСсылка.СкладскиеОперации - складские операции, оформляемые документом
//				НЕОБЯЗАТЕЛЬНЫЕ:
//                  ТолькоПросмотр - признак того, что серии в документе можно только просматривать (значение по умолчанию ЛОЖЬ)
//					ТоварВШапке - признак, что параметры указания серий определены для товара в шапке (иначе - для товара в ТЧ) (значение по умолчанию ЛОЖЬ)
//					БлокироватьДанныеФормы - признак того, что перед открытием форму указания серий, нужно заблокировать форму документа (значение по умолчанию ИСТИНА)
//												если ТолькоПросмотр = Истина, то данные формы не блокируются
//              	
//					ИмяТЧТовары - имя табличной части со списком товаров (значение по умолчанию - "Товары")
//              	ИмяТЧСерии - имя табличной части со списком серий (значение по умолчанию - "Серии")
//              	ИмяПоляКоличество - имя поля в ТЧ "Товары", в котором пользователь редактирует количество (значение по умолчанию - "КоличествоУпаковок")
//              	ИмяПоляСклад     - имя реквизита склада (значение по умолчанию - "Склад")
//					ИмяПоляПомещение - имя реквизита помещения, если не задано, значит в документе нет помещений
//              	
//					ПроцедураЗаполненияСерий - содержит имя документа: если параметр задан, то заполнение статусов указания серий делается
//										одноименной процедурой, размещенной в модуле менеджера документа
//					
//					ЭтоОрдер - признак того, что документ является ордером (значение по умолчанию ЛОЖЬ)
//					ЭтоЗаказ - признак того, что документ является заказом (значение по умолчанию ЛОЖЬ)
//					ЭтоНакладная - признак того, что документ является накладной (значение по умолчанию ЛОЖЬ)
//					
//					ПроверкаОтбора       - на адресном складе перед проверкой должны быть заполнены все серии, по которым ведется учет остатков
//
//      СтрокиТоваровДляОбработки - массив строк товаров, в которых нужно заполнить статусы указания серий,
//									если передано "Неопределено", то статусы заполняются во всех строках товаров
//      
//		СтрокиСерийДляОбработки - массив строк серий, по данным которых нужно заполнить статусы указания серий,
//									если передано "Неопределено", то учитываются все строки серий
//		
Процедура ЗаполнитьСтатусыУказанияСерий(Объект,ПараметрыУказанияСерий,СтрокиТоваровДляОбработки = Неопределено, СтрокиСерийДляОбработки = Неопределено) Экспорт
	
	ИмяТЧТовары = "";
	ТоварВШапке = Ложь;
	Если Не ПараметрыУказанияСерий.Свойство("ТоварВШапке", ТоварВШапке) Тогда
		ТоварВШапке = Ложь;
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧТовары", ИмяТЧТовары) Тогда
		ИмяТЧТовары = "Товары";
	КонецЕсли;
	
	Если Не (ТоварВШапке
		Или Объект[ИмяТЧТовары].Количество() <> 0 ) Тогда
		Возврат;
	КонецЕсли;
	
	ИмяМенеджера = "";
	
	Если ПараметрыУказанияСерий.Свойство("ПроцедураЗаполненияСерий",ИмяМенеджера) Тогда
		Если ПараметрыУказанияСерий.Свойство("ЭтоОбработка")
		   И ПараметрыУказанияСерий.ЭтоОбработка Тогда
			Обработки[ИмяМенеджера].ЗаполнитьСтатусыУказанияСерий(Объект,ПараметрыУказанияСерий,СтрокиТоваровДляОбработки,СтрокиСерийДляОбработки);
		Иначе
			Документы[ИмяМенеджера].ЗаполнитьСтатусыУказанияСерий(Объект,ПараметрыУказанияСерий,СтрокиТоваровДляОбработки,СтрокиСерийДляОбработки);
		КонецЕсли;
		
		Возврат;
	КонецЕсли;
	
	ИмяТЧСерии  = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	Если ИмяТЧТовары = ИмяТЧСерии Тогда
		ЗаполнитьСтатусУказанияСерииВТЧТовары(Объект, Объект[ИмяТЧТовары],ПараметрыУказанияСерий);
		Возврат;
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.Свойство("ЭтоЗаказ") Тогда
		ЭтоЗаказ = ПараметрыУказанияСерий.ЭтоЗаказ
	Иначе
		ЭтоЗаказ = Ложь;
	КонецЕсли;
	
	ИмяПоляМагазин = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяПоляМагазин", ИмяПоляМагазин) Тогда
		ИмяПоляМагазин = "Магазин";
	КонецЕсли;
	
	
	Если Не ПараметрыУказанияСерий.ИспользоватьСерииНоменклатуры Тогда
		
		Если ПолучитьФункциональнуюОпцию("ИспользоватьСерииНоменклатуры") Тогда
			Если ТоварВШапке Тогда
				Если ЭтоЗаказ Тогда
					Объект.УказыватьСерии = Ложь;
				КонецЕсли;
				Объект.СтатусУказанияСерий = 0;	
			Иначе
				Для Каждого СтрТабл из Объект[ИмяТЧТовары] Цикл
					СтрТабл.СтатусУказанияСерий = 0;	
					Если ЭтоЗаказ Тогда
						СтрТабл.УказыватьСерии = Ложь;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		Возврат;
	КонецЕсли;
	
	
	Если ЭтоЗаказ
		И Не ТоварВШапке
		И ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаКомплектующихДляСборки) = Неопределено 
		И ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаКомплектовДляРазборки) = Неопределено Тогда
		ЕстьОтменаСтроки = Истина;
	Иначе
		ЕстьОтменаСтроки = Ложь;
	КонецЕсли;
	
	ТекстПоляВыбораТовары = "";
	ТекстПоляВыбораСерии = "";
	ТекстПоляСвязиСоединениеТоварыСерии = "";
	ТекстПоляСвязиСоединениеТоварыВсеТовары = "";
	ТекстПоляСвязиВыгружаемыеКолонкиТовары = "";
	ТекстПоляСвязиВыгружаемыеКолонкиСерии = "";
	
	Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
		ТекстПоляВыбораТовары = ТекстПоляВыбораТовары + "
		|	ТаблицаТоваров." + СтрМас + ",";
		ТекстПоляВыбораСерии = ТекстПоляВыбораСерии + "
		|	ТаблицаСерий." + СтрМас + ",";
		ТекстПоляСвязиСоединениеТоварыСерии = ТекстПоляСвязиСоединениеТоварыСерии + "
	|			И ТаблицаТоваровДляЗапроса."+СтрМас+" = ТаблицаСерийДляЗапроса."+СтрМас;
		ТекстПоляСвязиСоединениеТоварыВсеТовары = ТекстПоляСвязиСоединениеТоварыВсеТовары + "
	|			И ТаблицаТоваров."+СтрМас+" = ТаблицаТоваровДляЗапроса." + СтрМас;
		ТекстПоляСвязиВыгружаемыеКолонкиТовары = ТекстПоляСвязиВыгружаемыеКолонкиТовары + ", " + СтрМас;
		ТекстПоляСвязиВыгружаемыеКолонкиСерии = ТекстПоляСвязиВыгружаемыеКолонкиСерии + ", " + СтрМас;
	КонецЦикла;
	
	Если ЕстьОтменаСтроки Тогда
		ТекстПоляВыбораТовары = ТекстПоляВыбораТовары + "
		|	ТаблицаТоваров.Отменено,";
		ТекстПоляСвязиВыгружаемыеКолонкиТовары = ТекстПоляСвязиВыгружаемыеКолонкиТовары + ", Отменено";
		УсловиеПоОтмененнойСтроке = "		КОГДА ТаблицаТоваров.Отменено 
									|			ТОГДА 0 ";
	Иначе
		УсловиеПоОтмененнойСтроке = "		КОГДА ЛОЖЬ 
									|			ТОГДА 0 ";
	КонецЕсли;
	
	ТекстПоляСвязиСоединениеМагазин = " ПО (МагазиныПолитикиУчетаСерий.Магазин = &Магазин)";

	ТекстЗапроса = 
	"ВЫБРАТЬ " +
	ТекстПоляВыбораТовары + "
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров.Характеристика,
	|	ТаблицаТоваров.Количество,
	|	ТаблицаТоваров.СтатусУказанияСерий,
	|	ТаблицаТоваров.НомерСтроки
	|ПОМЕСТИТЬ ТаблицаТоваров
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ " +
	ТекстПоляВыбораТовары + "
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров.Характеристика,
	|	СУММА(ТаблицаТоваров.Количество) КАК Количество,
	|	ТаблицаТоваров.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
	|ПОМЕСТИТЬ ТаблицаТоваровДляЗапроса
	|ИЗ
	|	ТаблицаТоваров КАК ТаблицаТоваров ";
	Если ЕстьОтменаСтроки Тогда
	ТекстЗапроса = ТекстЗапроса + "
	|ГДЕ
	|	НЕ ТаблицаТоваров.Отменено ";
	КонецЕсли;	
	ТекстЗапроса = ТекстЗапроса + "
	|
	|СГРУППИРОВАТЬ ПО " +
	ТекстПоляВыбораТовары + "
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров.Характеристика,
	|	ТаблицаТоваров.Номенклатура.ВидНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ " +
	ТекстПоляВыбораСерии + "
	|	ТаблицаСерий.Номенклатура,
	|	ТаблицаСерий.Характеристика,
	|	ТаблицаСерий.Количество
	|ПОМЕСТИТЬ ТаблицаСерий
	|ИЗ
	|	&ТаблицаСерий КАК ТаблицаСерий
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ " +
	ТекстПоляВыбораСерии + "
	|	ТаблицаСерий.Номенклатура,
	|	ТаблицаСерий.Характеристика,
	|	СУММА(ТаблицаСерий.Количество) КАК Количество
	|ПОМЕСТИТЬ ТаблицаСерийДляЗапроса
	|ИЗ
	|	ТаблицаСерий КАК ТаблицаСерий
	|
	|СГРУППИРОВАТЬ ПО " +
	ТекстПоляВыбораСерии + "
	|	ТаблицаСерий.Номенклатура,
	|	ТаблицаСерий.Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваров.СтатусУказанияСерий КАК СтарыйСтатусУказанияСерий,
	|	ВЫБОР "+
		 УсловиеПоОтмененнойСтроке + "
	|		ИНАЧЕ ВЫБОР
	|				КОГДА МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий ЕСТЬ NULL 
	|					ТОГДА 0
	|				ИНАЧЕ ВЫБОР
	|						КОГДА (&СправочныйВводСерий)
	|							ТОГДА ВЫБОР
	|										КОГДА ТаблицаТоваровДляЗапроса.Количество = ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0)
	|												И ТаблицаТоваровДляЗапроса.Количество > 0
	|											ТОГДА 2
	|										ИНАЧЕ 11
	|									КОНЕЦ
	|						КОГДА ((&ЭтоОрдер
	|									ИЛИ (НЕ Магазины.ИспользоватьОрдернуюСхемуПриОтгрузке)
	|										И &ЭтоНакладная)
	|									И (МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтгрузкеКлиенту
	|											И &ОтгрузкаКлиенту
	|										ИЛИ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтгрузкеВРозницу
	|											И &ОтгрузкаВРозницу
	|										ИЛИ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтгрузкеКомплектующихДляСборки
	|											И &ОтгрузкаКомплектующихДляСборки
	|											И ((НЕ &ТоварВШапке)
	|												ИЛИ &ЭтоОрдер)
	|										ИЛИ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтгрузкеКомплектовДляРазборки
	|											И &ОтгрузкаКомплектовДляРазборки
	|											И (&ТоварВШапке
	|												ИЛИ &ЭтоОрдер)
	|										ИЛИ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтгрузкеПоВозвратуПоставщику
	|											И &ОтгрузкаПоВозвратуПоставщику))
	|							ТОГДА ВЫБОР
	|											КОГДА ТаблицаТоваровДляЗапроса.Количество = ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0)
	|													И ТаблицаТоваровДляЗапроса.Количество > 0
	|												ТОГДА 2
	|											ИНАЧЕ 1
	|									КОНЕЦ
	|						КОГДА (&ЭтоОрдер
	|									ИЛИ (НЕ Магазины.ИспользоватьОрдернуюСхемуПриПеремещении)
	|										И &ЭтоНакладная)
	|										И (МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтгрузкеПоПеремещению
	|											И &ОтгрузкаПоПеремещению)
	|							ТОГДА ВЫБОР
	|											КОГДА ТаблицаТоваровДляЗапроса.Количество = ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0)
	|													И ТаблицаТоваровДляЗапроса.Количество > 0
	|												ТОГДА 2
	|											ИНАЧЕ 1
	|									КОНЕЦ
	|						КОГДА МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПриемке
	|								И (НЕ &ЭтоЗаказ)
	|								И (&ЭтоОрдер
	|									ИЛИ (НЕ Магазины.ИспользоватьОрдернуюСхемуПриПоступлении)
	|										И &ЭтоНакладная)
	|								И (МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПриемкеОтПоставщика
	|										И &ПриемкаОтПоставщика
	|									ИЛИ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПриемкеПоВозвратуОтКлиента
	|										И &ПриемкаПоВозвратуОтКлиента
	|									ИЛИ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПриемкеКомплектующихПослеРазборки
	|										И &ПриемкаКомплектующихПослеРазборки
	|										И ((НЕ &ТоварВШапке)
	|											ИЛИ &ЭтоОрдер)
	|									ИЛИ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПриемкеСобранныхКомплектов
	|										И &ПриемкаСобранныхКомплектов
	|										И (&ТоварВШапке
	|											ИЛИ &ЭтоОрдер))
	|							ТОГДА ВЫБОР
	|											КОГДА ТаблицаТоваровДляЗапроса.Количество = ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0)
	|													И ТаблицаТоваровДляЗапроса.Количество > 0
	|												ТОГДА 2
	|											ИНАЧЕ 1
	|									КОНЕЦ
	|						КОГДА МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПриемке
	|								И (НЕ &ЭтоЗаказ)
	|								И (&ЭтоОрдер
	|									ИЛИ (НЕ Магазины.ИспользоватьОрдернуюСхемуПриПеремещении)
	|										И &ЭтоНакладная)
	|								И (МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПриемкеПоПеремещению
	|										И &ПриемкаПоПеремещению)
	|							ТОГДА ВЫБОР
	|											КОГДА ТаблицаТоваровДляЗапроса.Количество = ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0)
	|													И ТаблицаТоваровДляЗапроса.Количество > 0
	|												ТОГДА 2
	|											ИНАЧЕ 1
	|									КОНЕЦ
	|						КОГДА МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтраженииИзлишковНедостачПорчи
	|								И (&ЭтоОрдер
	|									ИЛИ (НЕ Магазины.ИспользоватьОрдернуюСхемуПриОтраженииИзлишковНедостач)
	|										И &ЭтоНакладная)
	|								И (&ОтражениеИзлишков
	|									ИЛИ &ОтражениеНедостач
	|									ИЛИ &ОтражениеПорчи)
	|							ТОГДА ВЫБОР
	|											КОГДА ТаблицаТоваровДляЗапроса.Количество = ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0)
	|													И ТаблицаТоваровДляЗапроса.Количество > 0
	|												ТОГДА 2
	|											ИНАЧЕ 1
	|									КОНЕЦ
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СтатусУказанияСерий
	|ПОМЕСТИТЬ ТаблицаСтатусов
	|ИЗ
	|	ТаблицаТоваров КАК ТаблицаТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаТоваровДляЗапроса КАК ТаблицаТоваровДляЗапроса
	|			ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаСерийДляЗапроса КАК ТаблицаСерийДляЗапроса
	|			ПО ТаблицаТоваровДляЗапроса.Номенклатура = ТаблицаСерийДляЗапроса.Номенклатура
	|				И ТаблицаТоваровДляЗапроса.Характеристика = ТаблицаСерийДляЗапроса.Характеристика " +
					ТекстПоляСвязиСоединениеТоварыСерии + "
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры.ПолитикиУчетаСерий КАК МагазиныПолитикиУчетаСерий
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Магазины КАК Магазины
	|				ПО МагазиныПолитикиУчетаСерий.Магазин = Магазины.Ссылка" +
				ТекстПоляСвязиСоединениеМагазин + "
	|			И ТаблицаТоваровДляЗапроса.ВидНоменклатуры = МагазиныПолитикиУчетаСерий.Ссылка
	|		ПО ТаблицаТоваров.Номенклатура = ТаблицаТоваровДляЗапроса.Номенклатура
	|			И ТаблицаТоваров.Характеристика = ТаблицаТоваровДляЗапроса.Характеристика" +
				ТекстПоляСвязиСоединениеТоварыВсеТовары + "
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСтатусов.НомерСтроки КАК НомерСтроки,
	|	ТаблицаСтатусов.СтатусУказанияСерий КАК СтатусУказанияСерий
	|ИЗ
	|	ТаблицаСтатусов КАК ТаблицаСтатусов
	|ГДЕ
	|	ТаблицаСтатусов.СтатусУказанияСерий <> ТаблицаСтатусов.СтарыйСтатусУказанияСерий
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;

	Запрос.УстановитьПараметр("Магазин", Объект[ИмяПоляМагазин]);
	
	Запрос.УстановитьПараметр("ТоварВШапке", ТоварВШапке);
	
 	УстановитьПараметрыЗапросаПоПараметрамУказанияСерий(Запрос,ПараметрыУказанияСерий);
	
	Если ТоварВШапке Тогда
		
		ТаблицаТоваров = Новый ТаблицаЗначений;
		ТаблицаТоваров.Колонки.Добавить("Номенклатура",Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
		ТаблицаТоваров.Колонки.Добавить("Характеристика",Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
		ТаблицаТоваров.Колонки.Добавить("Количество",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,3,ДопустимыйЗнак.Неотрицательный)));
		ТаблицаТоваров.Колонки.Добавить("НомерСтроки",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(5,0,ДопустимыйЗнак.Неотрицательный)));
		ТаблицаТоваров.Колонки.Добавить("СтатусУказанияСерий",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(2,0,ДопустимыйЗнак.Неотрицательный)));
		
		Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
			Типы = Новый Массив;
			Типы.Добавить(ТипЗнч(Объект[СтрМас]));
			ТаблицаТоваров.Колонки.Добавить(СтрМас,Новый ОписаниеТипов(Типы));
		КонецЦикла;
		
		СтрокаТовара = ТаблицаТоваров.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаТовара,Объект);
		СтрокаТовара.НомерСтроки = 1;
		
		СтруктураПоиска = Новый Структура("Номенклатура, Характеристика" + ТекстПоляСвязиВыгружаемыеКолонкиТовары);
		ЗаполнитьЗначенияСвойств(СтруктураПоиска,Объект);
		
		НайденныеСтрокиСерий =  Объект[ИмяТЧСерии].НайтиСтроки(СтруктураПоиска);
		
		Запрос.УстановитьПараметр("ТаблицаТоваров",ТаблицаТоваров);
		Запрос.УстановитьПараметр("ТаблицаСерий", Объект[ИмяТЧСерии].Выгрузить(НайденныеСтрокиСерий,"Номенклатура, Характеристика, Количество" + ТекстПоляСвязиВыгружаемыеКолонкиСерии));
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
		
 			Объект.СтатусУказанияСерий = Выборка.СтатусУказанияСерий;
			Если ЭтоЗаказ Тогда
				Если (Выборка.СтатусУказанияСерий = 11
					Или Выборка.СтатусУказанияСерий = 0) Тогда
					Объект.УказыватьСерии = Ложь;
				Иначе
					Объект.УказыватьСерии = Истина;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
	Иначе	
		Если СтрокиСерийДляОбработки <> Неопределено
			И СтрокиТоваровДляОбработки <> Неопределено Тогда
			Запрос.УстановитьПараметр("ТаблицаТоваров", Объект[ИмяТЧТовары].Выгрузить(СтрокиТоваровДляОбработки,"Номенклатура, Характеристика, Количество,НомерСтроки, СтатусУказанияСерий" + ТекстПоляСвязиВыгружаемыеКолонкиТовары));
			Запрос.УстановитьПараметр("ТаблицаСерий", Объект[ИмяТЧСерии].Выгрузить(СтрокиСерийДляОбработки,"Номенклатура, Характеристика, Количество" + ТекстПоляСвязиВыгружаемыеКолонкиСерии));
		Иначе
			Запрос.УстановитьПараметр("ТаблицаТоваров", Объект[ИмяТЧТовары].Выгрузить(,"Номенклатура, Характеристика, Количество,НомерСтроки, СтатусУказанияСерий" + ТекстПоляСвязиВыгружаемыеКолонкиТовары));
			Запрос.УстановитьПараметр("ТаблицаСерий", Объект[ИмяТЧСерии].Выгрузить(,"Номенклатура, Характеристика, Количество" + ТекстПоляСвязиВыгружаемыеКолонкиСерии));
		КонецЕсли;
		
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			СтрТабл = Объект[ИмяТЧТовары][Выборка.НомерСтроки - 1];
			
			СтрТабл.СтатусУказанияСерий = Выборка.СтатусУказанияСерий;
			
			Если ЭтоЗаказ Тогда
				Если (Выборка.СтатусУказанияСерий = 11
					Или Выборка.СтатусУказанияСерий = 0) Тогда
					СтрТабл.УказыватьСерии = Ложь;
				Иначе
					СтрТабл.УказыватьСерии = Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

// Процедура заполнения колонки "СтатусУказанияСерий" в формах, в которых серия редактируется в одной таблице с товарами
// Параметры:
//	Объект - объект, в котором нужно заполнить статусы. Тип: ДанныеФормыСтруктура или ДокументОбъект
//	ТЧ - табличная часть
//  ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
//  СтрокиТоваровДляОбработки - массив строк товаров, в которых нужно заполнить статусы указания серий,
//									если передано "Неопределено", то статусы заполняются во всех строках
Процедура ЗаполнитьСтатусУказанияСерииВТЧТовары(Объект,ТЧ,ПараметрыУказанияСерий,СтрокиТоваровДляОбработки = Неопределено)
	
	Если Не ПараметрыУказанияСерий.ИспользоватьСерииНоменклатуры Тогда
		
		Если ПолучитьФункциональнуюОпцию("ИспользоватьСерииНоменклатуры") Тогда
			Для Каждого СтрТабл из ТЧ Цикл
				СтрТабл.СтатусУказанияСерий = 0;
				СтрТабл.Серия = Справочники.СерииНоменклатуры.ПустаяСсылка();
			КонецЦикла;
		КонецЕсли;
		
		Возврат;
	КонецЕсли;
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров.Серия,
	|	ТаблицаТоваров.СтатусУказанияСерий,
	|	ТаблицаТоваров.НомерСтроки
	|ПОМЕСТИТЬ ТаблицаТовары
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТовары.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТовары.СтатусУказанияСерий КАК СтарыйСтатусУказанияСерий,
	|	ВЫБОР
	|		КОГДА (НЕ МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий ЕСТЬ NULL )
	|			ТОГДА ВЫБОР
	|					КОГДА МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриПересчетеТоваров
	|							И (&ОтражениеРезультатовПересчетов
	|							ИЛИ &Пересчет)
	|						ТОГДА 2
	|					КОГДА МагазиныПолитикиУчетаСерий.ПолитикаУчетаСерий.УказыватьПриОтраженииИзлишковНедостачПорчи
	|							И (&ЭтоОрдер
	|								ИЛИ (НЕ Магазины.ИспользоватьОрдернуюСхемуПриОтраженииИзлишковНедостач))
	|							И (&ОтражениеИзлишков
	|								ИЛИ &ОтражениеНедостач)
	|						ТОГДА 2
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтатусУказанияСерий,
	|	ВЫБОР
	|		КОГДА ВЫРАЗИТЬ(ТаблицаТовары.Серия КАК Справочник.СерииНоменклатуры).ВидНоменклатуры = ВЫРАЗИТЬ(ТаблицаТовары.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СерияУказанаКорректно
	|ПОМЕСТИТЬ ТаблицаСтатусов
	|ИЗ
	|	ТаблицаТовары КАК ТаблицаТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры.ПолитикиУчетаСерий КАК МагазиныПолитикиУчетаСерий
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Магазины КАК Магазины
	|			ПО МагазиныПолитикиУчетаСерий.Магазин = Магазины.Ссылка
	|		ПО (ВЫРАЗИТЬ(ТаблицаТовары.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры = МагазиныПолитикиУчетаСерий.Ссылка)
	|			И (МагазиныПолитикиУчетаСерий.Магазин = &Магазин)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСтатусов.НомерСтроки КАК НомерСтроки,
	|	ТаблицаСтатусов.СтатусУказанияСерий КАК СтатусУказанияСерий,
	|	ТаблицаСтатусов.СерияУказанаКорректно КАК СерияУказанаКорректно
	|ИЗ
	|	ТаблицаСтатусов КАК ТаблицаСтатусов
	|ГДЕ
	|	(ТаблицаСтатусов.СтарыйСтатусУказанияСерий <> ТаблицаСтатусов.СтатусУказанияСерий
	|			ИЛИ (НЕ ТаблицаСтатусов.СерияУказанаКорректно))
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	Если СтрокиТоваровДляОбработки = Неопределено Тогда
		Запрос.УстановитьПараметр("ТаблицаТоваров", ТЧ.Выгрузить(,"НомерСтроки,Номенклатура,СтатусУказанияСерий,Серия"));
	Иначе
		Запрос.УстановитьПараметр("ТаблицаТоваров", ТЧ.Выгрузить(СтрокиТоваровДляОбработки,"НомерСтроки,Номенклатура,СтатусУказанияСерий, Серия"));
	КонецЕсли;
		
	Запрос.УстановитьПараметр("Магазин", Объект.Магазин);
	
	УстановитьПараметрыЗапросаПоПараметрамУказанияСерий(Запрос,ПараметрыУказанияСерий);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		СтрТабл = ТЧ[Выборка.НомерСтроки - 1];
		
		СтрТабл.СтатусУказанияСерий = Выборка.СтатусУказанияСерий;
		Если Выборка.СтатусУказанияСерий = 0
			Или Не Выборка.СерияУказанаКорректно Тогда
			СтрТабл.Серия = Справочники.СерииНоменклатуры.ПустаяСсылка();
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьПараметрыЗапросаПоПараметрамУказанияСерий(Запрос,ПараметрыУказанияСерий) Экспорт
	
	Если ПараметрыУказанияСерий.Свойство("ЭтоОрдер") Тогда
		Запрос.УстановитьПараметр("ЭтоОрдер", ПараметрыУказанияСерий.ЭтоОрдер);
	Иначе
		Запрос.УстановитьПараметр("ЭтоОрдер", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.Свойство("ЭтоНакладная") Тогда
		Запрос.УстановитьПараметр("ЭтоНакладная", ПараметрыУказанияСерий.ЭтоНакладная);
	Иначе
		Запрос.УстановитьПараметр("ЭтоНакладная", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.Свойство("ЭтоЗаказ") Тогда
		Запрос.УстановитьПараметр("ЭтоЗаказ", ПараметрыУказанияСерий.ЭтоЗаказ);
	Иначе
		Запрос.УстановитьПараметр("ЭтоЗаказ", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.Свойство("СправочныйВводСерий") Тогда
		Запрос.УстановитьПараметр("СправочныйВводСерий", ПараметрыУказанияСерий.СправочныйВводСерий);
	Иначе
		Запрос.УстановитьПараметр("СправочныйВводСерий", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаВРозницу) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтгрузкаВРозницу", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтгрузкаВРозницу", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаКлиенту) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтгрузкаКлиенту", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтгрузкаКлиенту", Ложь);
	КонецЕсли;
		
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаКомплектующихДляСборки) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтгрузкаКомплектующихДляСборки", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтгрузкаКомплектующихДляСборки", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаКомплектовДляРазборки) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтгрузкаКомплектовДляРазборки", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтгрузкаКомплектовДляРазборки", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаПоВозвратуПоставщику) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтгрузкаПоВозвратуПоставщику", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтгрузкаПоВозвратуПоставщику", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтгрузкаПоПеремещению) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтгрузкаПоПеремещению", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтгрузкаПоПеремещению", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ПриемкаОтПоставщика) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ПриемкаОтПоставщика", Истина);
	Иначе
		Запрос.УстановитьПараметр("ПриемкаОтПоставщика", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ПриемкаПоВозвратуОтКлиента) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ПриемкаПоВозвратуОтКлиента", Истина);
	Иначе
		Запрос.УстановитьПараметр("ПриемкаПоВозвратуОтКлиента", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ПриемкаПоПеремещению) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ПриемкаПоПеремещению", Истина);
	Иначе
		Запрос.УстановитьПараметр("ПриемкаПоПеремещению", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ПриемкаПоПрочемуОприходованию) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ПриемкаПоПрочемуОприходованию", Истина);
	Иначе
		Запрос.УстановитьПараметр("ПриемкаПоПрочемуОприходованию", Ложь);            
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ПриемкаСобранныхКомплектов) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ПриемкаСобранныхКомплектов", Истина);
	Иначе
		Запрос.УстановитьПараметр("ПриемкаСобранныхКомплектов", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ПриемкаКомплектующихПослеРазборки) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ПриемкаКомплектующихПослеРазборки", Истина);
	Иначе
		Запрос.УстановитьПараметр("ПриемкаКомплектующихПослеРазборки", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтражениеИзлишков) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтражениеИзлишков", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтражениеИзлишков", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтражениеНедостач) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтражениеНедостач", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтражениеНедостач", Ложь);
	КонецЕсли;

	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтражениеПорчи) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтражениеПорчи", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтражениеПорчи", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.Пересчет) <> Неопределено Тогда
		Запрос.УстановитьПараметр("Пересчет", Истина);
	Иначе
		Запрос.УстановитьПараметр("Пересчет", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.СкладскиеОперации.Найти(Перечисления.СкладскиеОперации.ОтражениеРезультатовПересчетов) <> Неопределено Тогда
		Запрос.УстановитьПараметр("ОтражениеРезультатовПересчетов", Истина);
	Иначе
		Запрос.УстановитьПараметр("ОтражениеРезультатовПересчетов", Ложь);
	КонецЕсли;
	
	Если ПараметрыУказанияСерий.Свойство("ПроверкаОтбора") Тогда
		Запрос.УстановитьПараметр("ПроверкаОтбора", ПараметрыУказанияСерий.ПроверкаОтбора);
	Иначе
		Запрос.УстановитьПараметр("ПроверкаОтбора", Ложь);
	КонецЕсли;
	
КонецПроцедуры

// Проверяет, предусматривает ли политика указания серий на переданном Магазине указание серий 
// и проверяет принадлежность серии
//	Параметры:
//		Номенклатура - СправочникСсылка.Номенклатура
//		Магазин - СправочникСсылка.Магазин
//		ИмяПараметраПолитикиУчетаСерий - Строка - имя реквизита политики учета серий, по которому нужно проверить
//			статус указания серий
//	Возвращаемое значение:
//		Структура:
//			СтатусУказанияСерий - Строка - статус указания серий
//			Серия - СправочникСсылка.СерииНоменклатуры - если серия принадлежит тому же виду номенклатуры,
//				то переданная серия, иначе - пустая ссылка
//
Функция СерияУказанаКорректно(Магазин, Номенклатура, Серия, ИмяПараметраПолитикиУчетаСерий) Экспорт
	Результат = Новый Структура("СтатусУказанияСерий,Серия");
		
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВидыНоменклатурыПолитикиУчетаСерий.ПолитикаУчетаСерий." + ИмяПараметраПолитикиУчетаСерий + "
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры.ПолитикиУчетаСерий КАК ВидыНоменклатурыПолитикиУчетаСерий
	|		ПО Номенклатура.ВидНоменклатуры = ВидыНоменклатурыПолитикиУчетаСерий.Ссылка
	|ГДЕ
	|	Номенклатура.Ссылка = &Номенклатура
	|	И ВидыНоменклатурыПолитикиУчетаСерий.Магазин = &Магазин
	|	И ВидыНоменклатурыПолитикиУчетаСерий.ПолитикаУчетаСерий." + ИмяПараметраПолитикиУчетаСерий;
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Магазин", Магазин);
	
	Если Запрос.Выполнить().Пустой() Тогда
		Результат.СтатусУказанияСерий = 0;
	Иначе
		Результат.СтатусУказанияСерий = 2;
	КонецЕсли;
	
	Если Результат.СтатусУказанияСерий = 0 Тогда
		Результат.Серия = Справочники.СерииНоменклатуры.ПустаяСсылка();
	Иначе
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Серия, "ВидНоменклатуры")
			 = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Номенклатура, "ВидНоменклатуры") Тогда
			Результат.Серия = Серия;
		Иначе
			Результат.Серия = Справочники.СерииНоменклатуры.ПустаяСсылка();
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
КонецФункции

//Процедура проверяет правильность указания серий товаров по статусам в ТЧ "Товары"
//Если статусы
//       1 - количество по сериям не совпадает с количеством товаров (движения по сериям делать не нужно)
//       3 - количество по сериям не совпадает с количеством товаров (нужно делать движения по сериям)
//       5 - количество по сериям не совпадает с количеством товаров (нужно делать движения по сериям, серии заполняются по FEFO)
//       7 - количество по сериям не совпадает с количеством товаров (серии указываются при планировании отгрузки)
//то выдается ошибка
//Параметры
//		ДокументОбъект - ДокументОбъект, в котором нужно проверить указание серий
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
//		Отказ - признак ошибки проверки
Процедура ПроверитьЗаполнениеСерий(
	ДокументОбъект, 
	ПараметрыУказанияСерий, 
	Отказ, 
	МассивНепроверяемыхРеквизитов = Неопределено, 
	ВыдаватьСообщения = Истина, 
	ТекстСообщения = "") Экспорт
	
	ИмяТЧТовары = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧТовары", ИмяТЧТовары) Тогда
		ИмяТЧТовары = "Товары";
	КонецЕсли;
	
	Если МассивНепроверяемыхРеквизитов <> Неопределено Тогда
		МассивНепроверяемыхРеквизитов.Добавить(ИмяТЧТовары+".Серия");
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.ИспользоватьСерииНоменклатуры Тогда
		Возврат;
	КонецЕсли;
	
	ИмяТЧСерии  = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	Если ИмяТЧТовары = ИмяТЧСерии Тогда
		
		ИмяПоляКоличество = "";
		
		Если Не ПараметрыУказанияСерий.Свойство("ИмяПоляКоличество", ИмяПоляКоличество) Тогда
			ИмяПоляКоличество = "КоличествоУпаковок";
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ТаблицаСерий.НомерСтроки КАК НомерСтроки,
		|	ТаблицаСерий.Номенклатура КАК Номенклатура,
		|	ТаблицаСерий.Серия КАК Серия,
		|	ТаблицаСерий."+ИмяПоляКоличество+" КАК КоличествоУпаковок,
		|	ТаблицаСерий.СтатусУказанияСерий КАК СтатусУказанияСерий
		|ПОМЕСТИТЬ ТаблицаСерий
		|ИЗ
		|	&ТаблицаСерий КАК ТаблицаСерий
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаСерий.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕ(ТаблицаСерий.Номенклатура) КАК ТоварПредставление,
		|	ВЫБОР
		|		КОГДА ТаблицаСерий.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК СерияНеЗаполнена,
		|	ВЫБОР
		|		КОГДА (НЕ ВЫРАЗИТЬ(ТаблицаСерий.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользоватьКоличествоСерии)
		|				И ТаблицаСерий.КоличествоУпаковок <> 1
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ОшибкаКоличества
		|ИЗ
		|	ТаблицаСерий КАК ТаблицаСерий
		|ГДЕ
		|	ТаблицаСерий.СтатусУказанияСерий <> 0
		|	И (ТаблицаСерий.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|			ИЛИ (НЕ ВЫРАЗИТЬ(ТаблицаСерий.Номенклатура КАК Справочник.Номенклатура).ВидНоменклатуры.ИспользоватьКоличествоСерии)
		|				И ТаблицаСерий.КоличествоУпаковок <> 1)
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки,
		|	СерияНеЗаполнена,
		|	ОшибкаКоличества";
		
		Запрос.УстановитьПараметр("ТаблицаСерий",ДокументОбъект[ИмяТЧТовары].Выгрузить(,"НомерСтроки,Номенклатура,Серия,СтатусУказанияСерий, " + ИмяПоляКоличество));
		
		Если ВыдаватьСообщения Тогда

			Выборка = Запрос.Выполнить().Выбрать();
			
			МетаданныеОбъекта = ДокументОбъект.Метаданные();
			ПредставлениеТЧ = МетаданныеОбъекта.ТабличныеЧасти[ИмяТЧТовары].Синоним;
			
			Пока Выборка.Следующий() Цикл

				Если Выборка.СерияНеЗаполнена Тогда

					ТекстСообщения = "Не заповнена колонка «Серия» в строке %НомерСтроки% списку «%ПредставлениеТЧ%»";
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%НомерСтроки%", Строка(Выборка.НомерСтроки));
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ПредставлениеТЧ%", ПредставлениеТЧ);
					
					Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТЧТовары, Выборка.НомерСтроки, "Серия");
					
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,Поле,"Объект",Отказ);

				КонецЕсли;

				Если Выборка.ОшибкаКоличества Тогда

					ТекстСообщения = "У рядку %НомерСтроки% кількість має дорівнювати 1, тому що політика обліку серій товару
									| «%ТоварПредставление%» передбачає, що кількість за будь-якою серією цього товару завжди дорівнюватиме 1 (одиниці)";
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%НомерСтроки%", Строка(Выборка.НомерСтроки));
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ТоварПредставление%", Выборка.ТоварПредставление);
					
					Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТЧТовары, Выборка.НомерСтроки, "КоличествоУпаковок");
					
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,ДокументОбъект,Поле,"Объект",Отказ);

				КонецЕсли;

			КонецЦикла;

		Иначе

			Если Не Запрос.Выполнить().Пустой() Тогда

				Отказ = Истина;

			КонецЕсли;

		КонецЕсли;

		Возврат;

	КонецЕсли;

	ТекстПоляВыбораТовары = "";
	ТекстПоляВыбораСерии = "";
	ТекстПоляСвязиСоединениеТоварыСерии = "";
	ТекстПоляСвязиСоединениеТоварыВсеТовары = "";
	ТекстПоляСвязиВыгружаемыеКолонкиТовары = "";
	ТекстПоляСвязиВыгружаемыеКолонкиСерии = "";
	
	Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
		ТекстПоляВыбораТовары = ТекстПоляВыбораТовары + "
		|	ТаблицаТоваров." + СтрМас + ",";
		ТекстПоляВыбораСерии = ТекстПоляВыбораСерии + "
		|	ТаблицаСерий." + СтрМас + ",";
		ТекстПоляСвязиСоединениеТоварыСерии = ТекстПоляСвязиСоединениеТоварыСерии + "
	|			И ТаблицаТоваровДляЗапроса."+СтрМас+" = ТаблицаСерийДляЗапроса."+СтрМас;
		ТекстПоляСвязиСоединениеТоварыВсеТовары = ТекстПоляСвязиСоединениеТоварыВсеТовары + "
	|			И ТаблицаТоваров."+СтрМас+" = ТаблицаТоваровДляЗапроса." + СтрМас;
		ТекстПоляСвязиВыгружаемыеКолонкиТовары = ТекстПоляСвязиВыгружаемыеКолонкиТовары + ", " + СтрМас;
		ТекстПоляСвязиВыгружаемыеКолонкиСерии = ТекстПоляСвязиВыгружаемыеКолонкиСерии + ", " + СтрМас;
	КонецЦикла;
	
	Если ПараметрыУказанияСерий.ПоляСвязи.Найти("Упаковка") <> Неопределено Тогда
		ИмяПоляКоличество       = "КоличествоУпаковок";
		ИмяПоляЕдиницаИзмерения = "Упаковка";
	Иначе
		ИмяПоляКоличество       = "Количество";
		ИмяПоляЕдиницаИзмерения = "Номенклатура.ЕдиницаИзмерения";
	КонецЕсли;
	
	ТекстПоляСвязиВыгружаемыеКолонкиТовары = ТекстПоляСвязиВыгружаемыеКолонкиТовары + ", " + ИмяПоляКоличество;
	ТекстПоляСвязиВыгружаемыеКолонкиСерии = ТекстПоляСвязиВыгружаемыеКолонкиСерии + ", " + ИмяПоляКоличество;
	
	ТекстЗапроса = 
	"ВЫБРАТЬ " +
	ТекстПоляВыбораТовары + "
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров.Характеристика,
	|	ТаблицаТоваров." + ИмяПоляКоличество + " КАК Количество,
	|	ТаблицаТоваров.СтатусУказанияСерий,
	|	ТаблицаТоваров.НомерСтроки
	|ПОМЕСТИТЬ ТаблицаТоваров
	|ИЗ
	|	&ТаблицаТоваров КАК ТаблицаТоваров
	|ГДЕ
	|   ТаблицаТоваров.СтатусУказанияСерий В (1,3,5,7,9)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ " +
	ТекстПоляВыбораТовары + "
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров."  +ИмяПоляЕдиницаИзмерения + " КАК ЕдиницаИзмерения,
	|	ТаблицаТоваров.Характеристика,
	|	СУММА(ТаблицаТоваров.Количество) КАК Количество
	|ПОМЕСТИТЬ ТаблицаТоваровДляЗапроса
	|ИЗ
	|	ТаблицаТоваров КАК ТаблицаТоваров
	|
	|СГРУППИРОВАТЬ ПО " +
	ТекстПоляВыбораТовары + "
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров.Характеристика,
	|	ТаблицаТоваров."  +ИмяПоляЕдиницаИзмерения + "
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ " +
	ТекстПоляВыбораСерии + "
	|	ТаблицаСерий.Номенклатура,
	|	ТаблицаСерий.Характеристика,
	|	ТаблицаСерий." + ИмяПоляКоличество + " КАК Количество
	|ПОМЕСТИТЬ ТаблицаСерий
	|ИЗ
	|	&ТаблицаСерий КАК ТаблицаСерий
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ " +
	ТекстПоляВыбораСерии + "
	|	ТаблицаСерий.Номенклатура,
	|	ТаблицаСерий.Характеристика,
	|	СУММА(ТаблицаСерий.Количество) КАК Количество
	|ПОМЕСТИТЬ ТаблицаСерийДляЗапроса
	|ИЗ
	|	ТаблицаСерий КАК ТаблицаСерий
	|
	|СГРУППИРОВАТЬ ПО " +
	ТекстПоляВыбораСерии + "
	|	ТаблицаСерий.Номенклатура,
	|	ТаблицаСерий.Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0) КАК КоличествоСерий,
	|	ТаблицаТоваровДляЗапроса.Количество КАК КоличествоТоваров,
	|	ПРЕДСТАВЛЕНИЕ(ТаблицаТоваровДляЗапроса.ЕдиницаИзмерения) КАК ЕдиницаИзмерения,
	|	ТаблицаТоваров.НомерСтроки КАК НомерСтроки,
	|	ПРЕДСТАВЛЕНИЕ(ТаблицаТоваров.Номенклатура) КАК Номенклатура,
	|	ПРЕДСТАВЛЕНИЕ(ТаблицаТоваров.Характеристика) КАК Характеристика
	|ИЗ
	|	ТаблицаТоваров КАК ТаблицаТоваров
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаТоваровДляЗапроса КАК ТаблицаТоваровДляЗапроса
	|			ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаСерийДляЗапроса КАК ТаблицаСерийДляЗапроса
	|			ПО ТаблицаТоваровДляЗапроса.Номенклатура = ТаблицаСерийДляЗапроса.Номенклатура
	|				И ТаблицаТоваровДляЗапроса.Характеристика = ТаблицаСерийДляЗапроса.Характеристика "
					+ ТекстПоляСвязиСоединениеТоварыСерии + "
	|		ПО ТаблицаТоваров.Номенклатура = ТаблицаТоваровДляЗапроса.Номенклатура
	|			И ТаблицаТоваров.Характеристика = ТаблицаТоваровДляЗапроса.Характеристика "
					+ ТекстПоляСвязиСоединениеТоварыВсеТовары + "
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаСерийДляЗапроса.Количество, 0) <> ТаблицаТоваровДляЗапроса.Количество
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	Запрос.УстановитьПараметр("ТаблицаТоваров", ДокументОбъект[ИмяТЧТовары].Выгрузить(,"НомерСтроки,СтатусУказанияСерий,Номенклатура,Характеристика"+ТекстПоляСвязиВыгружаемыеКолонкиТовары));
	Запрос.УстановитьПараметр("ТаблицаСерий", ДокументОбъект[ИмяТЧСерии].Выгрузить(,"Номенклатура,Характеристика"+ТекстПоляСвязиВыгружаемыеКолонкиСерии));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если ВыдаватьСообщения Тогда

		Пока Выборка.Следующий() Цикл

			ТекстСообщения = "Для товару «%Товар%»  вказано за серіями %КоличествоСерий% %ЕдиницаИзмерения%. Необхідно вказати %КоличествоТоваров% %ЕдиницаИзмерения%. Виправте серії.";

			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Товар%",ОбщегоНазначенияРТ.ПолучитьПредставлениеНоменклатуры(Выборка.Номенклатура, Выборка.Характеристика));
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%КоличествоСерий%",Выборка.КоличествоСерий);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%КоличествоТоваров%",Выборка.КоличествоТоваров);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ЕдиницаИзмерения%",Выборка.ЕдиницаИзмерения);

			Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТЧТовары, Выборка.НомерСтроки, "Номенклатура");

			#Если ТолстыйКлиентОбычноеПриложение Тогда
				Отказ = Истина;
			#Иначе
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,Поле,"Объект",Отказ);
			#КонецЕсли


			Прервать;

		КонецЦикла;

	Иначе

		Если Не Запрос.Выполнить().Пустой() Тогда

			Пока Выборка.Следующий() Цикл

				ТекстСообщения = "Для товару «%Товар%» вказано за серіями %КоличествоСерий% %ЕдиницаИзмерения%. Необхідно вказати %КоличествоТоваров% %ЕдиницаИзмерения%. Виправте серії.";

				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Товар%",ОбщегоНазначенияРТ.ПолучитьПредставлениеНоменклатуры(Выборка.Номенклатура, Выборка.Характеристика));
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%КоличествоСерий%",Выборка.КоличествоСерий);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%КоличествоТоваров%",Выборка.КоличествоТоваров);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ЕдиницаИзмерения%",Выборка.ЕдиницаИзмерения);

				Прервать;

			КонецЦикла;

			Отказ = Истина;

		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

//Процедура проверяет правильность указания серий товаров по статусам в шапке документа
//Если статусы
//       1 - количество по сериям не совпадает с количеством товаров (движения по сериям делать не нужно)
//       3 - количество по сериям не совпадает с количеством товаров (нужно делать движения по сериям)
//то выдается ошибка
//Параметры
//		ДокументОбъект - ДокументОбъект, в котором нужно проверить указание серий
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
//		Отказ - признак ошибки проверки
Процедура ПроверитьЗаполнениеСерийВШапке(ДокументОбъект, ПараметрыУказанияСерий, Отказ) Экспорт

	Если НЕ ПолучитьФункциональнуюОпцию("ИспользоватьСерииНоменклатуры") Тогда

		Возврат;

	КонецЕсли;

	Если ДокументОбъект.СтатусУказанияСерий = 1
		Или ДокументОбъект.СтатусУказанияСерий = 3 Тогда 

		ТекстСообщения = "Для товару «%Товар%» необхідно вказати серії!";

		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Товар%",ОбщегоНазначенияРТ.ПолучитьПредставлениеНоменклатуры(ДокументОбъект.Номенклатура, ДокументОбъект.Характеристика));

		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,"Номенклатура","Объект",Отказ);

	КонецЕсли;

КонецПроцедуры

//Процедура удаляет строки ТЧ "Серии", которым по полям связи нет соответствующих строк в ТЧ "Товары"
//или в этих строках статус указания серий равен 0 (не указывать)
//Параметры
//		ДокументОбъект - ДокументОбъект, в котором нужно удалить неиспользуемые строки серий
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
Процедура УдалитьНеиспользуемыеСтрокиСерий(ДокументОбъект,ПараметрыУказанияСерий) Экспорт
	
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьСерииНоменклатуры") Тогда
		Возврат;
	КонецЕсли;
	
	ЕстьТоварВШапке = ПараметрыУказанияСерий.Свойство("Шапка");
	
	Если ЕстьТоварВШапке Тогда
		ПараметрыУказанияСерийПроверка = ПараметрыУказанияСерий.ТЧ;
	Иначе
		ПараметрыУказанияСерийПроверка = ПараметрыУказанияСерий;
	КонецЕсли;
	
	ИмяТЧТовары = "";
	ИмяТЧСерии  = "";
		
	Если Не ПараметрыУказанияСерийПроверка.Свойство("ИмяТЧТовары", ИмяТЧТовары) Тогда
		ИмяТЧТовары = "Товары";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерийПроверка.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	ТекстПоляСвязиТовары = "";
	ТекстПоляСвязиСерии = "";
	ТекстПоляСвязиСоединениеТоварыСерии = "";
	ТекстПоляСвязиСоединениеТоварыВсеТовары = "";
	ТекстПоляСвязиВыгружаемыеКолонки = "";
	
	Для Каждого СтрМас из ПараметрыУказанияСерийПроверка.ПоляСвязи Цикл
		ТекстПоляСвязиТовары = ТекстПоляСвязиТовары + "
		|	ТаблицаТоваров." + СтрМас + ",";
		ТекстПоляСвязиСерии = ТекстПоляСвязиСерии + "
		|	ТаблицаСерий." + СтрМас + ",";
		ТекстПоляСвязиСоединениеТоварыСерии = ТекстПоляСвязиСоединениеТоварыСерии + "
	|			И ТаблицаТоваров."+СтрМас+" = ТаблицаСерий."+СтрМас;
		ТекстПоляСвязиВыгружаемыеКолонки = ТекстПоляСвязиВыгружаемыеКолонки + ", " + СтрМас  ;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ "
	+ ТекстПоляСвязиТовары + "
	|	ТаблицаТоваров.Номенклатура,
	|	ТаблицаТоваров.Характеристика,
	|	ТаблицаТоваров.СтатусУказанияСерий
	|ПОМЕСТИТЬ ТаблицаТоваров
	|ИЗ
	|	&ТаблицаТовары КАК ТаблицаТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ "
	+ ТекстПоляСвязиСерии + "
	|	ТаблицаСерий.НомерСтроки,
	|	ТаблицаСерий.Номенклатура,
	|	ТаблицаСерий.Характеристика
	|ПОМЕСТИТЬ ТаблицаСерий
	|ИЗ
	|	&ТаблицаСерий КАК ТаблицаСерий
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСерий.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	ТаблицаСерий КАК ТаблицаСерий
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаТоваров КАК ТаблицаТоваров
	|		ПО ТаблицаСерий.Номенклатура = ТаблицаТоваров.Номенклатура
	|			И ТаблицаСерий.Характеристика = ТаблицаТоваров.Характеристика"
				+ ТекстПоляСвязиСоединениеТоварыСерии + "
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаТоваров.СтатусУказанияСерий, 0) = 0
	|	ИЛИ ЕСТЬNULL(ТаблицаТоваров.СтатусУказанияСерий, 0) = 11
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаСерий.НомерСтроки
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки УБЫВ";
	
	ТаблицаТовары = ДокументОбъект[ИмяТЧТовары].Выгрузить(,"Номенклатура,Характеристика,СтатусУказанияСерий"+ТекстПоляСвязиВыгружаемыеКолонки);
	
	Если ЕстьТоварВШапке Тогда
		НоваяСтрока = ТаблицаТовары.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока,ДокументОбъект);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТаблицаТовары",ТаблицаТовары);
	Запрос.УстановитьПараметр("ТаблицаСерий", ДокументОбъект[ИмяТЧСерии].Выгрузить(,"НомерСтроки,Номенклатура,Характеристика"+ТекстПоляСвязиВыгружаемыеКолонки));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ДокументОбъект[ИмяТЧСерии].Удалить(ДокументОбъект[ИмяТЧСерии][Выборка.НомерСтроки-1]);
			
	КонецЦикла;
	
КонецПроцедуры

// Фукнция помещает строки ТЧ "Серии", соответствующие ключевым полям во временное хранилище, для передачи в форму
// редактирования серий
// Параметры
//		Объект - ДанныеФормыСтуктура - основной реквизит формы документа
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
//      ТекущиеДанныеИдентификатор - идентификатор текущей строки товаров в форме документа
//      УникальныйИдентификаторФормы - уникальный идентификатор формы, к которому привязываются данные, помещенные во временное хранилище
// Возвращаемое значение
//		Структура параметров формы указания серий
Функция ПоместитьСерииВХранилище(Объект, ПараметрыУказанияСерий, ТекущиеДанныеИдентификатор, Форма) Экспорт
	ТоварВШапке = Ложь;
	Если Не ПараметрыУказанияСерий.Свойство("ТоварВШапке", ТоварВШапке) Тогда
		ТоварВШапке = Ложь;
	КонецЕсли;
	
	УникальныйИдентификаторФормы = Форма.УникальныйИдентификатор;
	
	ТолькоПросмотр = Ложь;
	БлокироватьДанныеФормы = Истина;
	
	Если Не ПараметрыУказанияСерий.Свойство("ТолькоПросмотр",ТолькоПросмотр) Тогда
		ТолькоПросмотр = Ложь;
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("БлокироватьДанныеФормы",БлокироватьДанныеФормы) Тогда
		БлокироватьДанныеФормы = Истина;
	КонецЕсли;
	
	//Если нужно будет изменять количество, то данные формы нужно заблокировать
	//Если заблокировать не удастся - вылетит исключение
	Если Не ТолькоПросмотр
		И БлокироватьДанныеФормы Тогда
		Форма.ЗаблокироватьДанныеФормыДляРедактирования();
	КонецЕсли;
	
	ПроверкаДокумента = ПараметрыУказанияСерий.Свойство("ПроверкаТоваровВДокументе");
	
	ИмяТЧТовары  = "";
	ИмяТЧСерии   = "";
	ИмяПоляПомещение = "";
	ЭтоЗаказ = Ложь;
	ИмяКолонкиКоличество         = "";
	ИмяКолонкиКоличествоУпаковок = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ЭтоЗаказ",ЭтоЗаказ) Тогда
		ЭтоЗаказ = Ложь;
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧТовары", ИмяТЧТовары) Тогда
		ИмяТЧТовары = "Товары";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяПоляПомещение", ИмяПоляПомещение) Тогда
		ИмяПоляПомещение = "";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяКолонкиКоличество", ИмяКолонкиКоличество) Тогда
		ИмяКолонкиКоличество = "Количество";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяКолонкиКоличествоУпаковок", ИмяКолонкиКоличествоУпаковок) Тогда
		ИмяКолонкиКоличествоУпаковок = "КоличествоУпаковок";
	КонецЕсли;
	
	
	ТекстПоляСвязи = "";
	ТекстВыбораТоваров = "";
	
	Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
		ТекстВыбораТоваров = ТекстВыбораТоваров + "
		|	ТаблицаТоваров."  + СтрМас + ", ";
		
		ТекстПоляСвязи = ТекстПоляСвязи + "," + СтрМас  ;
	КонецЦикла;
	

	РегистрироватьСерии = ОбработкаТабличнойЧастиТоварыКлиентСервер.НеобходимоРегистрироватьСерии(ПараметрыУказанияСерий);
	
	Если ТоварВШапке Тогда
		ТекущиеДанные = Объект;
	Иначе
		ТекущиеДанные = Объект[ИмяТЧТовары].НайтиПоИдентификатору(ТекущиеДанныеИдентификатор);
	КонецЕсли;

	ЕстьУпаковки = ПараметрыУказанияСерий.ПоляСвязи.Найти("Упаковка") <> Неопределено;
	НомераСтрокДокумента = "";
	
	Если ТоварВШапке Тогда
		КоличествоВДокументе = Объект.Количество;
		СтруктураПоиска = Новый Структура("Номенклатура,Характеристика"+ТекстПоляСвязи);
		ЗаполнитьЗначенияСвойств(СтруктураПоиска,Объект);
	Иначе
		СтруктураПоиска = Новый Структура("Номенклатура,Характеристика"+ТекстПоляСвязи);
		ЗаполнитьЗначенияСвойств(СтруктураПоиска,ТекущиеДанные);
		
		НайденныеСтрокиТоваров = Объект[ИмяТЧТовары].НайтиСтроки(СтруктураПоиска);
		
		КоличествоВДокументе = 0;
		Для Каждого СтрМас из НайденныеСтрокиТоваров Цикл
			ИмяКолонкиКоличество         = ?(ПроверкаДокумента, "КоличествоВДокументе"        , ИмяКолонкиКоличество);
			ИмяКолонкиКоличествоУпаковок = ?(ПроверкаДокумента, "КоличествоУпаковокВДокументе", ИмяКолонкиКоличествоУпаковок);
			
			Если ЕстьУпаковки Тогда
				КоличествоВДокументе = КоличествоВДокументе + СтрМас[ИмяКолонкиКоличествоУпаковок];
			Иначе
				КоличествоВДокументе = КоличествоВДокументе + СтрМас[ИмяКолонкиКоличество];
			КонецЕсли;
			
			НомераСтрокДокумента = НомераСтрокДокумента + Строка(СтрМас.НомерСтроки) + ", ";
		КонецЦикла;
		
		Если Не ПустаяСтрока(НомераСтрокДокумента) Тогда
			НомераСтрокДокумента = Лев(НомераСтрокДокумента, СтрДлина(НомераСтрокДокумента)-2);
		КонецЕсли;
	КонецЕсли;
	
	НайденныеСтрокиСерий = Объект[ИмяТЧСерии].НайтиСтроки(СтруктураПоиска);
	
	ТаблицаСерий = Новый ТаблицаЗначений;
	ТаблицаСерий.Колонки.Добавить("Серия", Новый ОписаниеТипов("СправочникСсылка.СерииНоменклатуры"));
	ТаблицаСерий.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,3,ДопустимыйЗнак.Неотрицательный)));
	ТаблицаСерий.Колонки.Добавить("КоличествоУпаковок", Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,3,ДопустимыйЗнак.Неотрицательный)));
	
	Если ПроверкаДокумента Тогда
		ТаблицаСерий.Колонки.Добавить("КоличествоНеОтгружать", Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,3,ДопустимыйЗнак.Неотрицательный)));
		ТаблицаСерий.Колонки.Добавить("КоличествоУпаковокНеОтгружать", Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,3,ДопустимыйЗнак.Неотрицательный)));
		ТаблицаСерий.Колонки.Добавить("КоличествоВДокументе", Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,3,ДопустимыйЗнак.Неотрицательный)));
		ТаблицаСерий.Колонки.Добавить("КоличествоУпаковокВДокументе", Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,3,ДопустимыйЗнак.Неотрицательный)));
	КонецЕсли;
	
	Для Каждого СтрМас из НайденныеСтрокиСерий Цикл
		
		НоваяСтрока = ТаблицаСерий.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрМас);
		
		Если Не ЕстьУпаковки Тогда
			НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
			Если ПроверкаДокумента Тогда
				НоваяСтрока.КоличествоУпаковокНеОтгружать = НоваяСтрока.КоличествоНеОтгружать;
				Если Не ЕстьУпаковки Тогда
					НоваяСтрока.КоличествоУпаковокВДокументе = НоваяСтрока.КоличествоВДокументе;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(ТаблицаСерий,УникальныйИдентификаторФормы);
	
	
	ПараметрыФормыУказанияСерий = Новый Структура("Номенклатура,Характеристика,СтатусУказанияСерий,ХарактеристикиИспользуются"+ТекстПоляСвязи);
	ПараметрыФормыУказанияСерий.Вставить("НомераСтрокДокумента", НомераСтрокДокумента); 
	
	Если ТоварВШапке Тогда
		ЗаполнитьЗначенияСвойств(ПараметрыФормыУказанияСерий,Объект);
		Если ЭтоЗаказ Тогда
			ПараметрыФормыУказанияСерий.Вставить("КлючУникальности",1);		
		КонецЕсли;
	Иначе
		ЗаполнитьЗначенияСвойств(ПараметрыФормыУказанияСерий,ТекущиеДанные);
		Если ЭтоЗаказ Тогда
			ПараметрыФормыУказанияСерий.Вставить("КлючУникальности",0);		
			ПараметрыФормыУказанияСерий.УказыватьСерии = Истина;		
		КонецЕсли;
	КонецЕсли;
	
	ИмяПоляМагазин = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяПоляМагазин", ИмяПоляМагазин) Тогда
		ИмяПоляМагазин = "Магазин";
	КонецЕсли;
	
	ПараметрыФормыУказанияСерий.Вставить("АдресВоВременномХранилище",АдресВоВременномХранилище);
	ПараметрыФормыУказанияСерий.Вставить("РегистрироватьСерии",Истина);
	ПараметрыФормыУказанияСерий.Вставить("Магазин",Объект[ИмяПоляМагазин]);
	ПараметрыФормыУказанияСерий.Вставить("Помещение","");
	ПараметрыФормыУказанияСерий.Вставить("ТолькоПросмотр", ТолькоПросмотр);
	ПараметрыФормыУказанияСерий.Вставить("Количество",КоличествоВДокументе);
	ПараметрыФормыУказанияСерий.Вставить("АдресВоВременномХранилище",АдресВоВременномХранилище);
	ПараметрыФормыУказанияСерий.Вставить("СерииВТЧТовары",ИмяТЧСерии = ИмяТЧТовары);
	Если Объект.Свойство("Ссылка") Тогда
		ПараметрыФормыУказанияСерий.Вставить("Регистратор",Объект.Ссылка);
	КонецЕсли;
	ПараметрыФормыУказанияСерий.Вставить("ПараметрыУказанияСерий",ПараметрыУказанияСерий);
	
	ИмяФормы = "Обработка.ПодборСерийВДокументы.Форма.ФормаРегистрацииСерий";
	
	ПараметрыФормыУказанияСерий.Вставить("ИмяФормы", ИмяФормы);
	
	Возврат ПараметрыФормыУказанияСерий;
	
КонецФункции

// Процедура извлекает из временного хранилища серии, указанные в форме редактирования серий, помещает эти строки в ТЧ "Серии" документа,
// перерасчитывает статусы указания серий строках товаров
// Параметры
//		Объект - ДанныеФормыСтуктура - основной реквизит формы документа
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
//      ПараметрыФормыУказанияСерий - структура, которая была передана в форму редактирования серий как параметры формы
Процедура ОбработатьУказаниеСерий(Объект, ПараметрыУказанияСерий,ПараметрыФормыУказанияСерий, СтруктураДействий = Неопределено) Экспорт
	
	ИмяТЧТовары = "";
	ИмяТЧСерии  = "";
	ЭтоЗаказ    = Ложь;
	ТоварВШапке = Ложь;
	Если Не ПараметрыУказанияСерий.Свойство("ТоварВШапке", ТоварВШапке) Тогда
		ТоварВШапке = Ложь;
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧТовары", ИмяТЧТовары) Тогда
		ИмяТЧТовары = "Товары";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ЭтоЗаказ", ЭтоЗаказ) Тогда
		ЭтоЗаказ = Ложь;
	КонецЕсли;
	
	
	//Если обрабатывается результаты формы подбора серий,
	//то серии целиком загружаются из обработки
	Если Не ПараметрыФормыУказанияСерий.РегистрироватьСерии Тогда 
		
		СтруктураВозврата = ПолучитьИзВременногоХранилища(ПараметрыФормыУказанияСерий.АдресВоВременномХранилище);
		Объект[ИмяТЧСерии].Загрузить(СтруктураВозврата.ТаблицаСерий);
		
		Если ЭтоЗаказ Тогда
			Если ТоварВШапке Тогда
				Объект.УказыватьСерии = СтруктураВозврата.ТаблицаСерий.Количество() > 0;
			Иначе
				ТаблицаТоваров = СтруктураВозврата.ТаблицаТоваров;
				Для Каждого СтрТабл из ТаблицаТоваров Цикл
					НомераСтрок = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрТабл.НомераСтрокДокумента, ", ");
					
					Для Каждого НомерСтроки из НомераСтрок Цикл
						
						СтрокаТабличнойЧасти = Объект[ИмяТЧТовары][Число(Формат(НомерСтроки,"ЧГ=0"))-1];
						СтрокаТабличнойЧасти.УказыватьСерии = СтрТабл.УказыватьСерии;
						
					КонецЦикла;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьСтатусыУказанияСерий(Объект,ПараметрыУказанияСерий);
		
		Возврат;
	КонецЕсли;
	
	//Удалим прежние строки серий
	ТекстПоляСвязи = "";
	
	Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
		ТекстПоляСвязи = ТекстПоляСвязи + "," + СтрМас  ;
	КонецЦикла;
	
	СтруктураПоиска = Новый Структура("Номенклатура,Характеристика"+ТекстПоляСвязи);
	ЗаполнитьЗначенияСвойств(СтруктураПоиска,ПараметрыФормыУказанияСерий);
	НайденныеСтрокиСерий = Объект[ИмяТЧСерии].НайтиСтроки(СтруктураПоиска);
	
	Для Каждого СтрМас из НайденныеСтрокиСерий Цикл
		
		Объект[ИмяТЧСерии].Удалить(СтрМас);
		
	КонецЦикла;
	
	//Добавим новые строки серий
	ТаблицаСерий = ПолучитьИзВременногоХранилища(ПараметрыФормыУказанияСерий.АдресВоВременномХранилище);
	
	Для Каждого СтрТабл из ТаблицаСерий Цикл
		
		НоваяСтрока = Объект[ИмяТЧСерии].Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока,ПараметрыФормыУказанияСерий);
		ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрТабл);
	
	КонецЦикла;
	
	Если ИмяТЧСерии = ИмяТЧТовары Тогда
		Возврат;
	КонецЕсли;
	
	
	ЕстьУпаковки = ПараметрыУказанияСерий.ПоляСвязи.Найти("Упаковка") <> Неопределено; 
	
	Если ЕстьУпаковки Тогда
		КоличествоСерий = ТаблицаСерий.Итог("КоличествоУпаковок");
	Иначе
		КоличествоСерий = ТаблицаСерий.Итог("Количество");
	КонецЕсли;	
	
	ИмяКолонкиКоличество         = "";
	ИмяКолонкиКоличествоУпаковок = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяКолонкиКоличество", ИмяКолонкиКоличество) Тогда
		ИмяКолонкиКоличество = "Количество";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяКолонкиКоличествоУпаковок", ИмяКолонкиКоличествоУпаковок) Тогда
		ИмяКолонкиКоличествоУпаковок = "КоличествоУпаковок";
	КонецЕсли;
	
	КоличествоТоваров = ПараметрыФормыУказанияСерий.Количество;
	
	Если ТоварВШапке Тогда
		
		СерииУказаныПолностью = (КоличествоСерий = КоличествоТоваров
								И КоличествоТоваров > 0);
		
		ЧетныйСтатус = Объект.СтатусУказанияСерий % 2 = 0;
		
		Если Не ЧетныйСтатус
			И СерииУказаныПолностью Тогда
			Объект.СтатусУказанияСерий = Объект.СтатусУказанияСерий + 1;
		ИначеЕсли ЧетныйСтатус
			И Не СерииУказаныПолностью Тогда
			Объект.СтатусУказанияСерий = Объект.СтатусУказанияСерий - 1;
		КонецЕсли;
		
	Иначе
		
		НайденныеСтрокиТоваров = Объект[ИмяТЧТовары].НайтиСтроки(СтруктураПоиска);
		
		КэшированныеЗначения = ОбработкаТабличнойЧастиТоварыКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();
		
		Если КоличествоСерий <> КоличествоТоваров 
			И СтруктураДействий <> Неопределено
			И СтруктураДействий.Свойство("ОбновлятьКоличествоТоваровПриРегистрацииСерий")
			И СтруктураДействий.ОбновлятьКоличествоТоваровПриРегистрацииСерий Тогда
			
			ЕстьПересчетКоличества = Ложь;
			
			Если СтруктураДействий.Свойство("ПересчитатьКоличествоЕдиниц") Тогда
				СтруктураДействий.Удалить("ПересчитатьКоличествоЕдиниц");
				ЕстьПересчетКоличества = Истина;
			КонецЕсли;
			
			Если СтруктураДействий.Свойство("ПересчитатьКоличествоУпаковок") Тогда
				СтруктураДействий.Удалить("ПересчитатьКоличествоУпаковок");
				ЕстьПересчетКоличества = Истина;
			КонецЕсли;
			
			КоличествоКРаспределению = КоличествоСерий - КоличествоТоваров;
			
			Для Каждого СтрокаТоваров из НайденныеСтрокиТоваров Цикл
				Дельта = КоличествоКРаспределению;
				
				Если ЕстьУпаковки Тогда
					Если -Дельта > СтрокаТоваров[ИмяКолонкиКоличествоУпаковок] Тогда
						Дельта = -СтрокаТоваров[ИмяКолонкиКоличествоУпаковок];
						СтрокаТоваров[ИмяКолонкиКоличествоУпаковок] = 0;
					Иначе
						СтрокаТоваров[ИмяКолонкиКоличествоУпаковок] = СтрокаТоваров[ИмяКолонкиКоличествоУпаковок] + Дельта;
					КонецЕсли;
					
					Если ЕстьПересчетКоличества Тогда
						СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
					КонецЕсли;
				Иначе
					Если -Дельта > СтрокаТоваров[ИмяКолонкиКоличество] Тогда
						Дельта = -СтрокаТоваров[ИмяКолонкиКоличество];
						СтрокаТоваров[ИмяКолонкиКоличество] = 0;
					Иначе
						СтрокаТоваров[ИмяКолонкиКоличество] = СтрокаТоваров[ИмяКолонкиКоличество] + Дельта;
					КонецЕсли;
					
					Если ЕстьПересчетКоличества Тогда
						СтруктураДействий.Вставить("ПересчитатьКоличествоУпаковок");
					КонецЕсли;
				КонецЕсли;
				
				КоличествоТоваров = КоличествоТоваров + Дельта;
				
				КоличествоКРаспределению = КоличествоКРаспределению - Дельта;
				
				ОбработатьСтрокуТЧСервер(СтрокаТоваров, СтруктураДействий, КэшированныеЗначения);
				
				Если КоличествоКРаспределению = 0 Тогда
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		СерииУказаныПолностью = (КоличествоСерий = КоличествоТоваров
								И КоличествоТоваров > 0);
		
		Для Каждого СтрМас из НайденныеСтрокиТоваров Цикл
			
			Если ПараметрыУказанияСерий.Свойство("СправочныйВводСерий")
				И ПараметрыУказанияСерий.СправочныйВводСерий Тогда
				
				Если СерииУказаныПолностью Тогда
					СтрМас.СтатусУказанияСерий = 2;
				Иначе
					СтрМас.СтатусУказанияСерий = 11;
				КонецЕсли;
			Иначе
				ЧетныйСтатус = СтрМас.СтатусУказанияСерий % 2 = 0;
				
				Если Не ЧетныйСтатус
					И СерииУказаныПолностью Тогда
					СтрМас.СтатусУказанияСерий = СтрМас.СтатусУказанияСерий + 1;
				ИначеЕсли ЧетныйСтатус
					И Не СерииУказаныПолностью Тогда
					СтрМас.СтатусУказанияСерий = СтрМас.СтатусУказанияСерий - 1;
				КонецЕсли;
			КонецЕсли;
			
			Если ПараметрыУказанияСерий.Свойство("ЭтоПеремещениеМеждуСкладами")
				И ПараметрыУказанияСерий.ЭтоПеремещениеМеждуСкладами Тогда
				
				ЧетныйСтатус = СтрМас.СтатусУказанияСерийОтправитель % 2 = 0;
				
				Если Не ЧетныйСтатус
					И СерииУказаныПолностью Тогда
					СтрМас.СтатусУказанияСерийОтправитель = СтрМас.СтатусУказанияСерийОтправитель + 1;
				ИначеЕсли ЧетныйСтатус
					И Не СерииУказаныПолностью Тогда
					СтрМас.СтатусУказанияСерийОтправитель = СтрМас.СтатусУказанияСерийОтправитель - 1;
				КонецЕсли;
				
				ЧетныйСтатус = СтрМас.СтатусУказанияСерийПолучатель % 2 = 0;
				
				Если Не ЧетныйСтатус
					И СерииУказаныПолностью Тогда
					СтрМас.СтатусУказанияСерийПолучатель = СтрМас.СтатусУказанияСерийПолучатель + 1;
				ИначеЕсли ЧетныйСтатус
					И Не СерииУказаныПолностью Тогда
					СтрМас.СтатусУказанияСерийПолучатель = СтрМас.СтатусУказанияСерийПолучатель - 1;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчитывает статусы указания серий в строках товаров, если это необходимо, переподчиняет строки серий другим строкам
// ТЧ "Товары"
// Параметры
//		Объект - ДанныеФормыСтуктура - основной реквизит формы документа
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
//      ТекущиеДанныеИдентификатор - идентификатор текущей строки товаров в форме документа
//		КэшированныеЗначения - структура кеша реквизитов текущей строки товаров
Процедура ЗаполнитьСтатусыУказанияСерийПриОкончанииРедактированияСтрокиТЧ(Объект, ПараметрыУказанияСерий, ТекущаяСтрокаИдентификатор, КэшированныеЗначения, ЗапускИзРМК = Ложь) Экспорт
	
	ИмяТЧТовары = "";
	ИмяТЧСерии  = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧТовары", ИмяТЧТовары) Тогда
		ИмяТЧТовары = "Товары";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	Если ЗапускИзРМК Тогда
		ТекущаяСтрока = ТекущаяСтрокаИдентификатор;
	ИначеЕсли ТекущаяСтрокаИдентификатор <> Неопределено Тогда
		ТекущаяСтрока = Объект[ИмяТЧТовары].НайтиПоИдентификатору(ТекущаяСтрокаИдентификатор);
	Иначе
		ТекущаяСтрока = Неопределено //значит строку удалили;
	КонецЕсли;
	
	Если ИмяТЧТовары = ИмяТЧСерии Тогда
		НайденныеСтрокиТоваров = Новый Массив;
		НайденныеСтрокиТоваров.Добавить(ТекущаяСтрока);
		ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьСтатусыУказанияСерий(Объект,ПараметрыУказанияСерий,НайденныеСтрокиТоваров);
		Возврат;
	КонецЕсли;
	
	ТекстПоляСвязи = "";
	
	Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
		ТекстПоляСвязи = ТекстПоляСвязи + "," + СтрМас  ;
	КонецЦикла;
	
	ЕстьУпаковки = ПараметрыУказанияСерий.ПоляСвязи.Найти("Упаковка") <> Неопределено; 
	ЕстьПризнакУказанияСерий = ПараметрыУказанияСерий.ПоляСвязи.Найти("УказыватьСерии") <> Неопределено;
	
	
	//Если строка новая (в т.ч. скопированная) - будет кэшировано Неопределено
	//Тогда не нужно искать строки со старыми значениями
	Если КэшированныеЗначения.Номенклатура <> Неопределено Тогда
		СтруктураПоискаСтарыеЗначения = Новый Структура("Номенклатура,Характеристика"+ТекстПоляСвязи);
		ЗаполнитьЗначенияСвойств(СтруктураПоискаСтарыеЗначения,КэшированныеЗначения);
		
		НайденныеСтрокиТоваров = Объект[ИмяТЧТовары].НайтиСтроки(СтруктураПоискаСтарыеЗначения);
		НайденныеСтрокиСерий = Объект[ИмяТЧСерии].НайтиСтроки(СтруктураПоискаСтарыеЗначения);
	Иначе
		НайденныеСтрокиТоваров = Новый Массив;
		НайденныеСтрокиСерий   = Новый Массив;
	КонецЕсли;
	
	//Если поменялись ключевые поля:
	// - возможно нужно переподчинять серии
	// - статус указания серий нужно пересчитывать в строках по новым ключевым полям и по старым
	Если ТекущаяСтрока <> Неопределено 
		И Не ОбщегоНазначенияРТКлиентСервер.СтруктурыРавны(КэшированныеЗначения, ТекущаяСтрока, "Номенклатура,Характеристика"+ТекстПоляСвязи) Тогда
		
		ПереподчинитьСерии    = Ложь;
		ПересчитатьКоличество = Ложь;
		//Определим, нужно ли переподчинять серии. Это нужно если:
		//- серии относились только к одной строке
		//- новые и старые ключевые поля поддерживают одну политику учета
		//Если строки нужно переподчинять, то определим, нужно ли пересчитывать количество
		Если КэшированныеЗначения.Номенклатура <> Неопределено 
			И НайденныеСтрокиТоваров.Количество() = 0 Тогда//т.к. строк с такими ключевыми полями не осталось больше не осталось, значит такая строка была одна
			
			Если КэшированныеЗначения.Номенклатура = ТекущаяСтрока.Номенклатура Тогда //т.е. изменились поля, от которых политика учета не зависит
				Если (Не ЕстьПризнакУказанияСерий 
					Или КэшированныеЗначения.УказыватьСерии = ТекущаяСтрока.УказыватьСерии) Тогда
					ПереподчинитьСерии = Истина;
				Иначе
					ПереподчинитьСерии = Ложь;
				КонецЕсли;
			Иначе //будем переподчинять, если не поменялся вид номенклатуры
				ВидНоменклатурыТекущий = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(КэшированныеЗначения.Номенклатура,"ВидНоменклатуры");
				ВидНоменклатурыНовый   = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТекущаяСтрока.Номенклатура, "ВидНоменклатуры");
				
				ПереподчинитьСерии = (ВидНоменклатурыТекущий = ВидНоменклатурыНовый);
			КонецЕсли;
			
			Если ПереподчинитьСерии
				И ЕстьУпаковки
				И КэшированныеЗначения.Упаковка <> ТекущаяСтрока.Упаковка Тогда
				
				ПересчитатьКоличество = Истина;
				
			КонецЕсли;
			
		КонецЕсли;
		
		//Если строка удалена, то в качестве текущих значений будет передано Неопределено
		//Тогда не нужно искать строки с новыми значениями
		СтруктураПоискаНовыеЗначения = Новый Структура("Номенклатура,Характеристика"+ТекстПоляСвязи);
		ЗаполнитьЗначенияСвойств(СтруктураПоискаНовыеЗначения,ТекущаяСтрока);
		
		НайденныеСтрокиТоваровНовые = Объект[ИмяТЧТовары].НайтиСтроки(СтруктураПоискаНовыеЗначения);    
		
		//Добавим строки по новым ключевым полям в массив строк для пересчета статуса указания серий 
		
		//При объединении массивов будем обходить меньший массив
		Если НайденныеСтрокиТоваров.Количество() < НайденныеСтрокиТоваровНовые.Количество() Тогда
			Для Каждого СтрМас из НайденныеСтрокиТоваров Цикл
				НайденныеСтрокиТоваровНовые.Добавить(СтрМас);
			КонецЦикла;
			НайденныеСтрокиТоваров = НайденныеСтрокиТоваровНовые;
		Иначе
			Для Каждого СтрМас из НайденныеСтрокиТоваровНовые Цикл
				НайденныеСтрокиТоваров.Добавить(СтрМас);
			КонецЦикла;
		КонецЕсли;
		
		//Определим массив строк серий, который должен участвовать в пересчете статусов,
		Если ПереподчинитьСерии Тогда
			//Сначала переподчиним серии
			
			Для Каждого СтрМас из НайденныеСтрокиСерий Цикл
				
				ЗаполнитьЗначенияСвойств(СтрМас,ТекущаяСтрока, "Номенклатура,Характеристика"+ТекстПоляСвязи);
				
				Если ПересчитатьКоличество Тогда
					ПересчитатьКоличествоУпаковокВСтрокеТЧСервер(СтрМас, Новый Структура("ПересчитатьКоличествоУпаковок"), КэшированныеЗначения);
				КонецЕсли;
				
			КонецЦикла;
			
			//Если серии переподчинены, то достаточно произвести поиск по новым полям поиска
			НайденныеСтрокиСерий = Объект[ИмяТЧСерии].НайтиСтроки(СтруктураПоискаНовыеЗначения);
			
		Иначе	
			НайденныеСтрокиСерийНовые = Объект[ИмяТЧСерии].НайтиСтроки(СтруктураПоискаНовыеЗначения);
			
			//Если серии не переподчинены, то к строкам по старым ключевым полям нужно добавить строки по новым ключевым полям
			
			//При объединении массивов будем обходить меньший массив
			Если НайденныеСтрокиСерий.Количество() < НайденныеСтрокиСерийНовые.Количество() Тогда
				Для Каждого СтрМас из НайденныеСтрокиСерий Цикл
					НайденныеСтрокиСерийНовые.Добавить(СтрМас);
				КонецЦикла;
				НайденныеСтрокиСерий = НайденныеСтрокиСерийНовые;
			Иначе
				Для Каждого СтрМас из НайденныеСтрокиСерийНовые Цикл
					НайденныеСтрокиСерий.Добавить(СтрМас);
				КонецЦикла;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если НайденныеСтрокиТоваров.Количество() > 0 Тогда 
		ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьСтатусыУказанияСерий(Объект,ПараметрыУказанияСерий,НайденныеСтрокиТоваров,НайденныеСтрокиСерий);
	КонецЕсли;
	
КонецПроцедуры

// Процедура пересчитывает статус указания серий для товара в шапке документа, если это необходимо, переподчиняет строки серий
// Параметры
//		Объект - ДанныеФормыСтуктура - основной реквизит формы документа
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
//		КэшированныеЗначения - структура кеша реквизитов текущей строки товаров
Процедура ЗаполнитьСтатусыУказанияСерийПриИзмененииТовараВШапке(Объект, Знач ПараметрыУказанияСерий, КэшированныеЗначения) Экспорт
	
	ИмяТЧСерии  = "";
	
	Если Не ПараметрыУказанияСерий.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	ТекстПоляСвязи = "";
	
	Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
		ТекстПоляСвязи = ","+ ТекстПоляСвязи + СтрМас  ;
	КонецЦикла;
	
	ЕстьУпаковки = ПараметрыУказанияСерий.ПоляСвязи.Найти("Упаковка") <> Неопределено; 
	
	
	//Если поменялись ключевые поля:
	// - возможно нужно переподчинять серии
	// - статус указания серий нужно пересчитывать в строках по новым ключевым полям и по старым
	
	ИзменилисьКлючевыеПоля = Ложь;
	
	Если КэшированныеЗначения.НоменклатураШапка <> Объект.Номенклатура
		Или  КэшированныеЗначения.ХарактеристикаШапка <> Объект.Характеристика Тогда
		ИзменилисьКлючевыеПоля = Истина;
	Иначе	
		Для Каждого СтрМас из ПараметрыУказанияСерий.ПоляСвязи Цикл
			Если КэшированныеЗначения[СтрМас+"Шапка"] <> Объект[СтрМас] Тогда
				ИзменилисьКлючевыеПоля = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	ПересчитатьСтатус = Ложь;

	Если ИзменилисьКлючевыеПоля Тогда
		
		ПереподчинитьСерии    = Ложь;
		ПересчитатьКоличество = Ложь;
		//Определим, нужно ли переподчинять серии. Это нужно если:
		//- серии относились только к одной строке
		//- новые и старые ключевые поля поддерживают одну политику учета
		//Если строки нужно переподчинять, то определим, нужно ли пересчитывать количество
		
		Если КэшированныеЗначения.НоменклатураШапка = Объект.Номенклатура Тогда //т.е. изменились поля, от которых политика учета не зависит
			ПереподчинитьСерии = Истина;
		Иначе //будем переподчинять, если не поменялся вид номенклатуры
			ВидНоменклатурыТекущий = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(КэшированныеЗначения.НоменклатураШапка,"ВидНоменклатуры");
			ВидНоменклатурыНовый   = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Объект.Номенклатура, "ВидНоменклатуры");
			
			ПереподчинитьСерии = (ВидНоменклатурыТекущий = ВидНоменклатурыНовый);
			ПересчитатьСтатус  = Не (ВидНоменклатурыТекущий = ВидНоменклатурыНовый);
		КонецЕсли;
		
		Если ПереподчинитьСерии
			И ЕстьУпаковки
			И КэшированныеЗначения.УпаковкаШапка <> Объект.Упаковка Тогда
			
			ПересчитатьКоличество = Истина;
			
		КонецЕсли;
			
		Если ПереподчинитьСерии Тогда		
			СтруктураПоискаСтарыеЗначения = Новый Структура("Номенклатура,Характеристика"+ТекстПоляСвязи);
			Для Каждого КлючИЗначение из СтруктураПоискаСтарыеЗначения Цикл
				СтруктураПоискаСтарыеЗначения[КлючИЗначение.Ключ] = КэшированныеЗначения[КлючИЗначение.Ключ+"Шапка"]	
			КонецЦикла;
			
			НайденныеСтрокиСерий = Объект[ИмяТЧСерии].НайтиСтроки(СтруктураПоискаСтарыеЗначения);
			
			Для Каждого СтрМас из НайденныеСтрокиСерий Цикл
				
				ЗаполнитьЗначенияСвойств(СтрМас,Объект, "Номенклатура,Характеристика"+ТекстПоляСвязи);
				
				Если ПересчитатьКоличество Тогда
					ПересчитатьКоличествоУпаковокВСтрокеТЧСервер(СтрМас, Новый Структура("ПересчитатьКоличествоУпаковок"), КэшированныеЗначения);
				КонецЕсли;	
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЕстьУпаковки Тогда
		Если КэшированныеЗначения.КоличествоУпаковокШапка <> Объект.КоличествоУпаковок Тогда
			ПересчитатьСтатус = Истина;
		КонецЕсли;
	Иначе
		Если КэшированныеЗначения.КоличествоШапка <> Объект.Количество Тогда
			ПересчитатьСтатус = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ПересчитатьСтатус Тогда 
		ОбработкаТабличнойЧастиТоварыСервер.ЗаполнитьСтатусыУказанияСерий(Объект,ПараметрыУказанияСерий,Неопределено,Неопределено);
	КонецЕсли;
	
КонецПроцедуры

//Процедура заполняет накладную сериями, указанными в заказе
//		ДокументОбъект - ДокументОбъект, в котором нужно заполнить серии
//      ПараметрыУказанияСерий - структура параметров указания серий, возвращаемая соответствующей процедурой модуля менеджера документа
Процедура ЗаполнитьСерииПоЗаказам(Объект,ПараметрыУказанияСерий) Экспорт
	
	ЕстьТоварВШапке = ПараметрыУказанияСерий.Свойство("Шапка");
	
	Если ЕстьТоварВШапке Тогда
		Если Не ПараметрыУказанияСерий.ТЧ.ИспользоватьСерииНоменклатуры
			И Не ПараметрыУказанияСерий.Шапка.ИспользоватьСерииНоменклатуры Тогда
			Возврат;
		КонецЕсли;
		ПараметрыУказанияСерийЗаполнение = ПараметрыУказанияСерий.ТЧ;
	Иначе
		Если Не ПараметрыУказанияСерий.ИспользоватьСерииНоменклатуры Тогда
			Возврат;
		КонецЕсли;
		ПараметрыУказанияСерийЗаполнение = ПараметрыУказанияСерий;
	КонецЕсли;
	
	
	ИмяТЧТовары  = "";
	ИмяТЧСерии   = "";
		
	Если Не ПараметрыУказанияСерийЗаполнение.Свойство("ИмяТЧТовары", ИмяТЧТовары) Тогда              
		ИмяТЧТовары = "Товары";
	КонецЕсли;
	
	Если Не ПараметрыУказанияСерийЗаполнение.Свойство("ИмяТЧСерии", ИмяТЧСерии) Тогда
		ИмяТЧСерии = "Серии";
	КонецЕсли;
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ТаблицаТовары.Номенклатура,
	|	ТаблицаТовары.Характеристика,
	|	ТаблицаТовары.ДокументРезерваСерий,";
	ТекстЗапроса = ТекстЗапроса + "
	|	&Магазин КАК Магазин";
	ТекстЗапроса = ТекстЗапроса + "
	|ПОМЕСТИТЬ ТаблицаТовары
	|ИЗ
	|	&ТаблицаТовары КАК ТаблицаТовары
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РезервыСерийТоваров.Номенклатура,
	|	РезервыСерийТоваров.Характеристика,
	|	РезервыСерийТоваров.ДокументРезерваСерий,
	|	РезервыСерийТоваров.Склад,
	|	РезервыСерийТоваров.Серия,
	|	СУММА(РезервыСерийТоваров.Количество) КАК Количество
	|ИЗ
	|	(ВЫБРАТЬ
	|		РезервыСерийТоваровОстатки.Номенклатура КАК Номенклатура,
	|		РезервыСерийТоваровОстатки.Характеристика КАК Характеристика,
	|		РезервыСерийТоваровОстатки.ДокументРезерва КАК ДокументРезерваСерий,
	|		РезервыСерийТоваровОстатки.Склад КАК Склад,
	|		РезервыСерийТоваровОстатки.Серия КАК Серия,
	|		РезервыСерийТоваровОстатки.КоличествоОстаток КАК Количество
	|	ИЗ
	|		РегистрНакопления.РезервыСерийТоваров.Остатки(
	|				,
	|				(ДокументРезерва, Склад, Номенклатура, Характеристика) В
	|						(ВЫБРАТЬ
	|							ТаблицаТовары.ДокументРезерваСерий КАК ДокументРезерва,
	|							ТаблицаТовары.Склад,
	|							ТаблицаТовары.Номенклатура,
	|							ТаблицаТовары.Характеристика
	|						ИЗ
	|							ТаблицаТовары КАК ТаблицаТовары)
	|					И Серия <> ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)) КАК РезервыСерийТоваровОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		РезервыСерийТоваров.Номенклатура,
	|		РезервыСерийТоваров.Характеристика,
	|		РезервыСерийТоваров.ДокументРезерва,
	|		РезервыСерийТоваров.Склад,
	|		РезервыСерийТоваров.Серия,
	|		РезервыСерийТоваров.Количество
	|	ИЗ
	|		РегистрНакопления.РезервыСерийТоваров КАК РезервыСерийТоваров
	|	ГДЕ
	|		РезервыСерийТоваров.Регистратор = &Регистратор
	|		И РезервыСерийТоваров.Серия <> ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)) КАК РезервыСерийТоваров
	|
	|СГРУППИРОВАТЬ ПО
	|	РезервыСерийТоваров.Номенклатура,
	|	РезервыСерийТоваров.Серия,
	|	РезервыСерийТоваров.Склад,
	|	РезервыСерийТоваров.ДокументРезерваСерий,
	|	РезервыСерийТоваров.Характеристика
	|
	|УПОРЯДОЧИТЬ ПО
	|	РезервыСерийТоваров.Склад,
	|	РезервыСерийТоваров.ДокументРезерваСерий,
	|	РезервыСерийТоваров.Номенклатура,
	|	РезервыСерийТоваров.Характеристика";

	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	Запрос.УстановитьПараметр("Регистратор",Объект.Ссылка);
	
	ТаблицаТовары = Объект[ИмяТЧТовары].Выгрузить(,"Номенклатура,Характеристика,ДокументРезерваСерий");
	
	Если ЕстьТоварВШапке Тогда
		СтрокаТоваров = ТаблицаТовары.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаТоваров, Объект);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТаблицаТовары",ТаблицаТовары);
	Запрос.УстановитьПараметр("Магазин",Объект.Магазин);
	ПоляГруппировки = "Характеристика,Номенклатура,ДокументРезерваСерий";
		
	Выборка = Запрос.Выполнить().Выбрать();

	ТекущаяГруппировка = Новый Структура(ПоляГруппировки);
	
	Пока Выборка.Следующий() Цикл
		
		Если Не ОбщегоНазначенияРТКлиентСервер.СтруктурыРавны(ТекущаяГруппировка, Выборка, ПоляГруппировки) Тогда
			
			ЗаполнитьЗначенияСвойств(ТекущаяГруппировка, Выборка);
			
			НайденныеСтрокиСерий = Объект[ИмяТЧСерии].НайтиСтроки(ТекущаяГруппировка);
			
			Для Каждого СтрМас из НайденныеСтрокиСерий Цикл
				
				Объект[ИмяТЧСерии].Удалить(СтрМас);
				
			КонецЦикла;
			
		КонецЕсли;	
			
		НоваяСтрокаСерий = Объект[ИмяТЧСерии].Добавить();
		
		ЗаполнитьЗначенияСвойств(НоваяСтрокаСерий,Выборка);
		
	КонецЦикла;	
	
КонецПроцедуры

/////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ РАБОТЫ С ПЕРЕСОРТИЦЕЙ

// Процедура проверки выбора номенклатуры при пересортице
//
Процедура ПроверитьВыборНоменклатуры(ДокументОбъект, Отказ) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПересортицаТоваровСписания.НомерСтроки,
	|	ПересортицаТоваровСписания.Номенклатура,
	|	""Номенклатура"" КАК ГрафаПроверки
	|ПОМЕСТИТЬ ПересортицаТоваровСписания
	|ИЗ
	|	&ПересортицаТоваровСписания КАК ПересортицаТоваровСписания
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПересортицаТоваровОприходования.НоменклатураОприходование КАК Номенклатура,
	|	ПересортицаТоваровОприходования.НомерСтроки,
	|	""НоменклатураОприходование"" КАК ГрафаПроверки
	|ПОМЕСТИТЬ ПересортицаТоваровОприходования
	|ИЗ
	|	&ПересортицаТоваровОприходования КАК ПересортицаТоваровОприходования
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПересортицаТоваровСписания.НомерСтроки,
	|	ПересортицаТоваровСписания.Номенклатура,
	|	ПересортицаТоваровСписания.ГрафаПроверки,
	|	ВЫБОР
	|		КОГДА ПересортицаТоваровСписания.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|			ТОГДА ""услуга""
	|		ИНАЧЕ ""использование номеров подарочных сертификатов""
	|	КОНЕЦ КАК НаименованиеОшибки
	|ИЗ
	|	ПересортицаТоваровСписания КАК ПересортицаТоваровСписания
	|ГДЕ
	|	(ПересортицаТоваровСписания.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|			ИЛИ ПересортицаТоваровСписания.Номенклатура.ИспользоватьСерийныеНомера)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПересортицаТоваровОприходования.НомерСтроки,
	|	ПересортицаТоваровОприходования.Номенклатура,
	|	ПересортицаТоваровОприходования.ГрафаПроверки,
	|	ВЫБОР
	|		КОГДА ПересортицаТоваровОприходования.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|			ТОГДА ""услуга""
	|		ИНАЧЕ ""использование номеров подарочных сертификатов""
	|	КОНЕЦ
	|ИЗ
	|	ПересортицаТоваровОприходования КАК ПересортицаТоваровОприходования
	|ГДЕ
	|	(ПересортицаТоваровОприходования.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|			ИЛИ ПересортицаТоваровОприходования.Номенклатура.ИспользоватьСерийныеНомера)";
	
	Запрос.УстановитьПараметр("ПересортицаТоваровСписания", ДокументОбъект["Товары"].Выгрузить(,"НомерСтроки,Номенклатура"));
	Запрос.УстановитьПараметр("ПересортицаТоваровОприходования", ДокументОбъект["Товары"].Выгрузить(,"НомерСтроки,НоменклатураОприходование"));
	
	Результат = Запрос.Выполнить();
	ТаблицаЗапроса = Результат.Выгрузить();
	
	Для каждого СтрокаТЗ Из ТаблицаЗапроса Цикл
		
		Если СтрокаТЗ.ГрафаПроверки = "НоменклатураОприходование" Тогда
			Если СтрокаТЗ.НаименованиеОшибки = "услуга" Тогда
				ТекстСообщения = "У рядку %1 в якості номенклатури оприбуткування «%2» вказана послуга"; 
			Иначе
				ТекстСообщения = "У рядку %1 за номенклатурою оприбуткування «%2» ведеться облік за номерами подарункових сертифікатів"; 
			КонецЕсли;
		Иначе
			Если СтрокаТЗ.НаименованиеОшибки = "услуга" Тогда
				ТекстСообщения = "У рядку %1 в якості номенклатури оприбуткування «%2» указана услуга"; 
			Иначе
				ТекстСообщения = "У рядку %1 за номенклатурою оприбуткування «%2» ведеться облік за номерами подарункових сертифікатів"; 
			КонецЕсли;
		КонецЕсли;
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ТекстСообщения,
			СтрокаТЗ.НомерСтроки,
			СтрокаТЗ.Номенклатура
		);
		
		Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти("Товары", СтрокаТЗ.НомерСтроки, СтрокаТЗ.ГрафаПроверки);
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения,
			ДокументОбъект,
			Поле,
			,
			Отказ
		);

		
	КонецЦикла;
	
КонецПроцедуры

/////////////////////////////////////////////////////////////////
// ПРОЧИЕ

Процедура ПроверитьАссортиментСтроки(ТекущаяСтрока, СтруктураДействий)
	
	Перем СтруктураПараметровДействия, ЗначениеСвойства;
	
	Если Не СтруктураДействий.Свойство("ПроверитьАссортиментСтроки", СтруктураПараметровДействия) Тогда
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ТекущаяСтрока.Номенклатура) Тогда
		Возврат;
	КонецЕсли;
	
	Если СтруктураПараметровДействия.ПроверитьТоварВЗаказе <> Неопределено Тогда
		Если ТоварСодержитсяВЗаказе(ТекущаяСтрока.Номенклатура, СтруктураПараметровДействия.ПроверитьТоварВЗаказе) Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	СтруктураСостояния = АссортиментСервер.СтруктураСостоянияАссортиментаТовараВФормате(ТекущаяСтрока.Номенклатура,
																						СтруктураПараметровДействия.Магазин,
																						СтруктураПараметровДействия.Дата);
	
	Если НЕ СтруктураСостояния[СтруктураПараметровДействия.ИмяРесурсаАссортимента] Тогда
		
		ТекстСообщения = СтруктураПараметровДействия.ТекстСообщения;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, ТекущаяСтрока.Номенклатура);
		Если СтруктураПараметровДействия.РазрешатьДобавление Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				ТекстСообщения,
				СтруктураПараметровДействия.Ссылка,
				ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти("Объект." + СтруктураПараметровДействия.ИмяТабличнойЧасти,
																	ТекущаяСтрока.НомерСтроки,
																	"Номенклатура"));
		Иначе
			ТекущаяСтрока.Номенклатура = Справочники.Номенклатура.ПустаяСсылка();
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ТоварСодержитсяВЗаказе(Номенклатура, Заказ)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЗаказПоставщикуТовары.Номенклатура
	|ИЗ
	|	Документ.ЗаказПоставщику.Товары КАК ЗаказПоставщикуТовары
	|ГДЕ
	|	ЗаказПоставщикуТовары.Ссылка = &Ссылка
	|	И ЗаказПоставщикуТовары.Номенклатура = &Номенклатура";
	Запрос.УстановитьПараметр("Ссылка", Заказ);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Результат = Запрос.Выполнить();
	
	Возврат НЕ Результат.Пустой();
	
КонецФункции

Процедура ПроверитьЗапретРозничнойПродажи(ТекущаяСтрока, СтруктураДействий)
	
	Перем СтруктураПараметровДействия, ЗначениеСвойства;
	
	Если Не СтруктураДействий.Свойство("ПроверитьЗапретРозничнойПродажи", СтруктураПараметровДействия) Тогда
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ТекущаяСтрока.Номенклатура) Тогда
		Возврат;
	КонецЕсли;
	
	Если СкидкиНаценкиСерверПереопределяемый.ЗапрещенаПродажаТовара(
		ТекущаяСтрока.Номенклатура,
		СтруктураПараметровДействия.Магазин,
		СтруктураПараметровДействия.Дата)
	Тогда

		ТекстСообщения = СтруктураПараметровДействия.ТекстСообщения;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, ТекущаяСтрока.Номенклатура);
		ТекущаяСтрока.Номенклатура = Справочники.Номенклатура.ПустаяСсылка();
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);

	КонецЕсли;

КонецПроцедуры

// Процедура пересчета "ОчиститьКоличествоУчет"
//
Процедура ПересчитатьОчиститьКоличествоУчетВСтрокеТЧСервер(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения) Экспорт
	
	Если СтруктураДействий.Свойство("ОчиститьКоличествоУчет") Тогда
		
		ТекущаяСтрока.Количество 		 = 0;
		ТекущаяСтрока.КоличествоУпаковок = 0;
		
	КонецЕсли;

КонецПроцедуры

// Функция получения суммы документа без подарочных сертификатов
//
Функция ПолучитьСуммуДокументаБезПодарочныхСертификатов(Объект, ИмяТЧ = "Товары") Экспорт
	
	СуммаДокументаБезПодарочныхСертификатов = Объект[ИмяТЧ].Итог("Сумма");
	
	СтруктураПоиска = Новый Структура;
	СтруктураПоиска.Вставить("ТипНоменклатуры", Перечисления.ТипыНоменклатуры.ПодарочныйСертификат);
	
	СтрокиПодарочныхСертификатов = Объект[ИмяТЧ].НайтиСтроки(СтруктураПоиска);
	Для каждого СтрокаПодарочногоСертификата Из СтрокиПодарочныхСертификатов Цикл
	
		СуммаДокументаБезПодарочныхСертификатов = СуммаДокументаБезПодарочныхСертификатов - СтрокаПодарочногоСертификата.Сумма;
	
	КонецЦикла;
	
	Возврат СуммаДокументаБезПодарочныхСертификатов;
	
КонецФункции

Функция СтруктуруКолонокКоллекции(КоллекцияФормы)	Экспорт	//	LNK 04.07.2021 07:35:12

	СтруктураКолонок = Новый Структура;

	Для каждого КолонкаКоллекции Из КоллекцияФормы.Выгрузить(Новый Массив).Колонки Цикл

		СтруктураКолонок.Вставить(КолонкаКоллекции.Имя, КолонкаКоллекции.ТипЗначения);

	КонецЦикла;

	Возврат СтруктураКолонок;

КонецФункции

