////////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ ИНТЕРФЕЙС

// Общая процедура проверки реализации и погашения серийных номеров
//
// Параметры
//  ДокументОбъект - объект проводимого документа документа.
//  РежимПроведения - режим проведения документа
//  Отказ - Переменная отвечающая за прерывание проведения
//  Заголовок - Заголовок при ошибке
//
Процедура ПроверитьДвиженияСерийныхНомеровДляПогашения(
	ДокументОбъект,
	ЭтоДокумент,
	ЭтоНовый,
	ТабличнаяЧасть,
	ТабличнаяЧасть_ПогашениеПодарочныхСертификатов,
	Отказ,
	ТекстОшибки = "",
	Дата
	) Экспорт

	Возврат;	//	LNK 30.05.2020 13:04:52

	УстановитьПривилегированныйРежим(Истина);

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(СерийныеНомера.СерийныйНомер КАК Справочник.СерийныеНомера) КАК СерийныйНомер,
	|	СерийныеНомера.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомераВсе
	|ИЗ
	|	&СерийныеНомера КАК СерийныеНомера
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомераВсе.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	(НЕ ТабСерийныеНомераВсе.СерийныйНомер = ЗНАЧЕНИЕ(Справочник.СерийныеНомера.ПустаяСсылка))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.Период КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Получатель.Магазин КАК Магазин,
	|	ДвиженияСерийныхНомеров.Регистратор,
	|	ДвиженияСерийныхНомеров.СерийныйНомер
	|ПОМЕСТИТЬ ДвиженияСерийныхНомеров
	|ИЗ
	|	РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|ГДЕ
	|	ДвиженияСерийныхНомеров.Период < &Дата
	|	И &УсловиеПоРегистратору
	|	И ДвиженияСерийныхНомеров.СерийныйНомер В
	|			(ВЫБРАТЬ
	|				ТабСерийныеНомера.СерийныйНомер
	|			ИЗ
	|				ТабСерийныеНомера КАК ТабСерийныеНомера)
	|	И ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.ДатаОперации КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Магазин КАК Магазин,
	|	ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомера.СерийныйНомер.Владелец КАК Номенклатура,
	|	ТабСерийныеНомера.НомерСтроки
	|ИЗ
	|	ТабСерийныеНомера КАК ТабСерийныеНомера
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|		ПО ТабСерийныеНомера.СерийныйНомер = ДвиженияСерийныхНомеров.СерийныйНомер";
	
	Запрос.УстановитьПараметр("СерийныеНомера", ТабличнаяЧасть);
	
	Если ЭтоДокумент Тогда 
		Запрос.УстановитьПараметр("Регистратор", ДокументОбъект.Ссылка);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ДвиженияСерийныхНомеров.Регистратор <> &Регистратор");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ИСТИНА");
	КонецЕсли;
	Запрос.УстановитьПараметр("Дата", Дата);
	
	
	Результат = Запрос.Выполнить();
	ТаблицаЗапроса = Результат.Выгрузить();
	
	Для каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Номер подарочного сертификата %1 уже погашен. В магазине %2 Дата %3'"),
			СтрокаТаблицыЗапроса.СерийныйНомер,
			СтрокаТаблицыЗапроса.Магазин,
			Формат(СтрокаТаблицыЗапроса.ДатаОперации, "ДФ=dd.MM.yyyy")
		);
		
		Если ЭтоДокумент Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				Текст,
				ДокументОбъект,
				,
				,
				Отказ
			);
		Иначе
			Отказ = Истина;
		КонецЕсли;
		
		ТекстОшибки = ТекстОшибки + Символы.ПС + Текст;
		
	КонецЦикла;
	
	ПогашенныеСерийныеНомера = ТаблицаЗапроса.ВыгрузитьКолонку("СерийныйНомер");

	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(СерийныеНомера.СерийныйНомер КАК Справочник.СерийныеНомера) КАК СерийныйНомер,
	|	СерийныеНомера.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомераВсе
	|ИЗ
	|	&СерийныеНомера КАК СерийныеНомера
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомераВсе.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	(НЕ ТабСерийныеНомераВсе.СерийныйНомер = ЗНАЧЕНИЕ(Справочник.СерийныеНомера.ПустаяСсылка))
	|	И (НЕ ТабСерийныеНомераВсе.СерийныйНомер В (&ПогашенныеСерийныеНомера))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.Период КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Регистратор,
	|	ДвиженияСерийныхНомеров.Получатель.Магазин КАК Магазин,
	|	ДвиженияСерийныхНомеров.СерийныйНомер
	|ПОМЕСТИТЬ ДвиженияСерийныхНомеров
	|ИЗ
	|	РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|ГДЕ
	|	ДвиженияСерийныхНомеров.Период < &Дата
	|	И &УсловиеПоРегистратору
	|	И ДвиженияСерийныхНомеров.СерийныйНомер В
	|			(ВЫБРАТЬ
	|				ТабСерийныеНомера.СерийныйНомер
	|			ИЗ
	|				ТабСерийныеНомера КАК ТабСерийныеНомера)
	|	И ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.ДатаОперации КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Магазин КАК Магазин,
	|	ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомера.СерийныйНомер.Владелец КАК Номенклатура,
	|	ТабСерийныеНомера.НомерСтроки
	|ИЗ
	|	ТабСерийныеНомера КАК ТабСерийныеНомера
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|		ПО ТабСерийныеНомера.СерийныйНомер = ДвиженияСерийныхНомеров.СерийныйНомер
	|ГДЕ
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации ЕСТЬ NULL "
	);
	
	Запрос.УстановитьПараметр("СерийныеНомера", ТабличнаяЧасть_ПогашениеПодарочныхСертификатов);
	Запрос.УстановитьПараметр("ПогашенныеСерийныеНомера", ПогашенныеСерийныеНомера);
	
	Если ЭтоДокумент Тогда 
		Запрос.УстановитьПараметр("Регистратор", ДокументОбъект.Ссылка);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ДвиженияСерийныхНомеров.Регистратор <> &Регистратор");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ИСТИНА");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Дата", Дата);
	
	Результат = Запрос.Выполнить();
	ТаблицаЗапроса = Результат.Выгрузить();
	
	Для каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Номер подарочного сертификата %1 еще не был реализован.'"),
			СтрокаТаблицыЗапроса.СерийныйНомер
		);

		Если ЭтоДокумент Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				Текст,
				ДокументОбъект,
				,
				,
				Отказ
			);
		Иначе
			Отказ = Истина;
		КонецЕсли;
		
		ТекстОшибки = ТекстОшибки + Символы.ПС + Текст;
		
	КонецЦикла;

	НеРеализованныеСерийныеНомера = ТаблицаЗапроса.ВыгрузитьКолонку("СерийныйНомер");

	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(СерийныеНомера.СерийныйНомер КАК Справочник.СерийныеНомера) КАК СерийныйНомер,
	|	СерийныеНомера.НомерСтроки КАК НомерСтроки,
	|	ВЫРАЗИТЬ(СерийныеНомера.ПодарочныйСертификат КАК Справочник.Номенклатура) КАК ПодарочныйСертификат
	|ПОМЕСТИТЬ ТабСерийныеНомераВсе
	|ИЗ
	|	&СерийныеНомера КАК СерийныеНомера
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомераВсе.НомерСтроки КАК НомерСтроки,
	|	ТабСерийныеНомераВсе.ПодарочныйСертификат КАК ПодарочныйСертификат
	|ПОМЕСТИТЬ ТабСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	НЕ ТабСерийныеНомераВсе.СерийныйНомер = ЗНАЧЕНИЕ(Справочник.СерийныеНомера.ПустаяСсылка)
	|	И НЕ ТабСерийныеНомераВсе.СерийныйНомер В (&ПогашенныеСерийныеНомера)
	|	И НЕ ТабСерийныеНомераВсе.СерийныйНомер В (&НеРеализованныеСерийныеНомера)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.НомерСтроки КАК НомерСтроки,
	|	ТабСерийныеНомераВсе.ПодарочныйСертификат КАК ПодарочныйСертификат
	|ПОМЕСТИТЬ ТабБезСерийных
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	НЕ ТабСерийныеНомераВсе.ПодарочныйСертификат.ИспользоватьСерийныеНомера
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомера.НомерСтроки КАК НомерСтроки,
	|	ТабСерийныеНомера.ПодарочныйСертификат.ДатаОкончанияДействия КАК ДатаОкончанияДействия,
	|	NULL КАК Магазин,
	|	NULL КАК ДатаОперации,
	|	ЛОЖЬ КАК СрокОтПродажи,
	|	ТабСерийныеНомера.ПодарочныйСертификат КАК Номенклатура
	|ПОМЕСТИТЬ НеПравильныеСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомера КАК ТабСерийныеНомера
	|ГДЕ
	|	ТабСерийныеНомера.ПодарочныйСертификат.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.СОграничениемНаДату)
	|	И КОНЕЦПЕРИОДА(ТабСерийныеНомера.ПодарочныйСертификат.ДатаОкончанияДействия, ДЕНЬ) < &Дата
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Ведущая.СерийныйНомер,
	|	Ведущая.НомерСтроки,
	|	ВЫБОР
	|		КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Неделя)
	|			ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, НЕДЕЛЯ, Ведущая.КоличествоПериодовДействия)
	|		КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Декада)
	|			ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ДЕКАДА, Ведущая.КоличествоПериодовДействия)
	|		КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Месяц)
	|			ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, МЕСЯЦ, Ведущая.КоличествоПериодовДействия)
	|		КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Квартал)
	|			ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, КВАРТАЛ, Ведущая.КоличествоПериодовДействия)
	|		КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Полугодие)
	|			ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ПОЛУГОДИЕ, Ведущая.КоличествоПериодовДействия)
	|		КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Год)
	|			ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ГОД, Ведущая.КоличествоПериодовДействия)
	|		ИНАЧЕ ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ДЕНЬ, Ведущая.КоличествоПериодовДействия)
	|	КОНЕЦ,
	|	ДвиженияСерийныхНомеров.Отправитель.Магазин,
	|	ДвиженияСерийныхНомеров.Период,
	|	ИСТИНА,
	|	Ведущая.Номенклатура
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|		ТабСерийныеНомера.НомерСтроки КАК НомерСтроки,
	|		ТабСерийныеНомера.ПодарочныйСертификат.Периодичность КАК Периодичность,
	|		ТабСерийныеНомера.ПодарочныйСертификат.КоличествоПериодовДействия КАК КоличествоПериодовДействия,
	|		ТабСерийныеНомера.ПодарочныйСертификат КАК Номенклатура
	|	ИЗ
	|		ТабСерийныеНомера КАК ТабСерийныеНомера
	|	ГДЕ
	|		ТабСерийныеНомера.СерийныйНомер.Владелец.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.ПериодПослеПродажи)) КАК Ведущая
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
	|				&ДатаДвижений,
	|				СерийныйНомер В
	|						(ВЫБРАТЬ
	|							ТабСерийныеНомера.СерийныйНомер
	|						ИЗ
	|							ТабСерийныеНомера КАК ТабСерийныеНомера
	|						ГДЕ
	|							ТабСерийныеНомера.СерийныйНомер.Владелец.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.ПериодПослеПродажи))
	|					И АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)) КАК ДвиженияСерийныхНомеров
	|		ПО Ведущая.СерийныйНомер = ДвиженияСерийныхНомеров.СерийныйНомер
	|ГДЕ
	|	ВЫБОР
	|			КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Неделя)
	|				ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, НЕДЕЛЯ, Ведущая.КоличествоПериодовДействия)
	|			КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Декада)
	|				ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ДЕКАДА, Ведущая.КоличествоПериодовДействия)
	|			КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Месяц)
	|				ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, МЕСЯЦ, Ведущая.КоличествоПериодовДействия)
	|			КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Квартал)
	|				ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, КВАРТАЛ, Ведущая.КоличествоПериодовДействия)
	|			КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Полугодие)
	|				ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ПОЛУГОДИЕ, Ведущая.КоличествоПериодовДействия)
	|			КОГДА Ведущая.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Год)
	|				ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ГОД, Ведущая.КоличествоПериодовДействия)
	|			ИНАЧЕ ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеров.Период, ДЕНЬ, Ведущая.КоличествоПериодовДействия)
	|		КОНЕЦ < &Дата
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	NULL,
	|	ТабБезСерийных.НомерСтроки,
	|	ТабБезСерийных.ПодарочныйСертификат.ДатаОкончанияДействия,
	|	NULL,
	|	NULL,
	|	ЛОЖЬ,
	|	ТабБезСерийных.ПодарочныйСертификат
	|ИЗ
	|	ТабБезСерийных КАК ТабБезСерийных
	|ГДЕ
	|	КОНЕЦПЕРИОДА(ТабБезСерийных.ПодарочныйСертификат.ДатаОкончанияДействия, ДЕНЬ) < &Дата
	|	И ТабБезСерийных.ПодарочныйСертификат.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.СОграничениемНаДату)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НеПравильныеСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|	НеПравильныеСерийныеНомера.НомерСтроки КАК НомерСтроки,
	|	НеПравильныеСерийныеНомера.ДатаОкончанияДействия КАК ДатаОкончанияДействия,
	|	НеПравильныеСерийныеНомера.Магазин КАК Магазин,
	|	НеПравильныеСерийныеНомера.ДатаОперации КАК ДатаОперации,
	|	НеПравильныеСерийныеНомера.СрокОтПродажи КАК СрокОтПродажи,
	|	НеПравильныеСерийныеНомера.Номенклатура КАК Номенклатура
	|ИЗ
	|	НеПравильныеСерийныеНомера КАК НеПравильныеСерийныеНомера";
	
	Запрос.УстановитьПараметр("Дата", НачалоДня(Дата));
	Запрос.УстановитьПараметр("ДатаДвижений", КонецДня(Дата));
	Запрос.УстановитьПараметр("ПогашенныеСерийныеНомера", ПогашенныеСерийныеНомера);
	Запрос.УстановитьПараметр("НеРеализованныеСерийныеНомера", НеРеализованныеСерийныеНомера);
	
	Результат = Запрос.Выполнить();
	ТаблицаЗапроса = Результат.Выгрузить();
	
	Для каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		
		Если ЗначениеЗаполнено(СтрокаТаблицыЗапроса.СерийныйНомер) Тогда
			
			Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Номер подарочного сертификата: %1 закончился срок действия - %2'"),
				СтрокаТаблицыЗапроса.СерийныйНомер,
				Формат(СтрокаТаблицыЗапроса.ДатаОкончанияДействия, "ДФ=dd.MM.yyyy")
			);
			
		Иначе
			
			Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Подарочный сертификат: %1 закончился срок действия - %2'"),
				СтрокаТаблицыЗапроса.Номенклатура,
				Формат(СтрокаТаблицыЗапроса.ДатаОкончанияДействия, "ДФ=dd.MM.yyyy")
			);
			
		КонецЕсли;
		
		Если СтрокаТаблицыЗапроса.СрокОтПродажи Тогда
			
			Текст = Текст + Символы.ПС +
						СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = ' реализация была в магазине %1 Дата %2'"),
					СтрокаТаблицыЗапроса.Магазин,
					Формат(СтрокаТаблицыЗапроса.ДатаОперации, "ДФ=dd.MM.yyyy")
					);
			
		КонецЕсли;
		
		Если ЭтоДокумент Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				Текст,
				ДокументОбъект,
				,
				,
				Отказ
			);
		Иначе
			Отказ = Истина;
		КонецЕсли;
		
		ТекстОшибки = ТекстОшибки + Символы.ПС + Текст;

	КонецЦикла;

КонецПроцедуры

// +HVOYA. 30.08.2016 17:06:10, Львова Е.А.
Процедура hiПроверитьДвиженияСерийныхНомеровКупонов(ДокументОбъект, ЭтоДокумент, ЭтоНовый, ТаблицаЗначений_Товары, ИмяТабличнойЧасти, ТаблицаЗначений_СерийныеНомера,
	 		Отказ, ТекстОшибки = "", Дата = Неопределено, ЭтоПогашениеКупона) Экспорт

	Если НЕ ПривилегированныйРежим() Тогда

		УстановитьПривилегированныйРежим(Истина);

	КонецЕсли;
	
	Для каждого Строка Из ТаблицаЗначений_Товары Цикл	//	LNK 16.06.2020 07:22:47 Нужно переписать по ключу "Строка.ТипНоменклатуры"

		ДанныеНоменклатуры = ЗапасыПовтИсп.ДанныеНоменклатуры(Строка.Номенклатура);

		Если НЕ ДанныеНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.СкидочныйКупон Тогда

			Продолжить

		КонецЕсли;
		
		Если ДанныеНоменклатуры.ИспользоватьСерийныеНомера Тогда

			ОтборПоСН = Новый Структура("КлючСвязиСерийныхНомеров", Строка.КлючСвязиСерийныхНомеров); 
			МассивСтрок = ТаблицаЗначений_СерийныеНомера.НайтиСтроки(ОтборПоСН);

			Если МассивСтрок.Количество() = 0 Тогда

				Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Серийный номер скидочного купона номенклатуры ""%1"" (строка №%2) , не найден!'"), СокрЛП(ДанныеНоменклатуры.Номенклатура), Строка.НомерСтроки);
				ТекстОшибки = ТекстОшибки + Символы.ПС + Текст + Символы.ПС;

				Отказ = Истина;
				Продолжить;

			КонецЕсли; 

			СерийныйНомер = МассивСтрок[0].СерийныйНомер;
			
			Запрос = Новый Запрос(
			"ВЫБРАТЬ
			|	ТаблицаДвижений.Купон КАК Купон,
			|	ТаблицаДвижений.АналитикаХозяйственнойОперации КАК АналитикаХозяйственнойОперации,
			|	ТаблицаДвижений.ЧекККМ.Магазин КАК Магазин,
			|	ТаблицаДвижений.ЧекККМ.Дата КАК ДатаОперации
			|ИЗ
			|	РегистрСведений.ДвиженияСерийныхНомеровКупонов КАК ТаблицаДвижений
			|ГДЕ
			|	ТаблицаДвижений.Купон = &Купон
			|	И ТаблицаДвижений.СерийныйНомер = &СерийныйНомер"
			);
			Запрос.УстановитьПараметр("Купон", ДанныеНоменклатуры.Номенклатура);
			Запрос.УстановитьПараметр("СерийныйНомер", СерийныйНомер);
			
			Результат = Запрос.Выполнить();
			
			Выборка = Результат.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				Если Выборка.АналитикаХозяйственнойОперации = Справочники.АналитикаХозяйственныхОпераций.РеализацияТоваров Тогда
					Отказ = Ложь;
				ИначеЕсли Выборка.АналитикаХозяйственнойОперации = Справочники.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов Тогда
					Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Номер скидочного купона %3 номенклатуры ""%1"" (строка №%2) уже погашен в магазине %4. Дата погашения - %5.'"), 
							Строка.Номенклатура, 
							Строка.НомерСтроки, 
							СерийныйНомер,
							// +HVOYA. 24.11.2016 14:00:29, Львова Е.А.
							Выборка.Магазин,
							Формат(Выборка.ДатаОперации, "ДФ=dd.MM.yyyy"));
							// -HVOYA. 24.11.2016 14:00:34, Львова Е.А.
					
					Текст = Текст + Символы.ПС;
					ТекстОшибки = ТекстОшибки + Символы.ПС + Текст;
					Отказ = Истина;
				КонецЕсли;
			КонецЦикла;
			
		КонецЕсли; 
		
	КонецЦикла; 
	
КонецПроцедуры

Процедура hiПроверитьДвиженияСерийныхНомеровДляПогашенияКупонов(
	ДокументОбъект,
	ЭтоДокумент,
	ЭтоНовый,
	ТабличнаяЧасть,
	ТабличнаяЧасть_ПогашениеСкидочныхКупонов,
	Отказ,
	ТекстОшибки = "",
	Дата
	) Экспорт
	
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(СерийныеНомера.СерийныйНомер КАК Справочник.СерийныеНомера) КАК СерийныйНомер,
	|	СерийныеНомера.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомераВсе
	|ИЗ
	|	&СерийныеНомера КАК СерийныеНомера
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомераВсе.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	(НЕ ТабСерийныеНомераВсе.СерийныйНомер = ЗНАЧЕНИЕ(Справочник.СерийныеНомера.ПустаяСсылка)
	|	И НЕ ТабСерийныеНомераВсе.СерийныйНомер = ЗНАЧЕНИЕ(Справочник.СерийныеНомера.ПустаяСсылка))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.Период КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Получатель.Магазин КАК Магазин,
	|	ДвиженияСерийныхНомеров.Регистратор,
	|	ДвиженияСерийныхНомеров.СерийныйНомер
	|ПОМЕСТИТЬ ДвиженияСерийныхНомеров
	|ИЗ
	|	РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|ГДЕ
	|	ДвиженияСерийныхНомеров.Период < &Дата
	|	И &УсловиеПоРегистратору
	|	И ДвиженияСерийныхНомеров.СерийныйНомер В
	|			(ВЫБРАТЬ
	|				ТабСерийныеНомера.СерийныйНомер
	|			ИЗ
	|				ТабСерийныеНомера КАК ТабСерийныеНомера)
	|	И ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.ДатаОперации КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Магазин КАК Магазин,
	|	ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомера.СерийныйНомер.Владелец КАК Номенклатура,
	|	ТабСерийныеНомера.НомерСтроки
	|ИЗ
	|	ТабСерийныеНомера КАК ТабСерийныеНомера
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|		ПО ТабСерийныеНомера.СерийныйНомер = ДвиженияСерийныхНомеров.СерийныйНомер";
	
	Запрос.УстановитьПараметр("СерийныеНомера", ТабличнаяЧасть_ПогашениеСкидочныхКупонов);
	
	Если ЭтоДокумент Тогда 
		Запрос.УстановитьПараметр("Регистратор", ДокументОбъект.Ссылка);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ДвиженияСерийныхНомеров.Регистратор <> &Регистратор");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ИСТИНА");
	КонецЕсли;
	Запрос.УстановитьПараметр("Дата", Дата);
	
	
	Результат = Запрос.Выполнить();
	ТаблицаЗапроса = Результат.Выгрузить();
	
	Для каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Номер скидочного купона %1 уже погашен. В магазине %2 Дата %3'"),
			СтрокаТаблицыЗапроса.СерийныйНомер,
			СтрокаТаблицыЗапроса.Магазин,
			Формат(СтрокаТаблицыЗапроса.ДатаОперации, "ДФ=dd.MM.yyyy")
		);
		
		Если ЭтоДокумент Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				Текст,
				ДокументОбъект,
				,
				,
				Отказ
			);
		Иначе
			Отказ = Истина;
		КонецЕсли;
		
		ТекстОшибки = ТекстОшибки + Символы.ПС + Текст;
		
	КонецЦикла;
	
	ПогашенныеСерийныеНомера = ТаблицаЗапроса.ВыгрузитьКолонку("СерийныйНомер");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(СерийныеНомера.СерийныйНомер КАК Справочник.СерийныеНомера) КАК СерийныйНомер,
	|	СерийныеНомера.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомераВсе
	|ИЗ
	|	&СерийныеНомера КАК СерийныеНомера
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомераВсе.НомерСтроки
	|ПОМЕСТИТЬ ТабСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	(НЕ ТабСерийныеНомераВсе.СерийныйНомер = ЗНАЧЕНИЕ(Справочник.СерийныеНомера.ПустаяСсылка))
	|	И (НЕ ТабСерийныеНомераВсе.СерийныйНомер В (&ПогашенныеСерийныеНомера))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.Период КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Регистратор,
	|	ДвиженияСерийныхНомеров.Получатель.Магазин КАК Магазин,
	|	ДвиженияСерийныхНомеров.СерийныйНомер
	|ПОМЕСТИТЬ ДвиженияСерийныхНомеров
	|ИЗ
	|	РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|ГДЕ
	|	ДвиженияСерийныхНомеров.Период < &Дата
	|	И &УсловиеПоРегистратору
	|	И ДвиженияСерийныхНомеров.СерийныйНомер В
	|			(ВЫБРАТЬ
	|				ТабСерийныеНомера.СерийныйНомер
	|			ИЗ
	|				ТабСерийныеНомера КАК ТабСерийныеНомера)
	|	И ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации,
	|	ДвиженияСерийныхНомеров.ДатаОперации КАК ДатаОперации,
	|	ДвиженияСерийныхНомеров.Магазин КАК Магазин,
	|	ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомера.СерийныйНомер.Владелец КАК Номенклатура,
	|	ТабСерийныеНомера.НомерСтроки
	|ИЗ
	|	ТабСерийныеНомера КАК ТабСерийныеНомера
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|		ПО ТабСерийныеНомера.СерийныйНомер = ДвиженияСерийныхНомеров.СерийныйНомер
	|ГДЕ
	|	ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации ЕСТЬ NULL ";
	
	Запрос.УстановитьПараметр("СерийныеНомера", ТабличнаяЧасть_ПогашениеСкидочныхКупонов);
	Запрос.УстановитьПараметр("ПогашенныеСерийныеНомера", ПогашенныеСерийныеНомера);
	
	Если ЭтоДокумент Тогда 
		Запрос.УстановитьПараметр("Регистратор", ДокументОбъект.Ссылка);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ДвиженияСерийныхНомеров.Регистратор <> &Регистратор");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоРегистратору", "ИСТИНА");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Дата", Дата);
	
	Результат = Запрос.Выполнить();
	ТаблицаЗапроса = Результат.Выгрузить();
	
	Для каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		
		Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Номер скидочного купона %1 еще не был реализован.'"),
			СтрокаТаблицыЗапроса.СерийныйНомер
		);
		
		
		Если ЭтоДокумент Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				Текст,
				ДокументОбъект,
				,
				,
				Отказ
			);
		Иначе
			Отказ = Истина;
		КонецЕсли;
		
		ТекстОшибки = ТекстОшибки + Символы.ПС + Текст;
		
	КонецЦикла;

	НеРеализованныеСерийныеНомера = ТаблицаЗапроса.ВыгрузитьКолонку("СерийныйНомер");
	
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(СерийныеНомера.СерийныйНомер КАК Справочник.СерийныеНомера) КАК СерийныйНомер,
	|	СерийныеНомера.НомерСтроки,
	|	ВЫРАЗИТЬ(СерийныеНомера.СкидочныйКупон КАК Справочник.Номенклатура) КАК СкидочныйКупон
	|ПОМЕСТИТЬ ТабСерийныеНомераВсе
	|ИЗ
	|	&СерийныеНомера КАК СерийныеНомера
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомераВсе.НомерСтроки,
	|	ТабСерийныеНомераВсе.СкидочныйКупон
	|ПОМЕСТИТЬ ТабСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	(НЕ ТабСерийныеНомераВсе.СерийныйНомер = ЗНАЧЕНИЕ(Справочник.СерийныеНомера.ПустаяСсылка))
	|	И (НЕ ТабСерийныеНомераВсе.СерийныйНомер В (&ПогашенныеСерийныеНомера))
	|	И (НЕ ТабСерийныеНомераВсе.СерийныйНомер В (&НеРеализованныеСерийныеНомера))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабСерийныеНомераВсе.НомерСтроки,
	|	ТабСерийныеНомераВсе.СкидочныйКупон
	|ПОМЕСТИТЬ ТабБезСерийных
	|ИЗ
	|	ТабСерийныеНомераВсе КАК ТабСерийныеНомераВсе
	|ГДЕ
	|	(НЕ ТабСерийныеНомераВсе.СкидочныйКупон.ИспользоватьСерийныеНомера)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|	ТабСерийныеНомера.НомерСтроки,
	|	ТабСерийныеНомера.СкидочныйКупон.ДатаОкончанияДействия КАК ДатаОкончанияДействия,
	|	NULL КАК Магазин,
	|	NULL КАК ДатаОперации,
	|	ЛОЖЬ КАК СрокОтПродажи,
	|	ТабСерийныеНомера.СкидочныйКупон КАК Номенклатура
	|ПОМЕСТИТЬ НеПравильныеСерийныеНомера
	|ИЗ
	|	ТабСерийныеНомера КАК ТабСерийныеНомера
	|ГДЕ
	|	ТабСерийныеНомера.СкидочныйКупон.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.СОграничениемНаДату)
	|	И КОНЕЦПЕРИОДА(ТабСерийныеНомера.СкидочныйКупон.ДатаОкончанияДействия, ДЕНЬ) < &Дата
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.СерийныйНомер,
	|	ВложенныйЗапрос.НомерСтроки,
	|	ВЫБОР
	|		КОГДА ВложенныйЗапрос.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Месяц)
	|			ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеровСрезПоследних.Период, МЕСЯЦ, ВложенныйЗапрос.КоличествоПериодовДействия)
	|		ИНАЧЕ ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеровСрезПоследних.Период, ДЕНЬ, ВложенныйЗапрос.КоличествоПериодовДействия)
	|	КОНЕЦ,
	|	ДвиженияСерийныхНомеровСрезПоследних.Отправитель.Магазин,
	|	ДвиженияСерийныхНомеровСрезПоследних.Период,
	|	ИСТИНА,
	|	ВложенныйЗапрос.Номенклатура
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТабСерийныеНомера.СерийныйНомер КАК СерийныйНомер,
	|		ТабСерийныеНомера.НомерСтроки КАК НомерСтроки,
	|		ТабСерийныеНомера.СкидочныйКупон.Периодичность КАК Периодичность,
	|		ТабСерийныеНомера.СкидочныйКупон.КоличествоПериодовДействия КАК КоличествоПериодовДействия,
	|		ТабСерийныеНомера.СкидочныйКупон КАК Номенклатура
	|	ИЗ
	|		ТабСерийныеНомера КАК ТабСерийныеНомера
	|	ГДЕ
	|		ТабСерийныеНомера.СерийныйНомер.Владелец.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.ПериодПослеПродажи)) КАК ВложенныйЗапрос
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
	|				&ДатаДвижений,
	|				СерийныйНомер В
	|						(ВЫБРАТЬ
	|							ТабСерийныеНомера.СерийныйНомер
	|						ИЗ
	|							ТабСерийныеНомера КАК ТабСерийныеНомера
	|						ГДЕ
	|							ТабСерийныеНомера.СерийныйНомер.Владелец.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.ПериодПослеПродажи))
	|					И АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)) КАК ДвиженияСерийныхНомеровСрезПоследних
	|		ПО ВложенныйЗапрос.СерийныйНомер = ДвиженияСерийныхНомеровСрезПоследних.СерийныйНомер
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ВложенныйЗапрос.Периодичность = ЗНАЧЕНИЕ(Перечисление.Периодичность.Месяц)
	|				ТОГДА ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеровСрезПоследних.Период, МЕСЯЦ, ВложенныйЗапрос.КоличествоПериодовДействия)
	|			ИНАЧЕ ДОБАВИТЬКДАТЕ(ДвиженияСерийныхНомеровСрезПоследних.Период, ДЕНЬ, ВложенныйЗапрос.КоличествоПериодовДействия)
	|		КОНЕЦ < &Дата
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	NULL,
	|	ТабБезСерийных.НомерСтроки,
	|	ТабБезСерийных.СкидочныйКупон.ДатаОкончанияДействия,
	|	NULL,
	|	NULL,
	|	ЛОЖЬ,
	|	ТабБезСерийных.СкидочныйКупон
	|ИЗ
	|	ТабБезСерийных КАК ТабБезСерийных
	|ГДЕ
	|	КОНЕЦПЕРИОДА(ТабБезСерийных.СкидочныйКупон.ДатаОкончанияДействия, ДЕНЬ) < &Дата
	|	И ТабБезСерийных.СкидочныйКупон.ТипСрокаДействия = ЗНАЧЕНИЕ(Перечисление.СрокДействияПодарочныхСертификатов.СОграничениемНаДату)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СерийныйНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НеПравильныеСерийныеНомера.СерийныйНомер,
	|	НеПравильныеСерийныеНомера.НомерСтроки,
	|	НеПравильныеСерийныеНомера.ДатаОкончанияДействия,
	|	НеПравильныеСерийныеНомера.Магазин,
	|	НеПравильныеСерийныеНомера.ДатаОперации,
	|	НеПравильныеСерийныеНомера.СрокОтПродажи,
	|	НеПравильныеСерийныеНомера.Номенклатура
	|ИЗ
	|	НеПравильныеСерийныеНомера КАК НеПравильныеСерийныеНомера";

	
	Запрос.УстановитьПараметр("Дата", НачалоДня(Дата));
	Запрос.УстановитьПараметр("ДатаДвижений", КонецДня(Дата));
	Запрос.УстановитьПараметр("ПогашенныеСерийныеНомера", ПогашенныеСерийныеНомера);
	Запрос.УстановитьПараметр("НеРеализованныеСерийныеНомера", НеРеализованныеСерийныеНомера);
	
	Результат = Запрос.Выполнить();
	ТаблицаЗапроса = Результат.Выгрузить();
	
	Для каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		
		Если ЗначениеЗаполнено(СтрокаТаблицыЗапроса.СерийныйНомер) Тогда
			
			Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Номер скидочного купона: %1 закончился срок действия - %2'"),
				СтрокаТаблицыЗапроса.СерийныйНомер,
				Формат(СтрокаТаблицыЗапроса.ДатаОкончанияДействия, "ДФ=dd.MM.yyyy")
			);
			
		Иначе
			
			Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Скидочный купон: %1 закончился срок действия - %2'"),
				СтрокаТаблицыЗапроса.Номенклатура,
				Формат(СтрокаТаблицыЗапроса.ДатаОкончанияДействия, "ДФ=dd.MM.yyyy")
			);
			
		КонецЕсли;
		
		Если СтрокаТаблицыЗапроса.СрокОтПродажи Тогда
			
			Текст = Текст + Символы.ПС +
						СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = ' реализация была в магазине %1 Дата %2'"),
					СтрокаТаблицыЗапроса.Магазин,
					Формат(СтрокаТаблицыЗапроса.ДатаОперации, "ДФ=dd.MM.yyyy")
					);
			
		КонецЕсли;
		
		Если ЭтоДокумент Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				Текст,
				ДокументОбъект,
				,
				,
				Отказ
			);
		Иначе
			Отказ = Истина;
		КонецЕсли;
		
		ТекстОшибки = ТекстОшибки + Символы.ПС + Текст;
		
	КонецЦикла;

КонецПроцедуры
// -HVOYA. 30.08.2016 17:06:17, Львова Е.А.

// Общая процедура Остатков серийных номеров
//
// Параметры
//  ДокументОбъект - объект проводимого документа документа.
//  ИмяТабличнойЧасти - Имя табличной части Товары
//  ИмяТабличнойЧастиСерийныеНомера - Имя табличной части Серийные номера
//  РежимПроведения - режим проведения документа
//  Отказ - Переменная отвечающая за прерывание проведения
//  Заголовок - Заголовок при ошибке
//  Дата - дата проверки
//
Процедура ПроверитьОстаткиСерийныхНомеров(
		ТаблицаЗначений_Товары, 
		ТаблицаЗначений_СерийныеНомера,
		Отказ,
		ТекстОшибки) Экспорт

	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаТовары.Номенклатура КАК Справочник.Номенклатура) КАК Номенклатура,
	|	ВЫРАЗИТЬ(ТаблицаТовары.КлючСвязиСерийныхНомеров КАК ЧИСЛО(5, 0)) КАК КлючСвязиСерийныхНомеров,
	|	ВЫРАЗИТЬ(ТаблицаТовары.Склад КАК Справочник.Склады) КАК Склад
	|ПОМЕСТИТЬ ДокТовары
	|ИЗ
	|	&ТаблицаТовары КАК ТаблицаТовары
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫРАЗИТЬ(ТаблицаСерийныхНомеров.СерийныйНомер КАК Справочник.СерийныеНомера) КАК СерийныйНомер,
	|	ВЫРАЗИТЬ(ТаблицаСерийныхНомеров.КлючСвязиСерийныхНомеров КАК ЧИСЛО(5, 0)) КАК КлючСвязиСерийныхНомеров
	|ПОМЕСТИТЬ ТаблицаСерийныхНомеров
	|ИЗ
	|	&ТаблицаСерийныхНомеров КАК ТаблицаСерийныхНомеров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСерийныхНомеров.СерийныйНомер КАК СерийныйНомер,
	|	ДокТовары.Номенклатура КАК Номенклатура,
	|	ДокТовары.Склад КАК Склад
	|ПОМЕСТИТЬ ТаблицаСерийныхНомеровПолная
	|ИЗ
	|	ТаблицаСерийныхНомеров КАК ТаблицаСерийныхНомеров
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДокТовары КАК ДокТовары
	|		ПО ТаблицаСерийныхНомеров.КлючСвязиСерийныхНомеров = ДокТовары.КлючСвязиСерийныхНомеров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВложенныйЗапрос.Номенклатура КАК Номенклатура,
	|	ВложенныйЗапрос.СерийныйНомер КАК СерийныйНомер,
	|	ВложенныйЗапрос.Склад КАК Склад,
	|	СУММА(ВложенныйЗапрос.Количество) КАК Количество
	|ПОМЕСТИТЬ ТаблицаОстатков
	|ИЗ
	|	(ВЫБРАТЬ
	|		ДвиженияСерийныхНомеров.Номенклатура КАК Номенклатура,
	|		ДвиженияСерийныхНомеров.СерийныйНомер КАК СерийныйНомер,
	|		ДвиженияСерийныхНомеров.Получатель КАК Склад,
	|		ДвиженияСерийныхНомеров.Количество КАК Количество
	|	ИЗ
	|		РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|	ГДЕ
	|		(ДвиженияСерийныхНомеров.Номенклатура, ДвиженияСерийныхНомеров.СерийныйНомер, ДвиженияСерийныхНомеров.Получатель) В
	|				(ВЫБРАТЬ
	|					Таблица.Номенклатура,
	|					Таблица.СерийныйНомер,
	|					Таблица.Склад
	|				ИЗ
	|					ТаблицаСерийныхНомеровПолная КАК Таблица)
	|		И (НЕ ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов))
	|		И (НЕ ДвиженияСерийныхНомеров.Получатель = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка))
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДвиженияСерийныхНомеров.Номенклатура,
	|		ДвиженияСерийныхНомеров.СерийныйНомер,
	|		ДвиженияСерийныхНомеров.Отправитель,
	|		-ДвиженияСерийныхНомеров.Количество
	|	ИЗ
	|		РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
	|	ГДЕ
	|		(ДвиженияСерийныхНомеров.Номенклатура, ДвиженияСерийныхНомеров.СерийныйНомер, ДвиженияСерийныхНомеров.Отправитель) В
	|				(ВЫБРАТЬ
	|					Таблица.Номенклатура,
	|					Таблица.СерийныйНомер,
	|					Таблица.Склад
	|				ИЗ
	|					ТаблицаСерийныхНомеровПолная КАК Таблица)
	|		И (НЕ ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов))
	|		И (НЕ ДвиженияСерийныхНомеров.Отправитель = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка))) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.Склад,
	|	ВложенныйЗапрос.СерийныйНомер,
	|	ВложенныйЗапрос.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСерийныхНомеровПолная.СерийныйНомер,
	|	ТаблицаСерийныхНомеровПолная.Номенклатура,
	|	ТаблицаСерийныхНомеровПолная.Склад
	|ИЗ
	|	ТаблицаСерийныхНомеровПолная КАК ТаблицаСерийныхНомеровПолная
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОстатков КАК ТаблицаОстатков
	|		ПО ТаблицаСерийныхНомеровПолная.СерийныйНомер = ТаблицаОстатков.СерийныйНомер
	|			И ТаблицаСерийныхНомеровПолная.Номенклатура = ТаблицаОстатков.Номенклатура
	|			И ТаблицаСерийныхНомеровПолная.Склад = ТаблицаОстатков.Склад
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаОстатков.Количество, 0) <= 0";

	Запрос.УстановитьПараметр("ТаблицаТовары" , ТаблицаЗначений_Товары);
	Запрос.УстановитьПараметр("ТаблицаСерийныхНомеров" , ТаблицаЗначений_СерийныеНомера);
	ТаблицаПоОтрицательнымОстаткам = Запрос.Выполнить().Выгрузить();
	
	ШаблонСообщения = НСтр("ru = 'Номер подарочного сертификата %3 (%1) 
		|Отсутствует на складе %2'");
	
	Для каждого СтрокаТаблицы Из ТаблицаПоОтрицательнымОстаткам Цикл
		Отказ = Истина;
		ТекстОшибки = ТекстОшибки + Символы.ПС + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонСообщения,
			Строка(СтрокаТаблицы.Номенклатура),
			Строка(СтрокаТаблицы.Склад),
			Строка(СтрокаТаблицы.СерийныйНомер));
	КонецЦикла;
	
КонецПроцедуры //ПроверитьОстаткиСерийныхНомеров

// Функция получает таблицу серийных номеров
// Возвращаемое значение
//		ТаблицаЗапроса - ТаблицаЗначений - результат запроса, выгруженный в таблицу значений
Функция ПолучитьТаблицуСерийныхНомеров(МассивСерийныхНомеров, МассивИспользуемыхСерийныхНомеров, ЭтоРеализация, Дата) Экспорт

	УстановитьПривилегированныйРежим(Истина);
	
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СерийныеНомера.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ТабСерийныеНомера
	|ИЗ
	|	Справочник.СерийныеНомера КАК СерийныеНомера
	|ГДЕ
	|	СерийныеНомера.Ссылка В(&МассивСерийныхНомеров)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////";
	Если ЭтоРеализация Тогда
	
		Запрос.Текст = Запрос.Текст + Символы.ПС + 
		"ВЫБРАТЬ
		|	ДвиженияСерийныхНомеровСрезПоследних.СерийныйНомер
		|ПОМЕСТИТЬ ТабНеПравильныхСерийныхНомеров
		|ИЗ
		|	РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
		|			&Дата,
		|			СерийныйНомер В
		|					(ВЫБРАТЬ
		|						ТабСерийныеНомера.Ссылка
		|					ИЗ
		|						ТабСерийныеНомера КАК ТабСерийныеНомера)
		|				И (АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)
		|					ИЛИ АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов)
		|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаЗатраты)
		|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПоИнвентаризации))) КАК ДвиженияСерийныхНомеровСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабСерийныеНомера.Ссылка
		|ИЗ
		|	ТабСерийныеНомера КАК ТабСерийныеНомера
		|ГДЕ
		|	(НЕ ТабСерийныеНомера.Ссылка В
		|				(ВЫБРАТЬ
		|					ТабНеПравильныхСерийныхНомеров.СерийныйНомер
		|				ИЗ
		|					ТабНеПравильныхСерийныхНомеров КАК ТабНеПравильныхСерийныхНомеров))";
		
	Иначе
		Запрос.Текст = Запрос.Текст + Символы.ПС + 
		"ВЫБРАТЬ
		|	ДвиженияСерийныхНомеровСрезПоследних.СерийныйНомер
		|ПОМЕСТИТЬ ТабРеализованных
		|ИЗ
		|	РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
		|			&Дата,
		|			СерийныйНомер В
		|					(ВЫБРАТЬ
		|						ТабСерийныеНомера.Ссылка
		|					ИЗ
		|						ТабСерийныеНомера КАК ТабСерийныеНомера)
		|				И (АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)
		|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаЗатраты)
		|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПоИнвентаризации))) КАК ДвиженияСерийныхНомеровСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияСерийныхНомеровСрезПоследних.СерийныйНомер
		|ПОМЕСТИТЬ ТабПогашенныхИСписанных
		|ИЗ
		|	РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
		|			&Дата,
		|			СерийныйНомер В
		|					(ВЫБРАТЬ
		|						ТабСерийныеНомера.Ссылка
		|					ИЗ
		|						ТабСерийныеНомера КАК ТабСерийныеНомера)
		|				И (АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов)
		|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаЗатраты)
		|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПоИнвентаризации))) КАК ДвиженияСерийныхНомеровСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабСерийныеНомера.Ссылка
		|ИЗ
		|	ТабСерийныеНомера КАК ТабСерийныеНомера
		|ГДЕ
		|	(НЕ ТабСерийныеНомера.Ссылка В
		|				(ВЫБРАТЬ
		|					ТабПогашенныхИСписанных.СерийныйНомер
		|				ИЗ
		|					ТабПогашенныхИСписанных КАК ТабПогашенныхИСписанных))
		|	И ТабСерийныеНомера.Ссылка В
		|			(ВЫБРАТЬ
		|				ТабРеализованных.СерийныйНомер
		|			ИЗ
		|				ТабРеализованных КАК ТабРеализованных)";
	КонецЕсли;
		
	Запрос.УстановитьПараметр("МассивСерийныхНомеров", МассивСерийныхНомеров);
	Запрос.УстановитьПараметр("МассивИспользуемыхСерийныхНомеров", МассивИспользуемыхСерийныхНомеров);
	Запрос.УстановитьПараметр("Дата", Дата);
	
	Результат = Запрос.Выполнить();
	
	ТаблицаЗапроса = Результат.Выгрузить();
		
	Возврат ТаблицаЗапроса;

КонецФункции // ПолучитьТаблицуСерийныхНомеров()

// Функция подбирает таблицу серийных номеров
//
// Параметры:
//  Текст   - введенный текст
//  ТекстАвтоПодбора - текст авто подбора
//  МассивИспользуемыхСерийныхНомеров - Уже выбранные серийные номера
//  Номенклатура - номенклатура поиска
//  ТипСерийногоНомера - тип серийного номера номенклатуры
//
// ВозвращаемоеЗначение
//  Массив
//
Функция ПодобратьМассивСерийныхНомеров(СтруктураПараметров, Текст) Экспорт
	Перем Номенклатура, ТипСерийногоНомера, СерийныеНомера, Дата, ЭтоРеализация;
	
	МассивРезультата = Новый Массив;
	
	Если Не ТипЗнч(СтруктураПараметров) = Тип("Структура") Тогда
		Возврат МассивРезультата;
	КонецЕсли;
	
	СтруктураПараметров.Свойство("ЭтоРеализация"     , ЭтоРеализация);
	СтруктураПараметров.Свойство("Номенклатура"      , Номенклатура);
	СтруктураПараметров.Свойство("ТипСерийногоНомера", ТипСерийногоНомера);
	СтруктураПараметров.Свойство("СерийныеНомера"    , СерийныеНомера);
	СтруктураПараметров.Свойство("Дата"              , Дата);
	
	МассивИспользуемыхСерийныхНомеров = СерийныеНомера.Выгрузить().ВыгрузитьКолонку("СерийныйНомер");
	
	Если СтруктураПараметров.Свойство("МассивИспользованныхСерийныхНомеров") Тогда
		
		Для каждого ЭлементМассива Из СтруктураПараметров.МассивИспользованныхСерийныхНомеров Цикл
			
			МассивИспользуемыхСерийныхНомеров.Добавить(ЭлементМассива);
			
		КонецЦикла;
		
	КонецЕсли;
	
	МассивСерийныхНомеров = МаркетинговыеАкцииСервер.ПодобратьСерийныеНомераПоТексту(Текст, МассивИспользуемыхСерийныхНомеров, Номенклатура, ТипСерийногоНомера);
	
	Если МассивСерийныхНомеров.Количество() > 0  Тогда
		
		УстановитьПривилегированныйРежим(Истина);
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СерийныеНомера.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ ТабСерийныеНомера
		|ИЗ
		|	Справочник.СерийныеНомера КАК СерийныеНомера
		|ГДЕ
		|	СерийныеНомера.Ссылка В(&МассивСерийныхНомеров)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////";
		Если ЭтоРеализация Тогда
		
			Запрос.Текст = Запрос.Текст + Символы.ПС + 
			"ВЫБРАТЬ
			|	ДвиженияСерийныхНомеровСрезПоследних.СерийныйНомер
			|ПОМЕСТИТЬ ТабНеПравильныхСерийныхНомеров
			|ИЗ
			|	РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
			|			&Дата,
			|			СерийныйНомер В
			|					(ВЫБРАТЬ
			|						ТабСерийныеНомера.Ссылка
			|					ИЗ
			|						ТабСерийныеНомера КАК ТабСерийныеНомера)
			|				И (АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)
			|					ИЛИ АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов)
			|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаЗатраты)
			|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПоИнвентаризации))) КАК ДвиженияСерийныхНомеровСрезПоследних
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТабСерийныеНомера.Ссылка
			|ИЗ
			|	ТабСерийныеНомера КАК ТабСерийныеНомера
			|ГДЕ
			|	(НЕ ТабСерийныеНомера.Ссылка В
			|				(ВЫБРАТЬ
			|					ТабНеПравильныхСерийныхНомеров.СерийныйНомер
			|				ИЗ
			|					ТабНеПравильныхСерийныхНомеров КАК ТабНеПравильныхСерийныхНомеров))";
			
		Иначе
			Запрос.Текст = Запрос.Текст + Символы.ПС + 
			"ВЫБРАТЬ
			|	ДвиженияСерийныхНомеровСрезПоследних.СерийныйНомер
			|ПОМЕСТИТЬ ТабРеализованных
			|ИЗ
			|	РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
			|			&Дата,
			|			СерийныйНомер В
			|					(ВЫБРАТЬ
			|						ТабСерийныеНомера.Ссылка
			|					ИЗ
			|						ТабСерийныеНомера КАК ТабСерийныеНомера)
			|				И (АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.РеализацияТоваров)
			|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаЗатраты)
			|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПоИнвентаризации))) КАК ДвиженияСерийныхНомеровСрезПоследних
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ДвиженияСерийныхНомеровСрезПоследних.СерийныйНомер
			|ПОМЕСТИТЬ ТабПогашенныхИСписанных
			|ИЗ
			|	РегистрСведений.ДвиженияСерийныхНомеров.СрезПоследних(
			|			&Дата,
			|			СерийныйНомер В
			|					(ВЫБРАТЬ
			|						ТабСерийныеНомера.Ссылка
			|					ИЗ
			|						ТабСерийныеНомера КАК ТабСерийныеНомера)
			|				И (АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов)
			|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаЗатраты)
			|					ИЛИ АналитикаХозяйственнойОперации.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПоИнвентаризации))) КАК ДвиженияСерийныхНомеровСрезПоследних
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТабСерийныеНомера.Ссылка
			|ИЗ
			|	ТабСерийныеНомера КАК ТабСерийныеНомера
			|ГДЕ
			|	(НЕ ТабСерийныеНомера.Ссылка В
			|				(ВЫБРАТЬ
			|					ТабПогашенныхИСписанных.СерийныйНомер
			|				ИЗ
			|					ТабПогашенныхИСписанных КАК ТабПогашенныхИСписанных))
			|	И ТабСерийныеНомера.Ссылка В
			|			(ВЫБРАТЬ
			|				ТабРеализованных.СерийныйНомер
			|			ИЗ
			|				ТабРеализованных КАК ТабРеализованных)";
		КонецЕсли;
		
		Запрос.УстановитьПараметр("МассивСерийныхНомеров", МассивСерийныхНомеров);
		Запрос.УстановитьПараметр("МассивИспользуемыхСерийныхНомеров", МассивИспользуемыхСерийныхНомеров);
		Запрос.УстановитьПараметр("Дата", Дата);
		
		Результат = Запрос.Выполнить();
		ТаблицаЗапроса = Результат.Выгрузить();
		МассивРезультата = ТаблицаЗапроса.ВыгрузитьКолонку("Ссылка")
	КонецЕсли;
	
	Возврат МассивРезультата;
	

КонецФункции // ПодобратьМассивСерийныхНомеров()

