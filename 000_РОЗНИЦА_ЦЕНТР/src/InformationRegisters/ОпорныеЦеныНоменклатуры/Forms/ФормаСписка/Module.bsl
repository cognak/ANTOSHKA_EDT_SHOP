

&НаКлиенте
Процедура ЗагрузитьИзТаблицыExcelЗавершение(СписокФайлов, ДополнительныеПараметры)	Экспорт

	Если ТипЗнч(СписокФайлов) = Тип("Массив") И НЕ СписокФайлов.Количество() = 0 Тогда

		ПолноеИмяИмпортируемогоФайла = СписокФайлов[0];
		ТекстСообщения = "";

		Если ВыполнитьЗагрузкуИмёнИзФайлаExcel(
				ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ПолноеИмяИмпортируемогоФайла), УникальныйИдентификатор),
				ОбщегоНазначенияКлиентСервер.lx_GetTooken(ПолноеИмяИмпортируемогоФайла, "."),
				ТекстСообщения) Тогда

			ПоказатьОповещениеПользователя("Операция выполнена",, ТекстСообщения, БиблиотекаКартинок.Информация2_32);

		Иначе

			ПоказатьОповещениеПользователя("Операция не выполнена из-за ошибки",, ТекстСообщения, БиблиотекаКартинок.Ошибка32);

		КонецЕсли;

	Иначе

		ПоказатьОповещениеПользователя("Операция не выполнена",, "Выбор файла не был сделан пользователем", БиблиотекаКартинок.Ошибка32);

	КонецЕсли;

КонецПроцедуры


&НаКлиенте
Процедура ЗагрузитьИзТаблицыExcelЗавершениеПоМагазину(СписокФайлов, ДополнительныеПараметры)	Экспорт

	Если ТипЗнч(СписокФайлов) = Тип("Массив") И НЕ СписокФайлов.Количество() = 0 Тогда

		ПолноеИмяИмпортируемогоФайла = СписокФайлов[0];
		ТекстСообщения = "";

		Если ВыполнитьЗагрузкуИмёнИзФайлаExcelПоМагазину(
				ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ПолноеИмяИмпортируемогоФайла), УникальныйИдентификатор),
				ОбщегоНазначенияКлиентСервер.lx_GetTooken(ПолноеИмяИмпортируемогоФайла, "."),
				ТекстСообщения) Тогда

			ПоказатьОповещениеПользователя("Операция выполнена",, ТекстСообщения, БиблиотекаКартинок.Информация2_32);

		Иначе

			ПоказатьОповещениеПользователя("Операция не выполнена из-за ошибки",, ТекстСообщения, БиблиотекаКартинок.Ошибка32);

		КонецЕсли;

	Иначе

		ПоказатьОповещениеПользователя("Операция не выполнена",, "Выбор файла не был сделан пользователем", БиблиотекаКартинок.Ошибка32);

	КонецЕсли;

КонецПроцедуры

&НаСервере	//	LNK 14.01.2019 10:56:13
Функция ВыполнитьЗагрузкуИмёнИзФайлаExcel(АдресВХранилище, Расширение, ТекстСообщения)

	Выполнено = Истина;

	Попытка

		ИмяВременногоФайла = ПолучитьИмяВременногоФайла(Расширение);
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресВХранилище);
		ДвоичныеДанные.Записать(ИмяВременногоФайла);

		ТабличныйДокумент = Новый ТабличныйДокумент;

		ТабличныйДокумент.Прочитать(ИмяВременногоФайла, СпособЧтенияЗначенийТабличногоДокумента.Значение);

		Колонки = Новый Массив;
		Колонки.Добавить(Новый Структура("Имя, Номер", "IDN", 1));
		Колонки.Добавить(Новый Структура("Имя, Номер", "Цена", 2));

		ТаблицаЗначений = Новый ТаблицаЗначений;
		ТаблицаЗначений.Колонки.Добавить("IDN", Новый ОписаниеТипов("Строка",, Новый КвалификаторыСтроки(7)));
		ТаблицаЗначений.Колонки.Добавить("Цена" , Новый ОписаниеТипов("Число"));
		ТаблицаЗначений.Колонки.Добавить("НомерСтроки" , Новый ОписаниеТипов("Число"));
		Для НомерСтроки = 2 По ТабличныйДокумент.ВысотаТаблицы Цикл

			СтрокаТаблицы = ТаблицаЗначений.Добавить();
			СтрокаТаблицы.НомерСтроки = НомерСтроки;

			Для каждого Колонка Из Колонки Цикл

				ТекущаяОбласть = ТабличныйДокумент.ПолучитьОбласть(
					"R" + Формат(НомерСтроки, "ЧДЦ=; ЧН=0; ЧГ=") +
					"C" + Формат(Колонка.Номер, "ЧДЦ=; ЧН=0; ЧГ=")).ТекущаяОбласть;

				Если НЕ ПустаяСтрока(ТекущаяОбласть.Текст) Тогда
					Если Колонка.Имя = "IDN" тогда 
						СтрокаТаблицы[Колонка.Имя] = Формат(ТекущаяОбласть.Значение,"ЧГ=0"); 
					Иначе
						СтрокаТаблицы[Колонка.Имя] = СокрЛП(ТекущаяОбласть.Текст);
					КонецЕсли;

				КонецЕсли;


			КонецЦикла;

		КонецЦикла;

		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	Таблица.IDN КАК IDN,
		|	Таблица.Цена КАК Цена
		|ПОМЕСТИТЬ Источник
		|ИЗ
		|	&ТаблицаЗначений КАК Таблица
		|ГДЕ
		|	НЕ Таблица.IDN = """"
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	IDN
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Источник.Цена КАК Цена,
		|	Магазины.Ссылка КАК Магазин,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	Магазины.НомерМагазина КАК НомерМагазина,
		|	Источник.IDN КАК IDN
		|ИЗ
		|	Справочник.Магазины КАК Магазины
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Источник КАК Источник
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
		|			ПО Источник.IDN = Номенклатура.IDN
		|		ПО (ИСТИНА)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОрганизацииПодразделений.СрезПоследних(&Период, ) КАК ТаблицаОрганизаций
		|		ПО Магазины.Ссылка = ТаблицаОрганизаций.Владелец
		|ГДЕ
		|	ТаблицаОрганизаций.Организация В(&Организации)
		|	И Магазины.ВведенВЭксплуатацию = ИСТИНА
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерМагазина,
		|	IDN УБЫВ"
		);
		Запрос.УстановитьПараметр("Период", ТекущаяДата());	//	LNK 15.11.2023 14:18:42
		Запрос.УстановитьПараметр("ТаблицаЗначений", ТаблицаЗначений);
		Запрос.УстановитьПараметр("Организации", ОбщегоНазначенияРТ.ПолучитьОрганизацииУзлов());
		Выборка = Запрос.Выполнить().Выбрать();
		
		Счётчик = 0;
		ТекДата = ТекущаяДата();

		Пока Выборка.Следующий() Цикл

			ЗаписьОтличается = Ложь;
			ЗаписьЕсть = Ложь;
	      	НаборЗаписей = РегистрыСведений.ОпорныеЦеныНоменклатуры.СоздатьНаборЗаписей(); 
			НаборЗаписей.Отбор.Период.Установить(ТекДата);
			НаборЗаписей.Отбор.Магазин.Установить(Выборка.Магазин);
			НаборЗаписей.Отбор.Номенклатура.Установить(Выборка.Номенклатура);
			НаборЗаписей.Отбор.Характеристика.Установить(Выборка.Характеристика);
			НаборЗаписей.Прочитать();
			Для Каждого Запись из НаборЗаписей Цикл
				ЗаписьЕсть = Истина;
				Если НЕ Запись.Цена = Выборка.Цена тогда 
					Запись.Цена = Выборка.Цена;
					Запись.Период = ТекДата;
					ЗаписьОтличается = Истина;
				КонецЕсли;
			КонецЦикла; 			
			Если ЗаписьОтличается тогда 
				НаборЗаписей.Записать(Истина);
				Счётчик = Счётчик + 1;
			ИначеЕсли НЕ ЗаписьЕсть тогда   
				Запись = НаборЗаписей.Добавить();
				Запись.Активность      = Истина;
				Запись.Магазин         = Выборка.Магазин;
				Запись.Номенклатура = Выборка.Номенклатура;
				Запись.Характеристика    = Выборка.Характеристика;
				Запись.Цена       = Выборка.Цена;
				Запись.Упаковка       =  Справочники.УпаковкиНоменклатуры.ПустаяСсылка();
				Запись.Период = ТекДата;
				НаборЗаписей.Записать(Истина);
				Счётчик = Счётчик + 1;
			КонецЕсли;
		КонецЦикла;
		
		ТекстСообщения = "Пройдено " + Формат(Счётчик, "ЧДЦ=; ЧН=НЕТ; ЧГ=")+ " записей.";

	Исключение

		Выполнено = Ложь;
		ТекстСообщения = ОписаниеОшибки();

	КонецПопытки;

	Возврат Выполнено;

КонецФункции




&НаСервере	//	LNK 14.01.2019 10:56:13
Функция ВыполнитьЗагрузкуИмёнИзФайлаExcelПоМагазину(АдресВХранилище, Расширение, ТекстСообщения)

	Выполнено = Истина;

	Попытка

		ИмяВременногоФайла = ПолучитьИмяВременногоФайла(Расширение);
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресВХранилище);
		ДвоичныеДанные.Записать(ИмяВременногоФайла);

		ТабличныйДокумент = Новый ТабличныйДокумент;

		ТабличныйДокумент.Прочитать(ИмяВременногоФайла, СпособЧтенияЗначенийТабличногоДокумента.Значение);

		Колонки = Новый Массив;
		Колонки.Добавить(Новый Структура("IDN", "IDN", 1));
		Колонки.Добавить(Новый Структура("Цена", "Цена", 2));
		Колонки.Добавить(Новый Структура("НомерМагазина", "НомерМагазина", 2));
		ТаблицаЗначений = Новый ТаблицаЗначений;
		ТаблицаЗначений.Колонки.Добавить("IDN", Новый ОписаниеТипов("Строка",, Новый КвалификаторыСтроки(7)));
		ТаблицаЗначений.Колонки.Добавить("Цена" , Новый ОписаниеТипов("Число"));
		Колонки.Добавить(Новый Структура("НомерМагазина", "НомерМагазина", 2));
		Для НомерСтроки = 1 По ТабличныйДокумент.ВысотаТаблицы Цикл

			СтрокаТаблицы = ТаблицаЗначений.Добавить();
			СтрокаТаблицы.НомерСтроки = НомерСтроки;

			Для каждого Колонка Из Колонки Цикл

				ТекущаяОбласть = ТабличныйДокумент.ПолучитьОбласть(
					"R" + Формат(НомерСтроки, "ЧДЦ=; ЧН=0; ЧГ=") +
					"C" + Формат(Колонка.Номер, "ЧДЦ=; ЧН=0; ЧГ=")).ТекущаяОбласть;

				Если НЕ ПустаяСтрока(ТекущаяОбласть.Текст) Тогда
						СтрокаТаблицы[Колонка.Имя] = СокрЛП(ТекущаяОбласть.Текст);

				КонецЕсли;


			КонецЦикла;

		КонецЦикла;

		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	Таблица.IDN КАК IDN,
		|	Таблица.Цена КАК Цена,
		|	Таблица.НомерМагазина КАК НомерМагазина
		|ПОМЕСТИТЬ Источник
		|ИЗ
		|	&ТаблицаЗначений КАК Таблица
		|ГДЕ
		|	НЕ Таблица.Наименование = """"
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	IDN
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Источник.Цена КАК Цена,
		|	Магазины.Ссылка КАК Магазин,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.пустаяссылка) КАК Характеристика,
		|	Номенклатура.Ссылка КАК Номенклатура
		|ИЗ
		|	Источник КАК Источник
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
		|		ПО Источник.IDN = Номенклатура.IDN
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Магазины КАК Магазины
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОрганизацииПодразделений.СрезПоследних КАК ТаблицаОрганизаций
		|			ПО Магазины.Ссылка = ТаблицаОрганизаций.Владелец
		|		ПО Источник.НомерМагазина = Магазины.НомерМагазина
		|ГДЕ
		|	НЕ Номенклатура.Ссылка ЕСТЬ NULL
		|	И ТаблицаОрганизаций.Организация = &Организация
		|	И Магазины.ВведенВЭксплуатацию = ИСТИНА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Источник"
		);
	//	Заменил обращение к организации магазина.. но этот запрос не может работать!
	//	Параметр "Организация" не задан.. да и вообще эти загрузки, подозреваю, не рабочие.
		Запрос.УстановитьПараметр("Период", ТекущаяДата());	//	LNK 15.11.2023 14:18:42
		Запрос.УстановитьПараметр("ТаблицаЗначений", ТаблицаЗначений);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Счётчик = 0;
		ТекДата = ТекущаяДата();

		Пока Выборка.Следующий() Цикл

	      	НаборЗаписей = РегистрыСведений.ОпорныеЦеныНоменклатуры.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Период.Установить(ТекДата);
			НаборЗаписей.Отбор.Магазин.Установить(Выборка.Магазин);
			НаборЗаписей.Отбор.Номенклатура.Установить(Выборка.Номенклатура);
			НаборЗаписей.Отбор.Характеристика.Установить(Выборка.Характеристика);
			Запись = НаборЗаписей.Добавить();
			Запись.Период = ТекДата;
			Запись.Активность      = Истина;
			Запись.Магазин         = Выборка.Магазин;
			Запись.Номенклатура = Выборка.Номенклатура;
			Запись.Характеристика    = Выборка.Характеристика;
			Запись.Цена       = Выборка.Цена;
			Запись.Упаковка       =  Справочники.УпаковкиНоменклатуры.ПустаяСсылка();
			НаборЗаписей.Записать(Истина);
		КонецЦикла;
		
	




		ТекстСообщения = "Загружено " + Формат(Счётчик, "ЧДЦ=; ЧН=НЕТ; ЧГ=") + " имён людей.";

	Исключение

		Выполнено = Ложь;
		ТекстСообщения = ОписаниеОшибки();

	КонецПопытки;

	Возврат Выполнено;

КонецФункции // ВыполнитьЗагрузкуИмёнИзФайлаExcel()





&НаКлиенте
Процедура ЗагрузитьИзТаблицыExcel(Команда)

	ОписаниеОповещения = Новый ОписаниеОповещения("ЗагрузитьИзТаблицыExcelЗавершение", ЭтотОбъект);
	ДиалогВыбораФайла  = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбораФайла.Заголовок = "Выберите файл книги MS Excel";
	//ДиалогВыбораФайла.Фильтр = НСтр("ru = 'Лист Excel'") + " (*.xls)|*.xls|" + НСтр("ru = 'Лист Excel2007'") + " (*.xlsx)|*.xlsx";
	ДиалогВыбораФайла.Фильтр = НСтр("ru = 'Лист Excel2007'") + " (*.xlsx)|*.xlsx";
	ДиалогВыбораФайла.ПолноеИмяФайла = ПолноеИмяИмпортируемогоФайла;
	ДиалогВыбораФайла.МножественныйВыбор = Ложь;
	ДиалогВыбораФайла.ПроверятьСуществованиеФайла = Истина;

	ДиалогВыбораФайла.Показать(ОписаниеОповещения);

КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьИзТаблицыExcelПоМагазину(Команда)
	ОписаниеОповещения = Новый ОписаниеОповещения("ЗагрузитьИзТаблицыExcelЗавершениеПоМагазину", ЭтотОбъект);
	ДиалогВыбораФайла  = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбораФайла.Заголовок = "Выберите файл книги MS Excel";
	ДиалогВыбораФайла.Фильтр = НСтр("ru = 'Лист Excel'") + " (*.xls)|*.xls|" + НСтр("ru = 'Лист Excel2007'") + " (*.xlsx)|*.xlsx";
	ДиалогВыбораФайла.ПолноеИмяФайла = ПолноеИмяИмпортируемогоФайла;
	ДиалогВыбораФайла.МножественныйВыбор = Ложь;
	ДиалогВыбораФайла.ПроверятьСуществованиеФайла = Истина;

	ДиалогВыбораФайла.Показать(ОписаниеОповещения);
КонецПроцедуры
