
&НаСервере
Процедура СформироватьНаСервере()
	Тз = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Номенклатура");
	ТЗ.Колонки.Добавить("Сумма");
	ТЗ.Колонки.Добавить("Магазин");
	ТЗ.Колонки.Добавить("IDN");
	
	Запрос = Новый Запрос;
	Запрос.Текст  = 
		"ВЫБРАТЬ
		|	ЦеныНоменклатуры.ВидЦены КАК ВидЦены,
		|	ЦеныНоменклатуры.Номенклатура КАК Номенклатура,
		|	ЦеныНоменклатуры.Характеристика КАК Характеристика,
		|	ЦеныНоменклатуры.Цена КАК Цена,
		|	ЦеныНоменклатуры.Период КАК Период,
		|	ЦеныНоменклатуры.Номенклатура.IDN КАК IDN
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
		|ГДЕ
		|	ЦеныНоменклатуры.Период МЕЖДУ &ПериодС И &ПериодПо
		|	И ВЫБОР
		|			КОГДА &ВидЦены = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ЦеныНоменклатуры.ВидЦены = &ВидЦены
		|		КОНЕЦ
		|	И ВЫБОР
		|			КОГДА &Проект = ЗНАЧЕНИЕ(Справочник.ВидыНоменклатуры.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ЦеныНоменклатуры.Номенклатура.ВидНоменклатуры = &Проект
		|		КОНЕЦ
		|ИТОГИ ПО
		|	ВидЦены";
			
	Если ЗначениеЗаполнено(ЭтотОбъект.МагазинДляОтбора) тогда 
		ПравилоЦенообразования =   ОбщегоНазначения.ПолучитьЗначениеРеквизита(ЭтотОбъект.МагазинДляОтбора,"ВидЦены");
		ВидЦены = ОбщегоНазначения.ПолучитьЗначениеРеквизита(ПравилоЦенообразования,"ВидЦены");
	Иначе	
		ВидЦены = Справочники.ВидыЦен.ПустаяСсылка();
	КонецЕсли;
	Запрос.УстановитьПараметр("ПериодПо", ТекПериод.ДатаОкончания);
	Запрос.УстановитьПараметр("ПериодС", ТекПериод.ДатаНачала);
	Запрос.УстановитьПараметр("ВидЦены", ВидЦены);
	Запрос.УстановитьПараметр("Проект", ЭтотОбъект.Проект);
	
	Сообщить("Начало " + ТекущаяДата());
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаВидЦены = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"ВидЦены");
	Сообщить("Запрос " + ТекущаяДата());
	Пока ВыборкаВидЦены.Следующий() Цикл
		Магазин = НайтиМагизин(ВыборкаВидЦены.ВидЦены);
		Выборка = ВыборкаВидЦены.Выбрать();
		Пока Выборка.Следующий() Цикл
			ПредЦена = ПолучитьПредЦену(Выборка.Номенклатура,Выборка.ВидЦены,Выборка.Период);
			РазницаЦен =  Выборка.Цена - ПредЦена;
			Кол = ПолучитьКол(Выборка.Номенклатура,Магазин,Выборка.Период);
			Если Кол <> 0 и  РазницаЦен  <> 0  тогда 
				Строка = Тз.Добавить();
				Строка.Сумма = Кол * РазницаЦен;
				Строка.Номенклатура = Выборка.Номенклатура;
				Строка.Магазин = Магазин;
				Строка.IDN = Выборка.IDN;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ТЗ.Свернуть("Номенклатура,Магазин,IDN","Сумма");
	Объект.ТабличнаяЧасть.Загрузить(ТЗ);	
	Сообщить("Конец " + ТекущаяДата());
	
КонецПроцедуры

&НаКлиенте
Процедура Сформировать(Команда)
	СформироватьНаСервере();
КонецПроцедуры


&НаСервере
Функция ПолучитьПредЦену(Номенклатура,ВидЦены,ДатаСреза)
	Цена = 0;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЦеныНоменклатурыСрезПоследних.Цена КАК Цена
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
		|			&Период,
		|			ВидЦены = &ВидЦены
		|				И Номенклатура = &Номенклатура) КАК ЦеныНоменклатурыСрезПоследних";
	ПредДень = НачалоДня(ДатаСреза) - 2;
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("ВидЦены", ВидЦены);
	Запрос.УстановитьПараметр("Период", ПредДень);
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Цена = Выборка.Цена;
	КонецЦикла;
	Возврат Цена;	
КонецФункции


&НаСервере
Функция ПолучитьКол(Номенклатура,Магазин,ДатаСреза)
	Кол = 0;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ТоварыНаСкладахОстатки.КоличествоОстаток) КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(
		|			&период,
		|			Номенклатура = &Номенклатура
		|				И Склад.Магазин = &Магазин) КАК ТоварыНаСкладахОстатки";
	ПредДень = НачалоДня(ДатаСреза) - 2;
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Магазин", Магазин);
	Запрос.УстановитьПараметр("Период", ПредДень);
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Кол = Выборка.КоличествоОстаток;
	КонецЦикла;
	Возврат Кол;	
КонецФункции


&НаСервере
Функция НайтиМагизин(ВидЦен)
	Магазин = Справочники.Магазины.ПустаяСсылка();	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Магазины.Ссылка КАК Магазин
		|ИЗ
		|	Справочник.Магазины КАК Магазины
		|ГДЕ
		|	Магазины.ПравилоЦенообразования.ВидЦен = &ВидЦен";
	Запрос.УстановитьПараметр("ВидЦен", ВидЦен);
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Магазин = Выборка.Магазин;
	КонецЦикла;
	Возврат Магазин;	
КонецФункции


&НаСервере
Процедура СформироватьНаСервере2()
	Тз = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Номенклатура");
	ТЗ.Колонки.Добавить("Сумма");
	ТЗ.Колонки.Добавить("Магазин");
	ТЗ.Колонки.Добавить("IDN");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЦеныНоменклатуры.ВидЦены КАК ВидЦены,
		|	НАЧАЛОПЕРИОДА(ЦеныНоменклатуры.Период, ДЕНЬ) КАК Период
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
		|ГДЕ
		|	ЦеныНоменклатуры.Период МЕЖДУ &ПериодС И &ПериодПо
		|	И ВЫБОР
		|			КОГДА &ВидЦены = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ЦеныНоменклатуры.ВидЦены = &ВидЦены
		|		КОНЕЦ
		|
		|СГРУППИРОВАТЬ ПО
		|	ЦеныНоменклатуры.ВидЦены,
		|	НАЧАЛОПЕРИОДА(ЦеныНоменклатуры.Период, ДЕНЬ)
		|
		|УПОРЯДОЧИТЬ ПО
		|	ВидЦены,
		|	Период
		|ИТОГИ ПО
		|	ВидЦены,
		|	Период";
	
	Если ЗначениеЗаполнено(ЭтотОбъект.МагазинДляОтбора) тогда 
		ПравилоЦенообразования =   ОбщегоНазначения.ПолучитьЗначениеРеквизита(ЭтотОбъект.МагазинДляОтбора,"ПравилоЦенообразования");
		ВидЦены = ОбщегоНазначения.ПолучитьЗначениеРеквизита(ПравилоЦенообразования,"ВидЦен");
	Иначе	
		ВидЦены = Справочники.ВидыЦен.ПустаяСсылка();
	КонецЕсли;
	Запрос.УстановитьПараметр("ПериодПо", ТекПериод.ДатаОкончания);
	Запрос.УстановитьПараметр("ПериодС", ТекПериод.ДатаНачала);
	Запрос.УстановитьПараметр("ВидЦены", ВидЦены);
	
	//Сообщить("Начало " + ТекущаяДата());
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаВидЦены = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"ВидЦены");
	//Сообщить("Запрос " + ТекущаяДата());
	Пока ВыборкаВидЦены.Следующий() Цикл
		МагазинОтбор = НайтиМагизин(ВыборкаВидЦены.ВидЦены);
			Выборка = ВыборкаВидЦены.Выбрать();
			Пока Выборка.Следующий() Цикл
				Таб = ПолучитьТаб(ВыборкаВидЦены.ВидЦены,Выборка.Период,МагазинОтбор);
				Для каждого строка из  Таб цикл
				//Кол = строка.Кол;
				строкаТЗ = Тз.Добавить();
				строкаТЗ.Сумма = строка.Сумма;
				строкаТЗ.Номенклатура = строка.Номенклатура;
				строкаТЗ.IDN = строка.IDN; 				
				строкаТЗ.Магазин = МагазинОтбор;
				КонецЦикла;
			КонецЦикла;
	КонецЦикла;
	
	ТЗ.Свернуть("Номенклатура,Магазин,IDN","Сумма");
	Объект.ТабличнаяЧасть.Загрузить(ТЗ);	
	//Сообщить("Конец " + ТекущаяДата());
	
КонецПроцедуры

&НаСервере
Функция ПолучитьТаб(Видцены,текДата,Магазин)
	 	//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ВЫБОР
		|			КОГДА ЕСТЬNULL(ЦеныНоменклатурыПредыдущие.Цена, 0) = 0
		|				ТОГДА 0
		|			ИНАЧЕ (ЦеныНоменклатурыПредыдущие.Цена - ЦеныНоменклатуры.Цена) * ЕСТЬNULL(ТоварыКОтгрузкеОстатки.КоличествоОстаток, 0)
		|		КОНЕЦ) КАК Сумма,
		|	ЦеныНоменклатуры.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ ВременнаяТаблица
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ПредДень, ВидЦены = &ВидЦены) КАК ЦеныНоменклатурыПредыдущие
		|		ПО ЦеныНоменклатуры.Номенклатура = ЦеныНоменклатурыПредыдущие.Номенклатура
		|			И ЦеныНоменклатуры.ВидЦены = ЦеныНоменклатурыПредыдущие.ВидЦены
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(&ТекДата, Склад.Магазин = &Магазин) КАК ТоварыКОтгрузкеОстатки
		|		ПО ЦеныНоменклатуры.Номенклатура = ТоварыКОтгрузкеОстатки.Номенклатура
		|ГДЕ
		|	НАЧАЛОПЕРИОДА(ЦеныНоменклатуры.Период, ДЕНЬ) = &ТекДата
		|	И ЦеныНоменклатуры.ВидЦены = &ВидЦены
		|	И ВЫБОР
		|			КОГДА &Проект = ЗНАЧЕНИЕ(Справочник.ВидыНоменклатуры.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ЦеныНоменклатуры.Номенклатура.ВидНоменклатуры = &Проект
		|		КОНЕЦ
		|
		|СГРУППИРОВАТЬ ПО
		|	ЦеныНоменклатуры.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВременнаяТаблица.Номенклатура КАК Номенклатура,
		|	ВременнаяТаблица.Сумма КАК Сумма,
		|	ВременнаяТаблица.Номенклатура.IDN КАК IDN
		|ИЗ
		|	ВременнаяТаблица КАК ВременнаяТаблица
		|ГДЕ
		|	ВременнаяТаблица.Сумма <> 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВременнаяТаблица";
	ПредДень =  ТекДата -2;
	Запрос.УстановитьПараметр("ВидЦены", ВидЦены);
	Запрос.УстановитьПараметр("Магазин", Магазин);
	Запрос.УстановитьПараметр("ПредДень", ПредДень);
	Запрос.УстановитьПараметр("КонецДня", КонецДня(ТекДата));
	Запрос.УстановитьПараметр("ТекДата", ТекДата);
	Запрос.УстановитьПараметр("Проект", ЭтотОбъект.Проект);
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
Таб = Новый ТаблицаЗначений;	
Если не РезультатЗапроса.Пустой() тогда 
	Таб = РезультатЗапроса.Выгрузить(); 
КонецЕсли;	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

Возврат Таб;	
	
КонецФункции

&НаКлиенте
Процедура Команда2(Команда)
СформироватьНаСервере2()
КонецПроцедуры
