
// Функция записывает данные по лицевым счетам в XML-файл
// Возвращает имя файла
//
Функция ЗаписатьДанныеXML() Экспорт
	
	ИмяФайла = ИмяФайлаДанных;
	
	ЗаписьXML = Новый ЗаписьXML;  
	ЗаписьXML.ОткрытьФайл(ИмяФайла);

	ДокументDOM = Новый ДокументDOM("", "root");
	КорневойЭлемент = ДокументDOM.ЭлементДокумента;
	//КорневойЭлемент.УстановитьАтрибут("filetype", "accounts");
	//
	КорневойЭлемент.УстановитьАтрибут("filedate",Строка(Формат(ДатаВыгрузки,"ДЛФ=Д")));
		
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЧекККМ.Ссылка КАК ЧЕК,
	               |	ЧекККМ.ЗаказПокупателя.IDN КАК НомерЗаказа,
	               |	ЧекККМ.Дата КАК Дата,
	               |	ЧекККМ.ЗаказПокупателя.Контрагент.IDN КАК Контрагент,
	               |	ЧекККМ.Товары.(
	               |		Ссылка,
	               |		НомерСтроки,
	               |		Номенклатура,
	               |		Характеристика,
	               |		Количество,
	               |		Цена,
	               |		Сумма,
	               |		СтавкаНДС,
	               |		СуммаНДС,
	               |		ПроцентАвтоматическойСкидки,
	               |		ПроцентРучнойСкидки,
	               |		РегистрацияПродажи,
	               |		Штрихкод,
	               |		Склад,
	               |		КлючСвязиСерийныхНомеров,
	               |		Продавец,
	               |		ПродажаПодарка,
	               |		Упаковка,
	               |		КоличествоУпаковок,
	               |		КлючСвязи,
	               |		СуммаАвтоматическойСкидки,
	               |		СуммаРучнойСкидки,
	               |		СтатусУказанияСерий,
	               |		ПричинаРучнойСкидки,
	               |		АкционнаяЦена
	               |	),
	               |	ЧекККМ.Оплата.(
	               |		Ссылка,
	               |		НомерСтроки,
	               |		ВидОплаты,
	               |		ЭквайринговыйТерминал,
	               |		Сумма,
	               |		ПроцентТорговойУступки,
	               |		СуммаТорговойУступки,
	               |		СсылочныйНомер,
	               |		НомерЧекаЭТ,
	               |		НомерПлатежнойКарты,
	               |		ДанныеПереданыВБанк
	               |	)
	               |ИЗ
	               |	Документ.ЧекККМ КАК ЧекККМ
	               |ГДЕ
	               |	ЧекККМ.СтатусЧекаККМ = &СтатусЧекаККМ
	               |ИТОГИ
	               |	МАКСИМУМ(НомерЗаказа),
	               |	МАКСИМУМ(Дата),
	               |	МАКСИМУМ(Контрагент)
	               |ПО
	               |	ЧЕК";
				
	Запрос.УстановитьПараметр("СтатусЧекаККМ", Перечисления.СтатусыЧековККМ.Пробитый);
	
	
	РезультатЗапроса = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	//ТаблицаТР = Запрос.Выполнить().Выгрузить();
	
	
	Пока РезультатЗапроса.Следующий() Цикл
		
		//ЛС - данные по лицевым счетам
		СтрокаЧек = ДокументDOM.СоздатьЭлемент("ЧЕК");
		КорневойЭлемент.ДобавитьДочерний(СтрокаЧек);
		
		
		СтрокаЧек.УстановитьАтрибут("НомерЗаказа",XMLСтрока(РезультатЗапроса.НомерЗаказа));	
		СтрокаЧек.УстановитьАтрибут("Дата",XMLСтрока((РезультатЗапроса.Дата)));
		
		СтрокаКонтрагент = ДокументDOM.СоздатьЭлемент("Контрагент");
		СтрокаЧек.ДобавитьДочерний(СтрокаКонтрагент);
		
		СтрокаКонтрагент.УстановитьАтрибут("user_id",XMLСтрока(РезультатЗапроса.Контрагент));
		
		
				
		
		
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			ВыборкаОплаты = Выборка.Оплаты.Выбрать();
			СтрокаОплаты = ДокументDOM.СоздатьЭлемент("Оплаты");
			СтрокаЧек.ДобавитьДочерний(СтрокаОплаты);

			Пока ВыборкаОплаты.Следующий() Цикл
				СтрокаОплаты.УстановитьАтрибут("ТипОплаты",XMLСтрока(ВыборкаОплаты.ВидОплаты));
				СтрокаОплаты.УстановитьАтрибут("Сумма",XMLСтрока(ВыборкаОплаты.Сумма));
			КонецЦикла;
			
			
			ВыборкаТОВары = ВыборкаОплаты.Товары.Выбрать();
			СтрокаТовар = ДокументDOM.СоздатьЭлемент("Товары");
			СтрокаЧек.ДобавитьДочерний(СтрокаТовар);
			Пока ВыборкаТОВары.Следующий() Цикл
				СтрокаОплаты.УстановитьАтрибут("Склад",XMLСтрока(ВыборкаТОВары.Склад));
				СтрокаОплаты.УстановитьАтрибут("Товар",XMLСтрока(ВыборкаТОВары.Номенклатура.Код));
				СтрокаОплаты.УстановитьАтрибут("Количество",XMLСтрока(ВыборкаТОВары.Количество));

				СтрокаОплаты.УстановитьАтрибут("Цена",XMLСтрока(ВыборкаТОВары.Цена));
				СтрокаОплаты.УстановитьАтрибут("Сумма",XMLСтрока(ВыборкаТОВары.Сумма));


			КонецЦикла;
			//СтрокаЛС.УстановитьАтрибут("НомерКвартиры", XMLСтрока(РезультатЗапроса.НомерКвартиры));	
		КонецЦикла;	
		
	КонецЦикла;
	

	// запись документа
	ЗаписьDOM = Новый ЗаписьDOM();
	ЗаписьDOM.Записать(ДокументDOM, ЗаписьXML);
	
	ЗаписьXML.Закрыть();
	
	Возврат ИмяФайла;
	
КонецФункции
