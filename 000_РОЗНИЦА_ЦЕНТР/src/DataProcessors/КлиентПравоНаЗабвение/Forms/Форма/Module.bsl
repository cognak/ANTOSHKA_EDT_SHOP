
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("Ключ") Тогда
		Объект.Контрагент = Параметры.Ключ;	
		УстановитьНомерТелефона();
	Иначе
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры
&НаКлиенте	//	LNK 12.08.2019 12:40:27
Процедура Подключаемый_ДоступностьWebRetail()

	РесурсWebRetailДоступен = РозничныеПродажиСлужебный.РесурсWebRetailДоступен();

	Если РесурсWebRetailДоступен Тогда

			Элементы.ИндикаторПодключения.Картинка = БиблиотекаКартинок.RFDIОперацииВыполнены;

	Иначе	Элементы.ИндикаторПодключения.Картинка = БиблиотекаКартинок.RFDIЗапись;

	КонецЕсли;

КонецПроцедуры


&НаКлиенте
Функция ПроверитьЗаполнениеТелефона()
	
	Возврат ЗначениеЗаполнено(НомерТелефона);
		
КонецФункции

&НаСервере
Процедура УстановитьНомерТелефона()
	СтрокаТелефон = Объект.Контрагент.КонтактнаяИнформация.Найти(Перечисления.ТипыКонтактнойИнформации.Телефон,"Тип");
	Если СтрокаТелефон = Неопределено Тогда
		СообщениеПользователю = Новый СообщениеПользователю();
		СообщениеПользователю.Текст = "Контактний телефон не знайдено!";
		СообщениеПользователю.Сообщить();
		Возврат;
	КонецЕсли;
	
	НомерТелефона = СтрокаТелефон.Представление;
	
	
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьКодПодтвержденияSMSЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	ОтладочныйРежим = Ложь;
	
	
	Если РезультатВопроса = КодВозвратаДиалога.ОК Тогда

		Если ОтладочныйРежим ИЛИ ОтправитьКодПодтвержденияSMSНаСервере(НомерТелефона, ИмяКомпьютера(), ПредопределенноеЗначение("Справочник.Контрагенты.ПустаяСсылка")) Тогда

			ПодтверждениеОтправлено = Истина;
			ПоказатьОповещениеПользователя("Код успешно отправлен на телефон" + Символы.ПС + "«" + НомерТелефона + "»");

		КонецЕсли;


		ТекущийЭлемент = Элементы.КодПодтверждения;

	КонецЕсли;

КонецПроцедуры

&НаСервереБезКонтекста
Функция ОтправитьКодПодтвержденияSMSНаСервере(НомерТелефона, ИмяКлиентскогоКомпьютера, Контрагент)

	ДополнительныеПараметры = Новый Структура(
		"ИмяКомпьютера, Контрагент", ИмяКлиентскогоКомпьютера, Контрагент);

	Возврат ВерификацияКлиентовСервер.ОтправитьКодПодтверждения(ОтправкаSMS.ПодготовитьНомерТелефона(НомерТелефона), ДополнительныеПараметры, Истина);

КонецФункции

&НаСервереБезКонтекста
Функция КодПодтвержденияПриИзмененииНаСервере(НомерТелефона)

	Возврат ВерификацияКлиентовСервер.ПолучитьКодПодтверждения(ОтправкаSMS.ПодготовитьНомерТелефона(НомерТелефона), Истина);

КонецФункции // КодПодтвержденияПриИзмененииНаСервере()


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Подключаемый_ДоступностьWebRetail();
КонецПроцедуры


&НаКлиенте
Процедура КодПодтвержденияПриИзменении(Элемент)
	ПоказатьОповещениеПользователя("Проверка номера телефона"
	,, "Отправлен запрос на получение последнего кода подтверждения ..."
	, БиблиотекаКартинок.Вопрос32, СтатусОповещенияПользователя.Информация);

	ПодтверждениеПолучено = Ложь;	//	сбросим возможное подтверждение

	Если ОтладочныйРежим Тогда

		ДанныеКлиента = Новый Структура(
			"Указан, КодКлиента"
			, Истина
			, КодПодтверждения
		);

	Иначе

		ДанныеКлиента = КодПодтвержденияПриИзмененииНаСервере(НомерТелефона);

	КонецЕсли;

	Если ДанныеКлиента.Указан Тогда

		Если СокрЛП(ДанныеКлиента.КодКлиента) = СокрЛП(КодПодтверждения) Тогда

			ПодтверждениеПолучено = Истина;

			ПоказатьОповещениеПользователя("Проверка номера телефона"
			,, "Поздравляем! Код подтверждения соответствует"
			, БиблиотекаКартинок.Информация32, СтатусОповещенияПользователя.Информация);

			//ТекущийЭлемент = Элементы.РегистрацияКлиента;
			Ответ = КонтактнаяИнформацияВызовСервера.ОчиститьДанныеКлиента(Объект.Контрагент);
			Если Ответ.Успешно Тогда
				ПоказатьОповещениеПользователя("Очистка информации о клиенте"
					,, "Данные клиента успешно удалены из базы"
					, БиблиотекаКартинок.Вопрос32, СтатусОповещенияПользователя.Информация);
					
					ПоказатьПредупреждение(Новый ОписаниеОповещения("ОчисткаКлиентаУспешноЗавершение", ЭтотОбъект),"Данные о клиенте удалены из базы успешно",0,"Очистка информации о клиенте");
					
					
					
			Иначе
				ПоказатьОповещениеПользователя("Очистка информации о клиенте"
					,, "Не удалось удалить данные о клиенте!"+Символы.ПС+Ответ.ОписаниеОшибки
					, БиблиотекаКартинок.Важно, СтатусОповещенияПользователя.Важное);
				ПоказатьПредупреждение(Новый ОписаниеОповещения("ОчисткаКлиентаНеуспешноЗавершение", ЭтотОбъект),"Ошибка при удалении данных: "+Символы.ПС+Ответ.ОписаниеОшибки,0,"Очистка информации о клиенте");
					
			КонецЕсли;
			
		Иначе

			ПоказатьОповещениеПользователя("Проверка номера телефона"
			,, "Код подтверждения не совпадает с отправленным на номер телефона «" + НомерТелефона + "»"
			, БиблиотекаКартинок.Ошибка32, СтатусОповещенияПользователя.Важное);

			ТекущийЭлемент = Элементы.КодПодтверждения;

		КонецЕсли;

	Иначе

		ПоказатьОповещениеПользователя("Проверка номера телефона"
		,, "Код подтверждения не получен. Возможно, не соответствует номер телефона «" + НомерТелефона + "»"
		, БиблиотекаКартинок.Ошибка32, СтатусОповещенияПользователя.Важное);

		ТекущийЭлемент = Элементы.КодПодтверждения;
	
	КонецЕсли;

	
КонецПроцедуры

&НаКлиенте
Процедура ОчисткаКлиентаУспешноЗавершение(ДополнительныеПараметры) Экспорт
	ЭтаФорма.ОбновитьОтображениеДанных();
	ЭтаФорма.ОтобразитьИзменениеДанных(Объект.Контрагент,ВидИзмененияДанных.Изменение);
	//НавСсылкаНаКонтрагента = ПолучитьНавигационнуюСсылку(Объект.Контрагент);
	//ПерейтиПоНавигационнойСсылке(НавСсылкаНаКонтрагента);
	//ЭтаФорма.ВыполнитьПереход(Объект.Контрагент);
	//ЭтаФорма.Закрыть();
КонецПроцедуры


&НаКлиенте
Процедура ОчисткаКлиентаНеУспешноЗавершение(ДополнительныеПараметры) Экспорт
	ЭтаФорма.ОбновитьОтображениеДанных();
	ЭтаФорма.ОтобразитьИзменениеДанных(Объект.Контрагент,ВидИзмененияДанных.Изменение);
КонецПроцедуры

&НаКлиенте
Процедура КомандаОправитьКодПодтвержденияСМС(Команда)
	Подключаемый_ДоступностьWebRetail();

	Если НЕ РесурсWebRetailДоступен Тогда

		Сообщить(
			"SMS аутентификация"
			, "НЕТ доступа к серверу ЦБ. Попытайтесь выполнить позже."
		);
		Возврат;

	КонецЕсли;

	Если ПроверитьЗаполнениеТелефона() Тогда

		ПоказатьВопрос(Новый ОписаниеОповещения("ОтправитьКодПодтвержденияSMSЗавершение", ЭтотОбъект)
			, "Будет отправлено SMS по указанному номеру. Подтвердите своё решение:", РежимДиалогаВопрос.ОКОтмена
			, 60, КодВозвратаДиалога.ОК, "ИДЕНТИФИКАЦИЯ", КодВозвратаДиалога.Отмена);

	Иначе

		Сообщить("В действии отказано!", "Необходимо заполнить все обязательные поля.");

	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура КомандаЗакрыть(Команда)
	ЭтаФорма.ВладелецФормы.Закрыть(Неопределено);
	//ЭтаФорма.Закрыть(Неопределено);
КонецПроцедуры

